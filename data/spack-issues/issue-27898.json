{
    "body": "### Steps to reproduce the issue\r\n\r\n`papi@6.0.0.1 +rocm amdgpu_target=gfx908` fails to build using:\r\n* `spack@develop` (f81d84dfc6b1c3a821dffab785e62ecd79f130ab from `Tue Dec 7 12:30:14 2021 +0100`)\r\n* Ubuntu 20.04, x86_64\r\n* GCC 9.3.0\r\n* ROCm 4.3.1, defined externally, installed via apt\r\n\r\nI had to manually add `depends_on('numactl')` to `rocprofiler-dev` to bypass this https://github.com/spack/spack/pull/27839 -- otherwise it complained it couldn't find `libnuma`\r\n\r\nConcrete spec: [papi.spec.json.txt](https://github.com/spack/spack/files/7688556/papi.spec.json.txt)\r\n\r\nConcretization:\r\n```\r\npapi@6.0.0.1%gcc@9.3.0~cuda+example~infiniband~lmsensors~nvml~powercap~rapl+rocm~rocm_smi~sde+shared~static_tools amdgpu_target=gfx908 arch=linux-ubuntu20.04-x86_64\r\n    ^hip@4.3.1%gcc@9.3.0~ipo build_type=Release patches=2a4190477b7d9206b9cd8d70770ba0bc007273cbe54772efb12f9ca2e37c0392,99190b4616edb362d48f9b265c3018a3c6339481b0729d9fe46185fca25bc54b,e276c4acf3d37712b6bea306fea34f539d3c4f743471e9da208b5eb17b16ae67 arch=linux-ubuntu20.04-x86_64\r\n    ^hsa-rocr-dev@4.3.1%gcc@9.3.0+image~ipo+shared build_type=Release patches=71e6851d9be8113bfb8d71b66a3171e0d0401bae5e6f161c9e7fe32558261a46 arch=linux-ubuntu20.04-x86_64\r\n    ^llvm-amdgpu@4.3.1%gcc@9.3.0~ipo+openmp+rocm-device-libs build_type=Release patches=d999f3b235e655ee07f6dd2590302082feaa06d32c5c6b53aae9c5cf1e45b644 arch=linux-ubuntu20.04-x86_64\r\n    ^rocprofiler-dev@4.3.1%gcc@9.3.0~ipo build_type=Release patches=16754a151dd227edf76b2a32a50721f5f30fd223510f34e2f438627e50a9d143 arch=linux-ubuntu20.04-x86_64\r\n        ^cmake@3.21.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-x86_64\r\n            ^ncurses@6.2%gcc@9.3.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-x86_64\r\n                ^pkgconf@1.8.0%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n            ^openssl@1.1.1l%gcc@9.3.0~docs certs=system arch=linux-ubuntu20.04-x86_64\r\n                ^perl@5.34.0%gcc@9.3.0+cpanm+shared+threads arch=linux-ubuntu20.04-x86_64\r\n                    ^berkeley-db@18.1.40%gcc@9.3.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu20.04-x86_64\r\n                    ^bzip2@1.0.8%gcc@9.3.0~debug~pic+shared arch=linux-ubuntu20.04-x86_64\r\n                        ^diffutils@3.8%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                            ^libiconv@1.16%gcc@9.3.0 libs=shared,static arch=linux-ubuntu20.04-x86_64\r\n                    ^gdbm@1.19%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                        ^readline@8.1%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                    ^zlib@1.2.11%gcc@9.3.0+optimize+pic+shared arch=linux-ubuntu20.04-x86_64\r\n        ^hsakmt-roct@4.3.1%gcc@9.3.0~ipo+shared build_type=Release arch=linux-ubuntu20.04-x86_64\r\n        ^numactl@2.0.14%gcc@9.3.0 patches=4e1d78cbbb85de625bad28705e748856033eaafab92a66dffd383a3d7e00cc94,62fc8a8bf7665a60e8f4c93ebbd535647cebf74198f7afafec4c085a8825c006,ff37630df599cfabf0740518b91ec8daaf18e8f288b19adaae5364dc1f6b2296 arch=linux-ubuntu20.04-x86_64\r\n            ^autoconf@2.69%gcc@9.3.0 patches=35c449281546376449766f92d49fc121ca50e330e60fefcfc9be2af3253082c2,7793209b33013dc0f81208718c68440c5aae80e7a1c4b8d336e382525af791a7,a49dd5bac3b62daa0ff688ab4d508d71dbd2f4f8d7e2a02321926346161bf3ee arch=linux-ubuntu20.04-x86_64\r\n                ^m4@1.4.19%gcc@9.3.0+sigsegv patches=9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573,bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89 arch=linux-ubuntu20.04-x86_64\r\n                    ^libsigsegv@2.13%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n            ^automake@1.16.3%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n            ^libtool@2.4.6%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n        ^rocminfo@4.3.1%gcc@9.3.0~ipo build_type=Release arch=linux-ubuntu20.04-x86_64\r\n        ^roctracer-dev-api@4.3.1%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n```\r\n\r\n```\r\n$> spack install -f ./papi.spec.json\r\n...\r\n==> Installing papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm\r\n==> No binary for papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm found: installing from source\r\n==> Fetching https://mirror.spack.io/_source-cache/archive/3c/3cd7ed50c65b0d21d66e46d0ba34cd171178af4bbf9d94e693915c1aca1e287f.tar.gz\r\n==> No patches needed for papi\r\n==> papi: Executing phase: 'autoreconf'\r\n==> papi: Executing phase: 'configure'\r\n==> papi: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16' 'V=1'\r\n\r\n4 errors found in build log:\r\n     2280    /spack/lib/spack/env/gcc/gfortran -I../testlib -I. -I.. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecsls\r\n             yu/rocprofiler/include -g -Wextra  -Wall -ffixed-line-length-132 -O1 openmp.F ../testlib/libtestlib.a ../libpapi.a -o openmp -ldl -fopenmp\r\n     2281    /spack/lib/spack/env/gcc/gcc -I../testlib -I.. -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/ro\r\n             cprofiler/include -g -Wextra  -Wall -O2  -c cache_testcode.c\r\n     2282    openmp.F:5:9:\r\n     2283\r\n     2284        5 |       use omp_lib\r\n     2285          |         1\r\n  >> 2286    Fatal Error: File 'omp_lib.mod' opened at (1) is not a GNU Fortran module file\r\n     2287    compilation terminated.\r\n  >> 2288    make[2]: *** [Makefile.recipies:44: openmp] Error 1\r\n     2289    make[2]: *** Waiting for unfinished jobs....\r\n     2290    /spack/lib/spack/env/gcc/gcc -I../testlib -I.. -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/ro\r\n             cprofiler/include -g -Wextra  -Wall -O2  -c matrix_multiply.c\r\n     2291    /spack/lib/spack/env/gcc/gcc -o papi_mem_info papi_mem_info.o ../libpapi.a -ldl\r\n     2292    /spack/lib/spack/env/gcc/gcc -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../..\r\n             /testlib -I../../../validation_tests -o broken_events broken_events.o event_name_lib.o ../../../testlib/libtestlib.a ../../../libpapi.a -ldl\r\n     2293    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -O2  -I../testlib -I.. -I. -c papi_l1_dcm.c\r\n     2294    /spack/lib/spack/env/gcc/gcc -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../..\r\n             /testlib -I../../../validation_tests -o nmi_watchdog nmi_watchdog.o ../../../testlib/libtestlib.a ../../../libpapi.a -ldl\r\n\r\n     ...\r\n\r\n     2315    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -O2  -I../testlib -I.. -I. -c papi_tot_ins.c\r\n     2316    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src/components/perf_event/tests'\r\n     2317    + make -C components/perf_event_uncore/tests\r\n     2318    make[2]: Entering directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src/components/perf_event_uncore/tests'\r\n     2319    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -O2 -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../../testlib -I\r\n             ../../../validation_tests -c -o perf_event_uncore.o perf_event_uncore.c\r\n     2320    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src/ftests'\r\n  >> 2321    make[1]: *** [Makefile.inc:247: ftests] Error 2\r\n     2322    make[1]: *** Waiting for unfinished jobs....\r\n     2323    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../../testlib -I../.\r\n             ./../validation_tests -c perf_event_uncore_lib.c\r\n     2324    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -O2 -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../../testlib -I\r\n             ../../../validation_tests -c -o perf_event_uncore_attach.o perf_event_uncore_attach.c\r\n     2325    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -O2 -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../../testlib -I\r\n             ../../../validation_tests -c -o perf_event_uncore_multiple.o perf_event_uncore_multiple.c\r\n     2326    /spack/lib/spack/env/gcc/gcc -o papi_multiplex_cost papi_multiplex_cost.o cost_utils.o ../libpapi.a -lm -ldl\r\n     2327    /spack/lib/spack/env/gcc/gcc -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/rocprofiler-dev-4.3.1-i2mkcw6mpfieb34p2gcvp5lbkecslsyu/rocprofiler/include -g -\r\n             Wextra  -Wall -O2 -I. -I/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/include -I../../.. -I../../../testlib -I\r\n             ../../../validation_tests -c -o perf_event_amd_northbridge.o perf_event_amd_northbridge.c\r\n\r\n     ...\r\n\r\n     2370    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src/components/example/tests'\r\n     2371    + make -C components/rocm/tests\r\n     2372    make[2]: Entering directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src/components/rocm/tests'\r\n     2373    make[2]: Nothing to be done for 'tests'.\r\n     2374    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src/components/rocm/tests'\r\n     2375    make[1]: Leaving directory '/tmp/root/spack-stage/spack-stage-papi-6.0.0.1-ci6piaob6vkrhwfp4p2zngfovnfpfldm/spack-src/src'\r\n  >> 2376    make: *** [Rules.pfm4_pe:43: libpfm4/lib/libpfm.a] Error 2\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.0-472-6be1c9b9d3\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-broadwell\r\n* **Concretizer:** clingo\r\n\r\n### Additional information\r\n\r\n[spack-build-02-configure-out.txt](https://github.com/spack/spack/files/7688569/spack-build-02-configure-out.txt)\r\n[spack-build-env.txt](https://github.com/spack/spack/files/7688570/spack-build-env.txt)\r\n[spack-build-out.txt](https://github.com/spack/spack/files/7688571/spack-build-out.txt)\r\n\r\n@G-Ragghianti\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\r\n- [X] I have uploaded the build log and environment files\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/27898",
    "updated_at": "2021-12-09 21:34:38",
    "created_at": "2021-12-09 21:30:58",
    "closed_at": "None",
    "state": "open",
    "title": "papi +rocm build fails: 'omp_lib.mod' is not a GNU Fortran module file",
    "number": 27898,
    "milestone": null,
    "labels": [
        "build-error",
        "e4s",
        "ROCm/hip"
    ],
    "id": 1076049896,
    "html_url": "https://github.com/spack/spack/issues/27898",
    "assignees": [],
    "comments": 0
}