{
    "body": "Spack gets confused about the location of global install of package with locally generated hash despite being given the location and modulefile. \r\n\r\n\r\n### Steps to reproduce the issue\r\n\r\n```\r\n$ spack install ... ^intel@2018.3.222\r\n```\r\n\r\n### Error Message\r\n\r\n```\r\n[sajid@apsxrmd-0001 jobs]$ spack install --keep-stage -v -j 10 petsc@develop+hypre+mpi+knl %intel@18.0.3 ^intel-mkl@2018.3.222 ^intel-mpi@2018.3.222 ^/573\r\n==> intel-mpi@2018.3.222 : externally installed in /blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mpi-2018.3.222-4aoglyb6zfpaydn6iuiz63wyj3soolv2\r\n==> intel-mpi@2018.3.222 : already registered in DB\r\n...\r\n==> intel-mkl@2018.3.222 : externally installed in /blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4\r\n==> intel-mkl@2018.3.222 : already registered in DB\r\n==> Installing hypre\r\n==> Searching for binary cache of hypre\r\n==> Warning: No Spack mirrors are currently configured\r\n==> No binary for hypre found: installing from source\r\n==> Error: InstallError: Cannot locate core MKL libraries:\r\n        ['libmkl_intel_lp64', 'libmkl_sequential', 'libmkl_core']\r\n\r\n/blues/gpfs/home/sajid/packages/spack/lib/spack/spack/build_systems/intel.py:761, in blas_libs:\r\n        758            shared=('+shared' in self.spec))\r\n        759        debug_print(mkl_libs)\r\n        760\r\n  >>    761        if len(mkl_libs) < 3:\r\n        762            raise_lib_error('Cannot locate core MKL libraries:', mkl_libnames)\r\n        763\r\n        764        # The Intel MKL link line advisor recommends these system libraries\r\n```\r\nthat activate the full debug output. \r\n\r\n\r\n### Information on your system\r\n\r\nThis includes:\r\n\r\n 1. linux-centos7-x86_64\r\n 2. custom `packages.yaml`:\r\n```\r\n[sajid@apsxrmd-0001 ~]$ cat .spack/packages.yaml \r\npackages:\r\n  all:\r\n    # Set Intel as default compiler\r\n    compiler: [intel, gcc, pgi, nag]\r\n    providers:\r\n      # Set Intel MKL as default BLAS/LAPACK provider\r\n      blas:   [intel-mkl,openblas]\r\n      lapack: [intel-mkl,openblas]\r\n      # Set Intel MPI as default MPI implementation\r\n      mpi: [intel-mpi, mvapich2, mpich, openmpi]\r\n    variants: ~mpi+openmp\r\n  # External Packages\r\n  # Many of these are build dependencies, so it doesn't really matter\r\n  # if we build with the latest version. Just use the system installation.\r\n  autoconf:\r\n    paths:\r\n      autoconf@2.69 arch=linux-centos7-x86_64: /usr\r\n#      autoconf@2.63 arch=linux-centos6-x86_64: /usr\r\n    buildable: False\r\n  automake:\r\n    paths:\r\n      automake@1.13.4 arch=linux-centos7-x86_64: /usr\r\n      automake@1.11.1 arch=linux-centos6-x86_64: /usr\r\n    buildable: False\r\n  bison:\r\n    paths:\r\n      bison@2.7   arch=linux-centos7-x86_64: /usr\r\n      bison@2.4.1 arch=linux-centos6-x86_64: /usr\r\n    buildable: False\r\n#  cmake:\r\n#    paths:\r\n#      cmake@2.8.12.2 arch=linux-centos6-x86_64: /usr\r\n#  flex:\r\n#    paths:\r\n#      flex@2.5.37 arch=linux-centos7-x86_64: /usr\r\n#      flex@2.5.35 arch=linux-centos6-x86_64: /usr\r\n#    buildable: False\r\n  libtool:\r\n    paths:\r\n      libtool@2.4.2 arch=linux-centos7-x86_64: /usr\r\n      libtool@2.2.6b arch=linux-centos6-x86_64: /usr\r\n    buildable: False\r\n  m4:\r\n    paths:\r\n      m4@1.4.16 arch=linux-centos7-x86_64: /usr\r\n      m4@1.4.13 arch=linux-centos6-x86_64: /usr\r\n    buildable: False\r\n  openssl:\r\n    # Instead of rebuilding everything when a security update comes out,\r\n    # always build with the system openssl. It is more likely to be\r\n    # updated if the bug is serious enough\r\n    paths:\r\n      openssl@1.0.1e arch=linux-centos7-x86_64: /usr\r\n      openssl@1.0.1e arch=linux-centos6-x86_64: /usr\r\n    buildable: False\r\n#  numactl:\r\n#    paths:\r\n#      numactl@2.0.9 arch=linux-centos6-x86_64: /usr\r\n#    buildable: False\r\n  #perl:\r\n  #  # Perl cannot be built with the Intel compilers\r\n  #  paths:\r\n  #    perl@5.16.3 arch=linux-centos7-x86_64: /usr\r\n  #    perl@5.10.1 arch=linux-centos6-x86_64: /usr\r\n  #  buildable: False\r\n#  #  pkg-config:\r\n#    paths:\r\n#    pkg-config@0.27.1 arch=linux-centos7-x86_64: /usr\r\n#    pkg-config@0.23   arch=linux-centos6-x86_64: /usr\r\n#    buildable: False\r\n  # Build all compilers with the system compiler\r\n#  gcc:\r\n#    compiler: [gcc@4.8.5]\r\n#    variants: ~binutils\r\n#  intel:\r\n#    compiler: [gcc@4.8.5]\r\n#  intel-parallel-studio:\r\n#    compiler: [gcc@4.8.5]\r\n#    variants: +all\r\n#  nag:\r\n#    compiler: [gcc@4.8.5]\r\n#  pgi:\r\n#    compiler: [gcc@4.8.5]\r\n  # Set default variants\r\n  cantera:\r\n    variants: +python\r\n  gromacs:\r\n    variants: +plumed\r\n  hdf:\r\n    variants: +szip\r\n  hdf5:\r\n    variants: +szip~mpi\r\n  mvapich2:\r\n    variants: ch3_rank_bits=32 fabrics=psm process_managers=slurm threads=multiple\r\n  netcdf:\r\n    variants: +hdf4+dap+cdmremote~mpi\r\n  openmpi:\r\n    variants: fabrics=psm2 schedulers=slurm +thread_multiple\r\n  intel-mkl:\r\n    modules:\r\n       intel-mkl@2018.3.222%intel@18.0.3 +shared~ilp64 arch=linux-centos7-x86_64: /blues/gpfs/home/software/spack-0.10.1/share/spack/lmod/linux-centos7-x86_64/intel/18.0.3/intel-mkl/2018.3.222-6ff5hhp.lua\r\n    paths:\r\n       intel-mkl@2018.3.222%intel@18.0.3 +shared~ilp64 arch=linux-centos7-x86_64: /blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4 \r\n    buildable: False\r\n  intel-mpi:\r\n    modules:\r\n        intel-mpi@2018.3.222%intel@18.0.3 arch=linux-centos7-x86_64: /blues/gpfs/home/software/spack-0.10.1/share/spack/lmod/linux-centos7-x86_64/intel/18.0.3/intel-mpi/2018.3.222-4aoglyb.lua\r\n    paths:\r\n       intel-mpi@2018.3.222%intel@18.0.3 arch=linux-centos7-x86_64: /blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mpi-2018.3.222-4aoglyb6zfpaydn6iuiz63wyj3soolv2 \r\n    buildable: False\r\n\r\n```\r\n\r\nDoes spack know of the existance of intel-mkl@2018.3.222 ? Yes.\r\n```\r\n[sajid@apsxrmd-0001 jobs]$ spack find -lv intel-mkl\r\n==> 2 installed packages\r\n-- linux-centos7-x86_64 / intel@17.0.4 --------------------------\r\nvrmvwju intel-mkl@2017.3.196~ilp64+shared threads=none\r\n\r\n-- linux-centos7-x86_64 / intel@18.0.3 --------------------------\r\nqn7bzkv intel-mkl@2018.3.222~ilp64+shared threads=none\r\n``` \r\n\r\nDoes spack know where to find it ? No!\r\n```\r\n[sajid@apsxrmd-0001 jobs]$ spack location intel-mkl@2018.3.222\r\n==> Error: [Errno 2] No such file or directory: '/blues/gpfs/home/sajid/packages/spack/var/spack/stage/intel-mkl-2018.3.222-qn7bzkvvpmexkr2kwgxikhv3pcebhglg'\r\n```\r\n\r\nExtra info (module generated by local instance of spack):\r\n```\r\n[sajid@apsxrmd-0001 linux-centos7-x86_64]$ pwd\r\n/home/sajid/packages/spack/share/spack/modules/linux-centos7-x86_64\r\n[sajid@apsxrmd-0001 linux-centos7-x86_64]$ cat intel-mkl-2018.3.222-intel-18.0.3-qn7bzkv \r\n#%Module1.0\r\n## Module file created by spack (https://github.com/spack/spack) on 2019-02-26 00:46:36.450210\r\n##\r\n## intel-mkl@2018.3.222%intel@18.0.3~ilp64+shared threads=none arch=linux-centos7-x86_64 /qn7bzkv\r\n##\r\n## Configure options: unknown, software installed outside of Spack\r\n##\r\n\r\n\r\nmodule-whatis \"Intel Math Kernel Library.\"\r\n\r\nproc ModulesHelp { } {\r\nputs stderr \"Intel Math Kernel Library.\"\r\n}\r\n\r\n\r\nprepend-path PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/bin\"\r\nprepend-path LD_LIBRARY_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/lib\"\r\nprepend-path LIBRARY_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/lib\"\r\nprepend-path CMAKE_PREFIX_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/\"\r\nprepend-path CPATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/include:/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/include:/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/gcc-4.8.5/intel-18.0.3-d6gtsxst5w4bw3ko7qvtaweu23hv5y6b/compilers_and_libraries_2018.3.222/linux/pstl/include:/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/gcc-4.8.5/intel-18.0.3-d6gtsxst5w4bw3ko7qvtaweu23hv5y6b/compilers_and_libraries_2018.3.222/linux/tbb/include:/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/gcc-4.8.5/intel-18.0.3-d6gtsxst5w4bw3ko7qvtaweu23hv5y6b/include\"\r\nprepend-path LD_LIBRARY_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/lib/intel64_lin\"\r\nprepend-path LD_LIBRARY_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64_lin\"\r\nprepend-path LIBRARY_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/lib/intel64_lin\"\r\nprepend-path LIBRARY_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64_lin\"\r\nprepend-path NLSPATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/lib/intel64_lin/locale/%l_%t/%N:/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/lib/intel64_lin/locale/%l_%t/%N:/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/gcc-4.8.5/intel-18.0.3-d6gtsxst5w4bw3ko7qvtaweu23hv5y6b/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64/locale/%l_%t/%N\"\r\nappend-path PKG_CONFIG_PATH \"/blues/gpfs/home/software/spack-0.10.1/opt/spack/linux-centos7-x86_64/intel-18.0.3/intel-mkl-2018.3.222-6ff5hhpjd6k3y4uvcg4mrthoqj3e3ok4/compilers_and_libraries_2018.3.222/linux/mkl/bin/pkgconfig\"\r\n```\r\n\r\nPS : This worked in Feb, did something change ?\r\n\r\n",
    "user": "s-sajid-ali",
    "url": "https://api.github.com/repos/spack/spack/issues/11086",
    "updated_at": "2019-07-20 00:49:55",
    "created_at": "2019-04-02 18:57:52",
    "closed_at": "None",
    "state": "open",
    "title": "spack confused about location of global package with local hash",
    "number": 11086,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 428389246,
    "html_url": "https://github.com/spack/spack/issues/11086",
    "assignees": [
        "scheibelp"
    ],
    "comments": 2
}