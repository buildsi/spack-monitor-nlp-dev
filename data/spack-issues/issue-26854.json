{
    "body": "### Steps to reproduce\n\nStart with a failed job from a `develop` pipeline in gitlab CI, for example [this](https://gitlab.spack.io/spack/spack/-/jobs/1146018) one.  Following the instructions in the job trace results in:\r\n\r\n```\r\n$ spack ci reproduce-build https://gitlab.spack.io/api/v4/projects/2/jobs/1146018/artifacts --working-dir /tmp/phist_repro\r\n==> Fetching artifacts from: https://gitlab.spack.io/api/v4/projects/2/jobs/1146018/artifacts\r\n\r\n==> Job ran with the following image: ghcr.io/scottwittenburg/ecpe4s-ubuntu18.04-runner-x86_64:2021-05-15\r\ncheckout_commit: 5dc8094f8468a33404de018243a60ae2202d6a0f\r\nmerge_commit: None\r\n==> Job ran with the following tags: ['spack', 'public', 'large', 'x86_64']\r\n\r\nRun the following command:\r\n\r\n    $ docker run --rm -v /tmp/phist_repro:/builds/spack/spack -ti ghcr.io/scottwittenburg/ecpe4s-ubuntu18.04-runner-x86_64:2021-05-15\r\n\r\nOnce inside the container:\r\n\r\n    - Activate the environment\r\n\r\n        $ source /builds/spack/spack/spack/share/spack/setup-env.sh\r\n        $ spack env activate --without-view /builds/spack/spack/jobs_scratch_dir/reproduction\r\n\r\n    - Run the install script\r\n\r\n        $ /builds/spack/spack/jobs_scratch_dir/reproduction/install.sh\r\n\r\n$ docker run --rm -v /tmp/phist_repro:/builds/spack/spack -ti ghcr.io/scottwittenburg/ecpe4s-ubuntu18.04-runner-x86_64:2021-05-15\r\nroot@447cc02c5908:/# source /builds/spack/spack/spack/share/spack/setup-env.sh\r\nroot@447cc02c5908:/# spack env activate --without-view /builds/spack/spack/jobs_scratch_dir/reproduction\r\nroot@447cc02c5908:/# /builds/spack/spack/jobs_scratch_dir/reproduction/install.sh\r\n...\r\n==> [2021-10-20-16:25:51.361793] Error: RuntimeError: Unable to locate python command in /home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spa/linux-ubuntu18.04-x86_64/gcc-7.5.0/python-3.8.10-ihtrj5dmjbjmlc2satbke4h4kagkrnq3/bin\r\n\r\n/builds/spack/spack/spack/var/spack/repos/builtin/packages/python/package.py:668, in command:\r\n        665                return Executable(path)\r\n        666        else:\r\n        667            msg = 'Unable to locate {0} command in {1}'\r\n  >>    668            raise RuntimeError(msg.format(self.name, self.prefix.bin))\r\n\r\n\r\nTraceback (most recent call last):\r\n  File \"/builds/spack/spack/spack/lib/spack/spack/build_environment.py\", line 1027, in _setup_pkg_and_run\r\n    pkg, dirty=kwargs.get('dirty', False), context=context)\r\n  File \"/builds/spack/spack/spack/lib/spack/spack/build_environment.py\", line 781, in setup_package\r\n    pkg.spec, context, custom_mods_only=False))\r\n  File \"/builds/spack/spack/spack/lib/spack/spack/build_environment.py\", line 979, in modifications_from_dependencies\r\n    add_modifications_for_dep(dspec)\r\n  File \"/builds/spack/spack/spack/lib/spack/spack/build_environment.py\", line 960, in add_modifications_for_dep\r\n    dpkg.setup_dependent_package(spec.package.module, spec)\r\n  File \"/builds/spack/spack/spack/var/spack/repos/builtin/packages/python/package.py\", line 1004, in setup_dependent_package\r\n    module.setup_py = Executable(\r\n  File \"/builds/spack/spack/spack/var/spack/repos/builtin/packages/python/package.py\", line 669, in command\r\nRuntimeError: Unable to locate python command in /home/software/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spa/linux-ubuntu18.04-x86_64/gcc-7.5.0/python-3.8.10-ihtrj5dmjbjmlc2satbke4h4kagkrnq3/bin\r\n```\r\n\r\nThe full output from running the `install.sh` script of the reproducer is attached.\r\n\r\nI think the problem is that because the job was part of a `develop` pipeline, the install command in the script is generated without the `--no-check-signature` option, as the only source of binary dependencies in `develop` pipelines is the main `s3://spack-binaries-develop` mirror, where all the pkgs are signed with a signing key.  The reproducer runs that script, but has not trusted the public part of that signing key, so none of the dependency binaries can be verified, resulting in lots of output like:\r\n\r\n```\r\n==> [2021-10-20-16:23:46.112566] Fetching s3://spack-binaries-develop/e4s/build_cache/linux-ubuntu18.04-x86_64/gcc-7.5.0/gdbm-1.19/linux-ubuntu18.04-x86_64-gcc-7.5.0-gdbm-1.19-oftaepjelizkam37ezxwkuw27clnosqn.spack\r\n==> [2021-10-20-16:23:48.364521] Extracting gdbm-1.19-oftaepjelizkam37ezxwkuw27clnosqn from binary cache\r\n==> [2021-10-20-16:23:48.370993] '/usr/bin/gpg2' '--verify' '/tmp/tmpwkmcfdcx/linux-ubuntu18.04-x86_64-gcc-7.5.0-gdbm-1.19-oftaepjelizkam37ezxwkuw27clnosqn.spec.json.asc' '/tmp/tmpwkmcfdcx/linux-ubuntu18.04-x86_64-gcc-7.5.0-gdbm-1.19-oftaepjelizkam37ezxwkuw27clnosqn.spec.json'\r\ngpg: Signature made Thu 23 Sep 2021 12:07:20 AM UTC\r\ngpg:                using RSA key C1B1A375B724E210B58F30620C35BFA2EADD3E30\r\ngpg: Can't check signature: No public key\r\n```\r\n\r\nIt's not clear to me why these don't result in failure immediately (all the dependencies seem to get flagged as installed in spite of the errors), but after the reproducer fails, the install tree within the container is empty (no deps were installed), which explains why (in this case) the python command cannot be located.\r\n\r\nThere is another piece of evidence that the problem is failing to verify binaries.  If we start the whole reproducer process over, and simply insert the `--no-check-signaure` cli option into the install command in the `install.sh` script before running it, the reproducer works as expected (that is, the package fails to build in the same way it failed in the gitlab pipeline).\r\n\r\n[spack_ci_reproducer_develop_fail.txt](https://github.com/spack/spack/files/7382890/spack_ci_reproducer_develop_fail.txt)\r\n\n\n### Error message\n\nError messages are included above.\n\n### Information on your system\n\nIn this case, I tried the reproducer on my macbook:\r\n\r\n```\r\n$ spack debug report\r\n* **Spack:** 0.16.3-4943-1983d6d9d0\r\n* **Python:** 3.7.9\r\n* **Platform:** darwin-catalina-skylake\r\n* **Concretizer:** clingo\r\n```\r\n\r\nBut the reproducer should be runnable anywhere spack and docker are installed/available.\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "scottwittenburg",
    "url": "https://api.github.com/repos/spack/spack/issues/26854",
    "updated_at": "2021-10-20 16:38:15",
    "created_at": "2021-10-20 16:38:15",
    "closed_at": "None",
    "state": "open",
    "title": "`spack ci reproduce-build` fails on jobs from `develop` pipelines",
    "number": 26854,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1031615094,
    "html_url": "https://github.com/spack/spack/issues/26854",
    "assignees": [],
    "comments": 0
}