{
    "body": "### Steps to reproduce\n\nInstall external rocm stack version x.y.z and u.v.w. Configure them in `/etc/spack/packages.yaml`\r\n\r\nFor me, u.v.w is 5.0.0 and x.y.z is 4.3.1, but this is an issue in general.\r\n\r\n```yaml\r\npackages:\r\n  hip:\r\n    buildable: false\r\n    version: [u.v.w, x.y.z]\r\n    externals:\r\n      - spec: hip@u.v.w\r\n        prefix: /path/to/hip/u.v.w\r\n      - spec: hip@x.y.z\r\n        prefix: /path/to/hip/x.y.z\r\n  # additional externals for llvm-amdgpu, hsa-rocr-dev, rocm-cmake, etc.\r\n```\r\n\r\n```console\r\n$ spack spec vtk-m@1.7.1+rocm ^hip@x.y.z\r\n```\n\n### Error message\n\n```console\r\n==> [2022-03-02-17:42:28.796966] Imported spec from built-in commands\r\n==> [2022-03-02-17:42:28.797789] Imported spec from built-in commands\r\n==> [2022-03-02-17:42:28.798937] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/config.yaml\r\n==> [2022-03-02-17:42:28.814173] Reading config file /etc/spack/config.yaml\r\n==> [2022-03-02-17:42:28.814926] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2022-03-02-17:42:28.840365] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/config.yaml\r\n==> [2022-03-02-17:42:28.854365] Reading config file /etc/spack/config.yaml\r\n==> [2022-03-02-17:42:28.855054] DATABASE LOCK TIMEOUT: 3s\r\n==> [2022-03-02-17:42:28.855080] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2022-03-02-17:42:28.855330] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2022-03-02-17:42:28.860829] DATABASE LOCK TIMEOUT: 3s\r\n==> [2022-03-02-17:42:28.860855] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2022-03-02-17:42:28.860890] [BOOTSTRAP CONFIG SCOPE] name=_builtin\r\n==> [2022-03-02-17:42:28.861111] [BOOTSTRAP CONFIG SCOPE] name=defaults, path=/home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults\r\n==> [2022-03-02-17:42:28.861132] [BOOTSTRAP CONFIG SCOPE] name=defaults/linux, path=/home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/linux\r\n==> [2022-03-02-17:42:28.861149] [BOOTSTRAP CONFIG SCOPE] name=bootstrap, path=/home/local/KHQ/ryan.krattiger/.spack/bootstrap/config\r\n==> [2022-03-02-17:42:28.861162] [BOOTSTRAP CONFIG SCOPE] name=bootstrap/linux, path=/home/local/KHQ/ryan.krattiger/.spack/bootstrap/config/linux\r\n==> [2022-03-02-17:42:28.861366] Reading config file /home/local/KHQ/ryan.krattiger/.spack/bootstrap/config/linux/compilers.yaml\r\n==> [2022-03-02-17:42:28.877513] [BOOTSTRAP ROOT SPEC] clingo-bootstrap@spack+python %gcc target=x86_64\r\n==> [2022-03-02-17:42:28.877543] [BOOTSTRAP MODULE clingo] Try importing from Python\r\n==> [2022-03-02-17:42:28.877676] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2022-03-02-17:42:28.980042] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/config.yaml\r\n==> [2022-03-02-17:42:29.025308] [BOOTSTRAP MODULE clingo] The installed spec \"clingo-bootstrap@spack+python %gcc target=x86_64 ^python@3.8 /kt74l7kjzrlp3cgtj2576o33mhsrgyrw\" provides the \"clingo\" Python module\r\n==> [2022-03-02-17:42:29.025534] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/concretizer.yaml\r\n==> [2022-03-02-17:42:29.027116] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/repos.yaml\r\n==> [2022-03-02-17:42:30.189950] Reading config file /etc/spack/compilers.yaml\r\n==> [2022-03-02-17:42:30.217469] Reading config file /home/local/KHQ/ryan.krattiger/.spack/compilers.yaml\r\n==> [2022-03-02-17:42:30.220488] Reading config file /home/local/KHQ/ryan.krattiger/.spack/linux/compilers.yaml\r\n==> [2022-03-02-17:42:30.226486] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/config.yaml\r\n==> [2022-03-02-17:42:30.240254] Reading config file /etc/spack/config.yaml\r\n==> [2022-03-02-17:42:30.241026] Reading config file /home/local/KHQ/ryan.krattiger/repos/spack/etc/spack/defaults/packages.yaml\r\n==> [2022-03-02-17:42:30.262316] Reading config file /etc/spack/packages.yaml\r\n==> [2022-03-02-17:42:30.462621] Reading config file /home/local/KHQ/ryan.krattiger/.spack/packages.yaml\r\n==> [2022-03-02-17:42:38.117210] build(hip)\r\n==> [2022-03-02-17:42:38.117296] build(vtk-m)\r\n==> [2022-03-02-17:42:38.117313] build(cmake)\r\n==> [2022-03-02-17:42:38.117326] build(rocm-cmake)\r\n==> [2022-03-02-17:42:38.117338] build(llvm-amdgpu)\r\n==> [2022-03-02-17:42:38.117351] build(hsa-rocr-dev)\r\n==> [2022-03-02-17:42:38.117363] build(kokkos)\r\n==> [2022-03-02-17:42:38.117374] build(perl)\r\n==> [2022-03-02-17:42:38.117390] build(ncurses)\r\n==> [2022-03-02-17:42:38.117401] build(zlib)\r\n==> [2022-03-02-17:42:38.117412] build(bzip2)\r\n==> [2022-03-02-17:42:38.117424] build(openssl)\r\n==> [2022-03-02-17:42:38.117435] build(pkgconf)\r\n==> [2022-03-02-17:42:38.117446] build(diffutils)\r\n==> [2022-03-02-17:42:38.117457] build(berkeley-db)\r\n==> [2022-03-02-17:42:38.117468] build(gdbm)\r\n==> [2022-03-02-17:42:38.117481] build(libiconv)\r\n==> [2022-03-02-17:42:38.117492] build(readline)\r\n==> [2022-03-02-17:42:38.122166] Ordered hashes [berkeley-db]: berkeley-db/84/b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522\r\n==> [2022-03-02-17:42:38.122303] Ordered hashes [hip]: hip/19/2a4190477b7d9206b9cd8d70770ba0bc007273cbe54772efb12f9ca2e37c0392, hip/24/e276c4acf3d37712b6bea306fea34f539d3c4f743471e9da208b5eb17b16ae67, hip/32/99190b4616edb362d48f9b265c3018a3c6339481b0729d9fe46185fca25bc54b\r\n==> [2022-03-02-17:42:38.122368] Ordered hashes [hsa-rocr-dev]: hsa-rocr-dev/495/71e6851d9be8113bfb8d71b66a3171e0d0401bae5e6f161c9e7fe32558261a46\r\n==> [2022-03-02-17:42:38.122440] Ordered hashes [llvm-amdgpu]: llvm-amdgpu/35/d999f3b235e655ee07f6dd2590302082feaa06d32c5c6b53aae9c5cf1e45b644\r\nInput spec\r\n--------------------------------\r\nvtk-m@1.7.1+rocm amdgpu_target=gfx900\r\n    ^hip@4.3.1\r\n\r\nConcretized\r\n--------------------------------\r\nvtk-m@1.7.1%gcc@9.3.0~64bitids+ascent_types~cuda+doubleprecision~ipo+kokkos~logging~mpi+openmp+rendering+rocm~shared~tbb~testlib~virtuals amdgpu_target=gfx900 build_type=Release arch=linux-ubuntu20.04-zen2\r\n    ^cmake@3.22.2%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-zen2\r\n        ^ncurses@6.2%gcc@9.3.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-zen2\r\n            ^pkgconf@1.8.0%gcc@9.3.0 arch=linux-ubuntu20.04-zen2\r\n        ^openssl@1.1.1m%gcc@9.3.0~docs certs=system arch=linux-ubuntu20.04-zen2\r\n            ^perl@5.34.0%gcc@9.3.0+cpanm+shared+threads arch=linux-ubuntu20.04-zen2\r\n                ^berkeley-db@18.1.40%gcc@9.3.0+cxx~docs+stl patches=b231fcc arch=linux-ubuntu20.04-zen2\r\n                ^bzip2@1.0.8%gcc@9.3.0~debug~pic+shared arch=linux-ubuntu20.04-zen2\r\n                    ^diffutils@3.8%gcc@9.3.0 arch=linux-ubuntu20.04-zen2\r\n                        ^libiconv@1.16%gcc@9.3.0 libs=shared,static arch=linux-ubuntu20.04-zen2\r\n                ^gdbm@1.19%gcc@9.3.0 arch=linux-ubuntu20.04-zen2\r\n                    ^readline@8.1%gcc@9.3.0 arch=linux-ubuntu20.04-zen2\r\n                ^zlib@1.2.11%gcc@9.3.0+optimize+pic+shared arch=linux-ubuntu20.04-zen2\r\n    ^hip@4.3.1%gcc@9.3.0~ipo build_type=Release patches=2a41904,99190b4,e276c4a arch=linux-ubuntu20.04-zen2\r\n    ^hsa-rocr-dev@5.0.0%gcc@9.3.0+image~ipo+shared build_type=Release patches=71e6851 arch=linux-ubuntu20.04-zen2\r\n    ^kokkos@3.5.00%gcc@9.3.0~aggressive_vectorization~compiler_warnings~cuda~cuda_constexpr~cuda_lambda~cuda_ldg_intrinsic~cuda_relocatable_device_code~cuda_uvm~debug~debug_bounds_check~debug_dualview_modify_check~deprecated_code~examples~explicit_instantiation~hpx~hpx_async_dispatch~hwloc~ipo~memkind~numactl~openmp~pic+profiling~profiling_load_print~pthread~qthread+rocm+serial+shared~sycl~tests~tuning~wrapper amdgpu_target=gfx900 build_type=RelWithDebInfo std=14 arch=linux-ubuntu20.04-zen2\r\n        ^llvm-amdgpu@5.0.0%gcc@9.3.0~ipo~link_llvm_dylib~llvm_dylib+openmp+rocm-device-libs build_type=Release patches=d999f3b arch=linux-ubuntu20.04-zen2\r\n    ^rocm-cmake@5.0.0%gcc@9.3.0~ipo+ldconfig build_type=Release arch=linux-ubuntu20.04-zen2\r\n```\r\n\r\nNote: hip is 4.3.1, but the other ROCm stack dependencies are 5.0.0.\r\n\r\nThese are not just build deps, the are also link and run deps, so having incompatible versions is not allowed. In all of the rocm packages, they explicitly depend on the same version.\n\n### Information on your system\n\n* **Spack:** 0.17.1-1276-a14a521727\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-zen2\r\n* **Concretizer:** clingo\r\n\r\n\r\n@chuckatkins @kwryankrattiger\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "kwryankrattiger",
    "url": "https://api.github.com/repos/spack/spack/issues/29298",
    "updated_at": "2022-03-03 10:40:50",
    "created_at": "2022-03-02 17:44:39",
    "closed_at": "None",
    "state": "open",
    "title": "Runtime dependency constraints are not respected for external packages",
    "number": 29298,
    "milestone": null,
    "labels": [
        "bug",
        "impact-medium",
        "ROCm/hip"
    ],
    "id": 1157507259,
    "html_url": "https://github.com/spack/spack/issues/29298",
    "assignees": [],
    "comments": 1
}