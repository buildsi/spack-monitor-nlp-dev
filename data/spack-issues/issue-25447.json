{
    "body": "### Steps to reproduce the issue\r\n\r\n1). Login to a node with the ppc64le architecture (IBM Power9):\r\n```console\r\n$ arch\r\nppc64le\r\n```\r\n\r\n2). Verify that the IBM XL compiler is present in your environment:\r\n```console\r\n$ module list\r\n\r\nCurrently Loaded Modulefiles:\r\n  1) git/2.17.1                                3) ibm/xlc-16.1.1.7-xlf-16.1.1.7-gcc-8.3.0\r\n  2) gcc/8.3.0\r\n```\r\n\r\n3). Clone the `spack` source and run the environment setup script:\r\n```console\r\n$ git clone git@github.com:spack/spack.git\r\n$ cd spack\r\n$ source ./share/spack/setup-env.sh\r\n```\r\n\r\n4). Verify that Spack knows about your IBM XL compiler:\r\n```console\r\n$ spack compiler list\r\n\r\n==> Available compilers\r\n-- gcc rhel7-ppc64le --------------------------------------------\r\ngcc@8.3.0  gcc@4.8.5\r\n\r\n-- xl rhel7-ppc64le ---------------------------------------------\r\nxl@16.1\r\n\r\n-- xl_r rhel7-ppc64le -------------------------------------------\r\nxl_r@16.1\r\n```\r\n\r\n5). Attempt to install `netlib-lapack 3.9.0` with the IBM XL compiler (NOTE:  Currently the dependencies `ncurses`, and `perl` cannot build under XL; build those with GCC instead):\r\n```console\r\n$ spack install -v netlib-lapack@3.9.0%xl_r@16.1 ^ncurses%gcc@8.3.0 ^perl%gcc@8.3.0\r\n```\r\n\r\nThe build attempt fails:\r\n```console\r\n==> Installing netlib-lapack-3.9.0-o7qrbi2suxqwgc2bv4vyy7crbavpx35d\r\n==> No binary for netlib-lapack-3.9.0-o7qrbi2suxqwgc2bv4vyy7crbavpx35d found: installing from source\r\n==> Fetching https://mirror.spack.io/_source-cache/archive/10/106087f1bb5f46afdfba7f569d0cbe23dacb9a07cd24733765a0e89dbe1ad573.tar.gz\r\n1 out of 1 hunk FAILED -- saving rejects to file CMakeLists.txt.rej\r\n1 out of 1 hunk FAILED -- saving rejects to file CBLAS/CMakeLists.txt.rej\r\n==> Patch /vast/home/quellyn/GIT/spack/var/spack/repos/builtin/packages/netlib-lapack/ibm-xl.patch failed.\r\n==> Error: ProcessError: Command exited with status 1:\r\n    '/usr/bin/patch' '-s' '-p' '1' '-i' '/vast/home/quellyn/GIT/spack/var/spack/repos/builtin/packages/netlib-lapack/ibm-xl.patch' '-d' '.'\r\n```\r\nLooking into this some more, it appears that *some* of the `ibm-xl.patch` was upstreamed in `netlib-lapack 3.9.0`.\r\n\r\nI then tried adjusting the Spack `package.py` file to limit the application of `ibm-xl.patch` to `netlib-lapack 3.8.x` or earlier:\r\n```console\r\n$ git diff package.py\r\n\r\n-    patch('ibm-xl.patch', when='@3.7: %xl')\r\n-    patch('ibm-xl.patch', when='@3.7: %xl_r')\r\n-    patch('ibm-xl.patch', when='@3.7: %cce@9:')\r\n+    patch('ibm-xl.patch', when='@3.7:3.8.9999 %xl')\r\n+    patch('ibm-xl.patch', when='@3.7:3.8.9999 %xl_r')\r\n+    patch('ibm-xl.patch', when='@3.7:3.8.9999 %cce@9:')\r\n```\r\n\r\nI also spun up a new patch that takes care of the piece of the old patch that was *not* upstreamed:\r\n```console\r\n$ cat ibm-xl-3.9.0.patch\r\n\r\ndiff -up ./CMakeLists.txt.orig ./CMakeLists.txt\r\n--- ./CMakeLists.txt.orig\t2021-08-16 13:53:27.287480698 -0600\r\n+++ ./CMakeLists.txt\t2021-08-16 13:53:24.917560749 -0600\r\n@@ -76,7 +76,7 @@ if(UNIX)\r\n     list(APPEND CMAKE_Fortran_FLAGS -fp-model strict)\r\n   endif()\r\n   if(CMAKE_Fortran_COMPILER_ID STREQUAL XL)\r\n-    list(APPEND CMAKE_Fortran_FLAGS -qnosave -qstrict=none)\r\n+    list(APPEND CMAKE_Fortran_FLAGS -qnosave -qstrict)\r\n   endif()\r\n # Delete libmtsk in linking sequence for Sun/Oracle Fortran Compiler.\r\n # This library is not present in the Sun package SolarisStudio12.3-linux-x86-bin\r\n```\r\n\r\nAnd added that to the `package.py`:\r\n```console\r\n+    patch('ibm-xl-3.9.0.patch', when='@3.9: %xl')\r\n+    patch('ibm-xl-3.9.0.patch', when='@3.9: %xl_r')\r\n```\r\n\r\nEven at that, `netlib-lapack` still failed to build:\r\n```console\r\n==> Installing netlib-lapack-3.9.0-5j5pgemssmtcifccy5nqokn5ehioy4fp\r\n==> No binary for netlib-lapack-3.9.0-5j5pgemssmtcifccy5nqokn5ehioy4fp found: installing from source\r\n==> Fetching https://mirror.spack.io/_source-cache/archive/10/106087f1bb5f46afdfba7f569d0cbe23dacb9a07cd24733765a0e89dbe1ad573.tar.gz\r\n==> Applied patch /vast/home/quellyn/GIT/spack/var/spack/repos/builtin/packages/netlib-lapack/ibm-xl-3.9.0.patch\r\n==> Ran patch() for netlib-lapack\r\n==> netlib-lapack: Executing phase: 'cmake'\r\n==> Error: TypeError: must be str, not NoneType\r\n\r\n/vast/home/quellyn/GIT/spack/var/spack/repos/builtin/packages/netlib-lapack/package.py:164, in cmake_args:\r\n        161\r\n        162        if self.spec.satisfies('%xl') or self.spec.satisfies('%xl_r'):\r\n        163            # use F77 compiler if IBM XL\r\n  >>    164            args.extend(['-DCMAKE_Fortran_COMPILER=' + self.compiler.f77,\r\n        165                         '-DCMAKE_Fortran_FLAGS=' +\r\n        166                         (' '.join(self.spec.compiler_flags['fflags'])) +\r\n        167                         \" -O3 -qnohot\"])\r\n\r\nSee build log for details:\r\n  /tmp/quellyn/spack-stage/spack-stage-netlib-lapack-3.9.0-5j5pgemssmtcifccy5nqokn5ehioy4fp/spack-build-out.txt\r\n```\r\n\r\nI have [reported this issue upstream](https://github.com/Reference-LAPACK/lapack/issues/606) as well.\r\n\r\n**NOTE** that `netlib-lapack 3.8.0` builds under XL without issue.  No version of `netlib-lapack > 3.8.0` succeeds, however.\r\n\r\nThere are no maintainers for the `netlib-lapck` Spack package listed. I will mention @KineticTheory , as he has an interest in the outcome of this issue as well.\r\n\r\n### Information on your system\r\n\r\n```console\r\n$ spack debug report\r\n\r\n* **Spack:** 0.16.2-3941-79c2d55830\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rhel7-power9le\r\n* **Concretizer:** original\r\n```\r\n\r\n### Additional information\r\n\r\n[spack-build-env.txt](https://github.com/spack/spack/files/6995164/spack-build-env.txt)\r\n[spack-build-out.txt](https://github.com/spack/spack/files/6995165/spack-build-out.txt)\r\n\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\r\n- [X] I have uploaded the build log and environment files\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "quellyn",
    "url": "https://api.github.com/repos/spack/spack/issues/25447",
    "updated_at": "2021-09-15 20:19:25",
    "created_at": "2021-08-16 20:17:31",
    "closed_at": "2021-09-15 20:19:25",
    "state": "closed",
    "title": "Installation issue: netlib-lapack",
    "number": 25447,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 972069630,
    "html_url": "https://github.com/spack/spack/issues/25447",
    "assignees": [],
    "comments": 0
}