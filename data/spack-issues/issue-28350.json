{
    "body": "Due to changes in #27485, which introduced setting custom environment modifications for spec executables that are bootstrapped, using GnuPG on macOS versions which are different from the one in which it was built in CI stopped working.\r\n\r\nThe cause of the issue is that, to set variables at the `package.py` module level we need a compiler entry compatible with the OS used to build GnuPG (in this case `Catalina`). When run e.g. on a more recent OS, like `Monterey` we have this error:\r\n```console\r\n% spack gpg list\r\n==> Bootstrapping gnupg from pre-built binaries\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/libgpg-error-1.42/darwin-catalina-x86_64-apple-clang-12.0.0-libgpg-error-1.42-hph66gvb7vlinpzwoytxq27ojb7gtl2j.spack\r\n==> Installing \"libgpg-error@1.42%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/libiconv-1.16/darwin-catalina-x86_64-apple-clang-12.0.0-libiconv-1.16-ckpif6rcf7mxdmceyv6sqvtnwfqi7fmc.spack\r\n==> Installing \"libiconv@1.16%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/npth-1.6/darwin-catalina-x86_64-apple-clang-12.0.0-npth-1.6-fjuoy73whriauk3bt6ma5fwet6iric7y.spack\r\n==> Installing \"npth@1.6%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/zlib-1.2.11/darwin-catalina-x86_64-apple-clang-12.0.0-zlib-1.2.11-qo6otxqnn6mxpw4zhqc4wdwqmgcfjdfe.spack\r\n==> Installing \"zlib@1.2.11%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\" +optimize+pic+shared arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/libassuan-2.5.5/darwin-catalina-x86_64-apple-clang-12.0.0-libassuan-2.5.5-2upi74qccouj4k6d7wultp2u5fntayi3.spack\r\n==> Installing \"libassuan@2.5.5%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/libgcrypt-1.9.3/darwin-catalina-x86_64-apple-clang-12.0.0-libgcrypt-1.9.3-xzhvvm44cfxwvgqgkpbeucpnl4dbj4p2.spack\r\n==> Installing \"libgcrypt@1.9.3%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/libksba-1.5.1/darwin-catalina-x86_64-apple-clang-12.0.0-libksba-1.5.1-aodyg5mzfule3vimuetmzulv5mzdx37g.spack\r\n==> Installing \"libksba@1.5.1%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/pinentry-1.1.1/darwin-catalina-x86_64-apple-clang-12.0.0-pinentry-1.1.1-ihqcvdm5okxuvnln463l7h4flbkhrp44.spack\r\n==> Installing \"pinentry@1.1.1%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  gui=tty arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Fetching https://mirror.spack.io/bootstrap/github-actions/v0.1/build_cache/darwin-catalina-x86_64/apple-clang-12.0.0/gnupg-2.3.1/darwin-catalina-x86_64-apple-clang-12.0.0-gnupg-2.3.1-47vilwybwuxved7jov7esiad3qlkv5rp.spack\r\n==> Installing \"gnupg@2.3.1%apple-clang@12.0.0 cflags=\"-mmacosx-version-min=10.13\"  arch=darwin-catalina-x86_64\" from a buildcache\r\n==> Error: cannot bootstrap any of the gpg2, gpg executables from spec \"gnupg@2.3: %apple-clang target=x86_64\"\r\n```\r\nThis PR fixes the issue by explicitly avoid setting variables at the `package.py` level during bootstrapping. With this modification the GnuPG executable built on `Catalina` works on any version of the OS > 10.13, including later versions:\r\n```\r\n% spack gpg list\r\n...\r\n/Users/culpo/PycharmProjects/spack/opt/spack/gpg/pubring.kbx\r\n------------------------------------------------------------\r\npub   rsa4096 2021-10-26 [SC]\r\n...\r\n% spack arch\r\ndarwin-monterey-cannonlake\r\n```",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/28350",
    "updated_at": "2022-01-12 16:19:11",
    "created_at": "2022-01-11 09:08:19",
    "closed_at": "2022-01-12 16:18:16",
    "state": "closed",
    "title": "bootstrap: fix bootstrapping GnuPG from different macOS versions",
    "number": 28350,
    "milestone": null,
    "labels": [
        "bug",
        "macOS",
        "build-environment",
        "buildcache",
        "bugfix"
    ],
    "id": 1098884311,
    "html_url": "https://github.com/spack/spack/pull/28350",
    "assignees": [],
    "comments": 2
}