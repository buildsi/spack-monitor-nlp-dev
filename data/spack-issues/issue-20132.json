{
    "body": "The HIP and ROCM packages for AMD GPU's have a lot of dependencies and\r\noften do not build cleanly.  I'd like to use this issue for a\r\ndiscussion of problems and solutions for making `spack install hip`\r\nwork more robustly.\r\n\r\n----------\r\n\r\n(1) Here's where I'm currently stuck at `spack install comgr`.\r\n\r\nThis is on x86_64, RH 8.2, gcc 8.3.1, spack at commit 676d68a979 on\r\nNov 18, just after 0.16.0 and just before a couple of troublesome\r\ncommits for ROCM.  The RH HIP/ROCM packages for 3.8.0 are installed at\r\n/opt/rocm.  But I'm also trying to build in spack from scratch.\r\n\r\n```\r\n% spack install -v comgr @3.8.0\r\n...\r\nCall Stack (most recent call first):\r\n  /home/krentel/rocm/160/install/linux-rhel8-x86_64/gcc-8.3.1/cmake-3.15.7-papjvxann3gzrdnc75na4\r\n  x7qk7gv3lq7/share/cmake-3.15/Modules/CMakeFindDependencyMacro.cmake:47 (find_package)\r\n  /opt/rocm/hip/lib/cmake/hip/hip-config.cmake:112 (find_dependency)\r\n  test/CMakeLists.txt:122 (find_package)\r\n...\r\n1 error found in build log:\r\n  >> 27    CMake Error at /home/krentel/rocm/160/spack-repo/build-stage/spack-stage-comgr-3.8.0-2celuqx77r52he\r\n           uhiub4awesu4iln567/spack-build-2celuqx/lib/cmake/amd_comgr/amd_comgr-config.cmake:3 (include):\r\n     28      The file\r\n     29    \r\n     30        /home/krentel/rocm/160/spack-repo/build-stage/spack-stage-comgr-3.8.0-2celuqx77r52heuhiub4awesu\r\n           4iln567/spack-build-2celuqx/lib/cmake/amd_comgr/amd_comgr-targets.cmake\r\n     31    \r\n     32      was generated by the export() command.  It may not be used as the argument\r\n     33      to the include() command.  Use ALIAS targets instead to refer to targets by\r\n```\r\n\r\nThe error is something in cmake about improperly using the output of\r\nexport() as the argument for include().  But note that the call stack\r\nincludes a cmake file from /opt/rocm/.  I have a full HIP install at\r\n/opt/rocm, but nothing in spack ever refers to it, so this should not\r\nhappen.\r\n\r\nAnd indeed, if I move /opt/rocm/ out of the way, then the build\r\nsucceeds.  So, the problem is that the ROCM cmake files are looking\r\ninto /opt/rocm/ when spack is trying to build everything from scratch.\r\n\r\nThis is probably something that needs to be fixed at the ROCM level,\r\noutside of spack.  Theoretically, spack could add patches, but it\r\nreally needs to be fixed in ROCM/comgr.\r\n\r\nI suspect there is a general problem that the ROCM cmake files are\r\nlooking into /opt/rocm/ and /usr when they shouldn't.  For example,\r\nthis is what the patches in llvm-amdgpu are doing for ncurses and\r\nzlib, fixing cmake to prefer the spack builds over /usr.\r\n\r\nAnyway, this is problem 1, where I'm stuck now.\r\n\r\n@srekolam @haampie You want to add your war stories or solutions?\r\n\r\n",
    "user": "mwkrentel",
    "url": "https://api.github.com/repos/spack/spack/issues/20132",
    "updated_at": "2020-12-15 12:55:46",
    "created_at": "2020-11-27 02:45:31",
    "closed_at": "2020-12-15 12:55:46",
    "state": "closed",
    "title": "making HIP and ROCM more robust",
    "number": 20132,
    "milestone": null,
    "labels": [
        "AMD"
    ],
    "id": 751942800,
    "html_url": "https://github.com/spack/spack/issues/20132",
    "assignees": [],
    "comments": 3
}