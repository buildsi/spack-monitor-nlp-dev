{
    "body": "I ran `spack test` on an LLNL LC machine and three relocate tests fail.  I confirmed this is the case with commit `c50b586`. The bug appears to be related to a too-specific check of the RPATHs.\r\n\r\n### Error Message\r\n\r\n```\r\n___________________________ test_replace_prefix_bin ____________________________\r\nhello_world = <function hello_world.<locals>._factory at 0x2aaab7813d08>\r\n\r\n    @pytest.mark.requires_executables('patchelf', 'strings', 'file', 'gcc')\r\n    def test_replace_prefix_bin(hello_world):\r\n        # Compile an \"Hello world!\" executable and set RPATHs\r\n        executable = hello_world(rpaths=['/usr/lib', '/usr/lib64'])\r\n    \r\n        # Relocate the RPATHs\r\n        spack.relocate._replace_prefix_bin(str(executable), '/usr', '/foo')\r\n    \r\n        # Check that the RPATHs changed\r\n        patchelf = spack.util.executable.which('patchelf')\r\n        output = patchelf('--print-rpath', str(executable), output=str)\r\n>       assert output.strip() == '/foo/lib:/foo/lib64'\r\nE       AssertionError: assert '/foo/tce/pac...ib:/foo/lib64' == '/foo/lib:/foo/lib64'\r\nE         - /foo/tce/packages/gcc/gcc-4.9.3/lib:/foo/tce/packages/gcc/gcc-4.9.3/lib64:/foo/lib:/foo/lib64\r\nE         + /foo/lib:/foo/lib64\r\n\r\nlib/spack/spack/test/relocate.py:256: AssertionError\r\n__________________ test_relocate_elf_binaries_absolute_paths ___________________\r\n\r\nhello_world = <function hello_world.<locals>._factory at 0x2aaab7813950>\r\ntmpdir = local('/tmp/$USER/pytest-of-$USER/pytest-7/test_relocate_elf_binaries_abs0')\r\n\r\n    @pytest.mark.requires_executables('patchelf', 'strings', 'file', 'gcc')\r\n    def test_relocate_elf_binaries_absolute_paths(hello_world, tmpdir):\r\n        # Create an executable, set some RPATHs, copy it to another location\r\n        orig_binary = hello_world(rpaths=[str(tmpdir.mkdir('lib')), '/usr/lib64'])\r\n        new_root = tmpdir.mkdir('another_dir')\r\n        shutil.copy(str(orig_binary), str(new_root))\r\n    \r\n        # Relocate the binary\r\n        new_binary = new_root.join('main.x')\r\n        spack.relocate.relocate_elf_binaries(\r\n            binaries=[str(new_binary)],\r\n            orig_root=str(orig_binary.dirpath()),\r\n            new_root=None,  # Not needed when relocating absolute paths\r\n            new_prefixes={\r\n                str(tmpdir): '/foo'\r\n            },\r\n            rel=False,\r\n            # Not needed when relocating absolute paths\r\n            orig_prefix=None, new_prefix=None\r\n        )\r\n    \r\n        # Check that the RPATHs changed\r\n        patchelf = spack.util.executable.which('patchelf')\r\n        output = patchelf('--print-rpath', str(new_binary), output=str)\r\n>       assert output.strip() == '/foo/lib:/usr/lib64'\r\nE       AssertionError: assert '/usr/tce/pac...ib:/usr/lib64' == '/foo/lib:/usr/lib64'\r\nE         - /usr/tce/packages/gcc/gcc-4.9.3/lib:/usr/tce/packages/gcc/gcc-4.9.3/lib64:/foo/lib:/usr/lib64\r\nE         + /foo/lib:/usr/lib64\r\n\r\nlib/spack/spack/test/relocate.py:283: AssertionError\r\n__________________ test_relocate_elf_binaries_relative_paths ___________________\r\n\r\nhello_world = <function hello_world.<locals>._factory at 0x2aaab77b3158>\r\ntmpdir = local('/tmp/$USER/pytest-of-$USER/pytest-7/test_relocate_elf_binaries_rel0')\r\n\r\n    @pytest.mark.requires_executables('patchelf', 'strings', 'file', 'gcc')\r\n    def test_relocate_elf_binaries_relative_paths(hello_world, tmpdir):\r\n        # Create an executable, set some RPATHs, copy it to another location\r\n        orig_binary = hello_world(\r\n            rpaths=['$ORIGIN/lib', '$ORIGIN/lib64', '/opt/local/lib']\r\n        )\r\n        new_root = tmpdir.mkdir('another_dir')\r\n        shutil.copy(str(orig_binary), str(new_root))\r\n    \r\n        # Relocate the binary\r\n        new_binary = new_root.join('main.x')\r\n        spack.relocate.relocate_elf_binaries(\r\n            binaries=[str(new_binary)],\r\n            orig_root=str(orig_binary.dirpath()),\r\n            new_root=str(new_root),\r\n            new_prefixes={str(tmpdir): '/foo'},\r\n            rel=True,\r\n            orig_prefix=str(orig_binary.dirpath()),\r\n            new_prefix=str(new_root)\r\n        )\r\n    \r\n        # Check that the RPATHs changed\r\n        patchelf = spack.util.executable.which('patchelf')\r\n        output = patchelf('--print-rpath', str(new_binary), output=str)\r\n>       assert output.strip() == '/foo/lib:/foo/lib64:/opt/local/lib'\r\nE       AssertionError: assert '/usr/tce/pac...opt/local/lib' == '/foo/lib:/foo...opt/local/lib'\r\nE         - /usr/tce/packages/gcc/gcc-4.9.3/lib:/usr/tce/packages/gcc/gcc-4.9.3/lib64:/foo/lib:/foo/lib64:/opt/local/lib\r\nE         + /foo/lib:/foo/lib64:/opt/local/lib\r\n\r\nlib/spack/spack/test/relocate.py:310: AssertionError\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.14.2-1095-8d73ca3\r\n* **Python:** 3.7.2\r\n* **Platform:** linux-rhel7-zen\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n",
    "user": "tldahlgren",
    "url": "https://api.github.com/repos/spack/spack/issues/16636",
    "updated_at": "2020-05-20 16:11:27",
    "created_at": "2020-05-13 23:21:26",
    "closed_at": "2020-05-20 16:11:27",
    "state": "closed",
    "title": "Bug/tests: three relocate.py tests fail with additional gcc libs ",
    "number": 16636,
    "milestone": null,
    "labels": [
        "bug",
        "tests"
    ],
    "id": 617815342,
    "html_url": "https://github.com/spack/spack/issues/16636",
    "assignees": [],
    "comments": 0
}