{
    "body": "### Steps to reproduce\n\nThe clingo concretizer fails when attempting to `--reuse` existing builds when a package that at exists in the builtin package repo was previously installed using a custom fork of the package (with site-specific modifications) located in a higher-priority local package repo has since been removed from the local repo so that a newer builtin-repo version of the package is preferred for future builds.\r\n\r\n```console\r\n# add modified package with same name as a builtin package to a local repo\r\nspack install <package>\r\n# remove modified package from local repo so builtin version is used\r\nspack -vd --stacktrace concretize --reuse -f\r\n```\r\n\r\nIdeally, a `spack.repo.UnknownPackageError` would mark the previous build as ineligible for re-use and concertize specs using only packages still existing in available repos, even under `--reuse`.\r\n\r\nWhile it's certainly possible to restore the missing package to the local repo as a direct clone of the upstream package, my hope is that when upstream packages are updated to handle issues that previously required site-specific hacks applied through a fork of the package existing in a private repo, I would be able to drop my private fork of the package.\n\n### Error message\n\n```console\r\nspack -vd --stacktrace concretize --reuse -f\r\n```\r\n\r\n```console\r\n[PID=3602251] Traceback (most recent call last):                                                                                                                                                                                               \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/util/parallel.py\", line 53, in __call__                                                                                                      \r\n    value = self.func(*args, **kwargs)                                                                                                                                                                                                         \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/environment/environment.py\", line 2057, in _concretize_task                                                                                  \r\n    return _concretize_from_constraints(spec_constraints, tests, reuse)                                                                                                                                                                        \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/environment/environment.py\", line 2035, in _concretize_from_constraints                                                                      \r\n    return s.concretized(tests=tests, reuse=reuse)                                                                                                                                                                                             \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/spec.py\", line 2692, in concretized                                                                                                          \r\n    clone.concretize(tests=tests, reuse=reuse)                                                                                                                                                                                                 \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/spec.py\", line 2648, in concretize                                                                                                           \r\n    self._new_concretize(tests, reuse=reuse)                                                                                                                                                                                                   \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/spec.py\", line 2619, in _new_concretize                                                                                                      \r\n    result = spack.solver.asp.solve([self], tests=tests, reuse=reuse)                                                                                                                                                                          \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/solver/asp.py\", line 2054, in solve                                                                                                          \r\n    setup, specs, dump, models, timers, stats, tests, reuse                                                                                                                                                                                    \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/solver/asp.py\", line 621, in solve                                                                                                           \r\n    answers = builder.build_specs(tuples)                                                                                                                                                                                                      \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/solver/asp.py\", line 1995, in build_specs                                                                                                    \r\n    spack.spec.Spec.inject_patches_variant(root)                                                                                                                                                                                               \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/spec.py\", line 2534, in inject_patches_variant                                                                                               \r\n    pkg_deps = dspec.parent.package_class.dependencies                                                                                                                                                                                         \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/spec.py\", line 1305, in package_class                                                                                                        \r\n    return spack.repo.path.get_pkg_class(self.fullname)                                                                                                                                                                                        \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/repo.py\", line 647, in get_pkg_class                                                                                                         \r\n    return self.repo_for_pkg(pkg_name).get_pkg_class(pkg_name)                                                                                                                                                                                 \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/repo.py\", line 1107, in get_pkg_class                                                                                                        \r\n    module = self._get_pkg_module(pkg_name)                                                                                                                                                                                                    \r\n  File \"/autofs/nccs-svm1_home2/belhorn/development/olcf-spack-environments/spack/lib/spack/spack/repo.py\", line 1067, in _get_pkg_module                                                                                                      \r\n    raise UnknownPackageError(pkg_name, self)                                                                                                                                                                                                  \r\nspack.repo.UnknownPackageError: Package 'ncl' not found in repository '/ccs/home/belhorn/development/olcf-spack-environments/share/spack/repos/olcf'\r\n```\n\n### Information on your system\n\n$ spack debug report\r\n* **Spack:** 0.17.1\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rhel8-zen2\r\n* **Concretizer:** clingo\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "mpbelhorn",
    "url": "https://api.github.com/repos/spack/spack/issues/28259",
    "updated_at": "2022-02-07 17:17:44",
    "created_at": "2022-01-05 16:49:21",
    "closed_at": "None",
    "state": "open",
    "title": "ASP solver does not handle missing packages during `--reuse`",
    "number": 28259,
    "milestone": null,
    "labels": [
        "bug",
        "concretization",
        "triage"
    ],
    "id": 1094549070,
    "html_url": "https://github.com/spack/spack/issues/28259",
    "assignees": [
        "tgamblin",
        "alalazo"
    ],
    "comments": 0
}