{
    "body": "### Steps to reproduce\n\nThe command was \r\n\r\n`spack -d install zlib`\r\n\r\nThe error is in the find_compilers function, when it calls \r\n\r\n`tp = multiprocessing.pool.ThreadPool()`\r\n\r\nThe CPU count is 128, and since nothing is specified, it tries to grab all 128 cores. Hardcoding it to ThreadPool(8) fixes the issue.\n\n### Error message\n\n==> [2021-11-09-10:44:05.760886] Imported install from built-in commands\r\n==> [2021-11-09-10:44:05.762909] Reading config file /geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults/config.yaml\r\n==> [2021-11-09-10:44:05.783034] Imported install from built-in commands\r\n==> [2021-11-09-10:44:05.788462] Reading config file /geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2021-11-09-10:44:05.822667] Reading config file /geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults/config.yaml\r\n==> [2021-11-09-10:44:05.842282] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-11-09-10:44:05.842323] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-11-09-10:44:05.842678] Reading config file /geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2021-11-09-10:44:05.874567] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-11-09-10:44:05.874609] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-11-09-10:44:05.874662] [BOOTSTRAP CONFIG SCOPE] name=_builtin\r\n==> [2021-11-09-10:44:05.874972] [BOOTSTRAP CONFIG SCOPE] name=defaults, path=/geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults\r\n==> [2021-11-09-10:44:05.875007] [BOOTSTRAP CONFIG SCOPE] name=defaults/linux, path=/geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults/linux\r\n==> [2021-11-09-10:44:05.875043] [BOOTSTRAP CONFIG SCOPE] name=bootstrap, path=/N/u/befulton/Quartz/.spack/bootstrap/config\r\n==> [2021-11-09-10:44:05.875066] [BOOTSTRAP CONFIG SCOPE] name=bootstrap/linux, path=/N/u/befulton/Quartz/.spack/bootstrap/config/linux\r\n==> [2021-11-09-10:44:06.080393] Reading config file /geode2/home/u010/befulton/Quartz/Apps/spack/etc/spack/defaults/config.yaml\r\nTraceback (most recent call last):\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/multiprocessing/pool.py\", line 212, in __init__\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/multiprocessing/pool.py\", line 303, in _repopulate_pool\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/multiprocessing/pool.py\", line 326, in _repopulate_pool_static\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/multiprocessing/dummy/__init__.py\", line 51, in start\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/threading.py\", line 852, in start\r\nRuntimeError: can't start new thread\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/main.py\", line 882, in main\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/main.py\", line 865, in _main\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/main.py\", line 535, in _invoke_command\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/cmd/install.py\", line 394, in install\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/cmd/__init__.py\", line 166, in parse_specs\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/spec.py\", line 2639, in concretize\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/spec.py\", line 2610, in _new_concretize\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/solver/asp.py\", line 2012, in solve\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/solver/asp.py\", line 464, in __init__\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/solver/asp.py\", line 442, in bootstrap_clingo\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/contextlib.py\", line 113, in __enter__\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/bootstrap.py\", line 691, in ensure_bootstrap_configuration\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/bootstrap.py\", line 659, in _add_compilers_if_missing\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/compilers/__init__.py\", line 332, in compilers_for_arch\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/compilers/__init__.py\", line 182, in all_compilers_config\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/compilers/__init__.py\", line 106, in get_compiler_config\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/compilers/__init__.py\", line 93, in init_compiler_config\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/compilers/__init__.py\", line 215, in find_compilers\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/multiprocessing/pool.py\", line 925, in __init__\r\n  File \"/N/soft/rhel8/python/3.8.5/lib/python3.8/multiprocessing/pool.py\", line 216, in __init__\r\nAttributeError: 'DummyProcess' object has no attribute 'terminate'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/N/u/befulton/Quartz/Apps/spack/bin/spack\", line 100, in <module>\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/main.py\", line 904, in main\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/config.py\", line 923, in get\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/config.py\", line 638, in get\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/config.py\", line 578, in get_config\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/llnl/util/lang.py\", line 190, in _memoized_function\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/config.py\", line 593, in _get_config_memoized\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/config.py\", line 148, in get_section\r\n  File \"/geode2/home/u010/befulton/Quartz/Apps/spack/lib/spack/spack/config.py\", line 1008, in read_config_file\r\nMemoryError\r\n\n\n### Information on your system\n\n* **Spack:** 0.17.0-40-6e6847d9c7\r\n* **Python:** 3.8.5\r\n* **Platform:** linux-rhel8-zen2\r\n* **Concretizer:** clingo\r\n\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "benfulton",
    "url": "https://api.github.com/repos/spack/spack/issues/27315",
    "updated_at": "2021-11-09 18:13:49",
    "created_at": "2021-11-09 18:13:49",
    "closed_at": "None",
    "state": "open",
    "title": "Default thread pool potentially too large",
    "number": 27315,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1048920676,
    "html_url": "https://github.com/spack/spack/issues/27315",
    "assignees": [],
    "comments": 0
}