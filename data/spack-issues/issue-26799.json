{
    "body": "### Steps to reproduce\r\n\r\nI am trying to build a spec that requires a dev-build of Python3 which is not presently available on Spock. I can have spack build Python in my environment without issue, but when I try to recreate the environment with additional specs or build a new environment that uses the same spack build of Python, spack install fails with the error\r\n\r\n\"/usr/bin/python3: symbol lookup error: /usr/bin/python3: undefined symbol: _Py_LegacyLocaleDetected\"\r\n\r\nIt possibly indicates some conflict between the spack-installed python and the system installation. To reproduce use the following environment yaml (spock.yaml):\r\n\r\n```\r\nspack:\r\n  specs:\r\n  - python@3.6.13 %clang@amd\r\n  concretization: together\r\n  compilers:\r\n  - compiler:\r\n      spec: clang@amd\r\n      paths:\r\n        cc: /opt/rocm-4.2.0/llvm/bin/clang\r\n        cxx: /opt/rocm-4.2.0/llvm/bin/clang++\r\n        f77: /opt/rocm-4.2.0/llvm/bin/flang\r\n        fc: /opt/rocm-4.2.0/llvm/bin/flang\r\n      flags: {}\r\n      operating_system: sles15\r\n      target:  any\r\n      modules:\r\n      - PrgEnv-cray/8.1.0\r\n      - rocm/4.2.0\r\n      environment: {}\r\n      extra_rpaths: []\r\n  - compiler:\r\n      spec: gcc@7.5.0\r\n      paths:\r\n        cc: /usr/bin/gcc\r\n        cxx: /usr/bin/g++\r\n        f77: /usr/bin/gfortran\r\n        fc:  /usr/bin/gfortran\r\n      flags: {}\r\n      operating_system: sles15\r\n      target: any\r\n      modules: []\r\n      environment: {}\r\n      extra_rpaths: []\r\n  repos: []\r\n  packages:\r\n    all:\r\n      compiler: [clang@amd,gcc@7.5.0]\r\n      providers:\r\n        mpi: [mpich]\r\n        pkgconfig: [pkg-config]\r\n      buildable: true\r\n      version: []\r\n      target: []\r\n    mpi:\r\n      buildable: False\r\n    libfabric:\r\n      variants: fabrics=verbs,rxm,mrail,tcp\r\n      buildable: true\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      compiler: []\r\n    mpich:\r\n      externals:\r\n      - spec: mpich@8.1.7-cray\r\n        modules:\r\n        - cray-mpich/8.1.7\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      compiler: []\r\n\r\n    libzmq:\r\n      externals:\r\n      - spec: libzmq@4.3.3\r\n        modules:\r\n        - libzmq/4.3.3\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      compiler: []\r\n\r\n    cmake:\r\n      externals:\r\n      - spec: cmake@3.21.3\r\n        modules:\r\n        - cmake/3.21.3\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      compiler: []\r\n      \r\n    bzip2:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - bzip2/1.0.8\r\n        spec: bzip2@1.0.8\r\n      compiler: []\r\n\r\n    boost:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - boost/1.77.0\r\n        spec: boost@1.77.0\r\n      compiler: []\r\n\r\n    libffi:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - libffi/3.3\r\n        spec: libffi@3.3.0\r\n      compiler: []\r\n    curl:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - curl/7.79.0\r\n        spec: curl@7.79.0\r\n      compiler: []\r\n\r\n    c-blosc:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - c-blosc/1.21.0\r\n        spec: c-blosc@1.21.0\r\n      compiler: []\r\n\r\n    diffutils:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - diffutils/3.8\r\n        spec: diffutils@3.8\r\n      compiler: []\r\n\r\n    perl:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - perl/5.34.0\r\n        spec: perl@5.34.0\r\n      compiler: []\r\n\r\n    zfp:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - zfp/0.5.5\r\n        spec: zfp@0.5.5\r\n      compiler: []\r\n\r\n    papi:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - papi/6.0.0.7\r\n        spec: papi@6.0.0.7\r\n      compiler: []\r\n\r\n    hwloc:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - hwloc/2.5.0\r\n        spec: hwloc@2.5.0\r\n      compiler: []\r\n\r\n    gettext:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - gettext/0.21\r\n        spec: gettext@0.21\r\n      compiler: []\r\n\r\n    zlib:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - zlib/1.2.11\r\n        spec: zlib@1.2.11\r\n      compiler: []\r\n\r\n    gdbm:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - gdbm/1.19\r\n        spec: gdbm@1.19\r\n      compiler: []\r\n\r\n    sqlite:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - sqlite/3.36.0\r\n        spec: sqlite@3.36.0\r\n      compiler: []\r\n\r\n    googletest:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - googletest/1.11.0\r\n        spec: googletest@1.11.0\r\n      compiler: []\r\n\r\n    libpng:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - libpng/1.6.37\r\n        spec: libpng@1.6.37\r\n      compiler: []\r\n\r\n    libelf:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - libelf/0.8.13\r\n        spec: libelf@0.8.13\r\n      compiler: []\r\n\r\n    elfutils:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - elfutils/0.182\r\n        spec: elfutils@0.182\r\n      compiler: []\r\n\r\n    expat:\r\n      version: []\r\n      target: []\r\n      buildable: false\r\n      providers: {}\r\n      externals:\r\n      - modules:\r\n        - expat/2.4.1\r\n        spec: expat@2.4.1\r\n      compiler: []\r\n\r\n\r\n\r\n  view: true\r\n\r\n```\r\n\r\nAnd build with:\r\n\r\n```\r\nspack env create test_python_spack spock.yaml\r\nspack --debug env activate test_python_spack\r\nspack concretize -f\r\nspack --debug install --no-checksum\r\n```\r\n\r\nThen edit spock.yaml and add another spec, e.g. \r\n```\r\n  specs:\r\n  - python@3.6.13 %clang@amd\r\n  - py-numpy\r\n```\r\n\r\nthen either remove and recreate the environment or just create a new one, e.g. \"spack env create test_python_spack2 spock.yaml\"\r\n\r\n\r\n\r\n\r\n### Error message\r\n\r\nspack install fails immediately with the error\r\n\r\n\"/usr/bin/python3: symbol lookup error: /usr/bin/python3: undefined symbol: _Py_LegacyLocaleDetected\"\r\n\r\nand produces no other output, even with --debug\r\n\r\n### Information on your system\r\n\r\n[ckelly@login2.spock test_spack_broken_python]$ spack debug report\r\n* **Spack:** 0.16.3-4829-e2a64bb483\r\n* **Python:** 3.6.13\r\n* **Platform:** cray-sles15-zen2\r\n* **Concretizer:** clingo\r\n\r\n\r\nUsing develop branch commit   e2a64bb483f42a2ce73a8148eac2b821e8173b30   from 10/12/21\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "giltirn",
    "url": "https://api.github.com/repos/spack/spack/issues/26799",
    "updated_at": "2021-10-20 15:35:08",
    "created_at": "2021-10-18 16:36:13",
    "closed_at": "None",
    "state": "open",
    "title": "Spack install fails immediately with error \"/usr/bin/python3: symbol lookup error: /usr/bin/python3: undefined symbol: _Py_LegacyLocaleDetected\" on Spock",
    "number": 26799,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1029348466,
    "html_url": "https://github.com/spack/spack/issues/26799",
    "assignees": [],
    "comments": 1
}