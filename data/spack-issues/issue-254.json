{
    "body": "From @kiwifb:\n\nSo I was doing some experiments with the IBM xl compiler so I could see if there was any issues.\nAnd it failed miserably building mpich-3.1.4 as part of a chain of dependencies.\nI can build mpich-3.1.4 with xlc-13.1/xlf-15.1 fine on that machine outside of spack so it \nwarranted further exploration.\n\nThe problem is with the generated libtool file. A diff of the config.lt files produced is very\nenlightening:\n\n```\nfrb15@p2n14-c /tmp/spack-stage/spack-stage-5B2T0e/mpich-3.1.4 :diff -u config.lt /hpc/scratch/frb15/work/compilers/test/mpich-3.1.4/build_xl13/config.lt\n--- config.lt   2015-12-17 10:47:17.000000000 +1300\n+++ /hpc/scratch/frb15/work/compilers/test/mpich-3.1.4/build_xl13/config.lt     2015-12-17 10:37:25.228602129 +1300\n@@ -483,9 +483,9 @@\n old_postuninstall_cmds=''\n old_archive_cmds='$AR $AR_FLAGS $oldlib$oldobjs~$RANLIB $tool_oldlib'\n lock_old_archive_extraction='no'\n-CC='/hpc/scratch/frb15/git/spack-2015-12-14/lib/spack/env/cc'\n+CC='xlc_r'\n CFLAGS='   -O2'\n-compiler='/hpc/scratch/frb15/git/spack-2015-12-14/lib/spack/env/f77'\n+compiler='xlf_r'\n GCC=''\n lt_cv_sys_global_symbol_pipe='sed -n -e '\\''s/^.*[      ]\\([ABCDGIRSTW][ABCDGIRSTW]*\\)[         ][      ]*\\([_A-Za-z][_A-Za-z0-9]*\\)$/\\1 \\2 \\2/p'\\'' | sed '\\''/ __gnu_lto/d'\\'''\n lt_cv_sys_global_symbol_to_cdecl='sed -n -e '\\''s/^T .* \\(.*\\)$/extern int \\1();/p'\\'' -e '\\''s/^[ABCDGIRSTW][ABCDGIRSTW]* .* \\(.*\\)$/extern char \\1;/p'\\'''\n@@ -499,9 +499,9 @@\n objdir='.libs'\n MAGIC_CMD='file'\n lt_prog_compiler_no_builtin_flag=''\n-lt_prog_compiler_pic=' -DPIC'\n-lt_prog_compiler_wl=''\n-lt_prog_compiler_static=''\n+lt_prog_compiler_pic=' -qpic -DPIC'\n+lt_prog_compiler_wl='-Wl,'\n+lt_prog_compiler_static='-qstaticlink'\n lt_cv_prog_compiler_c_o='yes'\n need_locks='no'\n MANIFEST_TOOL=':'\n```\n\nThere is more but it is enough for the sake of the argument. The build failed because the libtool\nvariable `wl` was set to nothing instead of \"-Wl,\". Failing that other bits would have caused failures\nlater on.\n\nWhy does it happen? The libtool code to set the various variables examine the base name of the\ncompiler to work things (from configure):\n\n```\n    linux* | k*bsd*-gnu | kopensolaris*-gnu | gnu*)\n      case $cc_basename in\n      # old Intel for x86_64, which still supported -KPIC.\n      ecc*)\nlt_prog_compiler_wl='-Wl,'\nlt_prog_compiler_pic='-KPIC'\nlt_prog_compiler_static='-static'\n        ;;\n      # icc used to be incompatible with GCC.\n      # ICC 10 doesn't accept -KPIC any more.\n      icc* | ifort*)\nlt_prog_compiler_wl='-Wl,'\nlt_prog_compiler_pic='-fPIC'\nlt_prog_compiler_static='-static'\n        ;;\n      # Lahey Fortran 8.1.\n      lf95*)\nlt_prog_compiler_wl='-Wl,'\nlt_prog_compiler_pic='--shared'\nlt_prog_compiler_static='--static'\n;;\n      nagfor*)\n# NAG Fortran compiler\nlt_prog_compiler_wl='-Wl,-Wl,,'\nlt_prog_compiler_pic='-PIC'\nlt_prog_compiler_static='-Bstatic'\n;;\n      tcc*)\n# Fabrice Bellard et al's Tiny C Compiler\nlt_prog_compiler_wl='-Wl,'\nlt_prog_compiler_pic='-fPIC'\nlt_prog_compiler_static='-static'\n;;\n      pgcc* | pgf77* | pgf90* | pgf95* | pgfortran*)\n        # Portland Group compilers (*not* the Pentium gcc compiler,\n# which looks to be a dead project)\nlt_prog_compiler_wl='-Wl,'\nlt_prog_compiler_pic='-fpic'\nlt_prog_compiler_static='-Bstatic'\n        ;;\n      ccc*)\n        lt_prog_compiler_wl='-Wl,'\n        # All Alpha code is PIC.\n        lt_prog_compiler_static='-non_shared'\n        ;;\n      xl* | bgxl* | bgf* | mpixl*)\n# IBM XL C 8.0/Fortran 10.1, 11.1 on PPC and BlueGene\nlt_prog_compiler_wl='-Wl,'\nlt_prog_compiler_pic='-qpic'\nlt_prog_compiler_static='-qstaticlink'\n;;\n      *)\ncase `$CC -V 2>&1 | sed 5q` in\n*Sun\\ Ceres\\ Fortran* | *Sun*Fortran*\\ [1-7].* | *Sun*Fortran*\\ 8.[0-3]*)\n # Sun Fortran 8.3 passes all unrecognized flags to the linker\n lt_prog_compiler_pic='-KPIC'\n lt_prog_compiler_static='-Bstatic'\n lt_prog_compiler_wl=''\n ;;\n*Sun\\ F* | *Sun*Fortran*)\n lt_prog_compiler_pic='-KPIC'\n lt_prog_compiler_static='-Bstatic'\n lt_prog_compiler_wl='-Qoption ld '\n ;;\n*Sun\\ C*)\n # Sun C 5.9\n lt_prog_compiler_pic='-KPIC'\n lt_prog_compiler_static='-Bstatic'\n lt_prog_compiler_wl='-Wl,'\n ;;\n        *Intel*\\ [CF]*Compiler*)\n lt_prog_compiler_wl='-Wl,'\n lt_prog_compiler_pic='-fPIC'\n lt_prog_compiler_static='-static'\n ;;\n*Portland\\ Group*)\n lt_prog_compiler_wl='-Wl,'\n lt_prog_compiler_pic='-fpic'\n lt_prog_compiler_static='-Bstatic'\n ;;\nesac\n;;\n      esac\n      ;;\n```\n\nAnd the problem here is that `libtool/configure` never figured out that the wrapper\nwas the XL compiler. It always stayed at `/hpc/scratch/frb15/git/spack-2015-12-14/lib/spack/env/cc`\nand wasn't picked as any of the option and the values are left to the default\nwhich is blank for most things.\n",
    "user": "tgamblin",
    "url": "https://api.github.com/repos/spack/spack/issues/254",
    "updated_at": "2015-12-21 00:57:00",
    "created_at": "2015-12-19 10:03:41",
    "closed_at": "2015-12-21 00:57:00",
    "state": "closed",
    "title": "Issues building with libtool",
    "number": 254,
    "milestone": null,
    "labels": [
        "bug"
    ],
    "id": 123075825,
    "html_url": "https://github.com/spack/spack/issues/254",
    "assignees": [
        "tgamblin"
    ],
    "comments": 0
}