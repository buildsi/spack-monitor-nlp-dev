{
    "body": "### Steps to reproduce\r\n\r\nThis error has been originally reported on Slack by @g-mathias (thanks!)\r\n\r\nThe following environment:\r\n```yaml\r\nspack:\r\n  # add package specs to the `specs` list\r\n  specs:\r\n    # 2020 plumed mpi\r\n    - matrix:\r\n      - [gromacs]\r\n      - ['@2020.1:2020.4'] \r\n      - ['%intel'] #compiler in extra matrix element\r\n      - ['+plumed ^plumed@2.6.4%intel']\r\n\r\n  view: false\r\n```\r\nfails to parse when expanding the matrix. To trigger the error:\r\n```console\r\n$ spack -e . concretize\r\n```\r\n\r\n### Error message\r\n\r\nThe error with a stacktrace is:\r\n\r\n<details>\r\n<summary>$ spack -d -e . concretize</summary>\r\n\r\n```\r\n==> [2022-02-03-13:13:40.299700] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/config.yaml\r\n==> [2022-02-03-13:13:40.321068] Reading config file /tmp/matrix/spack.yaml\r\n==> [2022-02-03-13:13:40.323254] Using environment '/tmp/matrix'\r\n==> [2022-02-03-13:13:40.324073] Imported concretize from built-in commands\r\n==> [2022-02-03-13:13:40.324521] Imported concretize from built-in commands\r\n==> [2022-02-03-13:13:40.327576] DuplicateCompilerSpecError: Spec for 'plumed' cannot have two compilers.\r\n==> [2022-02-03-13:13:40.327616] Error: Spec for 'plumed' cannot have two compilers.\r\nTraceback (most recent call last):\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 900, in main\r\n    return _main(argv)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 883, in _main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 553, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/cmd/concretize.py\", line 39, in concretize\r\n    concretized_specs = env.concretize(\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/environment/environment.py\", line 1118, in concretize\r\n    return self._concretize_separately(tests=tests, reuse=reuse)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/environment/environment.py\", line 1184, in _concretize_separately\r\n    self.user_specs, self.user_specs.specs_as_constraints\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/spec_list.py\", line 63, in specs_as_constraints\r\n    constraints.extend(_expand_matrix_constraints(item))\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/spec_list.py\", line 203, in _expand_matrix_constraints\r\n    test_spec = Spec(' '.join(ordered_combo))\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/spec.py\", line 1115, in __init__\r\n    spec_list = SpecParser(self).parse(spec_like)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/parse.py\", line 153, in parse\r\n    return self.do_parse()\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/spec.py\", line 4747, in do_parse\r\n    dep = self.spec(dep_name)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/spec.py\", line 4884, in spec\r\n    spec._set_compiler(self.compiler())\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/spec.py\", line 1241, in _set_compiler\r\n    raise DuplicateCompilerSpecError(\r\nspack.spec.DuplicateCompilerSpecError: Spec for 'plumed' cannot have two compilers.\r\n```\r\n\r\n</details>\r\n\r\nAs a further data point, the following environment which should be equivalent:\r\n```yaml\r\nspack:\r\n  # add package specs to the `specs` list\r\n  specs:\r\n    # 2020 plumed mpi\r\n    - matrix:\r\n      - [gromacs]\r\n      - ['@2020.1:2020.4%intel']\r\n      - [+plumed ^plumed@2.6.4%intel]\r\n  view: false\r\n```\r\nworks correctly.\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.1-1061-18b83c3833\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-icelake\r\n* **Concretizer:** clingo\r\n\r\nSee also #20340 for another issue with best-effort matrix expansion. Adding it here since they can be probably solved at the same time with a refactor PR.\r\n\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/28749",
    "updated_at": "2022-02-04 19:17:23",
    "created_at": "2022-02-03 12:23:27",
    "closed_at": "2022-02-04 19:17:23",
    "state": "closed",
    "title": "Stacks: matrix expansion failing with spack.spec.DuplicateCompilerSpecError",
    "number": 28749,
    "milestone": null,
    "labels": [
        "bug",
        "impact-low"
    ],
    "id": 1123022723,
    "html_url": "https://github.com/spack/spack/issues/28749",
    "assignees": [],
    "comments": 4
}