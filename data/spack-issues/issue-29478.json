{
    "body": "### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack spec -I python\r\nInput spec\r\n--------------------------------\r\n -   python\r\n\r\nConcretized\r\n--------------------------------\r\n[+]  python@3.9.10%gcc@8.5.0+bz2+ctypes+dbm~debug+ensurepip+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4+uuid+zlib patches=0d98e93,4c24573,f2fd060 arch=linux-centos7-x86_64\r\n[+]      ^bzip2@1.0.8%gcc@8.5.0~debug~pic+shared arch=linux-centos7-x86_64\r\n[+]          ^diffutils@3.8%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]              ^libiconv@1.16%gcc@8.5.0 libs=shared,static arch=linux-centos7-x86_64\r\n[+]      ^expat@2.4.6%gcc@8.5.0+libbsd arch=linux-centos7-x86_64\r\n[+]          ^libbsd@0.11.5%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]              ^libmd@1.0.4%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]      ^gdbm@1.19%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]          ^readline@8.1%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]              ^ncurses@6.2%gcc@8.5.0~symlinks+termlib abi=none arch=linux-centos7-x86_64\r\n[+]                  ^pkgconf@1.8.0%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]      ^gettext@0.21%gcc@8.5.0+bzip2+curses+git~libunistring+libxml2+tar+xz arch=linux-centos7-x86_64\r\n[+]          ^libxml2@2.9.12%gcc@8.5.0~python arch=linux-centos7-x86_64\r\n[+]              ^xz@5.2.5%gcc@8.5.0~pic libs=shared,static arch=linux-centos7-x86_64\r\n[+]              ^zlib@1.2.11%gcc@8.5.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n[+]          ^tar@1.34%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]      ^libffi@3.4.2%gcc@8.5.0 arch=linux-centos7-x86_64\r\n[+]      ^openssl@1.1.1m%gcc@8.5.0~docs certs=system arch=linux-centos7-x86_64\r\n[+]          ^perl@5.34.0%gcc@8.5.0+cpanm+shared+threads arch=linux-centos7-x86_64\r\n[+]              ^berkeley-db@18.1.40%gcc@8.5.0+cxx~docs+stl patches=b231fcc arch=linux-centos7-x86_64\r\n[+]      ^sqlite@3.37.2%gcc@8.5.0+column_metadata+dynamic_extensions+fts~functions+rtree arch=linux-centos7-x86_64\r\n[+]      ^util-linux-uuid@2.37.4%gcc@8.5.0 arch=linux-centos7-x86_64\r\n```\r\n\r\n\r\n### Error message\r\n\r\nPython appears to install successfully, but downstream packages fail, e.g. py-setuptools:\r\n<details><summary>Error message</summary><pre>\r\n```\r\n==> py-setuptools: Executing phase: 'install'\r\n==> [2022-03-12-10:39:09.181041] '/projects/spack/opt/spack/gcc-8.5.0/python/6z6bbfg/bin/python3.9' '-m' 'pip' '-vvv' '--no-input' '--no-cache-dir' '--disable-pip-version-check' 'install' '--no-deps' '--ignore-installed' '--no-build-isolation' '--no-warn-script-location' '--no-index' '--prefix=/projects/spack/opt/spack/gcc-8.5.0/py-setuptools/26gyn5x' '.'\r\nUsing pip 21.3.1 from /projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip (python 3.9)\r\nNon-user install due to --prefix or --target option\r\nIgnoring indexes: https://pypi.org/simple\r\nCreated temporary directory: /tmp/pip-ephem-wheel-cache-p5vr3e0t\r\nCreated temporary directory: /tmp/pip-req-tracker-iv7wygbd\r\nInitialized build tracking at /tmp/pip-req-tracker-iv7wygbd\r\nCreated build tracker: /tmp/pip-req-tracker-iv7wygbd\r\nEntered build tracker: /tmp/pip-req-tracker-iv7wygbd\r\nCreated temporary directory: /tmp/pip-install-2zg9v9l0\r\nProcessing /tmp/s3j/spack-stage/spack-stage-py-setuptools-59.4.0-26gyn5xre2zssmqsn2qqurxbbooxgssz/spack-src\r\n  Added file:///tmp/s3j/spack-stage/spack-stage-py-setuptools-59.4.0-26gyn5xre2zssmqsn2qqurxbbooxgssz/spack-src to build tracker '/tmp/pip-req-tracker-iv7wygbd'\r\n  Created temporary directory: /tmp/pip-modern-metadata-n1k48pa1\r\n  Preparing metadata (pyproject.toml): started\r\n  Running command /projects/spack/opt/spack/gcc-8.5.0/python/6z6bbfg/bin/python3.9 /projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /tmp/tmpte_wdk3q\r\n  Preparing metadata (pyproject.toml): finished with status 'done'\r\nERROR: Exception:\r\nTraceback (most recent call last):\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/cli/base_command.py\", line 164, in exc_logging_wrapper\r\n    status = run_func(*args)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/cli/req_command.py\", line 205, in wrapper\r\n    return func(self, options, args)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/commands/install.py\", line 338, in run\r\n    requirement_set = resolver.resolve(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/resolver.py\", line 73, in resolve\r\n    collected = self.factory.collect_root_requirements(root_reqs)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/factory.py\", line 468, in collect_root_requirements\r\n    req = self._make_requirement_from_install_req(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/factory.py\", line 430, in _make_requirement_from_install_req\r\n    cand = self._make_candidate_from_link(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/factory.py\", line 201, in _make_candidate_from_link\r\n    self._link_candidate_cache[link] = LinkCandidate(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/candidates.py\", line 281, in __init__\r\n    super().__init__(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/candidates.py\", line 156, in __init__\r\n    self.dist = self._prepare()\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/candidates.py\", line 225, in _prepare\r\n    dist = self._prepare_distribution()\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/resolution/resolvelib/candidates.py\", line 292, in _prepare_distribution\r\n    return preparer.prepare_linked_requirement(self._ireq, parallel_builds=True)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/operations/prepare.py\", line 482, in prepare_linked_requirement\r\n    return self._prepare_linked_requirement(req, parallel_builds)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/operations/prepare.py\", line 546, in _prepare_linked_requirement\r\n    dist = _get_prepared_distribution(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/operations/prepare.py\", line 58, in _get_prepared_distribution\r\n    abstract_dist.prepare_distribution_metadata(finder, build_isolation)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/distributions/sdist.py\", line 49, in prepare_distribution_metadata\r\n    self.req.prepare_metadata()\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/req/req_install.py\", line 556, in prepare_metadata\r\n    self.metadata_directory = generate_metadata(\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_internal/operations/build/metadata.py\", line 28, in generate_metadata\r\n    distinfo_dir = backend.prepare_metadata_for_build_wheel(metadata_dir)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_vendor/pep517/wrappers.py\", line 188, in prepare_metadata_for_build_wheel\r\n    return self._call_hook('prepare_metadata_for_build_wheel', {\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_vendor/pep517/wrappers.py\", line 332, in _call_hook\r\n    raise BackendUnavailable(data.get('traceback', ''))\r\npip._vendor.pep517.wrappers.BackendUnavailable: Traceback (most recent call last):\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/py-pip/m2bllhv/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 89, in _build_backend\r\n    obj = import_module(mod_path)\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/python/6z6bbfg/lib/python3.9/importlib/__init__.py\", line 127, in import_module\r\n    return _bootstrap._gcd_import(name[level:], package, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1030, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1007, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 972, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 228, in _call_with_frames_removed\r\n  File \"<frozen importlib._bootstrap>\", line 1030, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1007, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 986, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 680, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 850, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 228, in _call_with_frames_removed\r\n  File \"/tmp/s3j/spack-stage/spack-stage-py-setuptools-59.4.0-26gyn5xre2zssmqsn2qqurxbbooxgssz/spack-src/setuptools/__init__.py\", line 18, in <module>\r\n    from setuptools.dist import Distribution\r\n  File \"/tmp/s3j/spack-stage/spack-stage-py-setuptools-59.4.0-26gyn5xre2zssmqsn2qqurxbbooxgssz/spack-src/setuptools/dist.py\", line 38, in <module>\r\n    from setuptools import windows_support\r\n  File \"/tmp/s3j/spack-stage/spack-stage-py-setuptools-59.4.0-26gyn5xre2zssmqsn2qqurxbbooxgssz/spack-src/setuptools/windows_support.py\", line 2, in <module>\r\n    import ctypes\r\n  File \"/projects/spack/opt/spack/gcc-8.5.0/python/6z6bbfg/lib/python3.9/ctypes/__init__.py\", line 8, in <module>\r\n    from _ctypes import Union, Structure, Array\r\nModuleNotFoundError: No module named '_ctypes'\r\n</pre></details>\r\n\r\nLooking back at the python build logs, it silently hid the failure of the ctypes module:\r\n<details><summary>Error message</summary><pre>\r\n*** WARNING: renaming \"_ctypes\" since importing it failed: build/lib.linux-x86_64-3.9/_ctypes.cpython-39-x86_64-linux-gnu.so: undefined symbol: ffi_prep_cif\r\n\r\nPython build finished successfully!\r\nThe necessary bits to build these optional modules were not found:\r\n_bz2                  _curses               _curses_panel\r\n_lzma                 _sqlite3              _tkinter\r\nreadline\r\nTo find the necessary bits, look in setup.py in detect_modules() for the module's name.\r\n\r\n\r\nThe following modules found by detect_modules() in setup.py, have been\r\nbuilt by the Makefile instead, as configured by the Setup files:\r\n_abc                  atexit                pwd\r\ntime\r\n\r\n\r\nFollowing modules built successfully but were removed because they could not be imported:\r\n_ctypes\r\n</pre></details>\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.1-1532-8adc6b7e8e\r\n* **Python:** 3.9.10\r\n* **Platform:** linux-centos7-zen2\r\n* **Concretizer:** clingo\r\n\r\n### Additional information\r\n\r\n@adamjstewart @scheibelp @skosukhin @varioustoxins\r\n\r\nA recent build on an almost identical configuration passed, so I suspect this is due to the libffi update in #28970 .\r\n[spack-build-out.txt](https://github.com/spack/spack/files/8238107/spack-build-out.txt)\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\r\n- [X] I have uploaded the build log and environment files\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "sethrj",
    "url": "https://api.github.com/repos/spack/spack/issues/29478",
    "updated_at": "2022-03-13 02:42:21",
    "created_at": "2022-03-12 17:56:44",
    "closed_at": "2022-03-13 02:42:21",
    "state": "closed",
    "title": "Installation issue: python+ctypes",
    "number": 29478,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 1167354327,
    "html_url": "https://github.com/spack/spack/issues/29478",
    "assignees": [],
    "comments": 3
}