{
    "body": "<!-- Explain, in a clear and concise way, the command you ran and the result you were trying to achieve.\r\nExample: \"I ran `spack find` to list all the installed packages and ...\" -->\r\n\r\nSpack determines:\r\n\r\n==> Warning: gcc@7.4.0 cannot build optimized binaries for \"cascadelake\". Using best target possible: \"skylake_avx512\"\r\n\r\nBut then - it goes ahead and tries to build some dependent packages with `arch=linux-centos7-cascadelake`\r\n\r\nPresence of `perl` in `packages.yaml` appears to trigger this behavior [for this case with openmpi]\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ cat ~/.spack/packages.yaml\r\npackages:\r\n  perl:\r\n    externals:\r\n    - spec: perl@5.16.3\r\n      prefix: /usr\r\n    buildable: False\r\n\r\n\r\n$ spack spec openmpi%gcc@7.4.0\r\nInput spec\r\n--------------------------------\r\nopenmpi%gcc@7.4.0\r\n\r\nConcretized\r\n--------------------------------\r\n==> Warning: gcc@7.4.0 cannot build optimized binaries for \"cascadelake\". Using best target possible: \"skylake_avx512\"\r\nopenmpi@4.1.1%gcc@7.4.0~atomics~cuda~cxx~cxx_exceptions+gpfs~internal-hwloc~java~legacylaunchers~lustre~memchecker~pmi~singularity~sqlite3+static~thread_multiple+vt+wrapper-rpath fabrics=none schedulers=none arch=linux-centos7-skylake_avx512\r\n    ^hwloc@2.5.0%gcc@7.4.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml+pci+shared arch=linux-centos7-skylake_avx512\r\n        ^libpciaccess@0.16%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^libtool@2.4.6%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n                ^m4@1.4.19%gcc@7.4.0+sigsegv arch=linux-centos7-skylake_avx512\r\n                    ^libsigsegv@2.13%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^pkgconf@1.7.4%gcc@7.4.0 arch=linux-centos7-cascadelake\r\n            ^util-macros@1.19.1%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n        ^libxml2@2.9.10%gcc@7.4.0~python arch=linux-centos7-skylake_avx512\r\n            ^libiconv@1.16%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^xz@5.2.5%gcc@7.4.0~pic libs=shared,static arch=linux-centos7-skylake_avx512\r\n            ^zlib@1.2.11%gcc@7.4.0+optimize+pic+shared arch=linux-centos7-skylake_avx512\r\n        ^ncurses@6.2%gcc@7.4.0~symlinks+termlib abi=none arch=linux-centos7-cascadelake\r\n    ^libevent@2.1.12%gcc@7.4.0+openssl arch=linux-centos7-skylake_avx512\r\n        ^openssl@1.1.1k%gcc@7.4.0~docs+systemcerts arch=linux-centos7-skylake_avx512\r\n            ^perl@5.16.3%gcc@7.4.0+cpanm+shared+threads patches=0eac10ed90aeb0459ad8851f88081d439a4e41978e586ec743069e8b059370ac arch=linux-centos7-skylake_avx512\r\n    ^numactl@2.0.14%gcc@7.4.0 patches=4e1d78cbbb85de625bad28705e748856033eaafab92a66dffd383a3d7e00cc94,62fc8a8bf7665a60e8f4c93ebbd535647cebf74198f7afafec4c085a8825c006 arch=linux-centos7-skylake_avx512\r\n        ^autoconf@2.69%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n        ^automake@1.16.3%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n    ^openssh@8.5p1%gcc@7.4.0 arch=linux-centos7-cascadelake\r\n        ^libedit@3.1-20210216%gcc@7.4.0 arch=linux-centos7-cascadelake\r\n\r\n$ spack install --fail-fast openmpi%gcc@7.4.0\r\n```\r\n\r\n### Error Message\r\n\r\n```\r\n==> Installing pkgconf-1.7.4-onti3kpmfuuaau6pkg53zfoaerpli674\r\n==> No binary for pkgconf-1.7.4-onti3kpmfuuaau6pkg53zfoaerpli674 found: installing from source\r\n==> Error: UnsupportedMicroarchitecture: cannot produce optimized binary for micro-architecture 'cascadelake' with gcc@7.4.0 [supported compiler versions are 9.0:]\r\n\r\n/data/balay/spack.x/lib/spack/spack/build_environment.py:1021, in _setup_pkg_and_run:\r\n       1018        tb_string = traceback.format_exc()\r\n       1019\r\n       1020        # build up some context from the offending package so we can\r\n  >>   1021        # show that, too.\r\n       1022        package_context = get_package_context(tb)\r\n       1023\r\n       1024        logfile = None\r\n```\r\nWorkaround for now:\r\n```console\r\n$ spack spec openmpi%gcc@7.4.0 target=skylake_avx512\r\n```\r\n\r\n<!-- If Spack reported an error, provide the error message. If it did not report an error but the output appears incorrect, provide the incorrect output. If there was no error message and no output but the result is incorrect, describe how it does not match what you expect. -->\r\n```console\r\n$ spack --debug --stacktrace install --fail-fast openmpi%gcc@7.4.0 \r\n```\r\n[debug-stack.log.txt](https://github.com/spack/spack/files/6779688/debug-stack.log.txt)\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n```\r\n$ spack debug report\r\n* **Spack:** 0.16.2-3412-e0b901153b\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-centos7-cascadelake\r\n* **Concretizer:** original\r\n```\r\n\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\n\r\n### Additional information\r\n\r\nNote: If I remove the `perl` entry from packages.yaml -i.e empty packages.yaml - the correct target gets used [for all dependent packages]. Having entries for many other packages [other than perl] still gives the correct target arch for dependent packages.\r\n```console\r\n$ spack spec openmpi%gcc@7.4.0 \r\nInput spec\r\n--------------------------------\r\nopenmpi%gcc@7.4.0\r\n\r\nConcretized\r\n--------------------------------\r\n==> Warning: gcc@7.4.0 cannot build optimized binaries for \"cascadelake\". Using best target possible: \"skylake_avx512\"\r\nopenmpi@4.1.1%gcc@7.4.0~atomics~cuda~cxx~cxx_exceptions+gpfs~internal-hwloc~java~legacylaunchers~lustre~memchecker~pmi~singularity~sqlite3+static~thread_multiple+vt+wrapper-rpath fabrics=none schedulers=none arch=linux-centos7-skylake_avx512\r\n    ^hwloc@2.5.0%gcc@7.4.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml+pci+shared arch=linux-centos7-skylake_avx512\r\n        ^libpciaccess@0.16%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^libtool@2.4.6%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n                ^m4@1.4.19%gcc@7.4.0+sigsegv arch=linux-centos7-skylake_avx512\r\n                    ^libsigsegv@2.13%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^pkgconf@1.7.4%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^util-macros@1.19.1%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n        ^libxml2@2.9.10%gcc@7.4.0~python arch=linux-centos7-skylake_avx512\r\n            ^libiconv@1.16%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n            ^xz@5.2.5%gcc@7.4.0~pic libs=shared,static arch=linux-centos7-skylake_avx512\r\n            ^zlib@1.2.11%gcc@7.4.0+optimize+pic+shared arch=linux-centos7-skylake_avx512\r\n        ^ncurses@6.2%gcc@7.4.0~symlinks+termlib abi=none arch=linux-centos7-skylake_avx512\r\n    ^libevent@2.1.12%gcc@7.4.0+openssl arch=linux-centos7-skylake_avx512\r\n        ^openssl@1.1.1k%gcc@7.4.0~docs+systemcerts arch=linux-centos7-skylake_avx512\r\n            ^perl@5.34.0%gcc@7.4.0+cpanm+shared+threads arch=linux-centos7-skylake_avx512\r\n                ^berkeley-db@18.1.40%gcc@7.4.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-centos7-skylake_avx512\r\n                ^bzip2@1.0.8%gcc@7.4.0~debug~pic+shared arch=linux-centos7-skylake_avx512\r\n                    ^diffutils@3.7%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n                ^gdbm@1.19%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n                    ^readline@8.1%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n    ^numactl@2.0.14%gcc@7.4.0 patches=4e1d78cbbb85de625bad28705e748856033eaafab92a66dffd383a3d7e00cc94,62fc8a8bf7665a60e8f4c93ebbd535647cebf74198f7afafec4c085a8825c006 arch=linux-centos7-skylake_avx512\r\n        ^autoconf@2.69%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n        ^automake@1.16.3%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n    ^openssh@8.5p1%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n        ^libedit@3.1-20210216%gcc@7.4.0 arch=linux-centos7-skylake_avx512\r\n\r\n```\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n<!-- We encourage you to try, as much as possible, to reduce your problem to the minimal example that still reproduces the issue. That would help us a lot in fixing it quickly and effectively!\r\n\r\nIf you want to ask a question about the tool (how to use it, what it can currently do, etc.), try the `#general` channel on our Slack first. We have a welcoming community and chances are you'll get your reply faster and without opening an issue.\r\n\r\nOther than that, thanks for taking the time to contribute to Spack! -->\r\n",
    "user": "balay",
    "url": "https://api.github.com/repos/spack/spack/issues/24761",
    "updated_at": "2021-08-03 15:56:19",
    "created_at": "2021-07-07 19:49:02",
    "closed_at": "None",
    "state": "open",
    "title": "spack does not propagate (default) target to dependent packages - when perl is listed in packages.yaml",
    "number": 24761,
    "milestone": null,
    "labels": [
        "bug",
        "xSDK",
        "triage"
    ],
    "id": 939208466,
    "html_url": "https://github.com/spack/spack/issues/24761",
    "assignees": [],
    "comments": 3
}