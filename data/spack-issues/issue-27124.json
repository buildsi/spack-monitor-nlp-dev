{
    "body": "### Steps to reproduce\r\n\r\nI have noticed spack builds are affected based on modules loaded in your environment. To reproduce this issue here is a simple spack.yaml with a compiler definition for gcc on Perlmutter using the cray wrappers but using modules to load the appropriate environment.\r\n\r\n\r\n```\r\nsiddiq90@login37> cat spack.yaml \r\n# This is a Spack Environment file.\r\n#\r\n# It describes a set of packages to be installed, along with\r\n# configuration settings.\r\nspack:\r\n  # add package specs to the `specs` list\r\n  specs: []\r\n  compilers:\r\n   - compiler:\r\n      spec: gcc@11.2.0\r\n      paths:\r\n        cc: cc\r\n        cxx: CC\r\n        f77: ftn\r\n        fc: ftn\r\n      operating_system: sles15\r\n      modules:\r\n      - PrgEnv-gnu/8.1.0\r\n      - gcc/11.2.0\r\n      - cuda/11.3.0\r\n      - libfabric/1.11.0.4.79\r\n\r\n  view: true\r\n```\r\n\r\nNext you can create the environment wherever you have the spack.yaml\r\n\r\n```\r\nspack env create .\r\n```\r\n\r\n\r\nHere is the error i get when i install libsigsegv when i dont have any modules loaded\r\n\r\n```\r\nsiddiq90@login37> module list\r\nNo modules loaded\r\nsiddiq90@login37> spack install libsigsegv\r\n==> Installing libsigsegv-2.13-672qbf4xgvwea24ylbzn6ow32qlwl236\r\n==> No binary for libsigsegv-2.13-672qbf4xgvwea24ylbzn6ow32qlwl236 found: installing from source\r\n==> Error: CompilerAccessError: Compiler 'gcc@11.2.0' has executables that are missing or are not executable: ['CC', 'ftn', 'ftn']\r\n\r\n/global/common/software/spackecp/perlmutter/e4s-21.08/spack/lib/spack/spack/build_environment.py:1029, in _setup_pkg_and_run:\r\n       1026        tb_string = traceback.format_exc()\r\n       1027\r\n       1028        # build up some context from the offending package so we can\r\n  >>   1029        # show that, too.\r\n       1030        package_context = get_package_context(tb)\r\n       1031\r\n       1032        logfile = None\r\n```\r\n\r\nIt was not able to find the cray wrappers. Then i try with module restore which loads the startup modules that are provided by Cray and i am able to install  libsigsegv\r\n\r\n```\r\nsiddiq90@login37> module restore\r\nResetting modules to system default. Reseting $MODULEPATH back to system default. All extra directories will be removed from $MODULEPATH.\r\nsiddiq90@login37> module list\r\n\r\nCurrently Loaded Modules:\r\n  1) craype-x86-rome                                   6) nvidia/21.7           (g,c)   11) PrgEnv-nvidia/8.1.0 (cpe)\r\n  2) libfabric/1.11.0.4.79                             7) craype/2.7.10         (c)     12) cray-pmi/6.0.13\r\n  3) craype-network-ofi                                8) cray-dsmml/0.2.1              13) cray-pmi-lib/6.0.13\r\n  4) perftools-base/21.09.0                    (dev)   9) cray-mpich/8.1.9      (mpi)\r\n  5) xpmem/2.2.40-7.0.1.0_3.1__g1d7a24d.shasta        10) cray-libsci/21.08.1.2 (math)\r\n\r\n  Where:\r\n   g:     built for GPU\r\n   mpi:   MPI Providers\r\n   cpe:   Cray Programming Environment Modules\r\n   math:  Mathematical libraries\r\n   c:     Compiler\r\n   dev:   Development Tools and Programming Languages\r\n\r\n \r\n\r\nsiddiq90@login37> spack install libsigsegv\r\n==> Installing libsigsegv-2.13-672qbf4xgvwea24ylbzn6ow32qlwl236\r\n==> No binary for libsigsegv-2.13-672qbf4xgvwea24ylbzn6ow32qlwl236 found: installing from source\r\n==> Fetching https://mirror.spack.io/_source-cache/archive/be/be78ee4176b05f7c75ff03298d84874db90f4b6c9d5503f0da1226b3a3c48119.tar.gz\r\n==> No patches needed for libsigsegv\r\n==> libsigsegv: Executing phase: 'autoreconf'\r\n==> libsigsegv: Executing phase: 'configure'\r\n==> libsigsegv: Executing phase: 'build'\r\n==> libsigsegv: Executing phase: 'install'\r\n==> libsigsegv: Successfully installed libsigsegv-2.13-672qbf4xgvwea24ylbzn6ow32qlwl236\r\n  Fetch: 0.66s.  Build: 10.98s.  Total: 11.64s.\r\n[+] /global/common/software/spackecp/perlmutter/e4s-21.08/spack/opt/spack/cray-sles15-zen3/gcc-11.2.0/libsigsegv-2.13-672qbf4xgvwea24ylbzn6ow32qlwl236\r\n```\r\n\r\nI am using the spack branch https://github.com/spack/spack/tree/e4s-21.08 though i think this can be reproduced regardless of spack versions. \r\n\r\n\r\n\r\n### Error message\r\n\r\n_No response_\r\n\r\n### Information on your system\r\n\r\n```\r\nsiddiq90@login37> spack debug report\r\n* **Spack:** 0.16.2-3949-8831cb2eed\r\n* **Python:** 3.6.12\r\n* **Platform:** cray-sles15-zen3\r\n* **Concretizer:** original\r\n\r\n```\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "shahzebsiddiqui",
    "url": "https://api.github.com/repos/spack/spack/issues/27124",
    "updated_at": "2022-01-20 01:41:59",
    "created_at": "2021-11-01 16:36:11",
    "closed_at": "None",
    "state": "open",
    "title": "spack builds depended on user modules",
    "number": 27124,
    "milestone": null,
    "labels": [
        "bug",
        "triage",
        "nersc"
    ],
    "id": 1041366917,
    "html_url": "https://github.com/spack/spack/issues/27124",
    "assignees": [],
    "comments": 3
}