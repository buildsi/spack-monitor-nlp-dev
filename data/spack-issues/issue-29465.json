{
    "body": "### Steps to reproduce\n\n`spack ci rebuild` may fail to import a signing key if that signing key encodes a preference for a compression algorithm not available to the GPG where `spack ci rebuild` is run.\r\n\r\nFor example, if I generate a key using the GPG on my laptop, where `BZIP2` is a supported compression:\r\n```\r\n$laptop> gpg --version\r\ngpg (GnuPG) 2.3.2\r\nlibgcrypt 1.9.4\r\n...\r\nCompression: Uncompressed, ZIP, ZLIB, BZIP2\r\n\r\n$laptop> gpg --gen-key\r\n...\r\n\r\n$laptop> gpg --export-secret-key --armor <LAPTOP-KEYID> > laptop.privkey \r\n```\r\n\r\nThis key thus includes `BZIP2` in its list of preferred compression algorithms:\r\n```\r\n$laptop> gpg --list-packets laptop.privkey\r\n...\r\n:signature packet: algo 22, keyid EA123065E4C2285B\r\n...\r\n\thashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)\r\n...\r\n```\r\n\r\nTrying to import this key subsequently on a system where GPG doesn't support `BZIP2` compression yields an interactive prompt:\r\n```\r\n$ci-system> gpg --version\r\ngpg (GnuPG) 2.3.4\r\nlibgcrypt 1.9.4\r\n...\r\nCompression: Uncompressed, ZIP, ZLIB\r\n\r\n$ci-system> gpg --import laptop.privkey\r\ngpg: key EA123065E4C2285B: public key \"MacMiniTest\" imported\r\ngpg: key EA123065E4C2285B: secret key imported\r\ngpg: WARNING: key EA123065E4C2285B contains preferences for unavailable\r\nalgorithms on these user IDs:\r\ngpg:          \"MacMiniTest\": preference for compression algorithm 3\r\ngpg: it is strongly suggested that you update your preferences and\r\ngpg: re-distribute this key to avoid potential algorithm mismatch problems\r\n\r\nSet preference list to:\r\n     Cipher: AES256, AES192, AES, 3DES\r\n     AEAD: OCB, EAX\r\n     Digest: SHA512, SHA384, SHA256, SHA224, SHA1\r\n     Compression: ZLIB, ZIP, Uncompressed\r\n     Features: MDC, AEAD, Keyserver no-modify\r\nReally update the preferences? (y/N)\r\n```\r\n\r\nThe interactive prompt will cause problems for `spack ci rebuild` and other Spack routines relying on non-interactive GPG import:\r\n```\r\n$ci-system> spack -d python\r\n==> [2022-03-11-09:22:44.750258] Imported python from built-in commands\r\n==> [2022-03-11-09:22:44.750636] Imported python from built-in commands\r\nSpack version 0.17.1\r\nPython 3.8.9, Darwin arm64\r\n\r\n>>> import spack\r\n>>> spack_gpg = spack.main.SpackCommand('gpg')\r\n==> [2022-03-11-09:24:10.169150] Imported gpg from built-in commands\r\n==> [2022-03-11-09:24:10.176372] Imported gpg from built-in commands\r\n\r\n>>> spack_gpg('trust', 'laptop.privkey', output=str)\r\n\r\nSet preference list to:\r\n     Cipher: AES256, AES192, AES, 3DES\r\n     AEAD: OCB, EAX\r\n     Digest: SHA512, SHA384, SHA256, SHA224, SHA1\r\n     Compression: ZLIB, ZIP, Uncompressed\r\n     Features: MDC, AEAD, Keyserver no-modify\r\nReally update the preferences? (y/N)\r\n```\r\n\r\nHere's what the GitLab pipeline log would look like if `spack ci rebuild` were run under these circumstances:\r\n```\r\n$ spack -d ci rebuild ...\r\n...\r\n==> [2022-03-11-08:22:19.287928] ci.import_signing_key() will attempt to import a key\r\n==> [2022-03-11-08:22:19.829652] spack gpg list:\r\n==> [2022-03-11-08:22:19.829783] gpg: keybox '/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/opt/spack/gpg/pubring.kbx' created\r\ngpg: /Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/opt/spack/gpg/trustdb.gpg: trustdb created\r\n\r\n==> [2022-03-11-08:22:20.315908] ProcessError: Command exited with status 2:\r\n    '/Users/eugeneswalker/.spack/bootstrap/store/darwin-monterey-aarch64/apple-clang-13.0.0/gnupg-2.3.4-4rlspbhkcvkxnblt63vtgddosm4toxb3/bin/gpg2' '--import' '/var/folders/9z/kbwgst7n3yj5cqnblzh9mk8c0000h0/T/tmpevdrqbfj/signing_key'\r\n==> [2022-03-11-08:22:20.316680] ProcessError: Command exited with status 2:\r\n    '/Users/eugeneswalker/.spack/bootstrap/store/darwin-monterey-aarch64/apple-clang-13.0.0/gnupg-2.3.4-4rlspbhkcvkxnblt63vtgddosm4toxb3/bin/gpg2' '--import' '/var/folders/9z/kbwgst7n3yj5cqnblzh9mk8c0000h0/T/tmpevdrqbfj/signing_key'\r\n==> [2022-03-11-08:22:20.316763] Error: Command exited with status 2:\r\n'/Users/eugeneswalker/.spack/bootstrap/store/darwin-monterey-aarch64/apple-clang-13.0.0/gnupg-2.3.4-4rlspbhkcvkxnblt63vtgddosm4toxb3/bin/gpg2' '--import' '/var/folders/9z/kbwgst7n3yj5cqnblzh9mk8c0000h0/T/tmpevdrqbfj/signing_key'\r\nTraceback (most recent call last):\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/main.py\", line 916, in main\r\n    return _main(argv)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/main.py\", line 871, in _main\r\n    return finish_parse_and_run(parser, cmd_name, env_format_error)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/main.py\", line 899, in finish_parse_and_run\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/main.py\", line 556, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/cmd/ci.py\", line 645, in ci\r\n    return args.func(args)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/cmd/ci.py\", line 330, in ci_rebuild\r\n    spack_ci.import_signing_key(signing_key)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/ci.py\", line 1195, in import_signing_key\r\n    key_import_output = spack_gpg('trust', sign_key_path, output=str)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/main.py\", line 615, in __call__\r\n    self.returncode = _invoke_command(\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/main.py\", line 556, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/cmd/gpg.py\", line 212, in gpg\r\n    args.func(args)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/cmd/gpg.py\", line 170, in gpg_trust\r\n    spack.util.gpg.trust(args.keyfile)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/util/gpg.py\", line 96, in _wrapped\r\n    return func(*args, **kwargs)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/util/gpg.py\", line 245, in trust\r\n    GPG('--import', keyfile)\r\n  File \"/Users/eugeneswalker/builds/xsd85sz4/0/uo/Mac-Mini-Spack-Test/spack/lib/spack/spack/util/executable.py\", line 225, in __call__\r\n    raise ProcessError('Command exited with status %d:' %\r\nspack.util.executable.ProcessError: Command exited with status 2:\r\n    '/Users/eugeneswalker/.spack/bootstrap/store/darwin-monterey-aarch64/apple-clang-13.0.0/gnupg-2.3.4-4rlspbhkcvkxnblt63vtgddosm4toxb3/bin/gpg2' '--import' '/var/folders/9z/kbwgst7n3yj5cqnblzh9mk8c0000h0/T/tmpevdrqbfj/signing_key'\r\n```\r\n\r\nThis issue arose a few years ago: https://github.com/spack/spack/issues/15366\r\n\r\nNot sure what, if anything, we can/should do about this, other than making sure people are aware that they need to watch out for this?\r\n\r\nFYI to: @adamjstewart @scottwittenburg @wspear @shahzebsiddiqui @opadron \n\n### Error message\n\n_No response_\n\n### Information on your system\n\n* **Spack:** 0.17.1-1531-7ad8937d7a\r\n* **Python:** 3.8.9\r\n* **Platform:** darwin-monterey-m1\r\n* **Concretizer:** clingo\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/29465",
    "updated_at": "2022-03-11 19:14:42",
    "created_at": "2022-03-11 17:33:34",
    "closed_at": "None",
    "state": "open",
    "title": "spack ci rebuild: import_signing_key: compression algorithm mismatch yields interactive prompt, causes non-zero exit",
    "number": 29465,
    "milestone": null,
    "labels": [
        "bug",
        "triage",
        "e4s",
        "pipelines"
    ],
    "id": 1166681358,
    "html_url": "https://github.com/spack/spack/issues/29465",
    "assignees": [],
    "comments": 1
}