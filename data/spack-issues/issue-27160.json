{
    "body": "### Steps to reproduce the issue\n\n`kokkos@3.4.01 +tests +debug +rocm amdgpu_target=gfx908` build fails using:\r\n* `spack@develop` (372fc78e9869e36c54ac86bfd20e2447df0a8405 from `Tue Nov 2 19:37:23 2021 +0800`)\r\n* Ubuntu 20.04, ROCM 4.3.1, GCC 11\r\n\r\nConcrete spec: [kokkos.spec.yaml.txt](https://github.com/spack/spack/files/7462873/kokkos.spec.yaml.txt)\r\n \r\nConcretization:\r\n```\r\nroot@instinct:/# spack spec -I kokkos +debug +tests +rocm amdgpu_target=gfx908\r\nInput spec\r\n--------------------------------\r\n -   kokkos+debug+rocm+tests amdgpu_target=gfx908\r\n\r\nConcretized\r\n--------------------------------\r\n -   kokkos@3.4.01%gcc@11.1.0~aggressive_vectorization~compiler_warnings~cuda~cuda_constexpr~cuda_lambda~cuda_ldg_intrinsic~cuda_relocatable_device_code~cuda_uvm+debug~debug_bounds_check~debug_dualview_modify_check~deprecated_code~examples~explicit_instantiation~hpx~hpx_async_dispatch~hwloc~ipo~memkind~numactl~openmp~pic+profiling~profiling_load_print~pthread~qthread+rocm+serial+shared~sycl+tests~tuning~wrapper amdgpu_target=gfx908 build_type=RelWithDebInfo cuda_arch=none std=14 arch=linux-ubuntu20.04-broadwell\r\n[+]      ^cmake@3.21.4%gcc@11.1.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-broadwell\r\n[+]          ^ncurses@6.2%gcc@11.1.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-broadwell\r\n[+]              ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu20.04-broadwell\r\n[+]          ^openssl@1.1.1l%gcc@11.1.0~docs certs=system arch=linux-ubuntu20.04-broadwell\r\n[+]              ^perl@5.34.0%gcc@11.1.0+cpanm+shared+threads arch=linux-ubuntu20.04-broadwell\r\n[+]                  ^berkeley-db@18.1.40%gcc@11.1.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu20.04-broadwell\r\n[+]                  ^bzip2@1.0.8%gcc@11.1.0~debug~pic+shared arch=linux-ubuntu20.04-broadwell\r\n[+]                      ^diffutils@3.8%gcc@11.1.0 arch=linux-ubuntu20.04-broadwell\r\n[+]                          ^libiconv@1.16%gcc@11.1.0 libs=shared,static arch=linux-ubuntu20.04-broadwell\r\n[+]                  ^gdbm@1.19%gcc@11.1.0 arch=linux-ubuntu20.04-broadwell\r\n[+]                      ^readline@8.1%gcc@11.1.0 arch=linux-ubuntu20.04-broadwell\r\n[+]                  ^zlib@1.2.11%gcc@11.1.0+optimize+pic+shared arch=linux-ubuntu20.04-broadwell\r\n[+]      ^hip@4.3.1%gcc@11.1.0~ipo build_type=Release patches=2a4190477b7d9206b9cd8d70770ba0bc007273cbe54772efb12f9ca2e37c0392,99190b4616edb362d48f9b265c3018a3c6339481b0729d9fe46185fca25bc54b,e276c4acf3d37712b6bea306fea34f539d3c4f743471e9da208b5eb17b16ae67 arch=linux-ubuntu20.04-broadwell\r\n[+]      ^hsa-rocr-dev@4.3.1%gcc@11.1.0+image~ipo+shared build_type=Release patches=71e6851d9be8113bfb8d71b66a3171e0d0401bae5e6f161c9e7fe32558261a46 arch=linux-ubuntu20.04-broadwell\r\n[+]      ^llvm-amdgpu@4.3.1%gcc@11.1.0~ipo+openmp+rocm-device-libs build_type=Release patches=d999f3b235e655ee07f6dd2590302082feaa06d32c5c6b53aae9c5cf1e45b644 arch=linux-ubuntu20.04-broadwell\r\n```\r\n\r\nBuild output:\r\n```\r\n$> spack install -f kokkos.spec.yaml\r\n...\r\n==> Installing kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4\r\n==> No binary for kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4 found: installing from source\r\n==> Using cached archive: /spack/var/spack/cache/_source-cache/archive/14/146d5e233228e75ef59ca497e8f5872d9b272cb93e8e9cdfe05ad34a23f483d1.tar.gz\r\n==> No patches needed for kokkos\r\n==> kokkos: Executing phase: 'cmake'\r\n==> kokkos: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\n\r\n8 errors found in build log:\r\n     528    make[2]: Entering directory '/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv'\r\n     529    [ 23%] Building CXX object core/unit_test/CMakeFiles/KokkosCore_ProfilingAllCalls.dir/tools/TestAllCalls.cpp.o\r\n     530    cd /tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv/core/unit_test && /opt/rocm-4.3.1/hip/bin/hipcc -DGTEST_HAS_P\r\n            THREAD=0 -DGTEST_HAS_TR1_TUPLE=0 -DKOKKOS_DEPENDENCE -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/tpls/gtest -I/tmp/r\r\n            oot/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv/core/unit_test -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnk\r\n            tvgqly2odelqycjsrw3ccymjnh4/spack-src/core/unit_test -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/core/unit_test/cate\r\n            gory_files -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j\r\n            2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv/core/src -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/core/src -I\r\n            /tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv/containers/src -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01\r\n            -j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/containers/src -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-build-j2nnktv/alg\r\n            orithms/src -I/tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/algorithms/src -O2 -g -DNDEBUG -fPIE -march=core-avx2 -mtune\r\n            =core-avx2 -mrtm -fno-gpu-rdc --amdgpu-target=gfx908 -std=gnu++14 -MD -MT core/unit_test/CMakeFiles/KokkosCore_ProfilingAllCalls.dir/tools/TestAllCalls.cpp.o -MF CMa\r\n            keFiles/KokkosCore_ProfilingAllCalls.dir/tools/TestAllCalls.cpp.o.d -o CMakeFiles/KokkosCore_ProfilingAllCalls.dir/tools/TestAllCalls.cpp.o -c /tmp/root/spack-stage/\r\n            spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/core/unit_test/tools/TestAllCalls.cpp\r\n     531    In file included from <built-in>:1:\r\n     532    In file included from /opt/rocm-4.3.1/llvm/lib/clang/13.0.0/include/__clang_hip_runtime_wrapper.h:75:\r\n     533    In file included from /opt/rocm-4.3.1/llvm/lib/clang/13.0.0/include/cuda_wrappers/complex:75:\r\n  >> 534    /usr/lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/complex:703:7: error: __host__ __device__ function '__failed_assertion' cannot overload __host__ function\r\n             '__failed_assertion'\r\n     535          __glibcxx_assert( __rho >= 0 );\r\n     536          ^\r\n     537    /usr/lib/gcc/x86_64-linux-gnu/11/../../../../include/x86_64-linux-gnu/c++/11/bits/c++config.h:754:5: note: expanded from macro '__glibcxx_assert'\r\n     538        __glibcxx_assert_1(_Condition)        \\\r\n     539        ^\r\n     540    /usr/lib/gcc/x86_64-linux-gnu/11/../../../../include/x86_64-linux-gnu/c++/11/bits/c++config.h:743:13: note: expanded from macro '__glibcxx_assert_1'\r\n\r\n     ...\r\n\r\n     558    /usr/lib/gcc/x86_64-linux-gnu/11/../../../../include/x86_64-linux-gnu/c++/11/bits/c++config.h:743:13: note: expanded from macro '__glibcxx_assert_1'\r\n     559           void __failed_assertion();       \\\r\n     560                ^\r\n     561    In file included from <built-in>:1:\r\n     562    In file included from /opt/rocm-4.3.1/llvm/lib/clang/13.0.0/include/__clang_hip_runtime_wrapper.h:75:\r\n     563    In file included from /opt/rocm-4.3.1/llvm/lib/clang/13.0.0/include/cuda_wrappers/complex:75:\r\n  >> 564    /usr/lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/complex:778:14: error: no matching function for call to 'polar'\r\n     565        { return std::polar<_Tp>(exp(__z.real()), __z.imag()); }\r\n     566                 ^~~~~~~~~~~~~~~\r\n     567    /usr/lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/complex:797:43: note: in instantiation of function template specialization 'std::__complex_exp<double>' r\r\n            equested here\r\n     568        exp(const complex<_Tp>& __z) { return __complex_exp(__z); }\r\n     569                                              ^\r\n     570    /tmp/root/spack-stage/spack-stage-kokkos-3.4.01-j2nnktvgqly2odelqycjsrw3ccymjnh4/spack-src/core/unit_test/TestComplex.hpp:317:14: note: in instantiation of function\r\n            template specialization 'std::exp<double>' requested here\r\n...\r\n```\r\n\n\n### Information on your system\n\n* **Spack:** 0.16.3-5185-372fc78e98\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-broadwell\r\n* **Concretizer:** clingo\n\n### Additional information\n\n[kokkos-build-out.txt](https://github.com/spack/spack/files/7462898/kokkos-build-out.txt)\r\n[kokkos-build-env.txt](https://github.com/spack/spack/files/7462899/kokkos-build-env.txt)\r\n\r\n@DavidPoliakoff\r\n@jciesko\r\n\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\n- [X] I have uploaded the build log and environment files\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/27160",
    "updated_at": "2021-11-02 17:44:50",
    "created_at": "2021-11-02 17:38:03",
    "closed_at": "None",
    "state": "open",
    "title": "kokkos@3.4.01 +tests +rocm build fails: cannot overload __host__ function '__failed_assertion'",
    "number": 27160,
    "milestone": null,
    "labels": [
        "build-error",
        "e4s",
        "AMD",
        "ROCm/hip"
    ],
    "id": 1042639715,
    "html_url": "https://github.com/spack/spack/issues/27160",
    "assignees": [],
    "comments": 1
}