{
    "body": "### Problem Summary\r\n\r\nThe problem is that running `spack buildcache update-index` repeatedly on the same set of `spec.yaml` files might result in splicing the same dependencies back and forth forever.  Here's some excerpted output from several back-to-back runs to illustrate:\r\n\r\n```\r\n$ spack -d buildcache update-index --mirror-url <put-url-here>\r\n...\r\n==> [2021-09-07-17:50:28.918187] Specs sorted by number of dependencies:\r\n==> [2021-09-07-17:50:28.918229]   ncurses/uba77xw -> 1\r\n==> [2021-09-07-17:50:28.918505]   libtool/jdxbjft -> 2\r\n==> [2021-09-07-17:50:28.918674]   libpciaccess/bob4o5m -> 5\r\n==> [2021-09-07-17:50:28.918843]   hwloc/bkzrdnv -> 11\r\n==> [2021-09-07-17:50:28.918909]     needs the following deps spliced:\r\n==> [2021-09-07-17:50:28.918950]       libpciaccess/bob4o5m\r\n==> [2021-09-07-17:50:29.179143]     spliced and wrote file:///Users/scott/Documents/spack/shared_pr_mirror_stuff/smaller_repro/mirror/build_cache/linux-ubuntu18.04-x86_64-gcc-7.5.0-hwloc-2.5.0-bkzrdnv2smjzsvpmwjugmvjtyupp7zhf.spec.yaml\r\n```\r\n\r\nFrom the output we can see that spack spliced a different `libpciaccess` into the dependencies of `hwloc`.  So let's run the same command again.  Since the dependency `spec.yaml` files have not changed, only the `hwloc` has been updated, you might think spack would find there are no more specs that require splicing.\r\n\r\n```\r\n$ spack -d buildcache update-index --mirror-url <put-url-here>\r\n==> [2021-09-07-17:50:41.676978] Specs sorted by number of dependencies:\r\n==> [2021-09-07-17:50:41.677019]   ncurses/uba77xw -> 1\r\n==> [2021-09-07-17:50:41.677297]   libtool/jdxbjft -> 2\r\n==> [2021-09-07-17:50:41.677471]   libpciaccess/bob4o5m -> 5\r\n==> [2021-09-07-17:50:41.677644]   hwloc/bkzrdnv -> 11\r\n==> [2021-09-07-17:50:41.677771]     needs the following deps spliced:\r\n==> [2021-09-07-17:50:41.677845]       ncurses/uba77xw\r\n==> [2021-09-07-17:50:41.934255]     spliced and wrote file:///Users/scott/Documents/spack/shared_pr_mirror_stuff/smaller_repro/mirror/build_cache/linux-ubuntu18.04-x86_64-gcc-7.5.0-hwloc-2.5.0-bkzrdnv2smjzsvpmwjugmvjtyupp7zhf.spec.yaml\r\n```\r\n\r\n This time spack had to splice a different `ncurses` into the dependencies of the same spec, `hwloc`.  If we run the command again at this point, spack will again splice in the `libpciaccess` dep of `hwloc`, and running it again after that will result in spack splicing in the `ncurses` dep of `hwloc` again, and so forth forever.\r\n\r\nTo me, the problem seems to be that the `libpciaccess` and `ncurses` spec yaml files depend on different versions of `pkgconf`, but because `pkgconf` is a build dependency of both, changing its version doesn't change the dag hash of the dependents.  \r\n\r\n### Steps to reproduce\r\n\r\nTo reproduce the problem, download the four concrete spec yaml files which I took from an actual spack binary mirror we use in gitlab pipelines for PR/develop testing.  You have to change the names to remove the `.txt` (which we are forced to add before github will allow us to upload them).  Then do:\r\n\r\n```\r\nmkdir -p /Users/<you>/testing/backups\r\ncp ~/Downloads/*.spec.yaml /Users/<you>/testing/backups/\r\nmkdir -p /Users/<you>/testing/mirror/build_cache\r\ncp ~/Downloads/*.spec.yaml /Users/<you>/testing/mirror/build_cache/\r\nspack -d buildcache update-index --mirror-url file:///Users/<you>/testing/mirror\r\n```\r\n\r\nThe extra copies are so you can be sure to keep the originals pristine for comparison or replacement, as `spack buildcache update-index` can edit them in theory (and does edit the `hwloc` spec in this example).  If you run the last command above, over and over, you should see spack splicing in `libpciaccess`, then splicing in `nurses`, then `libpciaccess` again, etc....\r\n\r\n[linux-ubuntu18.04-x86_64-gcc-7.5.0-hwloc-2.5.0-bkzrdnv2smjzsvpmwjugmvjtyupp7zhf.spec.yaml.txt](https://github.com/spack/spack/files/7125063/linux-ubuntu18.04-x86_64-gcc-7.5.0-hwloc-2.5.0-bkzrdnv2smjzsvpmwjugmvjtyupp7zhf.spec.yaml.txt)\r\n[linux-ubuntu18.04-x86_64-gcc-7.5.0-libpciaccess-0.16-bob4o5m3uku6vtdil5imasprgy775zg7.spec.yaml.txt](https://github.com/spack/spack/files/7125064/linux-ubuntu18.04-x86_64-gcc-7.5.0-libpciaccess-0.16-bob4o5m3uku6vtdil5imasprgy775zg7.spec.yaml.txt)\r\n[linux-ubuntu18.04-x86_64-gcc-7.5.0-libtool-2.4.6-jdxbjftheiotj6solpomva7dowrhlerl.spec.yaml.txt](https://github.com/spack/spack/files/7125065/linux-ubuntu18.04-x86_64-gcc-7.5.0-libtool-2.4.6-jdxbjftheiotj6solpomva7dowrhlerl.spec.yaml.txt)\r\n[linux-ubuntu18.04-x86_64-gcc-7.5.0-ncurses-6.2-uba77xwfqaytmx3v5eye43deqq5rqsun.spec.yaml.txt](https://github.com/spack/spack/files/7125066/linux-ubuntu18.04-x86_64-gcc-7.5.0-ncurses-6.2-uba77xwfqaytmx3v5eye43deqq5rqsun.spec.yaml.txt)\r\n\r\n### Information on your system\r\n\r\nWhile the attached spec.yaml files are from a linux os, they can be copied to any system to test the `spack buildcache update-index` command.  I ran them on my macbook.\r\n\r\n```\r\n$ spack debug report\r\n* **Spack:** 0.16.2-4176-c6e538583f\r\n* **Python:** 3.7.9\r\n* **Platform:** darwin-catalina-skylake\r\n* **Concretizer:** original\r\n```\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "scottwittenburg",
    "url": "https://api.github.com/repos/spack/spack/issues/25829",
    "updated_at": "2021-09-10 17:48:38",
    "created_at": "2021-09-08 01:21:14",
    "closed_at": "None",
    "state": "open",
    "title": "buildcache update-index causes build dependency thrashing",
    "number": 25829,
    "milestone": null,
    "labels": [
        "bug",
        "hashes",
        "buildcache",
        "triage"
    ],
    "id": 990527789,
    "html_url": "https://github.com/spack/spack/issues/25829",
    "assignees": [],
    "comments": 3
}