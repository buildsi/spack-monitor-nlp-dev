{
    "body": "### Steps to reproduce the issue\r\n\r\n`llvm@13.0.0 +cuda cuda_arch=80 +omp_as_runtime` build fails because it can't find `libelf` header, despite `libelf` being declared an explicit dependency in `llvm`'s package.py. There is no problem if I build `~cuda +omp_as_runtime`. It looks like this issue has come up before:\r\n* https://github.com/spack/spack/blob/develop/var/spack/repos/builtin/packages/llvm/package.py#L547-L549\r\n\r\nUsing:\r\n* `spack@develop` (f6802b733a8889e73edeaa6c80d2077ee86bc490 from `Mon Dec 13 11:45:31 2021 +0100`)\r\n* Ubuntu 20.04, GCC 11.1.0\r\n* CUDA 11.5.1\r\n\r\n**Concrete spec:** [llvm.spec.json.txt](https://github.com/spack/spack/files/7707304/llvm.spec.json.txt)\r\n\r\n**Concretization**\r\n```\r\nllvm@13.0.0%gcc@11.1.0~all_targets+clang~code_signing+compiler-rt+cuda~flang+gold+internal_unwind~ipo+libcxx~link_llvm_dylib+lld+lldb~llvm_dylib~mlir+omp_as_runtime~omp_debug~omp_tsan+polly~python~shared_libs~split_dwarf~z3 build_type=Release cuda_arch=80 version_suffix=none arch=linux-ubuntu20.04-x86_64\r\n    ^binutils@2.36.1%gcc@11.1.0~gas+gold+headers~interwork+ld+libiberty~lto~nls+plugins libs=shared,static patches=a51b7bf4607645235be01683a3e2deb3a87d767cc124ea4ef6febf9f32abf4a7 arch=linux-ubuntu20.04-x86_64\r\n        ^diffutils@3.8%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n            ^libiconv@1.16%gcc@11.1.0 libs=shared,static arch=linux-ubuntu20.04-x86_64\r\n        ^zlib@1.2.11%gcc@11.1.0+optimize+pic+shared arch=linux-ubuntu20.04-x86_64\r\n    ^cmake@3.21.4%gcc@11.1.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-x86_64\r\n        ^ncurses@6.2%gcc@11.1.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-x86_64\r\n            ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n        ^openssl@1.1.1l%gcc@11.1.0~docs certs=system arch=linux-ubuntu20.04-x86_64\r\n            ^perl@5.34.0%gcc@11.1.0+cpanm+shared+threads arch=linux-ubuntu20.04-x86_64\r\n                ^berkeley-db@18.1.40%gcc@11.1.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu20.04-x86_64\r\n                ^bzip2@1.0.8%gcc@11.1.0~debug~pic+shared arch=linux-ubuntu20.04-x86_64\r\n                ^gdbm@1.19%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n                    ^readline@8.1%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n    ^cuda@11.5.1%gcc@11.1.0~dev arch=linux-ubuntu20.04-x86_64\r\n        ^libxml2@2.9.12%gcc@11.1.0~python arch=linux-ubuntu20.04-x86_64\r\n            ^xz@5.2.5%gcc@11.1.0+pic libs=shared,static arch=linux-ubuntu20.04-x86_64\r\n    ^hwloc@2.6.0%gcc@11.1.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml~opencl+pci~rocm+shared arch=linux-ubuntu20.04-x86_64\r\n        ^libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n            ^libtool@2.4.6%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n                ^m4@1.4.19%gcc@11.1.0+sigsegv patches=9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573,bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89 arch=linux-ubuntu20.04-x86_64\r\n                    ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n            ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n    ^libedit@3.1-20210216%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n    ^libelf@0.8.13%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n    ^libffi@3.3%gcc@11.1.0 patches=26f26c6f29a7ce9bf370ad3ab2610f99365b4bdd7b82e7c31df41a3370d685c0 arch=linux-ubuntu20.04-x86_64\r\n    ^ninja@1.10.2%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n        ^python@3.8.12%gcc@11.1.0+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4+uuid+zlib patches=0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87,4c2457325f2b608b1b6a2c63087df8c26e07db3e3d493caf36a56f0ecf6fb768,f2fd060afc4b4618fe8104c4c5d771f36dc55b1db5a4623785a4ea707ec72fb4 arch=linux-ubuntu20.04-x86_64\r\n            ^expat@2.4.1%gcc@11.1.0+libbsd arch=linux-ubuntu20.04-x86_64\r\n                ^libbsd@0.11.3%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n                    ^libmd@1.0.3%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n            ^gettext@0.21%gcc@11.1.0+bzip2+curses+git~libunistring+libxml2+tar+xz arch=linux-ubuntu20.04-x86_64\r\n                ^tar@1.34%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n            ^sqlite@3.36.0%gcc@11.1.0+column_metadata+fts~functions~rtree arch=linux-ubuntu20.04-x86_64\r\n            ^util-linux-uuid@2.36.2%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n    ^perl-data-dumper@2.173%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n    ^swig@4.0.2%gcc@11.1.0 arch=linux-ubuntu20.04-x86_64\r\n        ^pcre@8.44%gcc@11.1.0~jit+multibyte+utf arch=linux-ubuntu20.04-x86_64\r\n```\r\n\r\n**Installation**\r\n```\r\n$> spack install -f ./llvm.spec.json\r\n...\r\n==> Installing llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d\r\n==> No binary for llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d found: installing from source\r\n==> Fetching https://mirror.spack.io/_source-cache/archive/a1/a1131358f1f9f819df73fa6bff505f2c49d176e9eef0a3aedd1fdbce3b4630e8.tar.gz\r\n==> No patches needed for llvm\r\n==> llvm: Executing phase: 'cmake'\r\n==> llvm: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 1:\r\n    'ninja' '-j16' '-v'\r\n\r\n5 errors found in build log:\r\n     30643    }\r\n     30644    ^\r\n     30645    2 warnings generated.\r\n     30646    [157/239] Generating linkout.cuda.gfx700.bc\r\n     30647    [158/239] Generating linkout.cuda.gfx803.bc\r\n     30648    [159/239] Building CXX object openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir/impl/system.cpp.o\r\n  >> 30649    FAILED: openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir/impl/system.cpp.o\r\n     30650    /tmp/root/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-build-2rff2x2/./bin/clang++ --target=x86_64-unk\r\n              nown-linux-gnu -DTARGET_NAME=AMDGPU -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -Domptarget_rtl_amdgpu_EXP\r\n              ORTS -I/tmp/root/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-src/openmp/libomptarget/include -I/tmp/r\r\n              oot/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-src/openmp/libomptarget/plugins/amdgpu/impl -I/tmp/ro\r\n              ot/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-src/llvm/include -I/tmp/root/spack-stage/spack-stage-l\r\n              lvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-build-2rff2x2/include -I/tmp/root/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql7\r\n              3denonwehj5omq6jyd4d/spack-src/openmp/libomptarget/plugins/amdgpu/dynamic_hsa -I/tmp/root/spack-stage/spack-stage-llvm-13.0.0-2rff2x\r\n              22aql73denonwehj5omq6jyd4d/spack-src/openmp/libomptarget/plugins/common/elf_common -isystem /spack/opt/spack/linux-ubuntu20.04-x86_6\r\n              4/gcc-11.1.0/zlib-1.2.11-civxkiagoyviqxb77hb2zhuzea3jhxsg/include -std=c++11 -fPIC -fno-semantic-interposition -fvisibility-inlines-\r\n              hidden -Werror=date-time -Werror=unguarded-availability-new -Wall -Wextra -Wno-unused-parameter -Wwrite-strings -Wcast-qual -Wmissin\r\n              g-field-initializers -Wimplicit-fallthrough -Wcovered-switch-default -Wno-noexcept-type -Wnon-virtual-dtor -Wdelete-non-virtual-dtor\r\n               -Wsuggest-override -Wno-comment -Wstring-conversion -Wmisleading-indentation -fdiagnostics-color -ffunction-sections -fdata-section\r\n              s -Wall -Wcast-qual -Wformat-pedantic -Wimplicit-fallthrough -Wsign-compare -Wno-extra -Wno-pedantic -std=c++14 -O3 -DNDEBUG -fPIC -\r\n              MD -MT openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir/impl/system.cpp.o -MF openmp/libomptarget/plugins/amdg\r\n              pu/CMakeFiles/omptarget.rtl.amdgpu.dir/impl/system.cpp.o.d -o openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir\r\n              /impl/system.cpp.o -c /tmp/root/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-src/openmp/libomptarget/p\r\n              lugins/amdgpu/impl/system.cpp\r\n  >> 30651    /tmp/root/spack-stage/spack-stage-llvm-13.0.0-2rff2x22aql73denonwehj5omq6jyd4d/spack-src/openmp/libomptarget/plugins/amdgpu/impl/sys\r\n              tem.cpp:8:10: fatal error: 'libelf.h' file not found\r\n     30652    #include <libelf.h>\r\n     30653             ^~~~~~~~~~\r\n     30654    1 error generated.\r\n     30655    [160/239] Generating loop.gfx902.bc\r\n     30656    [161/239] Generating linkout.cuda.gfx900.bc\r\n     30657    [162/239] Building CXX object openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir/impl/atmi.cpp.o\r\n\r\n     ...\r\n\r\n     30661    [166/239] Building CXX object openmp/libomptarget/tools/deviceinfo/CMakeFiles/llvm-omp-device-info.dir/llvm-omp-device-info.cpp.o\r\n     30662    [167/239] Generating libomptarget-amdgcn-gfx700.bc\r\n     30663    [168/239] Generating libomptarget-amdgcn-gfx701.bc\r\n     30664    [169/239] Building LLVM bitcode Workshare.cpp-sm_80.bc\r\n     30665    [170/239] Generating libomptarget-amdgcn-gfx803.bc\r\n     30666    [171/239] Building CXX object openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir/src/rtl.cpp.o\r\n  >> 30667    FAILED: openmp/libomptarget/plugins/amdgpu/CMakeFiles/omptarget.rtl.amdgpu.dir/src/rtl.cpp.o\r\n...\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.0-477-98c3cbda9c\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-cascadelake\r\n* **Concretizer:** clingo\r\n\r\n### Additional information\r\n\r\n[spack-build-env.txt](https://github.com/spack/spack/files/7713327/spack-build-env.txt)\r\n[spack-build-out.txt](https://github.com/spack/spack/files/7713329/spack-build-out.txt)\r\n[spack-build-01-cmake-out.txt](https://github.com/spack/spack/files/7713333/spack-build-01-cmake-out.txt)\r\n\r\n@sethrj \r\n@haampie\r\n@trws\r\n@vlkale\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\r\n- [X] I have uploaded the build log and environment files\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/27999",
    "updated_at": "2021-12-14 21:08:14",
    "created_at": "2021-12-14 16:53:38",
    "closed_at": "None",
    "state": "open",
    "title": "llvm +cuda build fails: openmp/libomptarget/plugins/amdgpu/impl/sys tem.cpp:8:10: libelf.h file not found",
    "number": 27999,
    "milestone": null,
    "labels": [
        "build-error",
        "cuda",
        "e4s"
    ],
    "id": 1079995085,
    "html_url": "https://github.com/spack/spack/issues/27999",
    "assignees": [],
    "comments": 4
}