{
    "body": "### Steps to reproduce the issue\r\n\r\nI'm trying to narrow down an issue in `spack ci rebuild` for which #17536 should be a solution, but it seems to not entirely fix everything.\r\n\r\nI believe the issue is when you install a package (e.g. `curl`) which has dependencies in common with a compiler (e.g. for gcc it is perl, zlib) it will only install one version of perl, say `perl%gcc@7.5.0`, but not the spec compiled with the new compiler `perl%gcc@10.1.0`.\r\n\r\nIt seems the `spack install`command will fail the first time, but will not fail if I repeat it once more\r\n\r\nIf you want to try reproduce this, please use the `stabbles/spack-fix` docker image, since it contains the fixes from #17536 and more, and do e.g. ```docker run -it --rm --entrypoint=\"\" -v `pwd`:/workspace stabbles/spack-fix /bin/bash``` and run the following:\r\n\r\n```console\r\n$ cd /workspace\r\n$ ls\r\nconfig.yaml  curl.yaml  run.sh  spack.asc\r\n$ cat config.yaml \r\nconfig:\r\n    install_missing_compilers: True\r\n$ cat run.sh\r\n#!/bin/bash\r\n\r\nunset MODULEPATH\r\nexport AWS_ACCESS_KEY_ID=xxxx\r\nexport AWS_SECRET_ACCESS_KEY=xxxx\r\nexport S3_ENDPOINT_URL=http://148.187.98.133:9000\r\n\r\ncd /workspace\r\nspack gpg trust spack.asc\r\nspack mirror add minio s3://spack\r\ncp /workspace/config.yaml /opt/spack/etc/spack/config.yaml\r\n'/opt/spack/bin/spack' '-d' 'install' '--keep-stage' '--cache-only' '--only' 'dependencies' './curl.yaml'\r\n$ cat spack.asc\r\n-----BEGIN PGP PUBLIC KEY BLOCK-----\r\n\r\n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\r\n=sqpd\r\n-----END PGP PUBLIC KEY BLOCK-----\r\n\r\n```\r\n\r\nThe curl.yaml file can be downloaded here: https://gitlab.com/cscs-ci/ci-testing/spack-ci/-/jobs/639550384/artifacts/raw/jobs_scratch_dir/specs/curl.yaml\r\n\r\n### Error Message\r\n\r\nThe **first** time I run `./run.sh` it will error:\r\n\r\n```\r\n$ ./run.sh\r\n...\r\n==> [2020-07-15-13:12:09.000894, 393] Error: Detected uninstalled dependencies for openssl: {'perl', 'zlib', 'gcc'}\r\n==> [2020-07-15-13:12:09.000981, 393] InstallError: Cannot proceed with openssl: 3 uninstalled dependencies: perl,zlib,gcc\r\n==> [2020-07-15-13:12:09.001019, 393] Error: Cannot proceed with openssl: 3 uninstalled dependencies: perl,zlib,gcc\r\nTraceback (most recent call last):\r\n  File \"/opt/spack/lib/spack/spack/main.py\", line 761, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/opt/spack/lib/spack/spack/main.py\", line 489, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/opt/spack/lib/spack/spack/cmd/install.py\", line 397, in install\r\n    install_spec(args, kwargs, abstract, concrete)\r\n  File \"/opt/spack/lib/spack/spack/cmd/install.py\", line 243, in install_spec\r\n    spec.package.do_install(**kwargs)\r\n  File \"/opt/spack/lib/spack/spack/package.py\", line 1476, in do_install\r\n    builder.install(**kwargs)\r\n  File \"/opt/spack/lib/spack/spack/installer.py\", line 1456, in install\r\n    ','.join(task.uninstalled_deps)))\r\nspack.installer.InstallError: Cannot proceed with openssl: 3 uninstalled dependencies: perl,zlib,gcc\r\n```\r\n\r\nThe **second** time it is fine and installs the missing specs:\r\n```\r\n$ ./run.sh\r\n...\r\n$ spack find\r\n==> 28 installed packages\r\n-- linux-ubuntu18.04-broadwell / gcc@7.5.0 ----------------------\r\nautoconf@2.69  autoconf-archive@2019.01.06  automake@1.16.2  gcc@10.1.0  gdbm@1.18.1  gmp@6.1.2  isl@0.21  libsigsegv@2.12  libtool@2.4.6  m4@1.4.18  mpc@1.1.0  mpfr@4.0.2  ncurses@6.2  perl@5.30.3  pkgconf@1.7.3  readline@8.0  zlib@1.2.11  zstd@1.4.5\r\n\r\n-- linux-ubuntu18.04-broadwell / gcc@10.1.0 ---------------------\r\ngdbm@1.18.1  libiconv@1.16  libidn2@2.1.1a  libunistring@0.9.10  ncurses@6.2  openssl@1.1.1g  perl@5.30.3  pkgconf@1.7.3  readline@8.0  zlib@1.2.11\r\n```\r\n### Additional information\r\n\r\n- [ ] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "user": "haampie",
    "url": "https://api.github.com/repos/spack/spack/issues/17544",
    "updated_at": "2020-07-15 15:51:03",
    "created_at": "2020-07-15 11:20:19",
    "closed_at": "None",
    "state": "open",
    "title": "spack ci rebuild fails to install all cached dependencies.",
    "number": 17544,
    "milestone": null,
    "labels": [
        "bug",
        "triage",
        "pipelines"
    ],
    "id": 657272256,
    "html_url": "https://github.com/spack/spack/issues/17544",
    "assignees": [],
    "comments": 3
}