{
    "body": "Closes #25582 \r\n\r\n- Make sure PackageInstaller does not remove the install directory that was just recovered after failed `spack install --overwrite`\r\n- Remove cryptic error message and rethrow actual error\r\n\r\nBefore:\r\n\r\n```\r\n$ spack install zlib\r\n$ spack edit zlib # change make('install') to make('aergaergaerg')\r\n$ spack install --overwrite zlib\r\n==> The following package specs will be reinstalled:\r\n\r\n-- linux-ubuntu20.04-zen2 / gcc@10.3.0 --------------------------\r\njcfc4hl zlib@1.2.11%gcc +optimize+pic~shared\r\n==> Do you want to proceed? [y/N] y\r\n==> Installing zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\r\n==> No binary for zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl found: installing from source\r\n==> Using cached archive: /home/user/.spack/source_cache/_source-cache/archive/c3/c3e5e9fdd5004dcb542feda5ee4f0ff0744628baf8ed2dd5d66f8ca1197cb1a1.tar.gz\r\n==> No patches needed for zlib\r\n==> zlib: Executing phase: 'install'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16' 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'\r\n\r\n1 error found in build log:\r\n     34    ar rc libz.a adler32.o crc32.o deflate.o infback.o inffast.o inflate.o inftrees.o trees.o zutil.o compress.o uncompr.o gzclose.o gzlib.o gzread.o gzwrite.o\r\n     35    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o example example.o -L. libz.a\r\n     36    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o minigzip minigzip.o -L. libz.a\r\n     37    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o example64 example64.o -L. libz.a\r\n     38    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o minigzip64 minigzip64.o -L. libz.a\r\n     39    ==> [2021-08-24-15:13:46.190571] 'make' '-j16' 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'\r\n  >> 40    make: *** No rule to make target 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'.  Stop.\r\n\r\nSee build log for details:\r\n  /tmp/user/spack-stage/spack-stage-zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl/spack-build-out.txt\r\n\r\n==> Error: Failed to install zlib due to RuntimeError: the transactional move of \"/home/user/spack/opt/spack/linux-ubuntu20.04-zen2/gcc-10.3.0/zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\" failed.\r\n    ProcessError: Command exited with status 2:\r\n    'make' '-j16' 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'\r\n==> Error: the transactional move of \"/home/user/spack/opt/spack/linux-ubuntu20.04-zen2/gcc-10.3.0/zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\" failed.\r\n    ProcessError: Command exited with status 2:\r\n    'make' '-j16' 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'\r\n\r\n$ stat /home/user/spack/opt/spack/linux-ubuntu20.04-zen2/gcc-10.3.0/zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\r\nstat: cannot stat '/home/user/spack/opt/spack/linux-ubuntu20.04-zen2/gcc-10.3.0/zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl': No such file or directory\r\n```\r\n\r\nAfter:\r\n\r\n```\r\n$ spack install zlib\r\n$ spack edit zlib # change make('install') to make('aergaergaerg')\r\n$ spack install --overwrite zlib\r\n==> The following package specs will be reinstalled:\r\n\r\n-- linux-ubuntu20.04-zen2 / gcc@10.3.0 --------------------------\r\njcfc4hl zlib@1.2.11%gcc +optimize+pic~shared\r\n==> Do you want to proceed? [y/N] y\r\n==> Installing zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\r\n==> No binary for zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl found: installing from source\r\n==> Using cached archive: /home/user/.spack/source_cache/_source-cache/archive/c3/c3e5e9fdd5004dcb542feda5ee4f0ff0744628baf8ed2dd5d66f8ca1197cb1a1.tar.gz\r\n==> No patches needed for zlib\r\n==> zlib: Executing phase: 'install'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16' 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'\r\n\r\n1 error found in build log:\r\n     34    ar rc libz.a adler32.o crc32.o deflate.o infback.o inffast.o inflate.o inftrees.o trees.o zutil.o compress.o uncompr.o gzclose.o gzlib.o gzread.o gzwrite.o\r\n     35    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o example example.o -L. libz.a\r\n     36    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o minigzip minigzip.o -L. libz.a\r\n     37    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o example64 example64.o -L. libz.a\r\n     38    /home/user/spack/lib/spack/env/gcc/gcc -fPIC -O2 -D_LARGEFILE64_SOURCE=1 -DHAVE_HIDDEN -o minigzip64 minigzip64.o -L. libz.a\r\n     39    ==> [2021-08-24-15:16:59.715395] 'make' '-j16' 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'\r\n  >> 40    make: *** No rule to make target 'agjaeoigjaerogiaeorgaejoaejoaejigaeorgi'.  Stop.\r\n\r\nSee build log for details:\r\n  /tmp/user/spack-stage/spack-stage-zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl/spack-build-out.txt\r\n\r\n$ stat /home/user/spack/opt/spack/linux-ubuntu20.04-zen2/gcc-10.3.0/zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\r\n  File: /home/user/spack/opt/spack/linux-ubuntu20.04-zen2/gcc-10.3.0/zlib-1.2.11-jcfc4hlhnbwlpbz2jzjcgvwkacxyppbl\r\n  Size: 4096      \tBlocks: 8          IO Block: 4096   directory\r\n\r\n```",
    "user": "haampie",
    "url": "https://api.github.com/repos/spack/spack/issues/25583",
    "updated_at": "2021-08-31 09:47:16",
    "created_at": "2021-08-24 13:12:00",
    "closed_at": "2021-08-27 19:41:25",
    "state": "closed",
    "title": "Fix: --overwrite backs up old install dir, but it gets destroyed anyways",
    "number": 25583,
    "milestone": null,
    "labels": [
        "tests",
        "utilities"
    ],
    "id": 978084564,
    "html_url": "https://github.com/spack/spack/pull/25583",
    "assignees": [],
    "comments": 5
}