{
    "body": "This PR adds a regression test for version selection with preferences in `packages.yaml`. Before #25585 we used negative weights in a minimization to select the optimal version. This may lead to situations where a dependency may make the version score of dependents \"better\" if it is preferred in `packages.yaml`.\r\n\r\nAn example of a situation seen in the e4s pipelines in #25502 is the following. We would expect to see this selected in specs:\r\n```\r\n^libtool@2.4.6 (version weight: -1, i.e. it's the preferred in packages.yaml)\r\n```\r\nbut instead we got this:\r\n```\r\n^libtool@develop (version weight: 2)\r\n  ^help2man@1.47.16 (version weight: -1)\r\n  ^texinfo@6.5 (version weight: -1)\r\n  ^xz@5.2.5 (version weight: -1)\r\n```\r\nsince the overall version score is the same, but `xz` has a better score on a very low priority optimization criterion. The test added in this PR on a commit before 31dcdf7262316d0ab04a82af16a763888cd6439f fails like:\r\n```console\r\n$ SPACK_TEST_SOLVER=clingo spack unit-test lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_dependencies_cant_make_version_parent_score_better\r\n============================================================== test session starts ===============================================================\r\nplatform linux -- Python 3.6.9, pytest-3.2.5, py-1.4.34, pluggy-0.4.0\r\nrootdir: /home/culpo/PycharmProjects/spack, inifile: pytest.ini\r\ncollected 1 item                                                                                                                                  \r\n\r\nlib/spack/spack/test/concretize_preferences.py F\r\n============================================================ short test summary info =============================================================\r\nFAIL lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::()::test_dependencies_cant_make_version_parent_score_better\r\n\r\n=========================================================== slowest 30 test durations ============================================================\r\n0.65s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_dependencies_cant_make_version_parent_score_better\r\n0.03s setup    lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_dependencies_cant_make_version_parent_score_better\r\n0.00s teardown lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_dependencies_cant_make_version_parent_score_better\r\n==================================================================== FAILURES ====================================================================\r\n_______________________________ TestConcretizePreferences.test_dependencies_cant_make_version_parent_score_better ________________________________\r\n\r\nself = <spack.test.concretize_preferences.TestConcretizePreferences object at 0x7f76fbd2fbe0>\r\n\r\n    @pytest.mark.regression('25585')\r\n    def test_dependencies_cant_make_version_parent_score_better(self):\r\n        \"\"\"Test that a package can't select a worse version for a\r\n            dependent (libtool) because doing so it can pull-in a dependency\r\n            that makes the overall version score even or better and maybe\r\n            has a better score in some lower priority criteria.\r\n            \"\"\"\r\n        s = Spec('aml').concretized()\r\n    \r\n>       assert s.satisfies('^libtool-version@2.4.6')\r\nE       AssertionError: assert False\r\nE        +  where False = <bound method Spec.satisfies of aml@0.1.0%gcc@4.5.0 arch=test-debian6-core2 ^libtool-version@develop%gcc@4.5.0 arch=test-debian6-core2 ^xz@5.2.5%gcc@4.5.0 libs=shared,static arch=test-debian6-core2>('^libtool-version@2.4.6')\r\nE        +    where <bound method Spec.satisfies of aml@0.1.0%gcc@4.5.0 arch=test-debian6-core2 ^libtool-version@develop%gcc@4.5.0 arch=test-debian6-core2 ^xz@5.2.5%gcc@4.5.0 libs=shared,static arch=test-debian6-core2> = aml@0.1.0%gcc@4.5.0 arch=test-debian6-core2 ^libtool-version@develop%gcc@4.5.0 arch=test-debian6-core2 ^xz@5.2.5%gcc@4.5.0 libs=shared,static arch=test-debian6-core2.satisfies\r\n\r\nlib/spack/spack/test/concretize_preferences.py:397: AssertionError\r\n============================================================ 1 failed in 0.74 seconds ============================================================\r\n```",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/25602",
    "updated_at": "2021-08-26 16:29:49",
    "created_at": "2021-08-25 08:02:04",
    "closed_at": "2021-08-26 16:28:47",
    "state": "closed",
    "title": "Regression test for version selection with preferences",
    "number": 25602,
    "milestone": null,
    "labels": [
        "new-version",
        "dependencies",
        "tests",
        "new-variant"
    ],
    "id": 978842097,
    "html_url": "https://github.com/spack/spack/pull/25602",
    "assignees": [],
    "comments": 2
}