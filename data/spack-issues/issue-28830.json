{
    "body": "### Steps to reproduce\n\nThe error occurs in \r\n\r\n```bash\r\ncat > Vagrantfile << \\EOF\r\nVagrant.configure(\"2\") do |config|\r\n  config.vm.box = \"qnib/rocky8-spack\"\r\n  config.vm.box_version = \"2022.02.08-v2\"\r\nend\r\nEOF\r\nvagrant up\r\n```\r\n\r\nThis spins up a virtual machine with spack installed.\r\n\r\n```bash\r\n$ vagrant ssh\r\n[vagrant@localhost ~]$ sudo su - spack\r\n[spack@localhost ~]$\r\n```\r\n\r\nI followed the following steps to create a binary cache.\r\n**Note**: The S3 bucket is already created using `aws s3 mb s3://name`.\r\n\r\n## Binary cache creation\r\n\r\nLet's create a binary cache in AWS S3 and upload some packages to show the benefit.\r\n\r\n```bash\r\nexport GPG_KEY=qnib-binary-cache-key\r\nexport BUILD_CACHE=spack-vagrant-cache\r\nexport GPG_EMAIL=spack@test.com\r\n```\r\n### Create S3 Bucket\r\n\r\nLog into your AWS console and create a bucket with the name specified above.\r\n\r\nFirst, we need to configure the `awscli` with our AWS credentials. \r\n\r\n```bash\r\naws configure\r\n```\r\n\r\nMake sure to use a IAM profile that is restricted to only read and write to the bucket in question.\r\n\r\n```bash\r\n$ aws configure\r\nAWS Access Key ID [None]: <YOUR_ACCESS_KEY>\r\nAWS Secret Access Key [None]: <YOUR_SECRET_KEY>\r\nDefault region name [None]: eu-west-1\r\nDefault output format [None]:\r\n```\r\n\r\n### GPG Keys\r\n\r\n```bash\r\nspack gpg init\r\nspack gpg create ${GPG_KEY} ${GPG_EMAIL}\r\n```\r\nThis will create a key within ``.\r\n\r\n```bash\r\n$ spack gpg create ${GPG_KEY} ${GPG_EMAIL}\r\ngpg: keybox '/opt/spack/opt/spack/gpg/pubring.kbx' created\r\ngpg: /opt/spack/opt/spack/gpg/trustdb.gpg: trustdb created\r\ngpg: key TEST123 marked as ultimately trusted\r\ngpg: directory '/opt/spack/opt/spack/gpg/openpgp-revocs.d' created\r\ngpg: revocation certificate stored as '/opt/spack/opt/spack/gpg/openpgp-revocs.d/TEST123.rev'```\r\n\r\n### Create Mirror\r\n\r\n```bash\r\nspack mirror add ${BUILD_CACHE} \"s3://${BUILD_CACHE}\"\r\nspack mirror list\r\n```\r\n\r\nA mirror should be added to your local `~/.spack/mirrors.yaml`.\r\n\r\n\r\n```bash\r\n$ spack mirror list\r\nspack-vagrant-cache    s3://spack-vagrant-cache (fetch)\r\nspack-vagrant-cache    s3://spack-vagrant-cache (push)\r\nspack-public           https://mirror.spack.io\r\n$\r\n```\r\n\r\n### Install Package\r\n\r\n```bash\r\nspack install bzip2\r\n```\r\n\r\n### Fill Cache\r\n\r\n```bash\r\nspack buildcache create -f --rebuild-index -k ${GPG_KEY} -m ${BUILD_CACHE} bzip2\r\n```\r\n### Use Cache\r\n\r\nThe mirror we added above is per user, by changing the user we can utilize the mirror.\r\n\r\n```bash\r\nexport BUILD_CACHE=spack-vagrant-bins\r\nspack mirror add ${BUILD_CACHE} \"s3://${BUILD_CACHE}\"\r\nspack install --no-check-signature --cache-only bzip2\r\n```\n\n### Error message\n\nOK, that the setup...\r\n\r\nI am encountering this error. Sometimes when I am installing software...\r\n\r\n```bash\r\n[spack@localhost ~]$ spack install bzip2\r\n[+] /nfs/share/spack/pkg/linux-rocky8-x86_64/gcc-8.5.0/libiconv-1.16-35blyeuqkakrjcje6b7rpi52bylxmjoc\r\n[+] /nfs/share/spack/pkg/linux-rocky8-x86_64/gcc-8.5.0/diffutils-3.8-ku4gppnjmbo2e6zdcb6ht2nzjdid2ac7\r\n==> Installing bzip2-1.0.8-pbg6ou5bp6d3ob66fvd4ymetnbkegtgj\r\n==> Error: Failed to install bzip2 due to AttributeError: attribute 'closed' of '_io._IOBase' objects is not writable\r\n==> Error: attribute 'closed' of '_io._IOBase' objects is not writable\r\n[spack@localhost ~]$\r\n```\r\n\r\nSometimes when I want to upload to the S3 bucket.\r\n\r\n```bash\r\n$ spack buildcache create -f --rebuild-index -k ${GPG_KEY} -m ${BUILD_CACHE} bzip2\r\n==> Pushing binary packages to s3://spack-vagrant-cache/build_cache\r\ngpg: using \"qnib-binary-cache-key\" as default secret key for signing\r\n==> Error: attribute 'closed' of '_io._IOBase' objects is not writable\r\n```\n\n### Information on your system\n\n```bash\r\n$ spack debug report\r\n* **Spack:** 0.17.1-1106-c1b51d6e99\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rocky8-sandybridge\r\n* **Concretizer:** clingo\r\n```\r\n\r\n**Note**: Since my setup should be only used to to dryrun testing I specified `x86_64` in the `packages.yaml`.\r\n\r\n```bash\r\n$ cat /opt/spack/etc/spack/packages.yaml\r\npackages:\r\n  all:\r\n    target: [x86_64]\r\n  slurm:\r\n    buildable: false\r\n    externals:\r\n    - spec: slurm@21-08-5-1\r\n      prefix: /usr\r\n  openmpi:\r\n    variants: +pmi +legacylaunchers schedulers=slurm\r\n    version:\r\n       - 4.1.0\r\n$ cat /opt/spack/etc/spack/config.yaml |grep -v \"#\"\r\nconfig:\r\n  install_tree:\r\n    root: /nfs/share/spack/pkg\r\n  source_cache: /nfs/share/spack/cache\r\n  misc_cache: ${HOME}/cache\r\n```\r\n\r\n```bash\r\n$ cat /opt/spack/etc/spack/compilers.yaml\r\ncompilers:\r\n- compiler:\r\n    spec: gcc@8.5.0\r\n    paths:\r\n      cc: /bin/gcc\r\n      cxx: /bin/g++\r\n      f77: /bin/gfortran\r\n      fc: /bin/gfortran\r\n    flags: {}\r\n    operating_system: rocky8\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "ChristianKniep",
    "url": "https://api.github.com/repos/spack/spack/issues/28830",
    "updated_at": "2022-03-11 20:34:18",
    "created_at": "2022-02-08 13:49:40",
    "closed_at": "None",
    "state": "open",
    "title": "Error: attribute 'closed' of '_io._IOBase' objects is not writable",
    "number": 28830,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1127284052,
    "html_url": "https://github.com/spack/spack/issues/28830",
    "assignees": [],
    "comments": 21
}