{
    "body": "Refers to the comment in the \"Error message\" of #17479  When running:\r\n```\r\n$ spack test lib/spack/spack/test/cmd/ci.py::test_ci_generate_with_env\r\n```\r\nthe test fails. This does not happen when running the test as part of the test suite.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack test lib/spack/spack/test/cmd/ci.py::test_ci_generate_with_env\r\n=================================================================== test session starts ====================================================================\r\nplatform linux -- Python 3.7.4, pytest-3.2.5, py-1.4.34, pluggy-0.4.0\r\nrootdir: /home/culpo/PycharmProjects/spack, inifile: pytest.ini\r\ncollected 1 item                                                                                                                                            \r\n\r\nlib/spack/spack/test/cmd/ci.py F\r\n================================================================= short test summary info ==================================================================\r\nFAIL lib/spack/spack/test/cmd/ci.py::test_ci_generate_with_env\r\n\r\n================================================================ slowest 20 test durations =================================================================\r\n0.35s call     lib/spack/spack/test/cmd/ci.py::test_ci_generate_with_env\r\n0.03s setup    lib/spack/spack/test/cmd/ci.py::test_ci_generate_with_env\r\n0.00s teardown lib/spack/spack/test/cmd/ci.py::test_ci_generate_with_env\r\n========================================================================= FAILURES =========================================================================\r\n________________________________________________________________ test_ci_generate_with_env _________________________________________________________________\r\n\r\ntmpdir = local('/tmp/pytest-of-culpo/pytest-24/test_ci_generate_with_env0'), mutable_mock_env_path = local('/tmp/pytest-of-culpo/pytest-24/mock-env-path0')\r\nenv_deactivate = None, install_mockery = None, mock_packages = <spack.repo.RepoPath object at 0x7f85b4b2d310>\r\n\r\n    def test_ci_generate_with_env(tmpdir, mutable_mock_env_path, env_deactivate,\r\n                                  install_mockery, mock_packages):\r\n        \"\"\"Make sure we can get a .gitlab-ci.yml from an environment file\r\n           which has the gitlab-ci, cdash, and mirrors sections.\"\"\"\r\n        filename = str(tmpdir.join('spack.yaml'))\r\n        with open(filename, 'w') as f:\r\n            f.write(\"\"\"\\\r\n    spack:\r\n      definitions:\r\n        - bootstrap:\r\n          - cmake@3.4.3\r\n        - old-gcc-pkgs:\r\n          - archive-files\r\n          - callpath\r\n          - hypre@0.2.15\r\n      specs:\r\n        - matrix:\r\n          - [$old-gcc-pkgs]\r\n      mirrors:\r\n        some-mirror: https://my.fake.mirror\r\n      gitlab-ci:\r\n        bootstrap:\r\n          - name: bootstrap\r\n            compiler-agnostic: true\r\n        mappings:\r\n          - match:\r\n              - arch=test-debian6-x86_64\r\n            runner-attributes:\r\n              tags:\r\n                - donotcare\r\n              image: donotcare\r\n        final-stage-rebuild-index:\r\n          image: donotcare\r\n          tags: [donotcare]\r\n      cdash:\r\n        build-group: Not important\r\n        url: https://my.fake.cdash\r\n        project: Not used\r\n        site: Nothing\r\n    \"\"\")\r\n        with tmpdir.as_cwd():\r\n            env_cmd('create', 'test', './spack.yaml')\r\n            outputfile = str(tmpdir.join('.gitlab-ci.yml'))\r\n    \r\n            with ev.read('test'):\r\n>               ci_cmd('generate', '--output-file', outputfile)\r\n\r\nlib/spack/spack/test/cmd/ci.py:161: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\nlib/spack/spack/main.py:545: in __call__\r\n    self.command, self.parser, args, unknown)\r\nlib/spack/spack/main.py:489: in _invoke_command\r\n    return_val = command(parser, args)\r\nlib/spack/spack/cmd/ci.py:394: in ci\r\n    args.func(args)\r\nlib/spack/spack/cmd/ci.py:102: in ci_generate\r\n    use_dependencies=use_dependencies)\r\nlib/spack/spack/ci.py:457: in generate_gitlab_ci_yaml\r\n    env.concretize()\r\nlib/spack/spack/environment.py:968: in concretize\r\n    return self._concretize_separately()\r\nlib/spack/spack/environment.py:1036: in _concretize_separately\r\n    concrete = _concretize_from_constraints(uspec_constraints)\r\nlib/spack/spack/environment.py:1622: in _concretize_from_constraints\r\n    return s.concretized()\r\nlib/spack/spack/spec.py:2323: in concretized\r\n    clone.concretize()\r\nlib/spack/spack/spec.py:2170: in concretize\r\n    self._expand_virtual_packages(concretizer),\r\nlib/spack/spack/spec.py:2075: in _expand_virtual_packages\r\n    candidates = concretizer.choose_virtual_or_external(spec)\r\nlib/spack/spack/concretize.py:120: in choose_virtual_or_external\r\n    candidates = self._valid_virtuals_and_externals(spec)\r\nlib/spack/spack/concretize.py:94: in _valid_virtuals_and_externals\r\n    if is_spec_buildable(cspec):\r\nlib/spack/spack/package_prefs.py:202: in is_spec_buildable\r\n    any(spec.package.provides(name) for name in reverse))\r\nlib/spack/spack/package_prefs.py:202: in <genexpr>\r\n    any(spec.package.provides(name) for name in reverse))\r\nlib/spack/spack/spec.py:1175: in package\r\n    self._package = spack.repo.get(self)\r\nlib/spack/spack/repo.py:1190: in get\r\n    return path.get(spec)\r\nlib/spack/spack/repo.py:90: in converter\r\n    return function(self, spec_like, *args, **kwargs)\r\nlib/spack/spack/repo.py:650: in get\r\n    return self.repo_for_pkg(spec).get(spec)\r\nlib/spack/spack/repo.py:90: in converter\r\n    return function(self, spec_like, *args, **kwargs)\r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\n\r\nself = [Repo 'builtin.mock' at '/home/culpo/PycharmProjects/spack/var/spack/repos/builtin.mock'], spec = intel-parallel-studio\r\n\r\n    @autospec\r\n    def get(self, spec):\r\n        \"\"\"Returns the package associated with the supplied spec.\"\"\"\r\n        if not self.exists(spec.name):\r\n>           raise UnknownPackageError(spec.name)\r\nE           spack.repo.UnknownPackageError: Package 'intel-parallel-studio' not found.\r\n\r\nlib/spack/spack/repo.py:882: UnknownPackageError\r\n================================================================= 1 failed in 0.90 seconds =================================================================\r\n```\r\n\r\n### Error Message\r\n\r\nThe error message is reported above.\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.15.1-107-9c42f246e\r\n* **Python:** 3.7.4\r\n* **Platform:** linux-ubuntu18.04-broadwell\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands ~in debug mode~ and reported the output\r\n",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/17481",
    "updated_at": "2020-07-13 10:46:37",
    "created_at": "2020-07-13 10:46:37",
    "closed_at": "None",
    "state": "open",
    "title": "test_ci_generate_with_env fails when run on its own",
    "number": 17481,
    "milestone": null,
    "labels": [
        "bug",
        "tests",
        "maintainers",
        "triage"
    ],
    "id": 655750238,
    "html_url": "https://github.com/spack/spack/issues/17481",
    "assignees": [],
    "comments": 0
}