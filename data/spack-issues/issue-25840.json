{
    "body": "### Steps to reproduce the issue\n\n@sethrj @kubery @keiat I am having problems with building Trilinos via `srun`.  I am able to build every other package in my DAG (~20) but not Trilinos.  It seems that the the compute nodes are always trying to restage `Trilinos` and I'm not sure why.  This could be a bigger issue in spack, but I only have this problem with `Trilinos`. The stage directory is not/should not be in a tmp dir\r\n```\r\nspack config blame config\r\n---                                                                    config:\r\n/projects/wind/spack-manager/environments/test/general_config.yaml:2     source_cache: ~/.spack/downloads\r\n/projects/wind/spack-manager/environments/test/general_config.yaml:3     misc_cache: $spack/var/spack/cache\r\n/projects/wind/spack-manager/environments/test/machine_config.yaml:2     module_roots:\r\n/projects/wind/spack-manager/environments/test/machine_config.yaml:3       tcl: $spack/share/spack/modules\r\n/projects/wind/spack-manager/environments/test/machine_config.yaml:4       lmod: $spack/share/spack/lmod\r\n/projects/wind/spack-manager/environments/test/machine_config.yaml:5     build_stage:\r\n/projects/wind/spack-manager/environments/test/machine_config.yaml:6     - $spack/var/spack/stage\r\n/projects/wind/spack-manager/spack/etc/spack/defaults/config.yaml:62     - $tempdir/$user/spack-stage\r\n/projects/wind/spack-manager/spack/etc/spack/defaults/config.yaml:63     - ~/.spack/stage\r\n/projects/wind/spack-manager/spack/etc/spack/defaults/config.yaml:63     # - $spack/var/spack/stage\r\n```\r\nand  the stage on the compute nodes is indeed not in `$tmpdir`\r\n```\r\nsrun -N 2 -n 2 spack location -s trilinos\r\n/projects/wind/spack-manager/spack/var/spack/stage/psakiev/spack-stage-trilinos-develop-lqi4j65eqwl2vhfhzakngqzso4c6753u\r\n/projects/wind/spack-manager/spack/var/spack/stage/psakiev/spack-stage-trilinos-develop-lqi4j65eqwl2vhfhzakngqzso4c6753u\r\n```\r\nHowever.  When I go to install even if I prestage I am getting the same failures about being unable to copy files\r\n```\r\nsrun -N 1 -n 1 spack -d install -j 32\r\n[... lots of debug stuff ...]\r\n==> [2021-09-02-12:45:10.267256] Installing trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp\r\n==> [2021-09-02-12:45:10.875471] No binary for trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp found: installing from source\r\n==> [2021-09-02-12:45:04.679498] Removing netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka's uninstalled dependencies.\r\n==> [2021-09-02-12:45:04.679574] amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka: Removed netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from uninstalled deps list: set()\r\n==> [2021-09-02-12:45:04.679627] Removing netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu's uninstalled dependencies.\r\n==> [2021-09-02-12:45:04.679689] nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu: Removed netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from uninstalled deps list: set()\r\n==> [2021-09-02-12:45:04.679740] Removing netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp's uninstalled dependencies.\r\n==> [2021-09-02-12:45:04.679800] trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp: Removed netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from uninstalled deps list: set()\r\n==> [2021-09-02-12:45:04.679851] Removing netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs's uninstalled dependencies.\r\n==> [2021-09-02-12:45:04.679913] nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs: Removed netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r from uninstalled deps list: {'nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu', 'trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp'}\r\n==> [2021-09-02-12:45:04.680018] Downgrading to a read lock on netcdf-c-4.7.4-ar7anl7cafchmdbejayrn2e2bhrgdn7r with timeout 1e-09\r\n==> [2021-09-02-12:45:04.685851] Acquiring a write lock on amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka with timeout 1e-09\r\n==> [2021-09-02-12:45:04.693245] Creating stage lock spack-stage-amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka\r\n==> [2021-09-02-12:45:04.693372] Flagging amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka as installed\r\n==> [2021-09-02-12:45:04.693419] Removing amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka from exawind-master-qcywy7eq3chafzx5hsoljy6cgrpv2yym's uninstalled dependencies.\r\n==> [2021-09-02-12:45:04.693485] exawind-master-qcywy7eq3chafzx5hsoljy6cgrpv2yym: Removed amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka from uninstalled deps list: {'nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs'}\r\n==> [2021-09-02-12:45:04.693600] Downgrading to a read lock on amr-wind-main-mjwor5xjzcmpabexkc27wtwgglri2aka with timeout 1e-09\r\n==> [2021-09-02-12:45:04.700952] Acquiring a write lock on nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu with timeout 1e-09\r\n==> [2021-09-02-12:45:04.708598] Creating stage lock spack-stage-nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu\r\n==> [2021-09-02-12:45:04.708724] Flagging nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu as installed\r\n==> [2021-09-02-12:45:04.708772] Removing nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu from nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs's uninstalled dependencies.\r\n==> [2021-09-02-12:45:04.708838] nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs: Removed nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu from uninstalled deps list: {'trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp'}\r\n==> [2021-09-02-12:45:04.708944] Downgrading to a read lock on nccmp-1.9.0.1-5pgxojsvjxix6ssucrgzho7wxteeorzu with timeout 1e-09\r\n==> [2021-09-02-12:45:04.715492] Acquiring a write lock on trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp with timeout 1e-09\r\n==> [2021-09-02-12:45:04.744559] Creating stage lock spack-stage-trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp\r\n==> [2021-09-02-12:45:10.266914] FileNotFoundError: [Errno 2] No such file or directory\r\n==> [2021-09-02-12:45:10.267389] Searching for binary cache of trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp\r\n==> [2021-09-02-12:45:10.269445] Reading config file /projects/wind/spack-manager/spack/etc/spack/defaults/mirrors.yaml\r\n==> [2021-09-02-12:45:10.875175] Did not find linux-rhel7-x86_64-gcc-8.3.1-trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp.spec.yaml on https://mirror.spack.io/build_cache/linux-rhel7-x86_64-gcc-8.3.1-trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp.spec.yaml\r\n  Download failed: HTTP Error 404: Not Found\r\n==> [2021-09-02-12:45:10.884124] Reading config file /projects/wind/spack-manager/spack/etc/spack/defaults/packages.yaml\r\n==> [2021-09-02-12:45:11.216354] '/usr/bin/git' 'describe' '--tags' '--match' 'v*'\r\nCloning into 'Trilinos'...\r\nerror: unable to write file packages/rol/src/function/objective/ROL_Objective.hpp\r\nerror: unable to write file packages/rol/src/function/objective/ROL_ObjectiveDef.hpp\r\nerror: unable to write file packages/rol/src/function/objective/ROL_ObjectiveFromConstraint.hpp\r\nerror: unable to write file packages/rol/src/function/objective/ROL_ObjectiveFromConstraint_Def.hpp\r\nerror: unable to write file packages/rol/src/function/objective/ROL_QuadraticObjective.hpp\r\nerror: unable to write file packages/rol/src/function/objective/ROL_QuadraticObjective_Def.hpp\r\nerror: unable to write file packages/rol/src/function/objective/ROL_SlacklessObjective.hpp\r\n[.. all the files of trilinos not found...]\r\n[... more debug stuff...]\r\n==> [2021-09-02-12:45:20.477447] linkdir: /opt/rh/devtoolset-8/root/usr/lib/gcc/x86_64-redhat-linux/8/../../..\r\n==> [2021-09-02-12:45:20.477502] found raw link dirs: /opt/rh/devtoolset-8/root/usr/lib/gcc/x86_64-redhat-linux/8, /opt/rh/devtoolset-8/root/usr/lib/gcc/x86_64-redhat-linux/8/../../../../lib64, /lib/../lib64, /usr/lib/../lib64, /opt/rh/devtoolset-8/root/usr/lib/gcc/x86_64-redhat-linux/8/../../..\r\n==> [2021-09-02-12:45:20.477642] found link dirs: /opt/rh/devtoolset-8/root/usr/lib/gcc/x86_64-redhat-linux/8, /opt/rh/devtoolset-8/root/usr/lib64, /lib64, /usr/lib64, /opt/rh/devtoolset-8/root/usr/lib\r\n==> [2021-09-02-12:45:20.488762] Checking existence of https://mirror.spack.io/_source-cache/git/trilinos/Trilinos.git/develop.tar.gz\r\n==> [2021-09-02-12:45:21.036350] FailedDownloadError: Failed to fetch file from URL: https://mirror.spack.io/_source-cache/git/trilinos/Trilinos.git/develop.tar.gz\r\n    Urllib fetch failed to verify url https://mirror.spack.io/_source-cache/git/trilinos/Trilinos.git/develop.tar.gz\r\n==> [2021-09-02-12:45:21.036677] Checking existence of https://mirror.spack.io/trilinos/trilinos-develop.tar.gz\r\n==> [2021-09-02-12:45:21.592720] FailedDownloadError: Failed to fetch file from URL: https://mirror.spack.io/trilinos/trilinos-develop.tar.gz\r\n    Urllib fetch failed to verify url https://mirror.spack.io/trilinos/trilinos-develop.tar.gz\r\n==> [2021-09-02-12:45:21.593285] Cloning git repository: https://github.com/trilinos/Trilinos.git on branch develop\r\n==> [2021-09-02-12:45:21.606952] '/usr/bin/git' '--version'\r\n==> [2021-09-02-12:45:21.615460] '/usr/bin/git' '-c' 'advice.detachedHead=false' '--version'\r\n==> [2021-09-02-12:45:21.623451] '/usr/bin/git' '-c' 'advice.detachedHead=false' '--version'\r\n==> [2021-09-02-12:45:21.629855] '/usr/bin/git' '-c' 'advice.detachedHead=false' 'clone' '--branch' 'develop' '--single-branch' '--depth' '1' 'https://github.com/trilinos/Trilinos.git'\r\n==> [2021-09-02-12:45:52.245411] ProcessError: Command exited with status 128:\r\n==> [2021-09-02-12:45:21.629855] '/usr/bin/git' '-c' 'advice.detachedHead=false' 'clone' '--branch' 'develop' '--single-branch' '--depth' '1' 'https://github.com/trilinos/Trilinos.git'\r\n==> [2021-09-02-12:45:52.245411] ProcessError: Command exited with status 128:\r\n    '/usr/bin/git' '-c' 'advice.detachedHead=false' 'clone' '--branch' 'develop' '--single-branch' '--depth' '1' 'https://github.com/trilinos/Trilinos.git'\r\n==> [2021-09-02-12:45:52.245715] Fetching from https://mirror.spack.io/_source-cache/git/trilinos/Trilinos.git/develop.tar.gz failed.\r\n==> [2021-09-02-12:45:52.245767] Fetching from https://mirror.spack.io/trilinos/trilinos-develop.tar.gz failed.\r\n==> [2021-09-02-12:45:52.245808] Fetching from [git] https://github.com/trilinos/Trilinos.git on branch develop failed.\r\n==> [2021-09-02-12:45:52.272071] Error: FetchError: All fetchers failed\r\n\r\n/projects/wind/spack-manager/spack/lib/spack/spack/package.py:1376, in do_fetch:\r\n       1373\r\n       1374        self.stage.create()\r\n       1375        err_msg = None if not self.manual_download else self.download_instr\r\n  >>   1376        start_time = time.time()\r\n       1377        self.stage.fetch(mirror_only, err_msg=err_msg)\r\n       1378        self._fetch_time = time.time() - start_time\r\n       1379\r\n\r\n\r\nTraceback (most recent call last):\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/build_environment.py\", line 1022, in _setup_pkg_and_run\r\n    return_value = function(pkg, kwargs)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/installer.py\", line 1898, in build_process\r\n    return installer.run()\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/installer.py\", line 1735, in run\r\n    self.pkg.do_patch()\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/package.py\", line 1413, in do_patch\r\n    self.do_stage()\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/package.py\", line 1398, in do_stage\r\n    self.do_fetch(mirror_only)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/package.py\", line 1377, in do_fetch\r\n    self.stage.fetch(mirror_only, err_msg=err_msg)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/util/pattern.py\", line 23, in __call__\r\n    for item in self.container]\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/util/pattern.py\", line 23, in <listcomp>\r\n    for item in self.container]\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/stage.py\", line 507, in fetch\r\n    raise fs.FetchError(err_msg or 'All fetchers failed', None)\r\nspack.fetch_strategy.FetchError: All fetchers failed\r\n==> [2021-09-02-12:45:52.273301] Flagging trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp as failed: FetchError: All fetchers failed\r\n==> [2021-09-02-12:45:52.290133] Warning: Skipping build of nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs since trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp failed\r\n==> [2021-09-02-12:45:52.290193] Flagging nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs as failed\r\n==> [2021-09-02-12:45:52.305467] Warning: Skipping build of exawind-master-qcywy7eq3chafzx5hsoljy6cgrpv2yym since nalu-wind-master-gztjtf2ejackc6okhfq2uqydowpy3urs failed\r\n==> [2021-09-02-12:45:52.305525] Flagging exawind-master-qcywy7eq3chafzx5hsoljy6cgrpv2yym as failed\r\n==> [2021-09-02-12:45:52.345254] Downgrading to a read lock on trilinos-develop-5ovgze5t4bflekt3gw3z3owbchx6ppsp with timeout 1e-09\r\n==> [2021-09-02-12:45:52.379123] Error: exawind-master-qcywy7eq3chafzx5hsoljy6cgrpv2yym: Package was not installed\r\n==> [2021-09-02-12:45:52.682474] Skip view update, this environment does not maintain a view\r\n==> [2021-09-02-12:45:52.683746] InstallError: Installation request failed.  Refer to reported errors for failing package(s).\r\n==> [2021-09-02-12:45:52.683802] Error: Installation request failed.  Refer to reported errors for failing package(s).\r\nTraceback (most recent call last):\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/main.py\", line 797, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/main.py\", line 525, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/cmd/install.py\", line 359, in install\r\n    env.install_all(**kwargs)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/environment.py\", line 1483, in install_all\r\n    self.install_specs(None, **install_args)\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/environment.py\", line 1523, in install_specs\r\n    builder.install()\r\n  File \"/projects/wind/spack-manager/spack/lib/spack/spack/installer.py\", line 1679, in install\r\n    raise InstallError('Installation request failed.  Refer to '\r\nspack.installer.InstallError: Installation request failed.  Refer to reported errors for failing package(s).\r\nsrun: error: sb1299: task 0: Exited with exit code 1\r\n```\r\nI am able to build fine on the head node. This is only a problem on the compute nodes.\n\n### Information on your system\n\n```\r\n* **Spack:** 0.16.2-4107-beb3524392\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rhel7-sandybridge\r\n* **Concretizer:** clingo\r\n```\n\n### Additional information\n\nThe stage directory is empty when `srun` terminates so there is no build log or environment file available.\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\n- [X] I have uploaded the build log and environment files\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "psakievich",
    "url": "https://api.github.com/repos/spack/spack/issues/25840",
    "updated_at": "2021-09-15 10:20:48",
    "created_at": "2021-09-08 14:57:26",
    "closed_at": "2021-09-15 01:27:03",
    "state": "closed",
    "title": "Installation issue: distributed build of Trilinos",
    "number": 25840,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 991233792,
    "html_url": "https://github.com/spack/spack/issues/25840",
    "assignees": [],
    "comments": 9
}