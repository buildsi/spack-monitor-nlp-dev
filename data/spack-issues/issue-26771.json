{
    "body": "### Steps to reproduce\r\n\r\nThis is possibly not minimal, but the crux of the issue is that in some cases, Spack generates an invalid `loads` file wherein `paraview` comes before its dependency `openmpi`:\r\n\r\n```console\r\n$ spack external find --scope=site openmpi  # see #26275\r\n$ cat > etc/spack/packages.yaml\r\npackages:\r\n  perl:\r\n    externals:\r\n    - spec: perl@5.30.0~cpanm+shared+threads\r\n      prefix: /usr\r\n  llvm:\r\n    externals:\r\n    - spec: llvm@10.0.0+clang~lld~lldb\r\n      prefix: /usr\r\n      extra_attributes:\r\n        compilers:\r\n          c: /usr/bin/clang\r\n          cxx: /usr/bin/clang++-10\r\n  sqlite:\r\n    externals:\r\n    - spec: sqlite@3.31.1+fts~functions+rtree\r\n      prefix: /usr\r\n  rsync:\r\n    externals:\r\n    - spec: rsync@3.1.3\r\n      prefix: /usr\r\n  bzip2:\r\n    externals:\r\n    - spec: bzip2@1.0.8\r\n      prefix: /usr\r\n  bash:\r\n    externals:\r\n    - spec: bash@5.0.17\r\n      prefix: /usr\r\n  xz:\r\n    externals:\r\n    - spec: xz@5.2.4\r\n      prefix: /usr\r\n  tar:\r\n    externals:\r\n    - spec: tar@1.30\r\n      prefix: /usr\r\n  openssh:\r\n    externals:\r\n    - spec: openssh@8.2p1\r\n      prefix: /usr\r\n  git:\r\n    externals:\r\n    - spec: git@2.25.1~tcltk\r\n      prefix: /usr\r\n  openmpi:\r\n    externals:\r\n    - spec: openmpi@4.0.3%gcc@9.3.0~cuda+cxx~cxx_exceptions+java~memchecker+pmi~sqlite3~static~thread_multiple~wrapper-rpath\r\n        fabrics=ofi,psm,psm2 schedulers=slurm\r\n      prefix: /usr\r\n$ spack env create test-env\r\n$ cat > var/spack/environments/test-env/spack.yaml\r\nspack:\r\n  specs:\r\n  - itk ^hdf5~mpi ^fftw~mpi  # see #26308\r\n  - minc-toolkit +visualisation\r\n  - opencv +python3 +python_bindings_generator\r\n  - paraview\r\n  - python@3.9.6\r\n  - vtk +python   \r\n  - py-itk\r\n  view: false   \r\n  concretization: together\r\n  packages:    \r\n    all:\r\n      compiler: [gcc@9.3.0]\r\n      target: [broadwell]\r\n  include:\r\n  - ../../../../etc/spack/packages.yaml\r\n  modules:   \r\n    default: \r\n      lmod:\r\n        core_compilers:\r\n        - gcc@9.3.0\r\n$ spack env activate test-env\r\n$ spack install\r\n$ spack module refresh lmod\r\n$ spack env loads -r -m lmod\r\n$ source var/spack/environments/test-env/loads\r\nLmod has detected the following error:  These module(s) or\r\nextension(s) exist but cannot be loaded as requested: \"paraview/5.9.1-llxh62d\"\r\n   Try: \"module spider paraview/5.9.1-llxh62d\" to see how to load the\r\nmodule(s).\r\n$ cat var/spack/environments/test-env/loads  # note the out-of-order dependencies in the following:\r\n ...\r\n# paraview@5.9.1%gcc@9.3.0~advanced_debug~cuda~examples~hdf5~ipo+kits+mpi+opengl2~osmesa+plugins~python~python3~qt+shared build_type=RelWithDebInfo cuda_arch=none arch=linux-ubuntu20.04-broadwell  \r\nmodule load paraview/5.9.1-llxh62d\r\n ...\r\n# openmpi@4.0.3%gcc@9.3.0~atomics~cuda+cxx~cxx_exceptions+gpfs~internal-hwloc+java~legacylaunchers~lustre~memchecker+pmi~pmix~singularity~sqlite3~static~thread_multiple+vt~wrapper-rpath fabrics=ofi,psm,psm2 patches=60ce20bc14d98c572ef7883b9fcd254c3f232c2f3a13377480f96466169ac4c8 schedulers=slurm arch=linux-ubuntu20.04-broadwell\r\nmodule load openmpi/4.0.3-il4tndj\r\n ...\r\n```\r\n\r\n### Error message\r\n\r\nSee lmod error above when sourcing `loads` file.\r\n\r\nThere is no command to run in `debug` mode since the error occurs in generated code, not in Spack internals.\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.3-4878-4acda0839b\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-skylake\r\n* **Concretizer:** clingo\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "bcdarwin",
    "url": "https://api.github.com/repos/spack/spack/issues/26771",
    "updated_at": "2021-10-15 20:11:02",
    "created_at": "2021-10-15 20:09:22",
    "closed_at": "None",
    "state": "open",
    "title": "Spack generates a `loads` file not sorted by dependency ordering",
    "number": 26771,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1027772579,
    "html_url": "https://github.com/spack/spack/issues/26771",
    "assignees": [],
    "comments": 0
}