{
    "body": "# Short story\r\n\r\nThis pull request adds a package recipe for Gromacs Chain Coordinate (one of Gromacs forks)\r\n\r\n- It is reusing part of Gromacs package to avoid duplication. \r\n- Re-using Gromacs package is not trivial, some problems are described below.\r\n- Other than this, it is tested and recipe looks fine for me.\r\n\r\n# Long story\r\n\r\n## What is it?\r\n\r\nThere are at least four forks of Gromacs backed up by publications\r\n\r\n- Gromacs FDA https://github.com/HITS-MBM/gromacs-fda\r\n- Gromacs RAMD https://github.com/HITS-MCM/gromacs-ramd\r\n- Gromacs SWAXS https://gitlab.com/cbjh/gromacs-swaxs\r\n- Gromacs Chain Coordinate https://gitlab.com/cbjh/gromacs-chain-coordinate\r\n\r\nThis Pull request adds a package for Gromacs Chain Coordinate. \r\n\r\nMy goal is to add all four of them, but let's start with Gromacs Chain Coordinate.\r\n\r\n## Problem to solve\r\n\r\n- Gromacs Chain Coordinate builds in the same way as upstream Gromacs.\r\n- Just the Git repository is different. I am trying to inherit and override versions/urls.\r\n- There is no API for removing versions.\r\n\r\n## Does it work?\r\n\r\n```\r\n$ spack versions gromacs-chain-coordinate\r\n==> Safe versions (already checksummed):\r\n  main  2021.2-0.1\r\n```\r\n\r\n```\r\n$ spack install gromacs-chain-coordinate+cuda\r\n...\r\n==> Installing gromacs-chain-coordinate-2021.2-0.1-5pcghxnbfaxuqykgdkxfjlwry3phms6y\r\n==> No binary for gromacs-chain-coordinate-2021.2-0.1-5pcghxnbfaxuqykgdkxfjlwry3phms6y found: installing from source\r\n==> Using cached archive: /data/shared/spack/root/var/spack/cache/_source-cache/archive/87/879fdd04662370a76408b72c9fbc4aff60a6387b459322ac2700d27359d0dd87.tar.bz2\r\n==> Ran patch() for gromacs-chain-coordinate\r\n==> gromacs-chain-coordinate: Executing phase: 'cmake'\r\n==> gromacs-chain-coordinate: Executing phase: 'build'\r\n==> gromacs-chain-coordinate: Executing phase: 'install'\r\n==> gromacs-chain-coordinate: Successfully installed gromacs-chain-coordinate-2021.2-0.1-5pcghxnbfaxuqykgdkxfjlwry3phms6y\r\n  Fetch: 0.08s.  Build: 6m 47.03s.  Total: 6m 47.12s.\r\n[+] /data/shared/spack/root/opt/spack/linux-archrolling-broadwell/gcc-8.4.0/gromacs-chain-coordinate-2021.2-0.1-5pcghxnbfaxuqykgdkxfjlwry3phms6y\r\n$ module load gromacs-chain-coordinate@2021.2-0.1-mpi\r\n$ which gmx_mpi\r\n/data/shared/spack/root/opt/spack/linux-archrolling-broadwell/gcc-8.4.0/gromacs-chain-coordinate-2021.2-0.1-5pcghxnbfaxuqykgdkxfjlwry3phms6y/bin/gmx_mpi\r\n```\r\n\r\nSo yes, normal Gromacs versions are not visible and the package installs correctly.\r\n\r\n## Inheritance dillema\r\n\r\nWith current implementation, partial inheritance is used (calling some procedures of parent class, without real inheritance).\r\n\r\nIs this a correct way to do it?\r\n\r\nThree other options are\r\n1) Copy entire Gromacs package \u2013 But we don't like duplication. More maintenance, bad by principle.\r\n2) Add it to Gromacs package \u2013 I think it is not logical to do so, as these are forks, also Gromacs package is already complicated\r\n3) Use full inheritance and reset versions\r\n\r\n```python\r\n# Copyright 2013-2021 Lawrence Livermore National Security, LLC and other\r\n# Spack Project Developers. See the top-level COPYRIGHT file for details.\r\n#\r\n# SPDX-License-Identifier: (Apache-2.0 OR MIT)\r\n\r\nfrom spack.pkg.builtin.gromacs import Gromacs as BuiltinGromacs\r\n\r\n\r\ndef filter_versions(version_list, allowed_names):\r\n    return dict((key, value) for key, value in version_list.items()\r\n                if str(key) in allowed_names)\r\n\r\n\r\nclass GromacsChainCoordinate(BuiltinGromacs):\r\n    \"\"\"\r\n    A modification of GROMACS that implements the \"chain coordinate\", a reaction\r\n    coordinate for pore formation in membranes and stalk formation between membranes.\r\n    \"\"\"\r\n\r\n    homepage = 'https://gitlab.com/cbjh/gromacs-chain-coordinate/-/blob/main/README.md'\r\n    url = 'https://gitlab.com/cbjh/gromacs-chain-coordinate/-/archive/release-2021.chaincoord-0.1/gromacs-chain-coordinate-release-2021.chaincoord-0.1.tar.bz2'\r\n    git = 'https://gitlab.com/cbjh/gromacs-chain-coordinate.git'\r\n    maintainers = ['w8jcik']\r\n\r\n    version('main', branch='main')\r\n    version('2021.2-0.1', sha256=\"879fdd04662370a76408b72c9fbc4aff60a6387b459322ac2700d27359d0dd87\",\r\n            url=\"https://gitlab.com/cbjh/gromacs-chain-coordinate/-/archive/release-2021.chaincoord-0.1/gromacs-chain-coordinate-release-2021.chaincoord-0.1.tar.bz2\",\r\n            preferred=True)\r\n\r\n    def __init__(self, spec):\r\n        super(GromacsChainCoordinate, self).__init__(spec)\r\n\r\n        self.versions = filter_versions(self.versions, ['main', '2021.2-0.1'])\r\n```\r\n\r\n- This is less complicated.\r\n- Unfortunately it is using private interface (overriding `versions` property).\r\n- It is also less flexible if we want to have some alterations.\r\n- Python 2.7 tests fail with something about pickling and I wasn't able to fix it\r\n\r\n```python\r\nTypeError: a class that defines __slots__ without defining __getstate__ cannot be pickled\r\n```\r\nhttps://github.com/spack/spack/pull/25426/checks?check_run_id=3329234588\r\n\r\nOtherwise it works as well.\r\n\r\nIs the current implementation fine?\r\n",
    "user": "w8jcik",
    "url": "https://api.github.com/repos/spack/spack/issues/25426",
    "updated_at": "2021-09-30 02:12:38",
    "created_at": "2021-08-14 12:25:32",
    "closed_at": "2021-09-30 02:12:37",
    "state": "closed",
    "title": "gromacs-chain-coordinate: new package",
    "number": 25426,
    "milestone": null,
    "labels": [
        "new-version",
        "new-package",
        "dependencies",
        "maintainers",
        "new-variant"
    ],
    "id": 970901445,
    "html_url": "https://github.com/spack/spack/pull/25426",
    "assignees": [],
    "comments": 0
}