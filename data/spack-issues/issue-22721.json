{
    "body": "Despite PR #22683, I still fail to compile HDF5+fortran with Intel OneAPI, either 2021.1.1 or 2021.2.0.\r\nThis is both on Ubuntu x86_64 18.04 and 20.04 \r\nBasic error remains the same : there is a failing -loopopt=0 from configure.\r\n$ spack install hdf5+fortran~mpi+shared %oneapiAT2021.2\r\n==> Installing zlib-1.2.11-jesz5iyurv6flmlwyt3lolavgui6f6vn\r\n==> No binary for zlib-1.2.11-jesz5iyurv6flmlwyt3lolavgui6f6vn found: installing from source\r\n==> Fetching https://spack-llnl-mirror.s3-us-west-2.amazonaws.com/_source-cache/archive/c3/c3e5e9fdd5004dcb542feda5ee4f0ff0744628baf8ed2dd5d66f8ca1197cb1a1.tar.gz\r\n################################################################################################################ 100.0%\r\n==> No patches needed for zlib\r\n==> zlib: Executing phase: 'install'\r\n==> zlib: Successfully installed zlib-1.2.11-jesz5iyurv6flmlwyt3lolavgui6f6vn\r\n  Fetch: 2.82s.  Build: 2.51s.  Total: 5.33s.\r\n[+] /tmp/spack/opt/spack/linux-ubuntu18.04-zen2/oneapi-2021.2/zlib-1.2.11-jesz5iyurv6flmlwyt3lolavgui6f6vn\r\n==> Installing hdf5-1.10.7-rypct3qztneeyaxk3ihv2vf7ttxc5hty\r\n==> No binary for hdf5-1.10.7-rypct3qztneeyaxk3ihv2vf7ttxc5hty found: installing from source\r\n==> Fetching https://spack-llnl-mirror.s3-us-west-2.amazonaws.com/_source-cache/archive/7a/7a1a0a54371275ce2dfc5cd093775bb025c365846512961e7e5ceaecb437ef15.tar.gz\r\n################################################################################################################ 100.0%\r\n==> Ran patch() for hdf5\r\n==> hdf5: Executing phase: 'autoreconf'\r\n==> hdf5: Executing phase: 'configure'\r\n==> Error: ProcessError: Command exited with status 1:\r\n    '/tmp/cessenat/spack-stage/spack-stage-hdf5-1.10.7-rypct3qztneeyaxk3ihv2vf7ttxc5hty/spack-src/configure' '--prefix=/tmp/spack/opt/spack/linux-ubuntu18.04-zen2/oneapi-2021.2/hdf5-1.10.7-rypct3qztneeyaxk3ihv2vf7ttxc5hty' '--enable-unsupported' '--enable-symbols=yes' '--with-zlib=/tmp/spack/opt/spack/linux-ubuntu18.04-zen2/oneapi-2021.2/zlib-1.2.11-jesz5iyurv6flmlwyt3lolavgui6f6vn' '--disable-threadsafe' '--disable-cxx' '--disable-hl' '--enable-fortran' '--disable-java' '--without-szlib' '--enable-build-mode=production' '--enable-shared' 'CFLAGS=-fPIC' 'CXXFLAGS=-fPIC' 'FCFLAGS=-fPIC'\r\n\r\n2 errors found in build log:\r\n     86    checking what /tmp/spack/lib/spack/env/oneapi/ifx does with modules... module.mod\r\n     87    checking how /tmp/spack/lib/spack/env/oneapi/ifx finds modules... -I\r\n     88    checking if Fortran compiler version compatible with Fortran 2003 HDF... yes\r\n     89    checking how to get verbose linking output from /tmp/spack/lib/spack/env/oneapi/ifx... -v\r\n     90    checking for Fortran libraries of /tmp/spack/lib/spack/env/oneapi/ifx...  **-loopopt=0** -L/opt/intel/oneapi/co\r\n           mpiler/2021.2.0/linux/compiler/lib/intel64_lin -L/opt/intel/oneapi/compiler/2021.2.0/linux/lib -L/usr/lib/g\r\n           cc/x86_64-linux-gnu/7/ -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../x86_64-linux-gnu/ -L/usr/lib/gcc/x86_64-l\r\n           inux-gnu/7/../../../../lib/ -L/lib/x86_64-linux-gnu/ -L/lib/../lib64 -L/lib/../lib/ -L/usr/lib/x86_64-linux\r\n           -gnu/ -L/usr/lib/../lib/ -L/usr/lib/gcc/x86_64-linux-gnu/7/../../../ -L/lib64 -L/lib/ -L/usr/lib -L/usr/lib\r\n           /i386-linux-gnu -lifport -lifcoremt -limf -lsvml -lm -lipgo -lirc -lpthread -lirc_s -ldl\r\n     91    checking for dummy main to link with Fortran libraries... unknown\r\n  >> 92    configure: error: in `/tmp/cessenat/spack-stage/spack-stage-hdf5-1.10.7-rypct3qztneeyaxk3ihv2vf7ttxc5hty/sp\r\n           ack-src':\r\n  >> 93    configure: error: linking to Fortran libraries from C fails\r\n     94    See `config.log' for more details\r\n     94    See `config.log' for more details\r\n\r\nSee build log for details:\r\n  /tmp/cessenat/spack-stage/spack-stage-hdf5-1.10.7-rypct3qztneeyaxk3ihv2vf7ttxc5hty/spack-build-out.txt\r\n\r\n\r\nAlso, there are weird errors with\r\n- OneAPI 2021.1.1:\r\n$ spack install hdf5ATdevelop+fortran~mpi+shared %oneapiAT2021.1 ^autoconf@2.71\r\n... bla bla bla ...\r\n     9058    libtool: compile:  /home/cessenat/Softs/spack/lib/spack/env/oneapi/ifx -I. -\r\n             I../../src -stand:f03 -free -warn:all -g -O3 -I../../src -I../../fortran/src\r\n              -fPIC -c HDF5.F90 -o HDF5.o >/dev/null 2>&1\r\n     9059      FCLD     libhdf5_fortran.la\r\n     9060    ld: .libs/H5_ff.o: **relocation R_X86_64_PC32 against symbol `h5global_mp_pred\r\n             ef_types_' can not be used when making a shared object; recompile with -fPIC**\r\n  >> 9061    ld: final link failed: bad value\r\n     9062    make[3]: *** [Makefile:987: libhdf5_fortran.la] Error 1\r\n     9063    make[3]: Leaving directory '/tmp/cessenat/spack-stage/spack-stage-hdf5-devel\r\n             op-yxj7hfd2ulqg2sdkboqozeufaaullqfp/spack-src/fortran/src'\r\n\r\n- OneAPI 2021.2.0:\r\n$ spack install hdf5ATdevelop+fortran~mpi+shared %oneapiAT2021.2 ^autoconf@2.71\r\n... bla bla bla ...\r\n  >> 9286    tf.F90(150): error #5528: The REFERENCE attribute cannot be used with a pass\r\n             ed length CHARACTER variable on this platform\r\n     9287           INTEGER FUNCTION h5_fixname_c(base_name, base_namelen, fapl, &\r\n     9288    -------------------------------------^\r\n  >> 9289    tf.F90(151): error #5528: The REFERENCE attribute cannot be used with a pass\r\n             ed length CHARACTER variable on this platform\r\n     9290                full_name, full_namelen)\r\n     9291    ------------^\r\n  >> 9292    tf.F90(207): error #5528: The REFERENCE attribute cannot be used with a pass\r\n             ed length CHARACTER variable on this platform\r\n     9293           INTEGER FUNCTION h5_cleanup_c(base_name, base_namelen, fapl)\r\n     9294    -------------------------------------^\r\n     9295    compilation aborted for tf.F90 (code 1)\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\n* **Spack:** 0.16.1-2002-09dcb16a70\r\n* **Python:** 3.6.9\r\n* **Platform:** linux-ubuntu18.04-zen2\r\n* **Concretizer:** original\r\n\r\n<!-- If you have any relevant configuration detail (custom `packages.yaml` or `modules.yaml`, etc.) you can add that here as well. -->\r\n~/.spack/linux/compilers.yaml\r\n- compiler:\r\n    spec: oneapi@2021.2\r\n    paths:\r\n      cc: /opt/intel/oneapi/compiler/2021.2.0/linux/bin/icx\r\n      cxx: /opt/intel/oneapi/compiler/2021.2.0/linux/bin/icpx\r\n      f77: /opt/intel/oneapi/compiler/2021.2.0/linux/bin/ifx\r\n      fc: /opt/intel/oneapi/compiler/2021.2.0/linux/bin/ifx\r\n    flags: {}\r\n    operating_system: ubuntu18.04\r\n    target: x86_64\r\n    modules: [compiler/2021.2.0]\r\n    environment:\r\n      append_path:\r\n        LD_LIBRARY_PATH: ${LD_LIBRARY_PATH}:/opt/intel/oneapi/compiler/2021.2.0/linux/compiler/lib/intel64_lin\r\n      set:\r\n        MODULEPATH: ${MODULEPATH}:/opt/intel/oneapi/modulefiles\r\n    extra_rpaths:\r\n    - /opt/intel/oneapi/compiler/2021.2.0/linux/compiler/lib/intel64_lin\r\n\r\n\r\n### Additional information\r\n\r\n<!-- Please upload the following files. They should be present in the stage directory of the failing build. Also upload any config.log or similar file if one exists. -->\r\n* [spack-build-out.txt](\r\n[spack-build-out.txt](https://github.com/spack/spack/files/6243465/spack-build-out.txt)\r\n) \r\n[spack-build-out.txt](https://github.com/spack/spack/files/6243589/spack-build-out.txt)\r\n\r\n* [spack-build-env.txt](\r\n[spack-build-env.txt](https://github.com/spack/spack/files/6243466/spack-build-env.txt)\r\n)\r\n[spack-build-env.txt](https://github.com/spack/spack/files/6243591/spack-build-env.txt)\r\n\r\nAddon:\r\n -error for \"spack install hdf5ATdevelop+fortran~mpi+shared %oneapiAT2021.1 ^autoconf@2.71\":\r\n[hdf5_spack-build-out_oneapi2021-1.txt](https://github.com/spack/spack/files/6243529/hdf5_spack-build-out_oneapi2021-1.txt)\r\n[hdf5_spack-build-env_oneapi2021-1.txt](https://github.com/spack/spack/files/6243544/hdf5_spack-build-env_oneapi2021-1.txt)\r\n\r\n -error for \"spack install hdf5ATdevelop+fortran~mpi+shared %oneapiAT2021.2 ^autoconf@2.71\":\r\n[hdf5_spack-build-out_oneapi2021-2.txt](https://github.com/spack/spack/files/6243531/hdf5_spack-build-out_oneapi2021-2.txt)\r\n[hdf5_spack-build-env_oneapi2021-2.txt](https://github.com/spack/spack/files/6243546/hdf5_spack-build-env_oneapi2021-2.txt)\r\n\r\n<!-- Some packages have maintainers who have volunteered to debug build failures. Run `spack maintainers <name-of-the-package>` and @mention them here if they exist. -->\r\n@lrknox @tgamblin @frankwillmore\r\n\r\n### General information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have run `spack maintainers <name-of-the-package>` and @mentioned any maintainers\r\n- [x] I have uploaded the build log and environment files\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n",
    "user": "cessenat",
    "url": "https://api.github.com/repos/spack/spack/issues/22721",
    "updated_at": "2021-06-24 05:02:36",
    "created_at": "2021-04-01 12:50:52",
    "closed_at": "2021-06-23 15:37:50",
    "state": "closed",
    "title": "Installation issue: hdf5+fortran %oneapi",
    "number": 22721,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 848439747,
    "html_url": "https://github.com/spack/spack/issues/22721",
    "assignees": [],
    "comments": 9
}