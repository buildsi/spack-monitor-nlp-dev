{
    "body": "### Steps to reproduce the issue\n\n`cabana@0.4.0 +rocm` build fails using:\r\n* `spack@develop` (f6802b733a8889e73edeaa6c80d2077ee86bc490 from `Mon Dec 13 11:45:31 2021 +0100`)\r\n* Ubuntu 20.04, GCC 9.3.0\r\n* ROCm 4.3.1 installed via apt; individual components registered as external packages with Spack\r\n\r\n**Concrete spec:** [cabana.spec.json.txt](https://github.com/spack/spack/files/7706386/cabana.spec.json.txt)\r\n\r\n**Concretization**\r\n```\r\ncabana@0.4.0%gcc@9.3.0~arborx~cuda~heffte~hypre~ipo+mpi~openmp~pthread+rocm+serial+shared~sycl build_type=RelWithDebInfo arch=linux-ubuntu20.04-x86_64\r\n    ^cmake@3.21.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-x86_64\r\n        ^ncurses@6.2%gcc@9.3.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-x86_64\r\n            ^pkgconf@1.8.0%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n        ^openssl@1.1.1l%gcc@9.3.0~docs certs=system arch=linux-ubuntu20.04-x86_64\r\n            ^perl@5.34.0%gcc@9.3.0+cpanm+shared+threads arch=linux-ubuntu20.04-x86_64\r\n                ^berkeley-db@18.1.40%gcc@9.3.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu20.04-x86_64\r\n                ^bzip2@1.0.8%gcc@9.3.0~debug~pic+shared arch=linux-ubuntu20.04-x86_64\r\n                    ^diffutils@3.8%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                        ^libiconv@1.16%gcc@9.3.0 libs=shared,static arch=linux-ubuntu20.04-x86_64\r\n                ^gdbm@1.19%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                    ^readline@8.1%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                ^zlib@1.2.11%gcc@9.3.0+optimize+pic+shared arch=linux-ubuntu20.04-x86_64\r\n    ^kokkos@3.4.01%gcc@9.3.0~aggressive_vectorization~compiler_warnings~cuda~cuda_constexpr~cuda_lambda~cuda_ldg_intrinsic~cuda_relocatable_device_code~cuda_uvm~debug~debug_bounds_check~debug_dualview_modify_check~deprecated_code~examples~explicit_instantiation~hpx~hpx_async_dispatch~hwloc~ipo~memkind~numactl~openmp~pic+profiling~profiling_load_print~pthread~qthread+rocm+serial+shared~sycl~tests~tuning~wrapper amdgpu_target=gfx906 build_type=RelWithDebInfo std=14 arch=linux-ubuntu20.04-x86_64\r\n        ^hip@4.3.1%gcc@9.3.0~ipo build_type=Release patches=2a4190477b7d9206b9cd8d70770ba0bc007273cbe54772efb12f9ca2e37c0392,99190b4616edb362d48f9b265c3018a3c6339481b0729d9fe46185fca25bc54b,e276c4acf3d37712b6bea306fea34f539d3c4f743471e9da208b5eb17b16ae67 arch=linux-ubuntu20.04-x86_64\r\n        ^hsa-rocr-dev@4.3.1%gcc@9.3.0+image~ipo+shared build_type=Release patches=71e6851d9be8113bfb8d71b66a3171e0d0401bae5e6f161c9e7fe32558261a46 arch=linux-ubuntu20.04-x86_64\r\n        ^llvm-amdgpu@4.3.1%gcc@9.3.0~ipo+openmp+rocm-device-libs build_type=Release patches=d999f3b235e655ee07f6dd2590302082feaa06d32c5c6b53aae9c5cf1e45b644 arch=linux-ubuntu20.04-x86_64\r\n    ^mpich@3.4.2%gcc@9.3.0~argobots+fortran+hwloc+hydra+libxml2+pci+romio~slurm~two_level_namespace~verbs~wrapperrpath device=ch4 netmod=ofi pmi=pmi arch=linux-ubuntu20.04-x86_64\r\n        ^findutils@4.8.0%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n        ^hwloc@2.6.0%gcc@9.3.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml~opencl+pci~rocm+shared arch=linux-ubuntu20.04-x86_64\r\n            ^libpciaccess@0.16%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                ^libtool@2.4.6%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                    ^m4@1.4.19%gcc@9.3.0+sigsegv patches=9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573,bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89 arch=linux-ubuntu20.04-x86_64\r\n                        ^libsigsegv@2.13%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n                ^util-macros@1.19.3%gcc@9.3.0 arch=linux-ubuntu20.04-x86_64\r\n            ^libxml2@2.9.12%gcc@9.3.0~python arch=linux-ubuntu20.04-x86_64\r\n                ^xz@5.2.5%gcc@9.3.0+pic libs=shared,static arch=linux-ubuntu20.04-x86_64\r\n        ^libfabric@1.14.0%gcc@9.3.0~debug~kdreg fabrics=rxm,sockets,tcp,udp arch=linux-ubuntu20.04-x86_64\r\n```\r\n\r\n**Installation**\r\n```\r\n$> spack install -f ./cabana.spec.json\r\n...\r\n==> Installing cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn\r\n==> No binary for cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn found: installing from source\r\n==> Using cached archive: /spack/var/spack/cache/_source-cache/archive/c3/c347d23dc4a5204f9cc5906ccf3454f0b0b1612351bbe0d1c58b14cddde81e85.tar.gz\r\n==> No patches needed for cabana\r\n==> cabana: Executing phase: 'cmake'\r\n==> cabana: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\n\r\n78 errors found in build log:\r\n...\r\n     203    cd /tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju/core/unit_test && /spack/lib/spack/env/gcc/g++ -DKOKKOS_DEPENDEN\r\n            CE -I/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-src/core/src -I/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u6\r\n            6yvaqeo63z2cesrhmn/spack-build-yzb2jju/core/src -isystem /spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/kokkos-3.4.01-6hn26k77pcug7eptiaahot22lw7lgfpo/include -is\r\n            ystem /spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/mpich-3.4.2-da2intlyhnltoebtrcvfl7qeffmwwzp6/include -isystem /tmp/root/spack-stage/spack-stage-cabana-0.4.0-\r\n            yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju/_deps/googletest-src/googletest/include -isystem /tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yva\r\n            qeo63z2cesrhmn/spack-build-yzb2jju/_deps/googletest-src/googletest -O2 -g -DNDEBUG -fno-gpu-rdc --amdgpu-target=gfx906 -std=c++14 -MD -MT core/unit_test/CMakeFiles/Cab\r\n            ana_CartesianGrid_test.dir/tstCartesianGrid.cpp.o -MF CMakeFiles/Cabana_CartesianGrid_test.dir/tstCartesianGrid.cpp.o.d -o CMakeFiles/Cabana_CartesianGrid_test.dir/tst\r\n            CartesianGrid.cpp.o -c /tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-src/core/unit_test/tstCartesianGrid.cpp\r\n  >> 204    g++: error: unrecognized command line option '-fno-gpu-rdc'\r\n  >> 205    g++: error: unrecognized command line option '-fno-gpu-rdc'\r\n  >> 206    g++: error: unrecognized command line option '-fno-gpu-rdc'\r\n  >> 207    g++: error: unrecognized command line option '-fno-gpu-rdc'\r\n...\r\n  >> 217    g++: error: unrecognized command line option '--amdgpu-target=gfx906'\r\n  >> 218    make[2]: *** [core/unit_test/CMakeFiles/Cabana_Halo_test_HIP.dir/build.make:79: core/unit_test/CMakeFiles/Cabana_Halo_test_HIP.dir/HIP/tstHalo_HIP.cpp.o] Error 1\r\n     219    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju'\r\n  >> 220    make[1]: *** [CMakeFiles/Makefile2:552: core/unit_test/CMakeFiles/Cabana_Halo_test_HIP.dir/all] Error 2\r\n     221    make[1]: *** Waiting for unfinished jobs....\r\n  >> 222    g++: error: unrecognized command line option '-fno-gpu-rdc'\r\n  >> 223    g++: error: unrecognized command line option '--amdgpu-target=gfx906'\r\n  >> 224    g++: error: unrecognized command line option '--amdgpu-target=gfx906'\r\n  >> 225    make[2]: *** [core/unit_test/CMakeFiles/Cabana_ParameterPack_test_SERIAL.dir/build.make:79: core/unit_test/CMakeFiles/Cabana_ParameterPack_test_SERIAL.dir/SERIAL/tstPa\r\n            rameterPack_SERIAL.cpp.o] Error 1\r\n     226    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju'\r\n  >> 227    g++: error: unrecognized command line option '--amdgpu-target=gfx906'\r\n  >> 228    make[1]: *** [CMakeFiles/Makefile2:682: core/unit_test/CMakeFiles/Cabana_ParameterPack_test_SERIAL.dir/all] Error 2\r\n  >> 229    make[2]: *** [core/unit_test/CMakeFiles/Cabana_Parallel_test_HIP.dir/build.make:79: core/unit_test/CMakeFiles/Cabana_Parallel_test_HIP.dir/HIP/tstParallel_HIP.cpp.o] E\r\n            rror 1\r\n     230    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju'\r\n  >> 231    make[1]: *** [CMakeFiles/Makefile2:760: core/unit_test/CMakeFiles/Cabana_Parallel_test_HIP.dir/all] Error 2\r\n  >> 232    make[2]: *** [core/unit_test/CMakeFiles/Cabana_Tuple_test_SERIAL.dir/build.make:79: core/unit_test/CMakeFiles/Cabana_Tuple_test_SERIAL.dir/SERIAL/tstTuple_SERIAL.cpp.o\r\n            ] Error 1\r\n     233    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju'\r\n  >> 234    make[1]: *** [CMakeFiles/Makefile2:578: core/unit_test/CMakeFiles/Cabana_Tuple_test_SERIAL.dir/all] Error 2\r\n  >> 235    g++: error: unrecognized command line option '--amdgpu-target=gfx906'\r\n  >> 236    make[2]: *** [core/unit_test/CMakeFiles/Cabana_SoA_test.dir/build.make:79: core/unit_test/CMakeFiles/Cabana_SoA_test.dir/tstSoA.cpp.o] Error 1\r\n     237    make[2]: Leaving directory '/tmp/root/spack-stage/spack-stage-cabana-0.4.0-yzb2jju24z47u66yvaqeo63z2cesrhmn/spack-build-yzb2jju'\r\n  >> 238    make[1]: *** [CMakeFiles/Makefile2:656: core/unit_test/CMakeFiles/Cabana_SoA_test.dir/all] Error 2\r\n     239    [  4%] Building CXX object core/unit_test/CMakeFiles/Cabana_NeighborList_test_SERIAL.dir/__/__/cmake/test_harness/unit_test_main.cpp.o\r\n  >> 240    g++: error: unrecognized command line option '--amdgpu-target=gfx906'\r\n...\r\n```\n\n### Information on your system\n\n* **Spack:** 0.17.0-496-f6802b733a\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-broadwell\r\n* **Concretizer:** clingo\n\n### Additional information\n\n[spack-build-01-cmake-out.txt](https://github.com/spack/spack/files/7706418/spack-build-01-cmake-out.txt)\r\n[spack-build-env.txt](https://github.com/spack/spack/files/7706416/spack-build-env.txt)\r\n[spack-build-out.txt](https://github.com/spack/spack/files/7706417/spack-build-out.txt)\r\n\r\n@junghans\r\n@sslattery\r\n@streeve\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\n- [X] I have uploaded the build log and environment files\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/27967",
    "updated_at": "2021-12-14 17:25:53",
    "created_at": "2021-12-13 19:34:04",
    "closed_at": "None",
    "state": "open",
    "title": "cabana +rocm build fails: g++: error: unrecognized command line option '--amdgpu-target=gfx906'",
    "number": 27967,
    "milestone": null,
    "labels": [
        "build-error",
        "e4s",
        "ROCm/hip"
    ],
    "id": 1078905742,
    "html_url": "https://github.com/spack/spack/issues/27967",
    "assignees": [],
    "comments": 3
}