{
    "body": "### Steps to reproduce\r\n\r\nBuilds of `hdf5` starting after cc20dbf645d32a45ce6b7ed848c6f25eaf42e350 and 55dd306790eee6165e9076402bb6e674be7df324 produce `h5pcc` and `h5hlcc` that, when used, give link errors on Ubuntu 18.04 and 20.04. Problem does not appear to effect RHEL 7 and 8 builds.\r\n\r\nProblem illustrated below using:\r\n* spack@develop (e2b9ba30012aeab5a39f016f6efd7c9cdf9003f0 from Sat Aug 28 02:28:46 2021 +0200)\r\n* Ubuntu 20.04, GCC 9.3.0\r\n* Docker container image `ecpe4s/ubuntu20.04-runner-x86_64:2021-07-01`\r\n\r\nConcrete spec: [hdf5.spec.yaml.txt](https://github.com/spack/spack/files/7070010/hdf5.spec.yaml.txt)\r\n\r\n```\r\n$> spack mirror add E4S https://cache.e4s.io\r\n$> spack buildcache keys -it\r\n\r\n$> spack install -f ./hdf5.spec.yaml\r\n...\r\n==> Installing hdf5-1.12.0-vjgxfgrj67ajzx3ed6gvyaadtyh773nd\r\n==> Fetching https://cache.e4s.io/build_cache/linux-ubuntu20.04-x86_64/gcc-9.3.0/hdf5-1.12.0/linux-ubuntu20.04-x86_64-gcc-9.3.0-hdf5-1.12.0-vjgxfgrj67ajzx3ed6gvyaadtyh773nd.spack\r\n==> Extracting hdf5-1.12.0-vjgxfgrj67ajzx3ed6gvyaadtyh773nd from binary cache\r\ngpg: Signature made Mon 16 Aug 2021 11:00:10 AM PDT\r\ngpg:                using RSA key 25645FA2B218FE55B4EF649E4345F04B40005581\r\ngpg: Good signature from \"University of Oregon - E4S\" [unknown]\r\ngpg: WARNING: This key is not certified with a trusted signature!\r\ngpg:          There is no indication that the signature belongs to the owner.\r\nPrimary key fingerprint: 2564 5FA2 B218 FE55 B4EF  649E 4345 F04B 4000 5581\r\n[+] /spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/hdf5-1.12.0-vjgxfgrj67ajzx3ed6gvyaadtyh773nd\r\n\r\n$> git clone https://github.com/E4S-Project/testsuite\r\n$> cd testsuite/validation_tests/hdf5\r\n$> ./compile.sh\r\nvjgxfgr\r\n+ h5pcc -o ph5example ./ph5example.c\r\n/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/hdf5-1.12.0-vjgxfgrj67ajzx3ed6gvyaadtyh773nd/h5pcc\r\ndir is /spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/hdf5-1.12.0-vjgxfgrj67ajzx3ed6gvyaadtyh773nd\r\n/usr/bin/ld: /tmp/cc74NC07.o: in function `phdf5writeInd':\r\nph5example.c:(.text+0x4ce): undefined reference to `H5open'\r\n/usr/bin/ld: ph5example.c:(.text+0x4d5): undefined reference to `H5P_CLS_FILE_ACCESS_ID_g'\r\n/usr/bin/ld: ph5example.c:(.text+0x4dd): undefined reference to `H5Pcreate'\r\n/usr/bin/ld: ph5example.c:(.text+0x540): undefined reference to `H5Pset_fapl_mpio'\r\n/usr/bin/ld: ph5example.c:(.text+0x598): undefined reference to `H5check_version'\r\n/usr/bin/ld: ph5example.c:(.text+0x59d): undefined reference to `H5open'\r\n/usr/bin/ld: ph5example.c:(.text+0x5c0): undefined reference to `H5Fcreate'\r\n/usr/bin/ld: ph5example.c:(.text+0x615): undefined reference to `H5Pclose'\r\n/usr/bin/ld: ph5example.c:(.text+0x65c): undefined reference to `H5Screate_simple'\r\n/usr/bin/ld: ph5example.c:(.text+0x6a7): undefined reference to `H5open'\r\n/usr/bin/ld: ph5example.c:(.text+0x6ae): undefined reference to `H5T_NATIVE_INT_g'\r\n/usr/bin/ld: ph5example.c:(.text+0x6dd): undefined reference to `H5Dcreate2'\r\n/usr/bin/ld: ph5example.c:(.text+0x72c): undefined reference to `H5open'\r\n/usr/bin/ld: ph5example.c:(.text+0x733): undefined reference to `H5T_NATIVE_INT_g'\r\n/usr/bin/ld: ph5example.c:(.text+0x762): undefined reference to `H5Dcreate2'\r\n/usr/bin/ld: ph5example.c:(.text+0x8ae): undefined reference to `H5Dget_space'\r\n/usr/bin/ld: ph5example.c:(.text+0x926): undefined reference to `H5Sselect_hyperslab'\r\n/usr/bin/ld: ph5example.c:(.text+0x983): undefined reference to `H5Screate_simple'\r\n/usr/bin/ld: ph5example.c:(.text+0x9b8): undefined reference to `H5open'\r\n/usr/bin/ld: ph5example.c:(.text+0x9bf): undefined reference to `H5T_NATIVE_INT_g'\r\n...\r\ncollect2: error: ld returned 1 exit status\r\n```\r\n\r\nLine 32 of `$(which h5pcc)`:\r\n```\r\n/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/mpich-3.4.2-wi7swccrpet3ioz2fig2l233prsd5xq3/bin/mpicc `pkg-config --define-variable=prefix=$dir --cflags --libs hdf5-1.12.0` $@\r\n```\r\n\r\nChange so that `$@` comes before `pkgconf` output:\r\n```\r\n/spack/opt/spack/linux-ubuntu20.04-x86_64/gcc-9.3.0/mpich-3.4.2-wi7swccrpet3ioz2fig2l233prsd5xq3/bin/mpicc $@ `pkg-config --define-variable=prefix=$dir --cflags --libs hdf5-1.12.0`\r\n```\r\n\r\n... and the problem goes away.\r\n\r\nI don't know why this is an issue specifically on Ubuntu 18.04 and 20.04, but not RHEL 7 and RHEL 8... It may affect more than `h5pcc`. I do not know.\r\n\r\n@wspear @ChristopherHogan @brtnfld @byrnHDF @lkurz \r\n@epourmal @gheber @hyoklee @lrknox @soumagne @skosukhin\r\n\r\n### Error message\r\n\r\n_No response_\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.2-4080-e2b9ba3001\r\n* **Python:** 3.8.5\r\n* **Platform:** linux-ubuntu20.04-cascadelake\r\n* **Concretizer:** original\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/25673",
    "updated_at": "2021-09-17 21:37:27",
    "created_at": "2021-08-28 02:35:59",
    "closed_at": "None",
    "state": "open",
    "title": "hdf5: h5pcc, h5hlcc: switch to cmake causing link issues on Ubuntu 18, 20",
    "number": 25673,
    "milestone": null,
    "labels": [
        "bug",
        "triage",
        "e4s"
    ],
    "id": 981703339,
    "html_url": "https://github.com/spack/spack/issues/25673",
    "assignees": [],
    "comments": 1
}