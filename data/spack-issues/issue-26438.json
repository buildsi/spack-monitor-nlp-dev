{
    "body": "### Steps to reproduce\n\nAfter installing Xcode 13, which was released a few weeks ago, and its command line tools, gcc fails to build. I tried to build with command\r\n```\r\nspack install -j 1 gcc\r\n```\r\n(the `-j 1` option being to ensure ungarbled build output). The build error, from `spack-build-out.txt`, is:\r\n```\r\necho | /private/var/folders/ps/s7z7d8m50qd1k_4ry_v88_mm0000gn/T/ben/spack-stage/spack-stage-gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz/spack-src/spack-build/./gcc/xgcc -B/private/var/folders/ps/s7z7d8m50qd1k_4ry_v88_mm0000gn/T/ben/spack-stage/spack-stage-gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz/spack-src/spack-build/./gcc/ -E -dM - | \\\r\n          sed -n -e 's/^#define \\([^_][a-zA-Z0-9_]*\\).*/\\1/p' \\\r\n                 -e 's/^#define \\(_[^_A-Z][a-zA-Z0-9_]*\\).*/\\1/p' | \\\r\n          sort -u > tmp-macro_list\r\ndyld: Library not loaded: /usr/local/lib/libzstd.1.dylib\r\n  Referenced from: /private/var/folders/ps/s7z7d8m50qd1k_4ry_v88_mm0000gn/T/ben/spack-stage/spack-stage-gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz/spack-src/spack-build/./gcc/cc1\r\n  Reason: image not found\r\nxgcc: internal compiler error: Abort trap: 6 signal terminated program cc1\r\n```\r\n\r\nIt seems to be an issue with how the zstd library is linked to the binaries built by gcc. The command that builds `xgcc` is\r\n```\r\n/Users/ben/source/spack/lib/spack/env/clang/clang++ -std=c++11 -no-pie   -g  -DIN_GCC    -fno-strict-aliasing -fno-exceptions -fno-rtti -fasynchronous-unwind-tables -W -Wall -Wno-narrowing -Wwrite-strings -Wcast-qual -Wno-error=format-diag -Wno-format -Wmissing-format-attribute -Woverloaded-virtual -pedantic -Wno-long-long -Wno-variadic-macros -Wno-overlength-strings -fno-common  -DHAVE_CONFIG_H -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz/lib -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz/lib64 -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/gmp-6.2.1-hy4uvsghpne2d6ya7mcwxcvxzh4i3bak/lib -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/libiconv-1.16-fu7tfsrqgljwmgqfaf7zfehjbqhbr2vs/lib -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/mpc-1.1.0-lu23k2uff3v34bahbb4yi2zh3vre2w7a/lib -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/mpfr-4.1.0-f323tgxhee2umcfvobvlj4qi6ztyk7wh/lib -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/zlib-1.2.11-xevvljjwbmyqlp45p465lfqqj7e6kjeg/lib -Wl,-rpath,/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/zstd-1.5.0-oujwandath4wbabdvhy762bt3kcvdnyx/lib   -o xgcc gcc.o gcc-main.o ggc-none.o \\\r\n\t  c/gccspec.o driver-i386.o darwin-driver.o libcommon-target.a \\\r\n\t   libcommon.a ../libcpp/libcpp.a  -L/Users/ben/opt/spack/darwin-bigsur-skylake/apple-clang-13.0.0/libiconv-1.16-fu7tfsrqgljwmgqfaf7zfehjbqhbr2vs/lib -liconv ../libbacktrace/.libs/libbacktrace.a ../libiberty/libiberty.a ../libdecnumber/libdecnumber.a \r\n```\r\nThe correct directory for the Spack-built libzstd is in xgcc's RPATH (confirmed with `otool -l`), but the library doesn't load. Ostensibly the executable tries to load libzstd through `dlopen` (since libzstd isn't in the `otool -L` output), so it seems there's a loader path that's not correctly populated in the executable.\n\n### Error message\n\n```\r\n==> gcc: Executing phase: 'autoreconf'\r\n==> gcc: Executing phase: 'configure'\r\n==> gcc: Executing phase: 'build'\r\nlib/spack/spack/error.py:54 ==> [2021-10-02-20:49:24.380488] Error: ProcessError: Command exited with status 2:\r\n    'make' 'V=1'\r\n\r\n4 errors found in build log:\r\n     545031      Referenced from: /private/var/folders/ps/s7z7d8m50qd1k_4ry_v88\r\n               _mm0000gn/T/ben/spack-stage/spack-stage-gcc-11.2.0-pqdqj7f4ox2aw\r\n               3kxfcc4vzfejibrtimz/spack-src/spack-build/./gcc/cc1\r\n     545032      Reason: image not found\r\n     545033    xgcc: internal compiler error: Abort trap: 6 signal terminated p\r\n               rogram cc1\r\n     545034    Please submit a full bug report,\r\n     545035    with preprocessed source if appropriate.\r\n     545036    See <https://github.com/spack/spack/issues> for instructions.\r\n  >> 545037    make[3]: *** [s-selftest-c] Error 4\r\n     545038    rm gcc.pod\r\n  >> 545039    make[2]: *** [all-stage1-gcc] Error 2\r\n  >> 545040    make[1]: *** [stage1-bubble] Error 2\r\n  >> 545041    make: *** [all] Error 2\r\n\r\nSee build log for details:\r\n  /var/folders/ps/s7z7d8m50qd1k_4ry_v88_mm0000gn/T/ben/spack-stage/spack-stage-gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz/spack-build-out.txt\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/ben/source/spack/lib/spack/spack/build_environment.py\", line 1029, in _setup_pkg_and_run\r\n    return_value = function(pkg, kwargs)\r\n  File \"/Users/ben/source/spack/lib/spack/spack/installer.py\", line 1883, in build_process\r\n    return installer.run()\r\n  File \"/Users/ben/source/spack/lib/spack/spack/installer.py\", line 1749, in run\r\n    self._real_install()\r\n  File \"/Users/ben/source/spack/lib/spack/spack/installer.py\", line 1847, in _real_install\r\n    phase(pkg.spec, pkg.prefix)\r\n  File \"/Users/ben/source/spack/lib/spack/spack/package.py\", line 116, in phase_wrapper\r\n    phase(spec, prefix)\r\n  File \"/Users/ben/source/spack/lib/spack/spack/build_systems/autotools.py\", line 352, in build\r\n    inspect.getmodule(self).make(*params)\r\n  File \"/Users/ben/source/spack/lib/spack/spack/build_environment.py\", line 148, in __call__\r\n    return super(MakeExecutable, self).__call__(*args, **kwargs)\r\n  File \"/Users/ben/source/spack/lib/spack/spack/util/executable.py\", line 225, in __call__\r\n    raise ProcessError('Command exited with status %d:' %\r\nspack.util.executable.ProcessError: Command exited with status 2:\r\n    'make' 'V=1'\r\nlib/spack/spack/installer.py:1337 ==> [2021-10-02-20:50:36.525367] Flagging gcc-11.2.0-pqdqj7f4ox2aw3kxfcc4vzfejibrtimz as failed: ProcessError: Command exited with status 2:\r\n    'make' 'V=1'\r\nlib/spack/spack/main.py:800 ==> [2021-10-02-20:50:36.590056] ChildError: ProcessError: Command exited with status 2:\r\n    'make' 'V=1'\r\n```\n\n### Information on your system\n\n* **Spack:** 0.16.2-4358-76ad001c56\r\n* **Python:** 3.8.9\r\n* **Platform:** darwin-bigsur-skylake\r\n* **Concretizer:** clingo\r\n\r\nMy `compilers.yaml`:\r\n```\r\ncompilers:\r\n- compiler:\r\n    spec: apple-clang@13.0.0\r\n    paths:\r\n      cc: /usr/bin/clang\r\n      cxx: /usr/bin/clang++\r\n      f77: null\r\n      fc: null\r\n    flags: {}\r\n    operating_system: bigsur\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "benc303",
    "url": "https://api.github.com/repos/spack/spack/issues/26438",
    "updated_at": "2021-10-05 15:09:19",
    "created_at": "2021-10-03 03:06:45",
    "closed_at": "2021-10-05 02:03:48",
    "state": "closed",
    "title": "Installation issue: gcc with Xcode 13",
    "number": 26438,
    "milestone": null,
    "labels": [
        "macOS",
        "build-error",
        "triage"
    ],
    "id": 1014241935,
    "html_url": "https://github.com/spack/spack/issues/26438",
    "assignees": [],
    "comments": 5
}