{
    "body": "### Steps to reproduce\n\nThe issue can be reproduce locally with this simple environment:\r\n```yaml\r\nspack:\r\n  specs:\r\n  - libpciaccess ^libtool@2.4.6\r\n  - libpciaccess ^libtool@develop\r\n```\r\nwhich installs the same spec using two different build dependencies. This results in the two specs having:\r\n- The same value for `dag_hash`\r\n- Different values for `build_hash` and `full_hash`\r\n\r\nThe environment can be concretized correctly and produces a valid `spack.lock`:\r\n\r\n<details>\r\n\r\n<summary>$ spack concretize</summary>\r\n\r\n```console\r\n==> Concretized libpciaccess ^libtool@2.4.6\r\n -   hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   swnsnhf      ^libtool@2.4.6%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   grd2nfx          ^m4@1.4.19%gcc@11.1.0+sigsegv arch=linux-ubuntu18.04-broadwell\r\n[+]  oo46dbm              ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n[+]  o55dukk      ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n[+]  gzatf2b      ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n\r\n==> Concretized libpciaccess ^libtool@develop\r\n -   hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   7fvqcq5      ^libtool@develop%gcc@11.1.0 patches=055fdac32f7768c44f64dfc18c183233a7909ff8b7556f67038350eed2056571 arch=linux-ubuntu18.04-broadwell\r\n -   nw7erwd          ^autoconf@2.69%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   grd2nfx              ^m4@1.4.19%gcc@11.1.0+sigsegv arch=linux-ubuntu18.04-broadwell\r\n[+]  oo46dbm                  ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   276j6k5              ^perl@5.34.0%gcc@11.1.0+cpanm+shared+threads arch=linux-ubuntu18.04-broadwell\r\n[+]  zygezsz                  ^berkeley-db@18.1.40%gcc@11.1.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu18.04-broadwell\r\n -   maxtuqi                  ^bzip2@1.0.8%gcc@11.1.0~debug~pic+shared arch=linux-ubuntu18.04-broadwell\r\n -   cxdoxv2                      ^diffutils@3.7%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n[+]  kju5v7i                          ^libiconv@1.16%gcc@11.1.0 libs=shared,static arch=linux-ubuntu18.04-broadwell\r\n -   fpjhmtn                  ^gdbm@1.19%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   uycefnd                      ^readline@8.1%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   6peormu                          ^ncurses@6.2%gcc@11.1.0~symlinks+termlib abi=none arch=linux-ubuntu18.04-broadwell\r\n[+]  o55dukk                              ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n[+]  5rs6nuu                  ^zlib@1.2.11%gcc@11.1.0+optimize+pic+shared arch=linux-ubuntu18.04-broadwell\r\n -   gvowywk          ^automake@1.16.3%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   7fpysee          ^help2man@1.47.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n -   s5tjkhg          ^texinfo@6.5%gcc@11.1.0 patches=12f6edb0c6b270b8c8dba2ce17998c580db01182d871ee32b7b6e4129bd1d23a,1732115f651cff98989cb0215d8f64da5e0f7911ebf0c13b064920f088f2ffe1 arch=linux-ubuntu18.04-broadwell\r\n[+]  o7bfci5          ^xz@5.2.5%gcc@11.1.0~pic libs=shared,static arch=linux-ubuntu18.04-broadwell\r\n[+]  gzatf2b      ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n```\r\n\r\n</details>\r\n\r\nIt can also be installed correctly as a whole by:\r\n```console\r\n$ spack install\r\n```\r\nHowever, trying to install only part of it fails:\r\n```console\r\n$ spack install --no-add libpciaccess\r\n==> Error: libpciaccess matches multiple specs in the environment /home/culpo/tmp/fullhash: \r\nRoot spec libpciaccess ^libtool@2.4.6\r\n  hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\nRoot spec libpciaccess ^libtool@develop\r\n  hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n```\r\nNot that **this also happens if we use a spec.yaml from a concrete spec** which is what we do in pipelines:\r\n```console\r\n$ spack install --no-add -f libpciaccess.yaml\r\n==> Error: libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^libtool@2.4.6%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^m4@1.4.19%gcc@11.1.0+sigsegv arch=linux-ubuntu18.04-broadwell ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell matches multiple specs in the environment /home/culpo/tmp/fullhash: \r\nRoot spec libpciaccess ^libtool@2.4.6\r\n  hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\nRoot spec libpciaccess ^libtool@develop\r\n  hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n```\n\n### Error message\n\n```console\r\n$ spack install --no-add -f libpciaccess.yaml\r\n==> Error: libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^libtool@2.4.6%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^m4@1.4.19%gcc@11.1.0+sigsegv arch=linux-ubuntu18.04-broadwell ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell matches multiple specs in the environment /home/culpo/tmp/fullhash: \r\nRoot spec libpciaccess ^libtool@2.4.6\r\n  hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\nRoot spec libpciaccess ^libtool@develop\r\n  hihk3pi  libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu18.04-broadwell\r\n```\n\n### Information on your system\n\nThis should not be extremely relevant. The error was first spotted in pipelines, e.g. [here](https://gitlab.spack.io/spack/spack/-/jobs/659647) I reproduced it on:\r\n\r\n* **Spack:** 0.16.2-4008-2971a630b8\r\n* **Python:** 3.6.9\r\n* **Platform:** linux-ubuntu18.04-broadwell\r\n* **Concretizer:** original\r\n\r\nAnother thing to note is that _the issue happens also with the original concretizer_, but for some reason `clingo` is more likely to change build dependencies than the original concretizer.\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/25563",
    "updated_at": "2021-08-25 17:56:17",
    "created_at": "2021-08-23 11:38:19",
    "closed_at": "2021-08-25 17:56:17",
    "state": "closed",
    "title": "Pipelines failing if two specs have same dag hash, but different full hashes",
    "number": 25563,
    "milestone": null,
    "labels": [
        "bug",
        "hashes",
        "impact-medium",
        "environments",
        "pipelines"
    ],
    "id": 976936494,
    "html_url": "https://github.com/spack/spack/issues/25563",
    "assignees": [],
    "comments": 5
}