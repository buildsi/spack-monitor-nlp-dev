{
    "body": "### Steps to reproduce\r\n\r\nUsing the following spack generate job, no child pipelines are actually generated. The gitlab job \"passes\" but no pipelines are uploaded as artifacts, and the child pipeline croaks. This occurs with commit `2d45a9d617` (and all commits since), which introduced the concretization pool. This does not occur with commit `64a323b`, which is the parent of `2d45a9d617`.\r\n\r\n```yaml\r\nspack-generate-job:\r\n  <<: *spack-variables\r\n  <<: *spack-rules\r\n  stage: spack-generate\r\n  image: spack/ubuntu-bionic\r\n  tags: [k8s, ikp, exasgd, basic]\r\n  before_script:\r\n    - git clone ${SPACK_REPO}\r\n    - pushd spack && git checkout ${SPACK_REF} && popd\r\n    - . \"./spack/share/spack/setup-env.sh\"\r\n  script:\r\n    - cp buildsystem/container/spack.yaml . && spack env activate --without-view .\r\n    - spack -d ci generate\r\n      --artifacts-root \"${CI_PROJECT_DIR}/jobs_scratch_dir\"\r\n      --output-file \"${CI_PROJECT_DIR}/jobs_scratch_dir/pipeline.yml\"\r\n  artifacts:\r\n    paths:\r\n      - \"${CI_PROJECT_DIR}/jobs_scratch_dir\"\r\n```\r\n\r\n#### Expected Output\r\n\r\nI expect the usual concretization output, along with all jobs for specs that need to be rebuilt uploaded as artifacts:\r\n```console\r\n==> [2021-12-08-18:37:29.824885] Pruning spec that does not need to be rebuilt.\r\n==> [2021-12-08-18:37:29.880549] 17 build jobs generated in 11 stages\r\n==> [2021-12-08-18:37:29.880590] The max_needs_job is (specs) exago/v5c656i develop gcc@7.5.0 linux-ubuntu18.04-x86_64, with 5 needs\r\n==> [2021-12-08-18:37:29.880630] Warning: Unable to populate buildgroup without CDash credentials\r\n==> [2021-12-08-18:37:29.882520] '/usr/bin/git' 'describe' '--tags' '--match' 'v*'\r\nUploading artifacts...\r\n00:01\r\n/builds/exasgd/frameworks/exago/jobs_scratch_dir: found 5 matching files \r\nUploading artifacts to coordinator... ok            id=86300 responseStatus=201 Created token=2G4bF89d\r\n```\r\n\r\n#### Actual Output\r\n\r\nThe concretization output seems to be omitted and the pipeline appears to pass even though the child pipelines are not uploaded. This takes a very long time to occur.\r\n```console\r\n$ spack -d ci generate --artifacts-root \"${CI_PROJECT_DIR}/jobs_scratch_dir\" --output-file \"${CI_PROJECT_DIR}/jobs_scratch_dir/pipeline.yml\"\r\n... (snipped output)\r\n==> [2021-12-06-22:14:15.564685] Starting concretization pool with 8 processes\r\nUploading artifacts...\r\n00:01\r\n/builds/exasgd/frameworks/exago/jobs_scratch_dir: found 1 matching files \r\nUploading artifacts to coordinator... ok            id=86080 responseStatus=201 Created token=pQsj7GWQ\r\n```\r\n\r\n### Error message\r\n\r\nThe child gitlab ci pipeline fails with:\r\n```\r\nFound errors in your .gitlab-ci.yml:\r\nPath `jobs_scratch_dir/pipeline.yml` does not exist inside the `spack-generate-job` artifacts archive!\r\nYou can also test your .gitlab-ci.yml in CI Lint\r\n```\r\n\r\n### Information on your system\r\n\r\nRelevant snippet of `.gitlab-ci.yml`:\r\n```yaml\r\nstages:\r\n  - spack-generate\r\n  - spack-build\r\n\r\n.spack-variables: &spack-variables\r\n  variables:\r\n    # We usually use develop branch or tagged version here, but using commits to identify the issue\r\n    # 64a323b, parent commit of commit that introduced concretization pools\r\n    # 2d45a9d617, commit that introduced conc pools\r\n    SPACK_REF: 2d45a9d617\r\n    SPACK_REPO: https://github.com/LLNL/spack.git\r\n    S3_ENDPOINT_URL: http://cache.exasgd.pnl.gov\r\n\r\n.spack-rules: &spack-rules\r\n  rules:\r\n    - if: '$CI_COMMIT_REF_NAME == \"develop\"'\r\n    - if: '$CI_COMMIT_REF_NAME == \"master\"'\r\n    - if: '$CI_COMMIT_MESSAGE =~ /\\[matrix\\]/'\r\n    - if: $CI_MERGE_REQUEST_ID\r\n      when: never\r\n    - *pnnl-rule # specific to our site's gitlab\r\n    - when: manual\r\n\r\nspack-generate-job:\r\n  <<: *spack-variables\r\n  <<: *spack-rules\r\n  stage: spack-generate\r\n  image: spack/ubuntu-bionic\r\n  tags: [k8s, ikp, exasgd, basic]\r\n  before_script:\r\n    - git clone ${SPACK_REPO}\r\n    - pushd spack && git checkout ${SPACK_REF} && popd\r\n    - . \"./spack/share/spack/setup-env.sh\"\r\n  script:\r\n    - cp buildsystem/container/spack.yaml . && spack env activate --without-view .\r\n    - spack -d ci generate\r\n      --artifacts-root \"${CI_PROJECT_DIR}/jobs_scratch_dir\"\r\n      --output-file \"${CI_PROJECT_DIR}/jobs_scratch_dir/pipeline.yml\"\r\n  artifacts:\r\n    paths:\r\n      - \"${CI_PROJECT_DIR}/jobs_scratch_dir\"\r\n\r\nspack-build-job:\r\n  <<: *spack-rules\r\n  <<: *spack-variables\r\n  stage: spack-build\r\n  trigger:\r\n    include:\r\n      - artifact: \"jobs_scratch_dir/pipeline.yml\"\r\n        job: spack-generate-job\r\n    strategy: depend\r\n  needs:\r\n    - artifacts: True\r\n      job: spack-generate-job\r\n```\r\n\r\nSpack environment used for `spack ci`\r\n```yaml\r\nspack:\r\n  definitions:\r\n  - pkgs:\r\n    - exago@develop+hiop\r\n  - rajas: ['+raja', '~raja']\r\n  - ipopts: ['+ipopt', '~ipopt']\r\n  - mpis: ['+mpi', '~mpi']\r\n  - arch:\r\n    - '%gcc@7.5.0 arch=linux-ubuntu18.04-x86_64'\r\n  specs:\r\n  - matrix:\r\n    - [$pkgs]\r\n    - [$arch]\r\n    - [$rajas]\r\n    - [$ipopts]\r\n    - [$mpis]\r\n\r\n  mirrors:\r\n    pnnl: s3://spack-ci\r\n\r\n  config:\r\n    install_tree:\r\n      padded_length: 128\r\n\r\n  packages:\r\n    all:\r\n      target: [x86_64]\r\n      providers:\r\n        mpi: [openmpi, mpich]\r\n    petsc:\r\n      version: [3.14.6]\r\n      variants: ~hypre~hdf5~metis~superlu-dist\r\n    ipopt:\r\n      variants: +coinhsl~mumps\r\n      version: [3.12.10]\r\n    hiop:\r\n      version: [0.5.1]\r\n    coinhsl:\r\n      variants: +blas\r\n\r\n  gitlab-ci:\r\n\r\n    # the mc business is to pull proprietary tarballs so spack can build coinhsl in CI without violating licenses\r\n    before_script:\r\n      - unset SPACK_SIGNING_KEY\r\n      - curl -L -s -o mc 'https://dl.min.io/client/mc/release/linux-amd64/mc'\r\n         && chmod +x ./mc\r\n         && ./mc alias set minio $S3_ENDPOINT_URL $AWS_ACCESS_KEY_ID $AWS_SECRET_ACCESS_KEY\r\n         && ./mc cp -r minio/private/ .\r\n      - git clone ${SPACK_REPO}\r\n      - pushd spack && git checkout ${SPACK_CHECKOUT_VERSION} && popd\r\n      - . \"./spack/share/spack/setup-env.sh\"\r\n\r\n    script:\r\n      - unset SPACK_SIGNING_KEY\r\n      - pushd ${SPACK_CONCRETE_ENV_DIR} && spack env activate --without-view . && popd\r\n      - spack -d ci rebuild\r\n\r\n    rebuild-index: true\r\n\r\n    service-job-attributes:\r\n      before_script:\r\n        - git clone ${SPACK_REPO}\r\n        - pushd spack && git checkout ${SPACK_CHECKOUT_VERSION} && popd\r\n        - . \"./spack/share/spack/setup-env.sh\"\r\n      tags:\r\n      - k8s\r\n      - ikp\r\n      - exasgd\r\n      - basic\r\n      image:\r\n        name: spack/ubuntu-bionic\r\n        entrypoint: [\"\"]\r\n\r\n    mappings:\r\n    - match:\r\n      - arch=linux-ubuntu18.04-x86_64\r\n      runner-attributes:\r\n        tags:\r\n        - k8s\r\n        - ikp\r\n        - exasgd\r\n        - basic\r\n        image:\r\n          name: spack/ubuntu-bionic\r\n          entrypoint: [\"\"]\r\n```",
    "user": "ashermancinelli",
    "url": "https://api.github.com/repos/spack/spack/issues/27865",
    "updated_at": "2021-12-17 17:12:26",
    "created_at": "2021-12-08 19:05:22",
    "closed_at": "None",
    "state": "open",
    "title": "CI: Concretization step silently fails ",
    "number": 27865,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1074738543,
    "html_url": "https://github.com/spack/spack/issues/27865",
    "assignees": [
        "alalazo"
    ],
    "comments": 17
}