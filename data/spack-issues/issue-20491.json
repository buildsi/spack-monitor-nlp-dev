{
    "body": "I am trying to create an environment on ALCF Theta (Cray XC40) that installs all my dependencies. Among them is a more recent version of Python than is available on the system. The problem is that while I want the majority of specs to be cross-compiled for the KNL compute nodes, I want Python to be usable from the login and job head nodes which are Haswell cores (any Haswell code will of course work on KNL, albeit with a potential performance hit). My environment spack.yaml is as follows:\r\n\r\n```\r\nspack:\r\n  specs:\r\n  - python@3.6.0 %gcc@9.3.0-cray arch=cray-cnl7-haswell\r\n  - cereal@1.3.0 %gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n  - libzmq@4.3.2 %gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n  - googletest@1.10.0 %gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n  - adios2 @2.6.0 %gcc@9.3.0-cray ^libfabric@1.9.0 arch=cray-cnl7-mic_knl\r\n  - py-mochi-sonata ^mochi-sonata@master ^python@3.6.0 %gcc@9.3.0-cray ^libfabric@1.9.0 arch=cray-cnl7-mic_knl\r\n  - mochi-sonata +benchmark @master %gcc@9.3.0-cray ^libfabric@1.9.0 arch=cray-cnl7-mic_knl\r\n  - mercury @master %gcc@9.3.0-cray ^libfabric@1.9.0 arch=cray-cnl7-mic_knl\r\n  concretization: together\r\n  compilers:\r\n  - compiler:\r\n      spec: gcc@9.3.0-cray\r\n      paths:\r\n        cc: /opt/cray/pe/craype/2.6.5/bin/cc\r\n        cxx: /opt/cray/pe/craype/2.6.5/bin/CC\r\n        f77: /opt/cray/pe/craype/2.6.5/bin/ftn\r\n        fc: /opt/cray/pe/craype/2.6.5/bin/ftn\r\n      flags: {}\r\n      operating_system: cnl7\r\n      target: any\r\n      modules:\r\n      - PrgEnv-gnu\r\n      - gcc/9.3.0\r\n      - craype-mic-knl\r\n      - cray-mpich/7.7.10\r\n      environment:\r\n        unset: []\r\n      extra_rpaths: []\r\n  repos:\r\n  - /gpfs/mira-home/ckelly/install_chimbuko/sds/sds-repo\r\n  upstreams:\r\n    alcf-spack:\r\n      install_tree: /soft/spack/root/opt/spack\r\n  packages:\r\n    all:\r\n      compiler:\r\n      - gcc@9.3.0-cray\r\n      providers:\r\n        mpi:\r\n        - mpich\r\n        pkgconfig:\r\n        - pkg-config\r\n      buildable: true\r\n      version: []\r\n      target: []\r\n    mpich:\r\n      buildable: false\r\n      compiler: []\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      externals:\r\n      - spec: mpich@7.7.10 %gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n        modules:\r\n        - cray-mpich/7.7.10\r\n    pkg-config:\r\n      buildable: false\r\n      compiler: []\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      externals:\r\n      - spec: pkg-config@0.28 %gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n        prefix: /usr\r\n    autoconf:\r\n      buildable: false\r\n      compiler: []\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      externals:\r\n      - spec: autoconf@2.69%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n        prefix: /usr\r\n    automake:\r\n      buildable: false\r\n      compiler: []\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      externals:\r\n      - spec: automake@1.13.4%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n        prefix: /usr\r\n    bzip2:\r\n      buildable: false\r\n      compiler: []\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      externals:\r\n      - spec: bzip2@1.0.6%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n        prefix: /usr\r\n    zlib:\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      compiler: []\r\n      providers: {}\r\n      externals:\r\n      - spec: zlib\r\n        prefix: /usr\r\n    openssl:\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      compiler: []\r\n      providers: {}\r\n      externals:\r\n      - spec: openssl@1.1.1d\r\n        prefix: /usr\r\n    gdbm:\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      compiler: []\r\n      providers: {}\r\n      externals:\r\n      - spec: gdbm\r\n        prefix: /usr\r\n    m4:\r\n      buildable: false\r\n      version: []\r\n      target: []\r\n      compiler: []\r\n      providers: {}\r\n      externals:\r\n      - spec: m4\r\n        prefix: /usr\r\n\r\n    cmake:\r\n      buildable: false\r\n      compiler: []\r\n      version: []\r\n      target: []\r\n      providers: {}\r\n      externals:\r\n      - spec: cmake@3.18.0%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n        modules:\r\n        - cmake/3.18.0\r\n\r\n\r\n\r\n  view: true\r\n```\r\n\r\nHowever when concretizing I find that the dependencies are getting mixed up, with some being built with mic_knl and some with haswell. As a result the install of Python will not work on the head nodes.\r\n\r\n```\r\nckelly@thetalogin6:~/install_chimbuko/sds> spack concretize -f\r\n==> Concretized python@3.6.0%gcc@9.3.0-cray arch=cray-cnl7-haswell\r\n -   vf36ain  python@3.6.0%gcc@9.3.0-cray+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4+uuid+zlib patches=ebdca648c9c1d25f586d7e2a495b62e6d91973b55264a13d89eda1beff72ef56 arch=cray-cnl7-haswell\r\n[+]  albvl5x      ^bzip2@1.0.6%gcc@9.3.0-cray+shared arch=cray-cnl7-mic_knl\r\n -   h5vrrea      ^expat@2.2.10%gcc@9.3.0-cray+libbsd arch=cray-cnl7-haswell\r\n -   xrvm2xw          ^libbsd@0.10.0%gcc@9.3.0-cray arch=cray-cnl7-haswell\r\n -   rhegyfi      ^gdbm@1.18.1%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n -   ofd327t      ^gettext@0.21%gcc@9.3.0-cray+bzip2+curses+git~libunistring+libxml2+tar+xz arch=cray-cnl7-haswell\r\n[+]  v7scibr          ^libiconv@1.16%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n -   rsmirl2          ^libxml2@2.9.10%gcc@9.3.0-cray~python arch=cray-cnl7-haswell\r\n[+]  z47aiol              ^pkg-config@0.28%gcc@9.3.0-cray+internal_glib patches=49ffcd644e190dc5efcb2fab491177811ea746c1a526f75d77118c2706574358 arch=cray-cnl7-mic_knl\r\n -   blpwz5r              ^xz@5.2.5%gcc@9.3.0-cray~pic arch=cray-cnl7-haswell\r\n[+]  w72h6fk              ^zlib@1.2.11%gcc@9.3.0-cray+optimize+pic+shared arch=cray-cnl7-mic_knl\r\n -   f4mjorj          ^ncurses@6.2%gcc@9.3.0-cray~symlinks+termlib arch=cray-cnl7-haswell\r\n -   w3tp7lv          ^tar@1.32%gcc@9.3.0-cray arch=cray-cnl7-haswell\r\n[+]  5r3rs6d      ^libffi@3.3%gcc@9.3.0-cray patches=26f26c6f29a7ce9bf370ad3ab2610f99365b4bdd7b82e7c31df41a3370d685c0 arch=cray-cnl7-mic_knl\r\n -   jkc22se      ^libuuid@1.0.3%gcc@9.3.0-cray arch=cray-cnl7-haswell\r\n -   tq5pt7h      ^openssl@1.1.1d%gcc@9.3.0-cray+systemcerts arch=cray-cnl7-mic_knl\r\n -   a47tq6j      ^readline@8.0%gcc@9.3.0-cray arch=cray-cnl7-mic_knl\r\n -   xk53fxs      ^sqlite@3.33.0%gcc@9.3.0-cray+column_metadata+fts~functions~rtree arch=cray-cnl7-haswell\r\n```\r\n\r\nMy thought was that I would need a separate compiler, but adding the compiler\r\n\r\n```\r\n  - compiler:\r\n      spec: gcc@9.3.0-haswell\r\n      paths:\r\n        cc: /opt/cray/pe/craype/2.6.5/bin/cc\r\n        cxx: /opt/cray/pe/craype/2.6.5/bin/CC\r\n        f77: /opt/cray/pe/craype/2.6.5/bin/ftn\r\n        fc: /opt/cray/pe/craype/2.6.5/bin/ftn\r\n      flags: {}\r\n      operating_system: cnl7\r\n      target: any\r\n      modules:\r\n      - PrgEnv-gnu\r\n      - gcc/9.3.0\r\n      - craype-mic-haswell\r\n      - cray-mpich/7.7.10\r\n      environment:\r\n        unset: []\r\n      extra_rpaths: []\r\n```\r\n\r\nand changing the python spec:\r\n\r\n`  - python@3.6.0 %gcc@9.3.0-haswell arch=cray-cnl7-haswell`\r\n\r\nI get the most unhelpful error when reconcretizing:\r\n\r\n`==> Error: gcc@9.3.0-cray does not satisfy gcc@9.3.0-haswell`\r\n\r\nIt's possible that the packages->all->compiler definition is causing the problem here, but I don't know how to override it. \r\n\r\nI'd appreciate any help you can provide.\r\n\r\n* **Spack:** 0.16.0-123-42ed6e25e\r\n* **Python:** 3.6.10\r\n* **Platform:** cray-sles15-haswell\r\n* **Concretizer:** original\r\n\r\n\r\n- [x ] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x ] I have searched the issues of this repo and believe this is not a duplicate\r\n- [ ] I have run the failing commands in debug mode and reported the output\r\n",
    "user": "giltirn",
    "url": "https://api.github.com/repos/spack/spack/issues/20491",
    "updated_at": "2021-08-09 08:52:50",
    "created_at": "2020-12-21 16:00:35",
    "closed_at": "None",
    "state": "open",
    "title": "Concretize mixing architectures in dependencies (Theta)",
    "number": 20491,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 772273378,
    "html_url": "https://github.com/spack/spack/issues/20491",
    "assignees": [],
    "comments": 2
}