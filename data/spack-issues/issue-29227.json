{
    "body": "### Steps to reproduce the issue\r\n```console\r\n$ spack spec -I py-torch@1.8.2+distributed+magma~mkldnn cuda_arch=70 ^spectrum-mpi\r\nInput spec\r\n--------------------------------\r\npy-torch@1.8.2+distributed+magma~mkldnn cuda_arch=70\r\n    ^spectrum-mpi\r\n\r\nConcretized\r\n--------------------------------\r\ny4zyoel  py-torch@1.8.2%gcc@8.3.1+caffe2+cuda+cudnn+distributed+fbgemm+gloo+kineto+magma~metal~mkldnn+mpi+nccl+nnpack+numa+numpy+onnx_ml+openmp+qnnpack~rocm+tensorpipe~test+valgrind+xnnpack cuda_arch=70 patches=e37afffe45cf7594c22050109942370e49983ad772d12ebccf508377dc9dcfc9 arch=linux-rhel7-power9le\r\nmhnavkh      ^cmake@3.22.2%gcc@8.3.1~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-rhel7-power9le\r\n3uml3ee          ^ncurses@5.9.20130511%gcc@8.3.1~symlinks+termlib abi=5 patches=f84b2708a42777aadcc7f502a261afe10ca5646a51c1ef8b5e60d2070d926b57 arch=linux-rhel7-power9le\r\nb6rgoro          ^openssl@1.0.2k-fips%gcc@8.3.1~docs certs=system arch=linux-rhel7-power9le\r\n3pyjrhz      ^cuda@11.4.2%gcc@8.3.1~allow-unsupported-compilers~dev arch=linux-rhel7-power9le\r\nw6rccoz          ^libxml2@2.9.12%gcc@8.3.1~python arch=linux-rhel7-power9le\r\ncb4jv6v              ^gnuconfig@2021-08-14%gcc@8.3.1 arch=linux-rhel7-power9le\r\nid5xdfy              ^libiconv@1.16%gcc@8.3.1 libs=shared,static arch=linux-rhel7-power9le\r\n4pv6bv4              ^pkg-config@0.27.1%gcc@8.3.1+internal_glib patches=49ffcd644e190dc5efcb2fab491177811ea746c1a526f75d77118c2706574358 arch=linux-rhel7-power9le\r\nzrfyybe              ^xz@5.2.5%gcc@8.3.1~pic libs=shared,static arch=linux-rhel7-power9le\r\njw6upir              ^zlib@1.2.11%gcc@8.3.1+optimize+pic+shared arch=linux-rhel7-power9le\r\nd5bqwhd      ^cudnn@8.2.4.15-11.4%gcc@8.3.1 arch=linux-rhel7-power9le\r\ne5bo4uz      ^eigen@3.4.0%gcc@8.3.1~ipo build_type=RelWithDebInfo arch=linux-rhel7-power9le\r\npkgzd5i      ^fxdiv@2020-04-17%gcc@8.3.1~ipo build_type=RelWithDebInfo arch=linux-rhel7-power9le\r\nsp3tscc          ^ninja@1.10.2%gcc@8.3.1 arch=linux-rhel7-power9le\r\nueo4pbh              ^python@3.7.2%gcc@8.3.1+bz2+ctypes+dbm~debug+ensurepip+libxml2+lzma+nis~optimizations+pic+pyexpat~pythoncmd+readline+shared+sqlite3+ssl+tix+tkinter~ucs4+uuid+zlib patches=c129e34472ee39b1083c38a49ad06a8573d8b3b208743a120ca4c0818cdf1801 arch=linux-rhel7-power9le\r\nk2ctfnk      ^magma@2.6.1%gcc@8.3.1+cuda+fortran~ipo~rocm+shared build_type=RelWithDebInfo cuda_arch=80 arch=linux-rhel7-power9le\r\ncrfyo6h          ^openblas@0.3.19%gcc@8.3.1~bignuma~consistent_fpcsr~ilp64+locking+pic+shared symbol_suffix=none threads=none arch=linux-rhel7-power9le\r\ns44u24t              ^perl@5.16.3%gcc@8.3.1+cpanm+shared+threads patches=0eac10ed90aeb0459ad8851f88081d439a4e41978e586ec743069e8b059370ac,3bbd7d6f9933d80b9571533867b444c6f8f5a1ba0575bfba1fba4db9d885a71a arch=linux-rhel7-power9le\r\nhk6cdes      ^nccl@2.11.4-1%gcc@8.3.1+cuda cuda_arch=86 arch=linux-rhel7-power9le\r\nimo5c2t          ^rdma-core@20%gcc@8.3.1~ipo build_type=RelWithDebInfo arch=linux-rhel7-power9le\r\n2pknsgk      ^numactl@2.0.14%gcc@8.3.1 patches=4e1d78cbbb85de625bad28705e748856033eaafab92a66dffd383a3d7e00cc94,62fc8a8bf7665a60e8f4c93ebbd535647cebf74198f7afafec4c085a8825c006,ff37630df599cfabf0740518b91ec8daaf18e8f288b19adaae5364dc1f6b2296 arch=linux-rhel7-power9le\r\ngpwceow          ^autoconf@2.69%gcc@8.3.1 patches=7793209b33013dc0f81208718c68440c5aae80e7a1c4b8d336e382525af791a7 arch=linux-rhel7-power9le\r\nuvvkbkj              ^m4@1.4.19%gcc@8.3.1+sigsegv patches=9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573,bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89 arch=linux-rhel7-power9le\r\n6tk46gx                  ^libsigsegv@2.13%gcc@8.3.1 arch=linux-rhel7-power9le\r\nydhmdsp          ^automake@1.16.5%gcc@8.3.1 arch=linux-rhel7-power9le\r\n4wndo6m          ^libtool@2.4.6%gcc@8.3.1 arch=linux-rhel7-power9le\r\nj7n74vp      ^protobuf@3.14.0%gcc@8.3.1+shared build_type=Release arch=linux-rhel7-power9le\r\nxyrac6l      ^psimd@2020-05-17%gcc@8.3.1~ipo build_type=RelWithDebInfo arch=linux-rhel7-power9le\r\nloo3hlc      ^pthreadpool@2020-10-05%gcc@8.3.1~ipo build_type=RelWithDebInfo arch=linux-rhel7-power9le\r\n3ulnuqr      ^py-future@0.18.2%gcc@8.3.1 arch=linux-rhel7-power9le\r\ntxcm2d2          ^py-pip@21.3.1%gcc@8.3.1 arch=linux-rhel7-power9le\r\nft2h2dw          ^py-setuptools@59.4.0%gcc@8.3.1 arch=linux-rhel7-power9le\r\nhp7cezj              ^py-wheel@0.37.0%gcc@8.3.1 arch=linux-rhel7-power9le\r\nvrmpcf3      ^py-numpy@1.21.5%gcc@8.3.1+blas+lapack patches=873745d7b547857fcfec9cae90b09c133b42a4f0c23b6c2d84cf37e2dd816604 arch=linux-rhel7-power9le\r\ntkukip3          ^py-cython@0.29.24%gcc@8.3.1 arch=linux-rhel7-power9le\r\nack4ydr      ^py-protobuf@3.12.2%gcc@8.3.1~cpp arch=linux-rhel7-power9le\r\nyaja2f2          ^py-six@1.16.0%gcc@8.3.1 arch=linux-rhel7-power9le\r\nr4jceea      ^py-pybind11@2.6.2%gcc@8.3.1~ipo build_type=RelWithDebInfo arch=linux-rhel7-power9le\r\nxdg4nz3      ^py-pyyaml@6.0%gcc@8.3.1+libyaml arch=linux-rhel7-power9le\r\nioaz3zz          ^libyaml@0.2.5%gcc@8.3.1 arch=linux-rhel7-power9le\r\nqawoowm      ^py-tqdm@4.62.3%gcc@8.3.1~notebook~telegram arch=linux-rhel7-power9le\r\nrefhas3          ^py-setuptools-scm@6.3.2%gcc@8.3.1+toml arch=linux-rhel7-power9le\r\n4tbh5gq              ^py-packaging@21.3%gcc@8.3.1 arch=linux-rhel7-power9le\r\nk2wsmn2                  ^py-pyparsing@3.0.6%gcc@8.3.1 arch=linux-rhel7-power9le\r\noud4vnw              ^py-tomli@1.2.2%gcc@8.3.1 arch=linux-rhel7-power9le\r\na2w7lim      ^py-typing-extensions@3.10.0.2%gcc@8.3.1 arch=linux-rhel7-power9le\r\nrm7mmct      ^spectrum-mpi@10.3.1.03rtm0%gcc@8.3.1 arch=linux-rhel7-power9le\r\nuvyv7bj      ^valgrind@3.18.1%gcc@8.3.1+boost+mpi+only64bit~ubsan arch=linux-rhel7-power9le\r\n2k4x34d          ^boost@1.78.0%gcc@8.3.1+atomic+chrono~clanglibcpp~container~context~coroutine+date_time~debug+exception~fiber+filesystem+graph~icu+iostreams+locale+log+math~mpi+multithreaded~numpy~pic+program_options~python+random+regex+serialization+shared+signals~singlethreaded+system~taggedlayout+test+thread+timer~versionedlayout+wave cxxstd=98 visibility=hidden arch=linux-rhel7-power9le\r\n77xjlqz              ^bzip2@1.0.6%gcc@8.3.1~debug~pic+shared arch=linux-rhel7-power9le\r\n```\r\n### Error message\r\n\r\n```\r\n==> Fetching https://patch-diff.githubusercontent.com/raw/pytorch/pytorch/pull/59220.patch\r\n######################################################################## 100.0%\r\n==> Error: ChecksumError: sha256 checksum failed for /var/tmp/yousefi2/spack-stage/spack-stage-k6pxxyxv/59220.patch\r\n    Expected e37afffe45cf7594c22050109942370e49983ad772d12ebccf508377dc9dcfc9 but got beccd0b0250ebb60823cdaa0f7eb15f2a398d4c1c329ab570ec56283176988fe\r\n\r\n/usr/WS2/yousefi2/spack.git/lib/spack/spack/package.py:1404, in do_fetch:\r\n       1401\r\n       1402        self.stage.cache_local()\r\n       1403\r\n       1404        for patch in self.spec.patches:\r\n       1405            patch.fetch()\r\n       1406            if patch.stage:\r\n       1407                patch.stage.cache_local()\r\n\r\n\r\n==> Error: Terminating after first install failure: ChecksumError: sha256 checksum failed for /var/tmp/yousefi2/spack-stage/spack-stage-k6pxxyxv/59220.patch\r\n    Expected e37afffe45cf7594c22050109942370e49983ad772d12ebccf508377dc9dcfc9 but got beccd0b0250ebb60823cdaa0f7eb15f2a398d4c1c329ab570ec56283176988fe\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.1-1181-76489eb213\r\n* **Python:** 3.7.2\r\n* **Platform:** linux-rhel7-power9le\r\n* **Concretizer:** clingo\r\n\r\nSettings:\r\nfetch_url_method: curl\r\n\r\n### Additional information\r\n\r\nFound [this](https://github.com/spack/spack/issues/18338) issue but it doesn't look the same. I don't have issues with activating the environment. It fails during install. I also use the `--fail-fast` flag. \r\n\r\nI have attached my [bash script](https://github.com/spack/spack/files/8144149/build.txt) and [console output](https://github.com/spack/spack/files/8144135/ConsoleOutput.txt). Downloading the `59220.patch` from the url in `py-torch` package `package.py` file and checking `sha256sum` of the file shows that the expected checksum is indeed different.\r\n\r\nPackage maintainer: @adamjstewart \r\nUnfortunately I was unable to find `spack-build-out.txt` and `spack-build-env.txt`. I searched `/var/tmp/yousefi2/spack-stage/spack-stage-py-torch-1.8.2-kddfvce2cxijpuxl3abbh3v4ajo2fpza/` and `/var/tmp/yousefi2/spack-stage/spack-stage-a3c4sj4c/` where the patch file is for these files.\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\r\n- [ ] I have uploaded the build log and environment files\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "mohammadryousefi",
    "url": "https://api.github.com/repos/spack/spack/issues/29227",
    "updated_at": "2022-02-25 20:43:49",
    "created_at": "2022-02-25 19:54:13",
    "closed_at": "None",
    "state": "open",
    "title": "Installation issue: py-torch",
    "number": 29227,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 1150811818,
    "html_url": "https://github.com/spack/spack/issues/29227",
    "assignees": [
        "adamjstewart"
    ],
    "comments": 2
}