{
    "body": "If I install a package with `--test=all`, I see some very strange concretization behavior. For example, `spack install --test=all py-attrs`, which might have a circular test dependency on itself, tries to build `py-attrs` before building `python`, and crashes due to a missing attribute that is normally defined by the `PythonPackage` base class. See below for full error message.\r\n\r\n### Spack version\r\n\r\n```console\r\n$ spack --version\r\n0.14.0-149-6412b9e71a\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install --test=all py-attrs\r\n```\r\nNote that this error does not occur for `--test=root`. I'm not sure if this error exists for other packages or just packages with circular test dependencies.\r\n\r\n### Error Message\r\n\r\n```console\r\n$ spack install --test=all py-attrs\r\n==> Warning: clang@11.0.0-apple cannot build optimized binaries for \"ivybridge\". Using best target possible: \"x86_64\"\r\n[+] /Users/Adam/spack/opt/spack/darwin-catalina-x86_64/clang-11.0.0-apple/libiconv-1.16-gj3jnj46xug7rpjxwaepe6uwx35jdphz\r\n[+] /Users/Adam/spack/opt/spack/darwin-catalina-x86_64/clang-11.0.0-apple/expat-2.2.9-ctgvqggynhtr2zdidy2f64gk5vgt6jpg\r\n[+] /Users/Adam/spack/opt/spack/darwin-catalina-x86_64/clang-11.0.0-apple/pkgconf-1.6.3-t64p5ucui6qgo6tepzu44q3hrgpvabrx\r\n[+] /Users/Adam/spack/opt/spack/darwin-catalina-x86_64/clang-11.0.0-apple/xz-5.2.4-nahnpskrw2jjhtsviwietm4qcs5sa7oe\r\n[+] /Users/Adam/spack/opt/spack/darwin-catalina-x86_64/clang-11.0.0-apple/zlib-1.2.11-cvrek7vtvob6v2dfnvdowu2rkqtqtmmi\r\n[+] /Users/Adam/spack/opt/spack/darwin-catalina-x86_64/clang-11.0.0-apple/libffi-3.2.1-2mukefjdfv5eb2oyrsawyoqdkh2zndsd\r\n==> 2344: Installing py-attrs\r\n==> Finding buildcaches in /private/var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/pytest-of-Adam/pytest-2/test_ci_rebuild_basic0/working_dir/local_mirror/build_cache\r\n==> Fetching file:///private/var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/pytest-of-Adam/pytest-2/test_ci_rebuild_basic0/working_dir/local_mirror/build_cache/darwin-catalina-x86_64-clang-11.0.0-apple-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz.spec.yaml\r\ncurl: (37) Couldn't open file /private/var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/pytest-of-Adam/pytest-2/test_ci_rebuild_basic0/working_dir/local_mirror/build_cache/darwin-catalina-x86_64-clang-11.0.0-apple-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz.spec\r\n==> Failed to fetch file from URL: file:///private/var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/pytest-of-Adam/pytest-2/test_ci_rebuild_basic0/working_dir/local_mirror/build_cache/darwin-catalina-x86_64-clang-11.0.0-apple-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz.spec.yaml\r\n    Curl failed with error 37\r\n==> Fetching from file:///private/var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/pytest-of-Adam/pytest-2/test_ci_rebuild_basic0/working_dir/local_mirror/build_cache/darwin-catalina-x86_64-clang-11.0.0-apple-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz.spec.yaml failed.\r\n==> Warning: microarchitecture specific optimizations are not supported yet on mixed compiler toolchains [check clang@11.0.0-apple for further details]\r\n==> Using cached archive: /Users/Adam/spack/var/spack/cache/_source-cache/archive/f9/f913492e1663d3c36f502e5e9ba6cd13cf19d7fab50aa13239e420fef95e1396.tar.gz\r\n==> Staging archive: /var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/Adam/spack-stage/spack-stage-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz/attrs-19.2.0.tar.gz\r\n==> Created stage in /var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/Adam/spack-stage/spack-stage-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz\r\n==> No patches needed for py-attrs\r\n==> 2344: py-attrs: Building py-attrs [PythonPackage]\r\n==> 2344: py-attrs: Executing phase: 'build'\r\n==> Error: AttributeError: module 'spack.pkg.builtin.py-attrs' has no attribute 'python'\r\n\r\n/Users/Adam/spack/lib/spack/spack/build_systems/python.py:114, in python:\r\n  >>    114    def python(self, *args, **kwargs):\r\n        115        inspect.getmodule(self).python(*args, **kwargs)\r\n\r\nSee build log for details:\r\n  /var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/Adam/spack-stage/spack-stage-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz/spack-build-out.txt\r\n\r\n==> Error: Failed to install py-attrs due to ChildError: AttributeError: module 'spack.pkg.builtin.py-attrs' has no attribute 'python'\r\n/Users/Adam/spack/lib/spack/spack/build_systems/python.py:114, in python:\r\n  >>    114    def python(self, *args, **kwargs):\r\n        115        inspect.getmodule(self).python(*args, **kwargs)\r\n\r\nSee build log for details:\r\n  /var/folders/21/hwq39zyj4g36x6zjfyl5l8080000gn/T/Adam/spack-stage/spack-stage-py-attrs-19.2.0-iozreocs7s2va7fnjekmid3f6ni6hymz/spack-build-out.txt\r\nTraceback (most recent call last):\r\n  File \"/Users/Adam/spack/lib/spack/spack/build_environment.py\", line 801, in child_process\r\n    return_value = function()\r\n  File \"/Users/Adam/spack/lib/spack/spack/installer.py\", line 1109, in build_process\r\n    phase(pkg.spec, pkg.prefix)\r\n  File \"/Users/Adam/spack/lib/spack/spack/package.py\", line 108, in phase_wrapper\r\n    phase(spec, prefix)\r\n  File \"/Users/Adam/spack/lib/spack/spack/build_systems/python.py\", line 153, in build\r\n    self.setup_py('build', *args)\r\n  File \"/Users/Adam/spack/lib/spack/spack/build_systems/python.py\", line 121, in setup_py\r\n    self.python('-s', setup, '--no-user-cfg', *args, **kwargs)\r\n  File \"/Users/Adam/spack/lib/spack/spack/build_systems/python.py\", line 115, in python\r\n    inspect.getmodule(self).python(*args, **kwargs)\r\nAttributeError: module 'spack.pkg.builtin.py-attrs' has no attribute 'python'\r\n\r\n==> Warning: Skipping build of py-hypothesis since py-attrs failed\r\n==> Warning: Skipping build of py-pytest since py-attrs failed\r\n```\r\nAs you can see, it builds some of the Python dependencies, but not Python itself. Because `python` is not a dependency of `py-attrs` (during testing), `self.python(...)` crashes.\r\n\r\n### Information on your system\r\n\r\nmacOS 10.15.3\r\nPython 3.7.6\r\n\r\n### General information\r\n\r\n- [x] I have run `spack --version` and reported the version of Spack\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output",
    "user": "adamjstewart",
    "url": "https://api.github.com/repos/spack/spack/issues/15377",
    "updated_at": "2020-03-11 22:44:02",
    "created_at": "2020-03-06 17:46:12",
    "closed_at": "None",
    "state": "open",
    "title": "Strange concretization behavior with --test=all",
    "number": 15377,
    "milestone": null,
    "labels": [
        "bug",
        "concretization",
        "workaround",
        "impact-medium",
        "concretizer-use-case"
    ],
    "id": 577082741,
    "html_url": "https://github.com/spack/spack/issues/15377",
    "assignees": [
        "scheibelp"
    ],
    "comments": 4
}