{
    "body": "I installed a python package in my local Spack installation which is chained to our central Spack.\r\n\r\nI cannot uninstall it as it needs to access the upstream extension configuration despite having never been activated. \r\n\r\nThis looks similar but not identical to https://github.com/spack/spack/issues/13268\r\n\r\n### Steps to reproduce the issue\r\n\r\nInstall a python package in a chain then try and uninstall it \r\n\r\n```\r\n$ spack install scons\r\n==> 131661: Installing scons\r\n..\r\n==> 131661: scons: Successfully installed scons\r\n  Fetch: 0.62s.  Build: 9.47s.  Total: 10.09s.\r\n[+] /dcsrsoft/sandbox/eroche/meleze/opt/spack/linux-centos7-skylake_avx512/gcc-8.3.0/scons-3.1.2-iqc25yqsqoecf3w2pvvrg752u5zshimv\r\n```\r\n\r\n### Error Message\r\n\r\nThen\r\n\r\n```\r\n$ spack uninstall scons\r\n==> The following packages will be uninstalled:\r\n\r\n    -- linux-centos7-skylake_avx512 / gcc@8.3.0 ---------------------\r\n    iqc25yq scons@3.1.2\r\n\r\n==> Do you want to proceed? [y/N] y\r\n==> Error: [Errno 13] Permission denied: '/dcsrsoft/spack/meleze/v2/opt/spack/linux-centos7-skylake_avx512/gcc-8.3.0/python-3.7.6-3qfa6rjryjmwkj7zdc26ntxkqxq6mkdi/.spack/extensions.yaml'\r\n```\r\n\r\nThe file in the error message is in the upstream Spack and hasn't been changed recently:\r\n\r\n```\r\n$ ll /dcsrsoft/spack/meleze/v2/opt/spack/linux-centos7-skylake_avx512/gcc-8.3.0/python-3.7.6-3qfa6rjryjmwkj7zdc26ntxkqxq6mkdi/.spack/extensions.yaml\r\n-rw------- 1 dcsrsoft dcsr-soft-u-g 1550 Mar 31 20:42 /dcsrsoft/spack/meleze/v2/opt/spack/linux-centos7-skylake_avx512/gcc-8.3.0/python-3.7.6-3qfa6rjryjmwkj7zdc26ntxkqxq6mkdi/.spack/extensions.yaml\r\n```\r\n\r\nWith -d the latter part is\r\n\r\n```\r\n==> [2020-04-09-10:26:40.615561, 133285] WRITE LOCK (scons): /dcsrsoft/sandbox/eroche/meleze/opt/spack/.spack-db/prefix_lock[2450758027729552401:1] [Releasing] \r\n==> [2020-04-09-10:26:40.615767, 133285] WRITE LOCK (scons): /dcsrsoft/sandbox/eroche/meleze/opt/spack/.spack-db/prefix_lock[2450758027729552401:1] [Released at 10:26:40.615744] \r\nTraceback (most recent call last):\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/bin/spack\", line 64, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/main.py\", line 763, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/main.py\", line 488, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/cmd/uninstall.py\", line 348, in uninstall\r\n    uninstall_specs(args, specs)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/cmd/uninstall.py\", line 323, in uninstall_specs\r\n    do_uninstall(env, uninstall_list, args.force)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/cmd/uninstall.py\", line 225, in do_uninstall\r\n    item.do_uninstall(force=force)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/package.py\", line 1739, in do_uninstall\r\n    Package.uninstall_by_spec(self.spec, force)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/package.py\", line 1711, in uninstall_by_spec\r\n    spack.hooks.pre_uninstall(spec)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/hooks/__init__.py\", line 59, in __call__\r\n    hook(*args, **kwargs)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/hooks/extensions.py\", line 18, in pre_uninstall\r\n    if pkg.is_activated(view):\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/package.py\", line 1008, in is_activated\r\n    exts = extensions_layout.extension_map(self.extendee_spec)\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/directory_layout.py\", line 430, in extension_map\r\n    return self._extension_map(spec).copy()\r\n  File \"/dcsrsoft/sandbox/eroche/meleze/lib/spack/spack/directory_layout.py\", line 457, in _extension_map\r\n    with open(path) as ext_file:\r\nPermissionError: [Errno 13] Permission denied: '/dcsrsoft/spack/meleze/v2/opt/spack/linux-centos7-skylake_avx512/gcc-8.3.0/python-3.7.6-3qfa6rjryjmwkj7zdc26ntxkqxq6mkdi/.spack/extensions.yaml'\r\n```\r\n\r\n### Information on your system\r\n\r\n```\r\n$ spack -V\r\n0.13.3-1359-09dfbf9\r\n```\r\n\r\nupstreams.yaml\r\n\r\n```\r\nupstreams:\r\n  spack-dcsr-meleze:\r\n    install_tree: /dcsrsoft/spack/meleze/v2/opt/spack\r\n    modules:\r\n      lmod: /dcsrsoft/spack/meleze/v2/share/spack/lmod/S6g1-IB\r\n```\r\n\r\n### Additional information\r\n\r\n- [ ] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n\r\n",
    "user": "ilbiondo",
    "url": "https://api.github.com/repos/spack/spack/issues/15966",
    "updated_at": "2020-06-25 13:27:28",
    "created_at": "2020-04-09 08:32:06",
    "closed_at": "2020-06-25 13:27:28",
    "state": "closed",
    "title": "Python packages installed in a chain reference upstream and cannot be removed",
    "number": 15966,
    "milestone": null,
    "labels": [
        "bug",
        "extensions",
        "impact-medium",
        "spack-chains"
    ],
    "id": 597115483,
    "html_url": "https://github.com/spack/spack/issues/15966",
    "assignees": [
        "scheibelp"
    ],
    "comments": 5
}