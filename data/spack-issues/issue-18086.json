{
    "body": "Due a pinned version on the libzqm dependency of cppzmq, but an open version libzqm dependency in py-pyzmq, a bundle package that depends on both cppzmq and py-pyzmq results in an unsatisfiable version constraint even though a satisfiable version can be hinted at (and, arguably, should have been found). This may point to a class of unsatisfiable version constraints elsewhere that can be resolved.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack create -t bundle -n zmqbug\r\n```\r\nAdd a version and two generic dependencies:\r\n```python\r\n    version('1.0.0')\r\n    depends_on('cppzmq')\r\n    depends_on('py-pyzmq')\r\n```\r\n```console\r\n$ spack spec zmqbug\r\n$ spack spec zmqbug ^libzmq@4.2.5\r\n```\r\n\r\n### Error Message\r\n\r\nThe first spec (no hinting) fails with:\r\n```console\r\n$ spack spec zmqbug\r\nInput spec\r\n--------------------------------\r\nzmqbug\r\n\r\nConcretized\r\n--------------------------------\r\n==> Error: An unsatisfiable version constraint has been detected for spec:\r\n\r\n    libzmq@4.3.2%gcc@9.3.0+libsodium arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\nwhile trying to concretize the partial spec:\r\n\r\n    cppzmq@4.3.0%gcc@9.3.0 build_type=RelWithDebInfo arch=linux-ubuntu20.04-ivybridge\r\n        ^cmake@3.13.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\ncppzmq requires libzmq version 4.2.5, but spec asked for 4.3.2\r\n```\r\n\r\nThe second spec (with hinting) succeeds:\r\n```console\r\n$ spack spec zmqbug ^libzmq@4.2.5\r\nInput spec\r\n--------------------------------\r\nzmqbug\r\n    ^libzmq@4.2.5\r\n\r\nConcretized\r\n--------------------------------\r\nzmqbug@1.0.0%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n    ^cppzmq@4.3.0%gcc@9.3.0 build_type=RelWithDebInfo arch=linux-ubuntu20.04-ivybridge\r\n        ^cmake@3.13.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt patches=1c540040c7e203dd8e27aa20345ecb07fe06570d56410a24a266ae570b1c4c39 arch=linux-ubuntu20.04-ivybridge\r\n        ^libzmq@4.2.5%gcc@9.3.0+libsodium arch=linux-ubuntu20.04-ivybridge\r\n            ^libsodium@1.0.18%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n            ^pkgconf@1.7.3%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n    ^py-pyzmq@18.1.0%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n        ^py-cffi@1.13.0%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n            ^libffi@3.3%gcc@9.3.0 patches=26f26c6f29a7ce9bf370ad3ab2610f99365b4bdd7b82e7c31df41a3370d685c0 arch=linux-ubuntu20.04-ivybridge\r\n            ^py-pycparser@2.19%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                ^py-setuptools@46.1.3%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                    ^python@3.7.7%gcc@9.3.0+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4~uuid+zlib patches=0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87 arch=linux-ubuntu20.04-ivybridge\r\n                        ^bzip2@1.0.8%gcc@9.3.0+shared arch=linux-ubuntu20.04-ivybridge\r\n                            ^diffutils@3.7%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                                ^libiconv@1.16%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                        ^expat@2.2.9%gcc@9.3.0+libbsd arch=linux-ubuntu20.04-ivybridge\r\n                            ^libbsd@0.10.0%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                        ^gdbm@1.18.1%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                            ^readline@8.0%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                                ^ncurses@6.2%gcc@9.3.0~symlinks+termlib arch=linux-ubuntu20.04-ivybridge\r\n                        ^gettext@0.20.2%gcc@9.3.0+bzip2+curses+git~libunistring+libxml2+tar+xz arch=linux-ubuntu20.04-ivybridge\r\n                            ^libxml2@2.9.10%gcc@9.3.0~python arch=linux-ubuntu20.04-ivybridge\r\n                                ^xz@5.2.5%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                                ^zlib@1.2.11%gcc@9.3.0+optimize+pic+shared arch=linux-ubuntu20.04-ivybridge\r\n                            ^tar@1.32%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n                        ^openssl@1.1.1g%gcc@9.3.0+systemcerts arch=linux-ubuntu20.04-ivybridge\r\n                            ^perl@5.30.3%gcc@9.3.0+cpanm+shared+threads arch=linux-ubuntu20.04-ivybridge\r\n                        ^sqlite@3.31.1%gcc@9.3.0+column_metadata+fts~functions~rtree arch=linux-ubuntu20.04-ivybridge\r\n        ^py-cython@0.29.16%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n        ^py-py@1.8.0%gcc@9.3.0 arch=linux-ubuntu20.04-ivybridge\r\n            ^py-setuptools-scm@4.1.2%gcc@9.3.0~toml arch=linux-ubuntu20.04-ivybridge\r\n```\r\n\r\n### Information on your system\r\n\r\n```console\r\n$ spack debug report\r\n* **Spack:** 0.15.4\r\n* **Python:** 3.8.2\r\n* **Platform:** linux-ubuntu20.04-ivybridge\r\n```\r\n\r\nMinimal packages/zmqbug/package.py:\r\n```python\r\nfrom spack import *\r\nclass Zmqbug(BundlePackage):\r\n    version('1.0.0')\r\n    depends_on('cppzmq')\r\n    depends_on('py-pyzmq')\r\n```\r\n\r\n```console\r\n$ spack --debug --stacktrace spec zmqbug\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-08-15-17:33:42.830263] Imported spec from built-in commands\r\nlib/spack/spack/cmd/__init__.py:122 ==> [2020-08-15-17:33:42.831970] Imported spec from built-in commands\r\nInput spec\r\n--------------------------------\r\nzmqbug\r\n\r\nConcretized\r\n--------------------------------\r\nlib/spack/spack/config.py:805 ==> [2020-08-15-17:33:42.836936] Reading config file /usr/local/spack/etc/spack/defaults/config.yaml\r\nlib/spack/spack/config.py:805 ==> [2020-08-15-17:33:42.856110] Reading config file /usr/local/spack/etc/spack/defaults/repos.yaml\r\nlib/spack/spack/config.py:805 ==> [2020-08-15-17:33:42.858451] Reading config file /home/wdconinc/.spack/linux/repos.yaml\r\nlib/spack/spack/config.py:805 ==> [2020-08-15-17:33:42.978372] Reading config file /usr/local/spack/etc/spack/defaults/packages.yaml\r\nlib/spack/spack/config.py:805 ==> [2020-08-15-17:33:42.998922] Reading config file /home/wdconinc/.spack/linux/packages.yaml\r\nlib/spack/spack/config.py:805 ==> [2020-08-15-17:33:43.115847] Reading config file /home/wdconinc/.spack/linux/compilers.yaml\r\nlib/spack/spack/main.py:765 ==> [2020-08-15-17:33:43.172310] UnsatisfiableVersionSpecError: An unsatisfiable version constraint has been detected for spec:\r\n\r\n    libzmq@4.3.2%gcc@9.3.0+libsodium arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\nwhile trying to concretize the partial spec:\r\n\r\n    cppzmq@4.3.0%gcc@9.3.0 build_type=RelWithDebInfo arch=linux-ubuntu20.04-ivybridge\r\n        ^cmake@3.13.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\ncppzmq requires libzmq version 4.2.5, but spec asked for 4.3.2\r\nlib/spack/spack/error.py:55 ==> [2020-08-15-17:33:43.172976] Error: An unsatisfiable version constraint has been detected for spec:\r\n\r\n    libzmq@4.3.2%gcc@9.3.0+libsodium arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\nwhile trying to concretize the partial spec:\r\n\r\n    cppzmq@4.3.0%gcc@9.3.0 build_type=RelWithDebInfo arch=linux-ubuntu20.04-ivybridge\r\n        ^cmake@3.13.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\ncppzmq requires libzmq version 4.2.5, but spec asked for 4.3.2\r\nTraceback (most recent call last):\r\n  File \"/usr/local/spack/lib/spack/spack/main.py\", line 762, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/usr/local/spack/lib/spack/spack/main.py\", line 490, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/usr/local/spack/lib/spack/spack/cmd/spec.py\", line 103, in spec\r\n    spec.concretize()\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2168, in concretize\r\n    changes = (self.normalize(force, tests=tests,\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2650, in normalize\r\n    any_change = self._normalize_helper(\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2588, in _normalize_helper\r\n    changed |= self._merge_dependency(\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2547, in _merge_dependency\r\n    changed |= spec_dependency._normalize_helper(\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2588, in _normalize_helper\r\n    changed |= self._merge_dependency(\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2524, in _merge_dependency\r\n    changed |= spec_deps[dep.name].constrain(dep)\r\n  File \"/usr/local/spack/lib/spack/spack/spec.py\", line 2724, in constrain\r\n    raise UnsatisfiableVersionSpecError(self.versions, other.versions)\r\nspack.spec.UnsatisfiableVersionSpecError: An unsatisfiable version constraint has been detected for spec:\r\n\r\n    libzmq@4.3.2%gcc@9.3.0+libsodium arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\nwhile trying to concretize the partial spec:\r\n\r\n    cppzmq@4.3.0%gcc@9.3.0 build_type=RelWithDebInfo arch=linux-ubuntu20.04-ivybridge\r\n        ^cmake@3.13.4%gcc@9.3.0~doc+ncurses+openssl+ownlibs~qt arch=linux-ubuntu20.04-ivybridge\r\n\r\n\r\ncppzmq requires libzmq version 4.2.5, but spec asked for 4.3.2\r\n```\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\nNote: In order to work around this issue, I am simultaneously filing a PR #18087 to remove the version pinning on cppzmq by adding a more recent version.\r\n",
    "user": "wdconinc",
    "url": "https://api.github.com/repos/spack/spack/issues/18086",
    "updated_at": "2020-08-17 08:50:42",
    "created_at": "2020-08-15 22:36:56",
    "closed_at": "None",
    "state": "open",
    "title": "Valid concretization requiring older version is not found in dependency resolution",
    "number": 18086,
    "milestone": null,
    "labels": [
        "bug",
        "duplicate",
        "concretization"
    ],
    "id": 679652747,
    "html_url": "https://github.com/spack/spack/issues/18086",
    "assignees": [],
    "comments": 1
}