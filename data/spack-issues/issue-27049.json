{
    "body": "### Steps to reproduce\n\nFollowing instructions of install spack, but failed to install any package. Spack failed on build initial `perl` package,\r\n```console\r\ngit clone git clone https://github.com/spack/spack.git\r\n```\r\n\r\nThen use nix shell to provide python and other utilities\r\n```nix\r\n{ pkgs ? import <nixpkgs> { } }:\r\nwith pkgs;\r\nmkShell {\r\n  buildInputs = [\r\n    python38\r\n    coreutils\r\n  ];\r\n  shellHook = ''\r\n    . $spack/share/spack/setup-env.sh\r\n  '';\r\n}\r\n```\r\nwhich just provide python and other libs in current `$PATH` and related environment variables.\n\n### Error message\n\n```console\r\nspack --debug --stacktrace install hdf5\r\n\r\n\r\nlib/spack/spack/error.py:54 ==> [2021-10-29-09:49:07.904318] Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\n\r\n3 errors found in build log:\r\n     1294    LD_LIBRARY_PATH=/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src ./miniperl -Ilib make_ext.pl ext/Pod-Functions/pm_to_blib  MAKE=\"make\" LIBPERL_A=libperl.so\r\n     1295    ==> Please rerun the make command.  <==\r\n     1296    false\r\n     1297    make[1]: *** [Makefile:759: Makefile] Error 1\r\n     1298    make[1]: Leaving directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/cpan/Pod-Perldoc'\r\n     1299    make[1]: Entering directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/cpan/Pod-Perldoc'\r\n  >> 1300    /nix/store/9r0a3dipi8saq2zasp668zsk6qhqp5jb-glibc-2.32-48-dev/include/bits/errno.h:23:3: error: #error \"Never include <bits/errno.h> directly; use <errno.h> instead.\"\r\n     1301       23 | # error \"Never include <bits/errno.h> directly; use <errno.h> instead.\"\r\n     1302          |   ^~~~~\r\n     1303    make[1]: Entering directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/dist/XSLoader'\r\n     1304    make[1]: Leaving directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/cpan/Pod-Checker'\r\n     1305    Makefile out-of-date with respect to ../../lib/Config.pm ../../config.h\r\n     1306    Cleaning current config before rebuilding Makefile...\r\n\r\n     ...\r\n\r\n     1561    Auto Detect Gzip OS Code..\r\n     1562    Setting Gzip OS Code to 3 [Unix/Default]\r\n     1563    Looks Good.\r\n     1564    Setting license tag...\r\n     1565    Adding META_MERGE...\r\n     1566    make -f Makefile.old clean > /dev/null 2>&1\r\n  >> 1567    Can't exec \"pwd\": No such file or directory at /run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/dist/PathTools/Cwd.pm line 204.\r\n     1568    Generating a Unix-style Makefile\r\n     1569    Writing Makefile for Digest::SHA\r\n     1570    Generating a Unix-style Makefile\r\n     1571    Writing Makefile for B\r\n     1572    \"../../miniperl\" \"-I../../lib\" Makefile.PL \"INSTALLDIRS=perl\" \"INSTALLMAN1DIR=none\" \"INSTALLMAN3DIR=none\" \"PERL_CORE=1\" \"LIBPERL_A=libperl.so\" \"LINKTYPE=dynamic\" \"PERL=../../miniperl\"\r\n     1573    ==> Your Makefile has been rebuilt. <==\r\n\r\n     ...\r\n\r\n     1580    false\r\n     1581    make[1]: *** [Makefile:937: Makefile] Error 1\r\n     1582    make[1]: Leaving directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/cpan/Digest-SHA'\r\n     1583    make[1]: *** [Makefile:925: Makefile] Error 1\r\n     1584    make[1]: Leaving directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/ext/B'\r\n     1585    ==> Your Makefile has been rebuilt. <==\r\n  >> 1586    Can't exec \"pwd\": No such file or directory at /run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/dist/PathTools/Cwd.pm line 204.\r\n     1587    Generating a Unix-style Makefile\r\n     1588    Writing Makefile for GDBM_File\r\n     1589    ==> Please rerun the make command.  <==\r\n     1590    false\r\n     1591    make[1]: *** [Makefile:918: Makefile] Error 1\r\n     1592    make[1]: Leaving directory '/run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-src/cpan/Digest-MD5'\r\n\r\nSee build log for details:\r\n  /run/user/1000/xiang/spack-stage/spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre/spack-build-out.txt\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/xiang/spack/lib/spack/spack/build_environment.py\", line 1028, in _setup_pkg_and_run\r\n    return_value = function(pkg, kwargs)\r\n  File \"/home/xiang/spack/lib/spack/spack/installer.py\", line 1952, in build_process\r\n    return installer.run()\r\n  File \"/home/xiang/spack/lib/spack/spack/installer.py\", line 1809, in run\r\n    self._real_install()\r\n  File \"/home/xiang/spack/lib/spack/spack/installer.py\", line 1916, in _real_install\r\n    phase(pkg.spec, pkg.prefix)\r\n  File \"/home/xiang/spack/lib/spack/spack/package.py\", line 135, in phase_wrapper\r\n    phase(spec, prefix)\r\n  File \"/home/xiang/spack/var/spack/repos/builtin/packages/perl/package.py\", line 236, in build\r\n  File \"/home/xiang/spack/lib/spack/spack/build_environment.py\", line 147, in __call__\r\n    return super(MakeExecutable, self).__call__(*args, **kwargs)\r\n  File \"/home/xiang/spack/lib/spack/spack/util/executable.py\", line 231, in __call__\r\n    raise self.error\r\nspack.util.executable.ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\nlib/spack/spack/installer.py:1367 ==> [2021-10-29-09:49:08.032323] Flagging perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre as failed: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\nlib/spack/spack/installer.py:1376 ==> [2021-10-29-09:49:08.034224] Warning: Skipping build of openssl-1.1.1l-y6rlhcf6l6jmpfw7ly3ixjl7ul5btmhi since perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre failed\r\nlib/spack/spack/installer.py:1367 ==> [2021-10-29-09:49:08.034374] Flagging openssl-1.1.1l-y6rlhcf6l6jmpfw7ly3ixjl7ul5btmhi as failed\r\nlib/spack/spack/installer.py:1376 ==> [2021-10-29-09:49:08.035056] Warning: Skipping build of cmake-3.21.3-4vdb4x2hks3plq42mi6vpcv7jmgvmzbx since openssl-1.1.1l-y6rlhcf6l6jmpfw7ly3ixjl7ul5btmhi failed\r\nlib/spack/spack/installer.py:1367 ==> [2021-10-29-09:49:08.035204] Flagging cmake-3.21.3-4vdb4x2hks3plq42mi6vpcv7jmgvmzbx as failed\r\nlib/spack/spack/installer.py:1376 ==> [2021-10-29-09:49:08.036414] Warning: Skipping build of clingo-bootstrap-spack-xfnxvdh6q2e5omsixxvz2mj75wrnrrr3 since cmake-3.21.3-4vdb4x2hks3plq42mi6vpcv7jmgvmzbx failed\r\nlib/spack/spack/installer.py:1367 ==> [2021-10-29-09:49:08.036564] Flagging clingo-bootstrap-spack-xfnxvdh6q2e5omsixxvz2mj75wrnrrr3 as failed\r\nlib/spack/spack/installer.py:1376 ==> [2021-10-29-09:49:08.037285] Warning: Skipping build of bison-3.8.2-mlbslwjvyg5qfrlgbtfgpzj2aewyx2d7 since perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre failed\r\nlib/spack/spack/installer.py:1367 ==> [2021-10-29-09:49:08.037423] Flagging bison-3.8.2-mlbslwjvyg5qfrlgbtfgpzj2aewyx2d7 as failed\r\nlib/spack/spack/stage.py:327 ==> [2021-10-29-09:49:08.039546] Creating stage lock spack-stage-perl-5.34.0-mek6vwo24bmcpceehu2pf7yg45mgxkre\r\nlib/spack/spack/stage.py:327 ==> [2021-10-29-09:49:08.039770] Creating stage lock resource-cpanm-mek6vwo24bmcpceehu2pf7yg45mgxkre\r\nlib/spack/spack/bootstrap.py:405 ==> [2021-10-29-09:49:08.039912] [BOOTSTRAP MODULE clingo] Unexpected error \"Terminating after first install failure: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\"\r\nlib/spack/spack/config.py:1007 ==> [2021-10-29-09:49:08.041556] Reading config file /home/xiang/spack/etc/spack/defaults/config.yaml\r\nTraceback (most recent call last):\r\n  File \"/home/xiang/spack/bin/spack\", line 100, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/home/xiang/spack/lib/spack/spack/main.py\", line 816, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/xiang/spack/lib/spack/spack/main.py\", line 529, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/xiang/spack/lib/spack/spack/cmd/install.py\", line 394, in install\r\n    specs = spack.cmd.parse_specs(\r\n  File \"/home/xiang/spack/lib/spack/spack/cmd/__init__.py\", line 164, in parse_specs\r\n    spec.concretize(tests=tests)  # implies normalize\r\n  File \"/home/xiang/spack/lib/spack/spack/spec.py\", line 2640, in concretize\r\n    self._new_concretize(tests)\r\n  File \"/home/xiang/spack/lib/spack/spack/spec.py\", line 2610, in _new_concretize\r\n    result = spack.solver.asp.solve([self], tests=tests)\r\n  File \"/home/xiang/spack/lib/spack/spack/solver/asp.py\", line 1679, in solve\r\n    driver = PyclingoDriver()\r\n  File \"/home/xiang/spack/lib/spack/spack/solver/asp.py\", line 292, in __init__\r\n    spack.bootstrap.ensure_clingo_importable_or_raise()\r\n  File \"/home/xiang/spack/lib/spack/spack/bootstrap.py\", line 625, in ensure_clingo_importable_or_raise\r\n    ensure_module_importable_or_raise(\r\n  File \"/home/xiang/spack/lib/spack/spack/bootstrap.py\", line 418, in ensure_module_importable_or_raise\r\n    raise ImportError(msg)\r\nImportError: cannot bootstrap the \"clingo\" Python module from spec \"clingo-bootstrap@spack+python %gcc target=x86_64\" due to the following failures:\r\n    'spack-install' raised InstallError: Terminating after first install failure: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\n    Please run `spack -d spec zlib` for more verbose error messages\r\n```\r\n\r\n\n\n### Information on your system\n\n* **Spack:** 0.16.3-5058-890095e876\r\n* **Python:** 3.8.9\r\n* **Platform:** linux-nixos21-zen2\r\n* **Concretizer:** clingo\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "Hong-Xiang",
    "url": "https://api.github.com/repos/spack/spack/issues/27049",
    "updated_at": "2021-10-29 01:51:09",
    "created_at": "2021-10-29 01:51:09",
    "closed_at": "None",
    "state": "open",
    "title": "Failed to install package in NixOS",
    "number": 27049,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1039088319,
    "html_url": "https://github.com/spack/spack/issues/27049",
    "assignees": [],
    "comments": 0
}