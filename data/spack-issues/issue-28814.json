{
    "body": "### Steps to reproduce the issue\r\n\r\nMentioning @becker33 in case this issue is LLNL-specific.\r\n*****************************************************************************************\r\n\r\nThis issue happens for me on LLNL's RZansel platform. To reproduce, follow these steps:\r\n\r\n1. Log into LLNL's RZansel platform (IBM power9)\r\n2. Clone most recent hash from `develop`:\r\n```console\r\n[quellyn@rzansel61]$ git clone git@github.com:spack/spack.git\r\n[quellyn@rzansel61]$ cd spack\r\n```\r\n\r\n3. Get a compute node:\r\n```console\r\n[quellyn@rzansel61]$ lalloc 1 -q pdebug -W 300\r\n```\r\n\r\n4. Load the most recent stable GCC module available:\r\n```console\r\n[quellyn@rzansel4]$ module list\r\n\r\nCurrently Loaded Modules:\r\n  1) xl/2021.09.22   2) spectrum-mpi/rolling-release   3) cuda/10.1.243   4) StdEnv (S)\r\n\r\n  Where:\r\n   S:  Module is Sticky, requires --force to unload or purge\r\n\r\n[quellyn@rzansel4]$ module unload cuda\r\n[quellyn@rzansel4]$ module swap xl gcc/8.3.1\r\n\r\nDue to MODULEPATH changes, the following have been reloaded:\r\n  1) spectrum-mpi/rolling-release\r\n\r\n[quellyn@rzansel4]$ module list\r\n\r\nCurrently Loaded Modules:\r\n  1) StdEnv (S)   2) gcc/8.3.1   3) spectrum-mpi/rolling-release\r\n\r\n  Where:\r\n   S:  Module is Sticky, requires --force to unload or purge\r\n```\r\n\r\n5. Source the spack setup script, clean up environment:\r\n```console\r\n[quellyn@rzansel4]$ source ./share/spack/setup-env.sh\r\n[quellyn@rzansel4]$ spack clean -ab\r\n[quellyn@rzansel4]$ rm -rf ~/.spack\r\n```\r\n\r\n6.  Detect available compilers:\r\n```console\r\n[quellyn@rzansel4]$ spack compiler find\r\n\r\n==> Added 7 new compilers to /g/g12/quellyn/.spack/linux/compilers.yaml\r\n    xl_r@16.1  xl@16.1  gcc@8.3.1  gcc@4.9.3  gcc@4.8.5  clang@12.0.1  clang@6.0.0\r\n==> Compilers are defined in the following files:\r\n    /g/g12/quellyn/.spack/linux/compilers.yaml\r\n```\r\n\r\n7. Try to build `py-scipy 1.7.3`:\r\n```console\r\n[quellyn@rzansel4]$ spack install py-scipy@1.7.3%gcc@8.3.1\r\n```\r\n\r\nThe above fails with:\r\n```\r\nProcessing /tmp/quellyn/spack-stage/spack-stage-py-scipy-1.7.3-vllws5wm6bhzrohhddgxriwuop6n6kxx/spack-src-src to build t  Added file:///tmp/quellyn/spack-stage/spack-stage-py-scipy-1.7.3-vllws5wm6bhzrohhddgxriwuop6n6kxx/spack-src to build tracker '/tmp/pip-req-tracker-xobymc23'\r\n  Created temporary directory: /tmp/pip-modern-metadata-vsy4e_36\r\n  Preparing metadata (pyproject.toml): started\r\n  Running command /g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/python-3.9.10-z7cxgxwgmyuymangexbjg3dfbjwtns4u/bin/python3.9 /g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /var/tmp/tmpktko6ay31-nprcgeuxqrmtvzh  setup.py:491: UserWarning: Unrecognized setuptools command ('dist_info --egg-base /tmp/pip-modern-metadata-vsy4e_36'), proceeding with generating Cython sources and expanding templates    warnings.warn(\"Unrecognized setuptools command ('{}'), proceeding with \"\r\n  Running from SciPy source directory.zed setuptools command ('dist_info --egg-base /tmp/pip-modern-metadata-vsy4e_36'),  Traceback (most recent call last):ources and expanding templates\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 363, in <module>\r\n      main()om SciPy source directory.\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 345, in main\r\n      json_out['return_val'] = hook(**hook_input['kwargs'])\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py\", line 164, in prepare_metadata_for_build_wheel\r\n      return hook(metadata_directory, config_settings)\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-setuptools-57.4.0-xs2nb3azns4o2ituffaj5npkkeul43dx/lib/python3.9/site-packages/setuptools/build_meta.py\", line 166, in prepare_metadata_for_build_wheel\r\n      self.run_setup()\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-setuptools-57.4.0-xs2nb3azns4o2ituffaj5npkkeul43dx/lib/python3.9/site-packages/setuptools/build_meta.py\", line 258, in run_setup\r\n      super(_BuildMetaLegacyBackend,\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-setuptools-57.4.0-xs2nb3azns4o2ituffaj5npkkeul43dx/lib/python3.9/site-packages/setuptools/build_meta.py\", line 150, in run_setup\r\n      exec(compile(code, __file__, 'exec'), locals())\r\n    File \"setup.py\", line 631, in <module>\r\n      setup_package()\r\n    File \"setup.py\", line 608, in setup_package\r\n      cmdclass['build_ext'] = get_build_ext_override()\r\n    File \"setup.py\", line 242, in get_build_ext_override\r\n      import pythran\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/__init__.py\", line 41, in <module>\r\n      from pythran.toolchain import (generate_cxx, compile_cxxfile, compile_cxxcode,\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/toolchain.py\", line 6, in <module>\r\n      from pythran.backend import Cxx, Python\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/backend.py\", line 7, in <module>\r\n      from pythran.analyses import LocalNodeDeclarations, GlobalDeclarations, Scope\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/analyses/__init__.py\", line 12, in <module>\r\n      from .aliases import Aliases, StrictAliases\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/analyses/aliases.py\", line 6, in <module>\r\n      from pythran.syntax import PythranSyntaxError\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/syntax.py\", line 7, in <module>\r\n      from pythran.tables import MODULES\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/pythran/tables.py\", line 4524, in <module>\r\n      omp_version = getattr(__import__('omp'), 'VERSION', 45)\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/omp/__init__.py\", line 130, in <module>\r\n      sys.modules[__name__] = OpenMP()\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/omp/__init__.py\", line 33, in __init__\r\n      self.init_not_msvc()\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pythran-0.9.12-26e5uhqoc7mxs3crrxdoxnh5j5gluyei/lib/python3.9/site-packages/omp/__init__.py\", line 110, in init_not_msvc\r\n      self.libomp = ctypes.CDLL(libomp_path)\r\n    File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/python-3.9.10-z7cxgxwgmyuymangexbjg3dfbjwtns4u/lib/python3.9/ctypes/__init__.py\", line 374, in __init__\r\n      self._handle = _dlopen(self._name, mode)\r\n  OSError: /usr/tce/packages/gcc/gcc-8.3.1/rh/usr/bin/../lib/gcc/ppc64le-redhat-linux/8/libgomp.so: invalid ELF header\r\n  Preparing metadata (pyproject.toml): finished with status 'error'\r\nWARNING: Discarding file:///tmp/quellyn/spack-stage/spack-stage-py-scipy-1.7.3-vllws5wm6bhzrohhddgxriwuop6n6kxx/spack-src. Command errored out with exit status 1: /g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/python-3.9.10-z7cxgxwgmyuymangexbjg3dfbjwtns4u/bin/python3.9 /g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /var/tmp/tmpktko6ay3 Check the logs for full command output.\r\nERROR: Command errored out with exit status 1: /g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/python-3.9.10-z7cxgxwgmyuymangexbjg3dfbjwtns4u/bin/python3.9 /g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_vendor/pep517/in_process/_in_process.py prepare_metadata_for_build_wheel /var/tmp/tmpktko6ay3 Check the logs for full command output.\r\nException information:\r\nTraceback (most recent call last):\r\n  File \"/g/g12/quellyn/GIT/spack/opt/spack/linux-rhel7-power9le/gcc-8.3.1/py-pip-21.3.1-nprcgeuxqrmtvzhuxhkwinuca4vtj7vo/lib/python3.9/site-packages/pip/_internal/cli/base_command.py\", line 164, in exc_logging_wrapper\r\n    status = run_func(*args)\r\n```\r\n\r\nThe `setuptools` messages are worrying, but this is the one that really caught my eye:\r\n```\r\n  OSError: /usr/tce/packages/gcc/gcc-8.3.1/rh/usr/bin/../lib/gcc/ppc64le-redhat-linux/8/libgomp.so: invalid ELF header\r\n```\r\n\r\nIt turns out that `libgomp.so` is a script on RZansel:\r\n\r\n```console\r\n[quellyn@rzansel61]$ cat /usr/tce/packages/gcc/gcc-8.3.1/rh/usr/lib/gcc/ppc64le-redhat-linux/8/libgomp.so\r\n\r\n/* GNU ld script */\r\nOUTPUT_FORMAT(elf64-powerpcle)\r\nINPUT ( /usr/lib64/libgomp.so.1 )\r\n```\r\n\r\nBy contrast if I look at the closest equivalent GCC module (gcc/8.3.0 module) on a LANL cluster, it's a symlink to a real library:\r\n\r\n```console\r\n[quellyn@cn2026 ~]$ ls -la /projects/opt/ppc64le/p9/gcc/8.3.0/lib64/libgomp.so\r\nlrwxrwxrwx 1 root darwin-admin 16 Sep 24  2019 /projects/opt/ppc64le/p9/gcc/8.3.0/lib64/libgomp.so -> libgomp.so.1.0.0\r\n[quellyn@cn2026 ~]$ file /projects/opt/ppc64le/p9/gcc/8.3.0/lib64/libgomp.so.1.0.0\r\n/projects/opt/ppc64le/p9/gcc/8.3.0/lib64/libgomp.so.1.0.0: ELF 64-bit LSB shared object, 64-bit PowerPC or cisco 7500, version 1 (SYSV), dynamically linked, not stripped\r\n```\r\n\r\nNote that `py-scipy 1.7.3` builds fine on the LANL cluster.\r\n\r\nIf I back down to `py-scip 1.6.3` (which does not require `py-pythran`), it builds fine on RZansel.\r\n\r\n\r\n### Information on your system\r\n\r\n```console\r\n[quellyn@rzansel4]$ spack debug report\r\n* **Spack:** 0.17.1-1101-c791ddc742\r\n* **Python:** 3.7.2\r\n* **Platform:** linux-rhel7-power9le\r\n* **Concretizer:** clingo\r\n```\r\n\r\n### Additional information\r\n\r\n[spack-build-env.txt](https://github.com/spack/spack/files/8019196/spack-build-env.txt)\r\n[spack-build-out.txt](https://github.com/spack/spack/files/8019197/spack-build-out.txt)\r\n\r\n\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\r\n- [X] I have uploaded the build log and environment files\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "quellyn",
    "url": "https://api.github.com/repos/spack/spack/issues/28814",
    "updated_at": "2022-02-08 00:30:02",
    "created_at": "2022-02-07 22:36:49",
    "closed_at": "None",
    "state": "open",
    "title": "Installation issue: py-scipy 1.7.3 failure on LLNL's RZansel platform",
    "number": 28814,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 1126577435,
    "html_url": "https://github.com/spack/spack/issues/28814",
    "assignees": [],
    "comments": 1
}