{
    "body": "Spack should support applying compressed patches from remote, but currently fails on `.gz` files. The issue seems that `gunzip` always decompress the file in place, while Spack expects it to extract in the current working directory:\r\n\r\nhttps://github.com/spack/spack/blob/58edc361be0aec47bfed24ef310ffa808153c74c/lib/spack/spack/fetch_strategy.py#L465-L472\r\n\r\n\r\n### Steps to reproduce the issue\r\nUsing #22788 modified to retrieve the patch from remote:\r\n```console\r\n$ spack -d patch ncbi-rmblastn\r\n```\r\n\r\n### Error Message\r\n\r\n<details>\r\n\r\n<summary>$ spack -d patch ncbi-rmblastn </summary>\r\n\r\n```console\r\n$ spack -d patch ncbi-rmblastn\r\n==> [2021-04-07-10:16:42.722900] Imported patch from built-in commands\r\n==> [2021-04-07-10:16:42.723910] Imported patch from built-in commands\r\n==> [2021-04-07-10:16:42.725527] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/config.yaml\r\n==> [2021-04-07-10:16:42.750447] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/repos.yaml\r\n==> [2021-04-07-10:16:42.821071] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/packages.yaml\r\n==> [2021-04-07-10:16:42.860430] Reading config file /home/culpo/.spack/packages.yaml\r\n==> [2021-04-07-10:16:42.866125] Reading config file /home/culpo/.spack/linux/compilers.yaml\r\n==> [2021-04-07-10:16:42.971083] Ordered hashes [ncbi-rmblastn]: ncbi-rmblastn/0/ce985abd3512834adb9ad3e4078fbf9608a33a2ee6538a1e94b641490c92f899\r\n==> [2021-04-07-10:16:42.971715] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-04-07-10:16:42.971787] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-04-07-10:16:42.985895] Creating stage lock spack-stage-ncbi-rmblastn-2.9.0-7v3skwjselu63o5avqqaez3qslpizpr4\r\n==> [2021-04-07-10:16:42.986535] Reading config file /home/culpo/PycharmProjects/spack/etc/spack/defaults/mirrors.yaml\r\n==> [2021-04-07-10:16:42.987343] Reading config file /home/culpo/.spack/mirrors.yaml\r\n==> [2021-04-07-10:16:43.073409] Using cached archive: /home/culpo/PycharmProjects/spack/var/spack/cache/_source-cache/archive/a3/a390cc2d7a09422759fc178db84de9def822cbe485916bbb2ec0d215dacdc257.tar.gz\r\n==> [2021-04-07-10:16:43.187731] Creating stage lock spack-stage-g8t8mduw\r\n==> [2021-04-07-10:16:43.188243] Checking existence of http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz\r\n==> [2021-04-07-10:16:43.188815] '/usr/bin/curl' '--stderr' '-' '-s' '-f' '-r' '0-0' 'http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz'\r\n==> [2021-04-07-10:16:43.714717] Fetching http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz\r\n==> [2021-04-07-10:16:43.716420] '/usr/bin/curl' '-C' '-' '-o' '/tmp/culpo/spack-stage/spack-stage-g8t8mduw/isb-2.11.0+-rmblast.patch.gz.part' '-f' '-D' '-' '-L' 'http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz' '-#' '--connect-timeout' '10'\r\n########################################################################################################################################### 100,0%\r\n==> [2021-04-07-10:16:44.404490] Staging archive: /tmp/culpo/spack-stage/spack-stage-g8t8mduw/isb-2.11.0+-rmblast.patch.gz\r\n==> [2021-04-07-10:16:44.407331] '/bin/gunzip' '/tmp/culpo/spack-stage/spack-stage-g8t8mduw/isb-2.11.0+-rmblast.patch.gz'\r\n/tmp/culpo/spack-stage/spack-stage-g8t8mduw/spack-src\r\n==> [2021-04-07-10:16:44.417239] Created stage in /tmp/culpo/spack-stage/spack-stage-g8t8mduw\r\n/tmp/culpo/spack-stage/spack-stage-g8t8mduw/spack-src\r\n==> [2021-04-07-10:16:44.417716] NoSuchPatchError: Archive was empty: http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz\r\n==> [2021-04-07-10:16:44.417856] Error: Archive was empty: http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz\r\nTraceback (most recent call last):\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 772, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/main.py\", line 496, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/cmd/patch.py\", line 36, in patch\r\n    package.do_patch()\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/package.py\", line 1397, in do_patch\r\n    self.do_stage()\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/package.py\", line 1382, in do_stage\r\n    self.do_fetch(mirror_only)\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/package.py\", line 1370, in do_fetch\r\n    patch.fetch()\r\n  File \"/home/culpo/PycharmProjects/spack/lib/spack/spack/patch.py\", line 206, in fetch\r\n    \"Archive was empty: %s\" % self.url)\r\nspack.patch.NoSuchPatchError: Archive was empty: http://www.repeatmasker.org/isb-2.11.0+-rmblast.patch.gz\r\n```\r\n\r\n</details>\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.1-2091-c188575cfe\r\n* **Python:** 3.6.9\r\n* **Platform:** linux-ubuntu18.04-broadwell\r\n* **Concretizer:** original\r\n\r\n\r\n### Additional information\r\n\r\nThe following diff seems to solve the issue:\r\n\r\n```diff\r\ndiff --git a/lib/spack/spack/util/compression.py b/lib/spack/spack/util/compression.py\r\nindex 2f190e94e1..03a830109a 100644\r\n--- a/lib/spack/spack/util/compression.py\r\n+++ b/lib/spack/spack/util/compression.py\r\n@@ -22,6 +22,21 @@ def allowed_archive(path):\r\n     return any(path.endswith(t) for t in ALLOWED_ARCHIVE_TYPES)\r\n \r\n \r\n+def _gunzip(archive_file):\r\n+    \"\"\"Like gunzip, but extracts in cwd instead of in-place.\r\n+\r\n+    Args:\r\n+        archive_file (str): absolute path of the file to be decompressed\r\n+    \"\"\"\r\n+    import gzip\r\n+    decompressed_file = os.path.basename(archive_file.strip('.gz'))\r\n+    working_dir = os.getcwd()\r\n+    destination_abspath = os.path.join(working_dir, decompressed_file)\r\n+    with gzip.open(archive_file, \"rb\") as f_in:\r\n+        with open(destination_abspath, \"wb\") as f_out:\r\n+            f_out.write(f_in.read())\r\n+\r\n+\r\n def decompressor_for(path, extension=None):\r\n     \"\"\"Get the appropriate decompressor for a path.\"\"\"\r\n     if ((extension and re.match(r'\\.?zip$', extension)) or\r\n@@ -30,8 +45,7 @@ def decompressor_for(path, extension=None):\r\n         unzip.add_default_arg('-q')\r\n         return unzip\r\n     if extension and re.match(r'gz', extension):\r\n-        gunzip = which('gunzip', required=True)\r\n-        return gunzip\r\n+        return _gunzip\r\n     if extension and re.match(r'bz2', extension):\r\n         bunzip2 = which('bunzip2', required=True)\r\n         return bunzip2\r\n\r\n```\r\n\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/22822",
    "updated_at": "2021-04-28 15:00:59",
    "created_at": "2021-04-07 09:28:16",
    "closed_at": "2021-04-28 15:00:59",
    "state": "closed",
    "title": "Cannot apply a gunzipped patch file",
    "number": 22822,
    "milestone": null,
    "labels": [
        "bug",
        "impact-low",
        "patch"
    ],
    "id": 852212846,
    "html_url": "https://github.com/spack/spack/issues/22822",
    "assignees": [],
    "comments": 0
}