{
    "body": "Consider the following `demo` package:\r\n\r\n```diff\r\ndiff --git a/var/spack/repos/builtin/packages/demo/package.py b/var/spack/repos/builtin/packages/demo/package.py\r\nnew file mode 100644\r\nindex 000000000..c7dde8cbc\r\n--- /dev/null\r\n+++ b/var/spack/repos/builtin/packages/demo/package.py\r\n@@ -0,0 +1,9 @@\r\n+from spack import *\r\n+\r\n+class Demo(Package):\r\n+    git = 'https://github.com/FairRootGroup/FairLogger.git' # just any git repo\r\n+    version('1.6.0', commit='b9edcd623d758b79bb0d424c02c71239b2cc6b2a')\r\n+    phases = ['check_if_git_repo']\r\n+\r\n+    def check_if_git_repo(self, spec, prefix):\r\n+        Executable('git describe')()\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\nUsing Spack `v0.13.2-685-g9ed34f686`:\r\n\r\n```console\r\n$ spack clean -d && spack install -v demo && spack uninstall -y demo && spack install -v demo                   \r\n==> Removing cached downloads\r\n==> Installing demo\r\n==> Searching for binary cache of demo\r\n==> No binary for demo found: installing from source\r\n==> Cloning git repository: https://github.com/FairRootGroup/FairLogger.git at commit b9edcd623d758b79bb0d424c02c71239b2cc6b2a\r\n==> No checksum needed when fetching with git\r\n==> Already staged spack-stage-demo-1.6.0-4pyawof7uxjf3atqulp4rr4rit4i5jq2 in /tmp/dklein/spack-stage/spack-stage-demo-1.6.0-4pyawof7uxjf3atqulp4rr4rit4i5jq2\r\n==> No patches needed for demo\r\n==> Building demo [Package]\r\n==> Executing phase: 'check_if_git_repo'\r\n==> [2020-01-02-13:34:13.486880] 'git' 'describe'\r\nv1.6.0\r\n==> Successfully installed demo\r\n  Fetch: 1.34s.  Build: 0.21s.  Total: 1.55s.\r\n[+] /home/dklein/.spack/install_tree/linux-fedora31-skylake/gcc-9.2.1/demo-1.6.0-4pyawof7uxjf3atqulp4rr4rit4i5jq2\r\n==> Successfully uninstalled demo@1.6.0%gcc@9.2.1 arch=linux-fedora31-skylake/4pyawof\r\n==> Installing demo\r\n==> Searching for binary cache of demo\r\n==> No binary for demo found: installing from source\r\n==> Using cached archive: /home/dklein/.spack/source_cache/_source-cache/git//FairRootGroup/FairLogger.git/b9edcd623d758b79bb0d424c02c71239b2cc6b2a.tar.gz\r\n==> Warning: Fetching from mirror without a checksum!\r\n  This package is normally checked out from a version control system, but it has been archived on a spack mirror.  This means we cannot know a checksum for the tarball in advance. Be sure that your connection to this mirror is secure!\r\n==> Staging archive: /tmp/dklein/spack-stage/spack-stage-demo-1.6.0-4pyawof7uxjf3atqulp4rr4rit4i5jq2/b9edcd623d758b79bb0d424c02c71239b2cc6b2a.tar.gz\r\n==> Created stage in /tmp/dklein/spack-stage/spack-stage-demo-1.6.0-4pyawof7uxjf3atqulp4rr4rit4i5jq2\r\n==> No patches needed for demo\r\n==> Building demo [Package]\r\n==> Executing phase: 'check_if_git_repo'\r\n==> [2020-01-02-13:34:15.271202] 'git' 'describe'\r\nfatal: not a git repository (or any parent up to mount point /)\r\nStopping at filesystem boundary (GIT_DISCOVERY_ACROSS_FILESYSTEM not set).\r\n==> Error: ProcessError: Command exited with status 128:\r\n    'git' 'describe'\r\nSee build log for details:\r\n  /tmp/dklein/spack-stage/spack-stage-demo-1.6.0-4pyawof7uxjf3atqulp4rr4rit4i5jq2/spack-build-out.txt\r\n...\r\n```\r\n\r\n### Error Message\r\n\r\n```\r\n==> [2020-01-02-13:34:15.271202] 'git' 'describe'\r\nfatal: not a git repository (or any parent up to mount point /)\r\n```\r\n\r\nThe staged source directory from a source cache does not present as a git repo as it is the case when staging from upstream. The reason for this behaviour appears to be https://github.com/spack/spack/blob/9ed34f686fc605d2e5dfbb15b14ed8d63fdb7c72/lib/spack/spack/fetch_strategy.py#L870 which archives the working tree instead of the git repo.\r\n\r\nOn a second note, the same source caching strategy seems to result in the following warning\r\n```\r\n==> Warning: Fetching from mirror without a checksum!\r\n  This package is normally checked out from a version control system, but it has been archived on a spack mirror.  This means we cannot know a checksum for the tarball in advance. Be sure that your connection to this mirror is secure!\r\n```\r\nwhich is rather disappointing since the package spec contains the git commit hash with which one could reconstruct the working tree from a cached git repo.\r\n\r\n---\r\n\r\n1. As a package maintainer, should I be able to expect that the staged source directory (from a package with a git source) presents itself as a git repository clone even when staged from the cache? (=> If yes, consider this issue as a bug report, if no, consider this issue as resolved and thank you for clarifying the intended behaviour.)\r\n\r\n2. Regardless of the previous, would you consider accepting a contribution which changes the source caching strategy of the `GitFetchStrategy` to rather archive the git repo (just the `.git` directory without the working tree) and then reconstruct the working tree using the commit hash from the package spec? (=> Fixing the unsafe warning for that case.)\r\n\r\nCc: @ChristianTackeGSI",
    "user": "dennisklein",
    "url": "https://api.github.com/repos/spack/spack/issues/14344",
    "updated_at": "2020-02-24 10:07:11",
    "created_at": "2020-01-02 13:28:03",
    "closed_at": "None",
    "state": "open",
    "title": "Source cache does not present a git repo for packages with a git source",
    "number": 14344,
    "milestone": null,
    "labels": [
        "bug",
        "git"
    ],
    "id": 544578552,
    "html_url": "https://github.com/spack/spack/issues/14344",
    "assignees": [
        "scheibelp"
    ],
    "comments": 3
}