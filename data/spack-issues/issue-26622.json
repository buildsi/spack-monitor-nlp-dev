{
    "body": "Find some things to speed up pipeline generation, apart from the parallelization of separate concretization done in #26264.\r\n\r\n- [x] Stage already concretized specs instead of abstract ones\r\n- [x] Reduce number of network calls\r\n- [x] Resolve compiler bootstrapping issues caused by removal of \"redundant\" concretization \r\n\r\nWithout this PR (or #26264) the time to generate the E4S stack on a machine with 16 cores and 128GB RAM: \r\n\r\n```\r\n         2791561432 function calls (2640954370 primitive calls) in 3768.751 seconds\r\n\r\n   Ordered by: internal time\r\n   List reduced from 5804 to 20 due to restriction <20>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n      204 1136.368    5.570 1139.205    5.584 {method 'solve' of 'clingo.Control' objects}\r\n     1094  657.732    0.601  657.732    0.601 {method 'connect' of '_socket.socket' objects}\r\n      204  316.340    1.551  316.340    1.551 {method 'ground' of 'clingo.Control' objects}\r\n      204   78.431    0.384 2926.023   14.343 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/spec.py:2586(_new_concretize)\r\n102037509/30236460   74.983    0.000  575.468    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:99(coercing_method)\r\n      366   58.462    0.160   58.462    0.160 {method 'do_handshake' of '_ssl._SSLSocket' objects}\r\n 14283931   52.750    0.000  169.638    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:336(__getitem__)\r\n141907172   45.957    0.000   74.038    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:208(is_commit)\r\n 14401892   44.065    0.000   90.838    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:172(__init__)\r\n  9145110   43.108    0.000  147.485    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/solver/asp.py:314(fact)\r\n160589001   41.149    0.000   41.149    0.000 {method 'match' of 're.Pattern' objects}\r\n3236948/3236942   36.132    0.000   78.594    0.000 {built-in method builtins.__build_class__}\r\n     1105   35.954    0.033   35.954    0.033 {method 'read' of '_ssl._SSLSocket' objects}\r\n281940552/281922412   35.696    0.000   44.353    0.000 {built-in method builtins.isinstance}\r\n 14351403   28.026    0.000  331.781    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:67(coerce_versions)\r\n 28424087   27.347    0.000  103.055    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:373(__lt__)\r\n 85054216   25.348    0.000   68.962    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:192(_cmp)\r\n161804638/111592283   24.136    0.000   35.727    0.000 {built-in method builtins.len}\r\n4557944/3222059   23.377    0.000   43.056    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/spec.py:1356(traverse_edges)\r\n  9425890   21.790    0.000  249.868    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:498(__init__)\r\n```\r\n\r\nWith this PR on the same machine:\r\n\r\n```\r\n         1493151814 function calls (1411155039 primitive calls) in 3006.827 seconds\r\n\r\n   Ordered by: internal time\r\n   List reduced from 16155 to 20 due to restriction <20>\r\n\r\n   ncalls  tottime  percall  cumtime  percall filename:lineno(function)\r\n     1094  648.836    0.593  648.836    0.593 {method 'connect' of '_socket.socket' objects}\r\n      102  639.888    6.273  640.250    6.277 {method 'solve' of 'clingo.Control' objects}\r\n      102  235.054    2.304  235.054    2.304 {method 'ground' of 'clingo.Control' objects}\r\n51294040/15288593   66.863    0.000  514.913    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:99(coercing_method)\r\n      366   56.795    0.155   56.795    0.155 {method 'do_handshake' of '_ssl._SSLSocket' objects}\r\n 71255182   49.230    0.000   78.362    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:208(is_commit)\r\n  7165293   46.909    0.000  150.008    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:336(__getitem__)\r\n      102   40.387    0.396 2136.177   20.943 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/spec.py:2586(_new_concretize)\r\n  7295389   38.481    0.000   81.537    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:172(__init__)\r\n 80863592   37.962    0.000   37.962    0.000 {method 'match' of 're.Pattern' objects}\r\n     1094   36.112    0.033   36.112    0.033 {method 'read' of '_ssl._SSLSocket' objects}\r\n  4572555   34.259    0.000  115.351    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/solver/asp.py:314(fact)\r\n150773974/150755834   33.646    0.000   40.963    0.000 {built-in method builtins.isinstance}\r\n1625206/1625200   26.473    0.000  105.364    0.000 {built-in method builtins.__build_class__}\r\n 14264122   25.757    0.000  105.578    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:373(__lt__)\r\n 42719382   24.636    0.000   71.369    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:192(_cmp)\r\n84444956/58691964   22.380    0.000   33.521    0.000 {built-in method builtins.len}\r\n  7182053   22.346    0.000  286.052    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/version.py:67(coerce_versions)\r\n     1102   18.557    0.017   18.565    0.017 /usr/lib/python3.8/json/decoder.py:343(raw_decode)\r\n2590831/1709814   17.795    0.000   35.024    0.000 /data/scott/Documents/spack/speedup_pipeline_generation/spack/lib/spack/spack/spec.py:1356(traverse_edges)\r\n```\r\n\r\nWe can see that we reduced the number of calls to `ground` and `solve` in half, and got some speedup, from ~62 min down to ~50 min.\r\n\r\nAccording to the profile log, another place we're spending a lot of time is in making network connections, and one thing we do for every spec in the environment (both roots and dependencies), is to check the presence of the spec hash in the \"naughty list\".  Perhaps by retrieving everything from the naughty list up front, just once, we can get the number of network connect calls down.",
    "user": "scottwittenburg",
    "url": "https://api.github.com/repos/spack/spack/issues/26622",
    "updated_at": "2021-10-19 03:58:03",
    "created_at": "2021-10-08 23:26:42",
    "closed_at": "2021-10-19 03:58:03",
    "state": "closed",
    "title": "Speed up pipeline generation",
    "number": 26622,
    "milestone": null,
    "labels": [
        "tests"
    ],
    "id": 1021533204,
    "html_url": "https://github.com/spack/spack/pull/26622",
    "assignees": [],
    "comments": 10
}