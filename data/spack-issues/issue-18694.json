{
    "body": "Libtool control files can contain hardcoded paths to `libstdc++.la`. This can break builds when packages that contain these hardcoded paths get cached in a build cache, and are then subsequently installed into a target environment where `libstdc++.la` is not in the same location. \r\n\r\nFor instance, if I build the dependencies of `hpctoolkit` in an environment where `libstdc++.la` is at\r\n```\r\n/spack-build/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-8.1.0-glpr3bujg7j5hxvesdbis4cjqzwlncth/lib/../lib64/libstdc++.la\r\n``` \r\n\r\nThen the following files end up with this path hardcoded:\r\n```\r\n/spack-build/opt/spack/linux-centos7-x86_64/gcc-8.1.0/berkeley-db-18.1.40-uasyknrjfdzy2xfoswjqn36w7yzovyts/lib/libdb_cxx-18.1.la\r\n/spack-build/opt/spack/linux-centos7-x86_64/gcc-8.1.0/berkeley-db-18.1.40-uasyknrjfdzy2xfoswjqn36w7yzovyts/lib/libdb_stl-18.1.la\r\n/spack-build/opt/spack/linux-centos7-x86_64/gcc-8.1.0/gettext-0.21-md2v74tvbcqvsu56jmlre3p6mnms5tzm/lib/libasprintf.la\r\n/spack-build/opt/spack/linux-centos7-x86_64/gcc-8.1.0/mpich-3.2.1-y2wrnnftiawtynzg4qzugcfqktatnh64/lib/libmpicxx.la\r\n/spack-build/opt/spack/linux-centos7-x86_64/gcc-8.1.0/xerces-c-3.2.2-ba55khya5d3b6526s2lpzxadl24figaq/lib/libxerces-c.la\r\n```\r\n\r\nIf I then cache all the dependencies of `hpctoolkit`, and subsequently install those dependencies into an environment where `gcc@8.1.0` is installed to `/packages/gcc/8.1`,  this is what happens when you try to build `hpctoolkit`:\r\n\r\n```\r\n==> Installing hpctoolkit\r\n==> hpctoolkit: Executing phase: 'autoreconf'\r\n==> hpctoolkit: Executing phase: 'configure'\r\n==> hpctoolkit: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16'\r\n\r\n5 errors found in build log:\r\n...\r\n     1250    /bin/sh ../../../libtool  --tag=CXX   --mode=link /spack-test/lib/spack/env/gcc/g++ -g -O3 -Wall  -faligned-new -I/tmp/eugeneswalker/sp\r\n             ack-stage/spack-stage-hpctoolkit-2020.08.03-h7pd5znfeg25vx5d7pijtvkrmqqnljrr/spack-src/src -I/tmp/eugeneswalker/spack-stage/spack-stage-hpctoolki\r\n             t-2020.08.03-h7pd5znfeg25vx5d7pijtvkrmqqnljrr/spack-src/src -I/spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/binutils-2.33.1\r\n             -qmxhsmfvocs5u4qfad3prpixgjtjocgo/include -I/spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/xerces-c-3.2.2-ba55khya5d3b6526s2\r\n             lpzxadl24figaq/include  -g -O3 -Wall  -faligned-new -L/spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/xerces-c-3.2.2-ba55khya\r\n             5d3b6526s2lpzxadl24figaq/lib -L/spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/xz-5.2.5-fqzrczlylvl333jhjlasdsc5n2ydugxo/lib\r\n             -llzma  -o hpcprof-bin hpcprof_bin-main.o hpcprof_bin-Args.o ../../../src/lib/analysis/libHPCanalysis.la ../../../src/lib/banal/libHPCbanal_\r\n             simple.la ../../../src/lib/profxml/libHPCprofxml.la ../../../src/lib/prof/libHPCprof.la ../../../src/lib/binutils/libHPCbinutils.la ../../..\r\n             /src/lib/prof-lean/libHPCprof-lean.la ../../../src/lib/isa/libHPCisa.la -L/spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/int\r\n             el-xed-2019.03.01-ivkiqjbbhifszwlm3ncetcnztjqr5gjy/lib -lxed ../../../src/lib/xml/libHPCxml.la ../../../src/lib/support/libHPCsupport.la ../\r\n             ../../src/lib/support-lean/libHPCsupport-lean.la -L/spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/elfutils-0.180-s4ib3ctvhay\r\n             jk7l3r2diozomettjzdwj/lib -ldw -lelf /spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/xz-5.2.5-fqzrczlylvl333jhjlasdsc5n2ydugx\r\n             o/lib/liblzma.a -lxerces-c -lxerces-c /spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/binutils-2.33.1-qmxhsmfvocs5u4qfad3prpi\r\n             xgjtjocgo/lib/libbfd.a /spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/binutils-2.33.1-qmxhsmfvocs5u4qfad3prpixgjtjocgo/lib64\r\n             /libiberty.a -ldl /spack-test/opt/spack/linux-centos7-x86_64/gcc-8.1.0/zlib-1.2.11-sh7mgsynw6uq2lkaqsv4ty5zerjfu7ww/lib/libz.a -lm\r\n  >> 1251    libtool:   error: cannot find the library '/spack-test/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-8.1.0-glpr3bujg7j5hxvesdbis4cj\r\n             qzwlncth/lib/../lib64/libstdc++.la' or unhandled argument '/spack-test/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-8.1.0-glpr3buj\r\n             g7j5hxvesdbis4cjqzwlncth/lib/../lib64/libstdc++.la'\r\n  >> 1252    make[3]: *** [hpcprof-bin] Error 1\r\n     1253    make[3]: Leaving directory `/tmp/eugeneswalker/spack-stage/spack-stage-hpctoolkit-2020.08.03-h7pd5znfeg25vx5d7pijtvkrmqqnljrr/spack-src/src/tool/\r\n             hpcprof'\r\n  >> 1254    make[2]: *** [all-recursive] Error 1\r\n     1255    make[2]: Leaving directory `/tmp/eugeneswalker/spack-stage/spack-stage-hpctoolkit-2020.08.03-h7pd5znfeg25vx5d7pijtvkrmqqnljrr/spack-src/src/tool'\r\n  >> 1256    make[1]: *** [all-recursive] Error 1\r\n     1257    make[1]: Leaving directory `/tmp/eugeneswalker/spack-stage/spack-stage-hpctoolkit-2020.08.03-h7pd5znfeg25vx5d7pijtvkrmqqnljrr/spack-src/src'\r\n  >> 1258    make: *** [all-recursive] Error 1\r\n...\r\n```\r\n\r\nNotice in the error output that although the Spack `install_tree` was re-written, where the original install tree of `/spack-build/opt/spack` was replaced with `/spack-test/opt/spack`, you still have these paths:\r\n\r\n```\r\n  >> 1251    libtool:   error: cannot find the library '/spack-test/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-8.1.0-glpr3bujg7j5hxvesdbis4cj\r\n             qzwlncth/lib/../lib64/libstdc++.la' or unhandled argument '/spack-test/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-8.1.0-glpr3buj\r\n             g7j5hxvesdbis4cjqzwlncth/lib/../lib64/libstdc++.la'\r\n```\r\n\r\n@gartung @alalazo @tgamblin @becker33 @scottwittenburg ",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/18694",
    "updated_at": "2020-10-13 16:15:49",
    "created_at": "2020-09-16 15:42:12",
    "closed_at": "2020-10-13 16:15:49",
    "state": "closed",
    "title": "binary relocation: libtool control files: hardcoded paths to libstdc++.la are ploblematic",
    "number": 18694,
    "milestone": null,
    "labels": [
        "bug",
        "impact-medium",
        "buildcache",
        "binary-packages",
        "ecp",
        "e4s"
    ],
    "id": 702873295,
    "html_url": "https://github.com/spack/spack/issues/18694",
    "assignees": [
        "alalazo"
    ],
    "comments": 5
}