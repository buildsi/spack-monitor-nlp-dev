{
    "body": "Spack erroneously sets CC,FC to wrong compiler and mixes MPICC from one compiler with a different CC.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```\r\n[sajid@xrmlite ~]$ spack install petsc+complex ^intel-mkl@2018.3.222 ^openmpi %gcc@7.3.0       \r\n...                             \r\n==> Installing petsc\r\n==> Searching for binary cache of petsc\r\n==> Warning: No Spack mirrors are currently configured\r\n==> No binary for petsc found: installing from source\r\n==> Fetching http://ftp.mcs.anl.gov/pub/petsc/release-snapshots/petsc-3.10.2.tar.gz\r\n######################################################################## 100.0%\r\n==> Staging archive: /home/sajid/packages/spack/var/spack/stage/petsc-3.10.2-fqbenzsyao3bpbwpmtupmsykyl365ns6/petsc-3.10.2.tar.gz\r\n==> Created stage in /home/sajid/packages/spack/var/spack/stage/petsc-3.10.2-fqbenzsyao3bpbwpmtupmsykyl365ns6\r\n==> No patches needed for petsc\r\n==> Building petsc [Package]\r\n==> Executing phase: 'install'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' 'MAKE_NP=32'\r\n\r\n4 errors found in build log:\r\n     2044    ifort: command line warning #10006: ignoring unknown option '-fgcc-name=/home/sajid/packages/spack/opt/spack/linux-centos7-x86_\r\n             64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/'\r\n     2045    ifort: command line warning #10006: ignoring unknown option '-fgcc-name=/home/sajid/packages/spack/opt/spack/linux-centos7-x86_\r\n             64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/'\r\n     2046         CLINKER arch-linux2-c-opt/lib/libpetsc.so.3.10.2\r\n     2047    ld: arch-linux2-c-opt/obj/sys/objects/f2003-src/fsrc/optionenum.o: relocation R_X86_64_32S against `__STRLITPACK_0' can not be \r\n             used when making a shared object; recompile with -fPIC\r\n     2048    ld: arch-linux2-c-opt/obj/sys/classes/bag/f2003-src/fsrc/bagenum.o: relocation R_X86_64_32S against `__STRLITPACK_0' can not be\r\n              used when making a shared object; recompile with -fPIC\r\n     2049    ld: arch-linux2-c-opt/obj/sys/f90-mod/petscsysmod.o: relocation R_X86_64_32 against symbol `petscsys_mp_petsc_null_character_' \r\n             can not be used when making a shared object; recompile with -fPIC\r\n  >> 2050    ld: final link failed: Nonrepresentable section on output\r\n  >> 2051    gmake[2]: *** [arch-linux2-c-opt/lib/libpetsc.so.3.10.2] Error 1\r\n     2052    gmake[2]: Leaving directory `/tmp/sajid/spack-stage/spack-stage-RiLL7C/petsc-3.10.2'\r\n  >> 2053    gmake[1]: *** [gnumake] Error 2\r\n     2054    gmake[1]: Leaving directory `/tmp/sajid/spack-stage/spack-stage-RiLL7C/petsc-3.10.2'\r\n     2055    **************************ERROR*************************************\r\n     2056      Error during compile, check arch-linux2-c-opt/lib/petsc/conf/make.log\r\n     2057      Send it and arch-linux2-c-opt/lib/petsc/conf/configure.log to petsc-maint@mcs.anl.gov\r\n     2058    ********************************************************************\r\n  >> 2059    make: *** [all] Error 1\r\n\r\nSee build log for details:\r\n  /home/sajid/packages/spack/var/spack/stage/petsc-3.10.2-fqbenzsyao3bpbwpmtupmsykyl365ns6/petsc-3.10.2/spack-build.out\r\n\r\n```\r\n\r\n\r\nLooking at `spack-build.env` the issue becomes clear : \r\n```\r\n[sajid@xrmlite ~]$ cd /home/sajid/packages/spack/var/spack/stage/petsc-3.10.2-fqbenzsyao3bpbwpmtupmsykyl365ns6/petsc-3.10.2/\r\n[sajid@xrmlite petsc-3.10.2]$ cat spack-build.env | grep ifort\r\nexport F77=\"/home/sajid/packages/spack/lib/spack/env/intel/ifort\"\r\nexport FC=\"/home/sajid/packages/spack/lib/spack/env/intel/ifort\"\r\nexport SPACK_F77=\"/opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/ifort\"\r\nexport SPACK_FC=\"/opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/ifort\"\r\n[sajid@xrmlite petsc-3.10.2]$ cat spack-build.env | grep icc\r\nexport CC=\"/home/sajid/packages/spack/lib/spack/env/intel/icc\"\r\nexport MPICC=\"/home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-7.3.0/openmpi-3.1.3-tfdsutupnrf4fdceglyl4qo5rrekvb6s/bin/mpicc\"\r\nexport SPACK_CC=\"/opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/icc\"\r\n```\r\nSpack picks up the correct MPICC (from the `openmpi%gcc@7.3.0`) but mixes this with intel compilers (which were never specified). \r\n\r\n### Information on your system\r\n 1. OS : linux-centos7-x86_64\r\n 2. `compilers.yaml`: \r\n```\r\n[sajid@xrmlite ~]$ cd .spack/linux/\r\n[sajid@xrmlite linux]$ cat compilers.yaml \r\ncompilers:\r\n- compiler:\r\n    environment: {}\r\n    extra_rpaths: []\r\n    flags: {}\r\n    modules: []\r\n    operating_system: centos7\r\n    paths:\r\n      cc: /usr/bin/gcc\r\n      cxx: /usr/bin/g++\r\n      f77: /usr/bin/gfortran\r\n      fc: /usr/bin/gfortran\r\n    spec: gcc@4.8.5\r\n    target: x86_64\r\n- compiler:\r\n    environment: {}\r\n    extra_rpaths:\r\n    - /opt/intel/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64\r\n    - /opt/intel/compilers_and_libraries_2018.3.222/linux/compiler/lib/intel64_lin\r\n    - /home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/lib64\r\n    flags:\r\n      cflags: -xcore-avx2 -gcc-name=/home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/gcc\r\n      cxxflags: -xcore-avx2 -gcc-name=/home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/g++\r\n      fflags: -xcore-avx2 --gcc-name=/home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/\r\n    modules:\r\n    - intel18\r\n    operating_system: centos7\r\n    paths:\r\n      cc: /opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/icc\r\n      cxx: /opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/icpc\r\n      f77: /opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/ifort\r\n      fc: /opt/intel/compilers_and_libraries_2018.3.222/linux/bin/intel64/ifort\r\n    spec: intel@18.0.3\r\n    target: x86_64\r\n- compiler:\r\n    environment: {}\r\n    extra_rpaths: []\r\n    flags:\r\n     cflags: -march=haswell\r\n     cxxflags: -march=haswell\r\n    modules: []\r\n    operating_system: centos7\r\n    paths:\r\n      cc: /home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/gcc\r\n      cxx: /home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/g++\r\n      f77: /home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/gfortran\r\n      fc: /home/sajid/packages/spack/opt/spack/linux-centos7-x86_64/gcc-4.8.5/gcc-7.3.0-xyzezhjmbiebkjfoakso464rhfshlkyq/bin/gfortran\r\n    spec: gcc@7.3.0\r\n    target: x86_64\r\n```",
    "user": "s-sajid-ali",
    "url": "https://api.github.com/repos/spack/spack/issues/9839",
    "updated_at": "2019-01-10 00:53:08",
    "created_at": "2018-11-13 22:53:55",
    "closed_at": "2019-01-10 00:51:35",
    "state": "closed",
    "title": "Spack compiler wrapper fails to set the correct CC, mixes MPICC from one compiler with CC from another.",
    "number": 9839,
    "milestone": null,
    "labels": [
        "bug",
        "compilers"
    ],
    "id": 380460518,
    "html_url": "https://github.com/spack/spack/issues/9839",
    "assignees": [],
    "comments": 12
}