{
    "body": "### Steps to reproduce\n\nSpack fails to execute tests (`spack install --test=root <package name>`) if cmake uses autotools make check emulation as described in [cmake wiki](https://gitlab.kitware.com/cmake/community/-/wikis/doc/tutorials/EmulateMakeCheck)\r\n\r\n\r\nGiven the following minimal package.py file : \r\n```python\r\nclass MinimalCmakeMakeCheckGit(CMakePackage):\r\n    \"\"\"A minimal cmake project using autotools make check emulation\"\"\"\r\n\r\n    homepage = \"://github.com/uraoul/minimal_cmake_make_check\"\r\n    git      = \"https://github.com/uraoul/minimal_cmake_make_check.git\"\r\n\r\n    maintainers = ['uraoul']\r\n\r\n    version('main', branch='main')\r\n\r\n    def check(self):\r\n        make('check')\r\n```\r\n\r\n\r\nAnd the following construct in CMakeFiles.txt : \r\n```cmake\r\ncmake_minimum_required(VERSION 3.14)\r\n\r\nproject(cmake_make_check)\r\nadd_executable (foo main.cxx)\r\n\r\ninclude(CTest)\r\nenable_testing()\r\n\r\n# emulate autotools make check\r\n# see https://gitlab.kitware.com/cmake/community/-/wikis/doc/tutorials/EmulateMakeCheck\r\nset(CMAKE_CTEST_COMMAND ctest -T test)\r\nadd_custom_target(check COMMAND ${CMAKE_CTEST_COMMAND})\r\nadd_executable(mytest EXCLUDE_FROM_ALL mytest.cxx)\r\nadd_test(mytest mytest)\r\nadd_dependencies(check mytest)\r\n\r\ninstall(TARGETS foo DESTINATION bin)\r\n```\r\n\r\n`spack install --test=root minimal-cmake-make-check-git`  fails with `make: *** No rule to make target 'check'.  Stop.` (see details below)\r\n\r\nOf course, the `minimal_cmake_make_check` project compiles and runs tests smoothly otherwise with:\r\n\r\n```console\r\n$ git clone https://github.com/uraoul/minimal_cmake_make_check.git\r\n$ cd minimal_cmake_make_check\r\n$ cmake .\r\n$ make\r\n$ make check\r\n```\r\n\r\n\r\n\r\n\r\n\r\n\n\n### Error message\n\n```console\r\nspack install --test=root minimal-cmake-make-check-git\r\n==> Warning: Missing a source id for minimal-cmake-make-check-git@main\r\n[...]\r\n==> Installing minimal-cmake-make-check-git-main-6mltjvlcx66uyidh4ndgdqfdfpunbusl\r\n==> No binary for minimal-cmake-make-check-git-main-6mltjvlcx66uyidh4ndgdqfdfpunbusl found: installing from source\r\n==> minimal-cmake-make-check-git: Executing phase: 'cmake'\r\n==> minimal-cmake-make-check-git: Executing phase: 'build'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j16' 'check'\r\n\r\n1 error found in build log:\r\n     36    make[2]: Leaving directory '/export/TMP/me/spack-stage-minimal-cmake-make-check-git-main-6mltjvlcx66\r\n           uyidh4ndgdqfdfpunbusl/spack-build-6mltjvl'\r\n     37    [100%] Built target foo\r\n     38    make[1]: Leaving directory '/export/TMP/me/spack-stage-minimal-cmake-make-check-git-main-6mltjvlcx66\r\n           uyidh4ndgdqfdfpunbusl/spack-build-6mltjvl'\r\n     39    /home/me/Codes/pleiades-prerequis/spack/opt/spack/linux-debian9-haswell/gcc-10.2.0/cmake-3.18.4-z7ji\r\n           ixhpyzpe4menhbrj3fhe6oxpk4qr/bin/cmake -E cmake_progress_start /export/TMP/me/spack-stage-minimal-cm\r\n           ake-make-check-git-main-6mltjvlcx66uyidh4ndgdqfdfpunbusl/spack-build-6mltjvl/CMakeFiles 0\r\n     40    ==> [2021-09-08-09:21:01.083728] RUN-TESTS: build-time tests [check]\r\n     41    ==> [2021-09-08-09:21:01.084799] 'make' '-j16' 'check'\r\n  >> 42    make: *** No rule to make target 'check'.  Stop.\r\n\r\nSee build log for details:\r\n  /export/TMP/me/spack-stage-minimal-cmake-make-check-git-main-6mltjvlcx66uyidh4ndgdqfdfpunbusl/spack-build-out.txt\r\n```\n\n### Information on your system\n\n```console\r\n* **Spack:** 0.16.2-1-c699e907fc\r\n* **Python:** 3.5.3\r\n* **Platform:** linux-debian9-haswell\r\n ```\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "uraoul",
    "url": "https://api.github.com/repos/spack/spack/issues/25833",
    "updated_at": "2021-09-08 07:40:35",
    "created_at": "2021-09-08 07:40:35",
    "closed_at": "None",
    "state": "open",
    "title": "`make: *** No rule to make target 'check'` with cmake emulating autotools behavior",
    "number": 25833,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 990816510,
    "html_url": "https://github.com/spack/spack/issues/25833",
    "assignees": [],
    "comments": 0
}