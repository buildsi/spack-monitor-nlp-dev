{
    "body": "##### TLDR\r\n\r\nThis PR changes the testing framework from [nose](http://nose.readthedocs.io/en/latest/) to [pytest](http://doc.pytest.org/en/latest/) for the reasons discussed in #2368. \r\n\r\nAdded benefits:\r\n- fixtures fit well the combinatorial problem we will be facing when adding install tests for packages\r\n- using fixtures scope the execution time for tests has been trimmed down to 3-4 minutes \r\n\r\n##### Modifications\r\n\r\n- [x] removed nose from `lib/spack/external/`\r\n- [x] made `spack test` a wrapper around `pytest`\r\n- [x] rewrote all the mocking classes as a set of fixtures\r\n- [x] removed the mocking classes\r\n- [x] ported all the tests that required mocking to pytest syntax\r\n\r\nI left the port of tests that are written as plain `unittest.TestCase` for future PRs: this one is already huge as it is, and tests that just depend on `unittest.TestCase` can be ported one module at a time.\r\n\r\n##### Miscellaneous Notes\r\n\r\n- `pytest` is better run from spack root directory\r\n- `spack test` is just a wrapper around `pytest` that can be used everywhere\r\n- if coverage is needed run `pytest --cov`, as `spack test` will give wrong results (for any other thing the two commands are equivalent)\r\n\r\n\r\n##### Running `spack test` without `pytest`:\r\n```console\r\n$ spack test\r\n==> Error: Install 'pytest' to have the 'spack test' command available\r\n```\r\n\r\n##### Running the entire test suite\r\n```console\r\n$ spack test\r\n=============================================================================================== test session starts ===============================================================================================\r\nplatform linux2 -- Python 2.7.6, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack, inifile: pytest.ini\r\nplugins: cov-2.4.0\r\ncollected 470 items \r\n\r\nlib/spack/spack/test/architecture.py .......\r\n<more output skipped>\r\nlib/spack/spack/test/cmd/uninstall.py .\r\n\r\n============================================================================================ slowest 20 test durations ============================================================================================\r\n4.35s setup    lib/spack/spack/test/database.py::test_005_db_exists\r\n4.19s teardown lib/spack/spack/test/database.py::test_030_db_sanity_from_another_process\r\n3.94s setup    lib/spack/spack/test/cmd/uninstall.py::test_uninstall\r\n3.93s setup    lib/spack/spack/test/cmd/module.py::test_exit_with_failure[failure_args0]\r\n2.45s call     lib/spack/spack/test/python_version.py::PythonVersionTest::test_core_module_compatibility\r\n1.80s call     lib/spack/spack/test/python_version.py::PythonVersionTest::test_package_module_compatibility\r\n1.03s call     lib/spack/spack/test/mirror.py::TestMirror::test_all_mirror\r\n0.84s call     lib/spack/spack/test/spec_yaml.py::test_ordered_read_not_required_for_consistent_dag_hash\r\n0.79s call     lib/spack/spack/test/directory_layout.py::test_read_and_write_spec\r\n0.76s call     lib/spack/spack/test/lock.py::LockTest::test_complex_acquire_and_release_chain\r\n0.71s call     lib/spack/spack/test/modules.py::TestTcl::test_autoload\r\n0.61s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize_with_restricted_virtual\r\n0.54s call     lib/spack/spack/test/database.py::test_025_reindex\r\n0.42s call     lib/spack/spack/test/architecture.py::test_user_input_combination\r\n0.42s call     lib/spack/spack/test/modules.py::TestTcl::test_prerequisites\r\n0.42s setup    lib/spack/spack/test/hg_fetch.py::test_fetch[default]\r\n0.38s call     lib/spack/spack/test/install.py::test_store\r\n0.37s setup    lib/spack/spack/test/mirror.py::TestMirror::test_svn_mirror\r\n0.36s call     lib/spack/spack/test/modules.py::TestLmod::test_autoload\r\n0.35s call     lib/spack/spack/test/modules.py::TestTcl::test_blacklist\r\n=========================================================================================== 470 passed in 50.75 seconds ===========================================================================================\r\n```\r\n\r\n##### Run a few tests selectively\r\n```console\r\n$ spack test -k 'spec_dag or concretize'\r\n=============================================================================================== test session starts ===============================================================================================\r\nplatform linux2 -- Python 2.7.6, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack, inifile: pytest.ini\r\nplugins: cov-2.4.0\r\ncollected 470 items \r\n\r\nlib/spack/spack/test/concretize.py ...........................................\r\nlib/spack/spack/test/concretize_preferences.py .....\r\nlib/spack/spack/test/spec_dag.py .............................\r\n\r\n============================================================================================ slowest 20 test durations ============================================================================================\r\n0.65s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize_with_restricted_virtual\r\n0.42s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_compilers\r\n0.30s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_variants\r\n0.28s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal\r\n0.28s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal_run\r\n0.25s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal_full\r\n0.24s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_providers\r\n0.24s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_copy_concretized\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_preorder_edge_traversal\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_postorder_edge_traversal\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_preorder_node_traversal\r\n0.21s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_deptype_traversal_with_builddeps\r\n0.20s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_normalize_twice\r\n0.19s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_preorder_path_traversal\r\n0.18s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize_link_dep_of_build_dep\r\n0.18s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_postorder_node_traversal\r\n0.18s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_postorder_path_traversal\r\n0.17s call     lib/spack/spack/test/concretize.py::TestConcretize::test_concretize[callpath]\r\n0.16s call     lib/spack/spack/test/concretize_preferences.py::TestConcretizePreferences::test_preferred_versions\r\n0.15s call     lib/spack/spack/test/spec_dag.py::TestSpecDag::test_normalize_mpileaks\r\n============================================================================================== 393 tests deselected ===============================================================================================\r\n==================================================================================== 77 passed, 393 deselected in 8.46 seconds ====================================================================================\r\n```\r\n\r\n##### Show the setup plan for a set of tests\r\n```console\r\n$ spack test -k test_05 --setup-plan\r\n=============================================================================================== test session starts ===============================================================================================\r\nplatform linux2 -- Python 2.7.6, pytest-3.0.5, py-1.4.32, pluggy-0.4.0\r\nrootdir: /home/mculpo/PycharmProjects/spack, inifile: pytest.ini\r\nplugins: cov-2.4.0\r\ncollected 470 items \r\n\r\nlib/spack/spack/test/database.py \r\n      SETUP    F monkeypatch\r\n      SETUP    F mock_fetch_cache (fixtures used: monkeypatch)\r\n      SETUP    F no_stdin_duplication (fixtures used: monkeypatch)\r\nSETUP    S tmpdir_factory\r\nSETUP    S repo_path\r\n  SETUP    M builtin_mock (fixtures used: repo_path)\r\nSETUP    S linux_os\r\nSETUP    S configuration_dir (fixtures used: linux_os, tmpdir_factory)\r\n  SETUP    M config (fixtures used: configuration_dir)\r\n  SETUP    M database (fixtures used: builtin_mock, config, tmpdir_factory)\r\n        lib/spack/spack/test/database.py::test_050_basic_query (fixtures used: builtin_mock, config, configuration_dir, database, linux_os, mock_fetch_cache, monkeypatch, no_stdin_duplication, repo_path, tmpdir_factory)\r\n      TEARDOWN F no_stdin_duplication\r\n      TEARDOWN F mock_fetch_cache\r\n      TEARDOWN F monkeypatch\r\n  TEARDOWN M database\r\n  TEARDOWN M config\r\n  TEARDOWN M builtin_mock\r\nTEARDOWN S configuration_dir\r\nTEARDOWN S linux_os\r\nTEARDOWN S repo_path\r\nTEARDOWN S tmpdir_factory\r\n\r\n============================================================================================ slowest 20 test durations ============================================================================================\r\n0.00s setup    lib/spack/spack/test/database.py::test_050_basic_query\r\n0.00s teardown lib/spack/spack/test/database.py::test_050_basic_query\r\n============================================================================================== 469 tests deselected ===============================================================================================\r\n========================================================================================= 469 deselected in 0.50 seconds ==========================================================================================\r\n```\r\n\r\n##### Getting help on the ton of options that are not above\r\n```console\r\n$ spack test -h\r\n...\r\n```\r\n\r\n\r\n",
    "user": "alalazo",
    "url": "https://api.github.com/repos/spack/spack/issues/2502",
    "updated_at": "2016-12-29 21:56:02",
    "created_at": "2016-12-07 12:32:34",
    "closed_at": "2016-12-29 15:48:49",
    "state": "closed",
    "title": "unit tests: replace nose with pytest ",
    "number": 2502,
    "milestone": null,
    "labels": [
        "ready",
        "external-packages",
        "refactoring",
        "tests"
    ],
    "id": 194037853,
    "html_url": "https://github.com/spack/spack/pull/2502",
    "assignees": [
        "tgamblin"
    ],
    "comments": 25
}