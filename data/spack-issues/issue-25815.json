{
    "body": "### Steps to reproduce\r\n\r\nHi I have installed and loaded singularity successfully\r\n```bash\r\n$ spack install singularity@3.8.1\r\n$ which singularity\r\n/tmp/envs/spack1/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/singularity-3.8.1-yvuhkankhgat6qx6sza3zdkj6lwi2u2i/bin/singularity\r\n$ which newuidmap\r\n/tmp/envs/spack1/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/shadow-4.8.1-ik7hpk7czh6m6c7mriode56n4q4uw2pd/bin/newuidmap\r\n```\r\n\r\nI have a `.def` file which I can correctly build as the root user:\r\n```bash\r\nsingularity -d build myenv_centos_default.sif myenv_centos_default.def\r\n```\r\n\r\n### Error message\r\n\r\nHowever, I get the following error when I try to build the `.sif` file in a rootless way:\r\n```bash\r\n$ singularity -d build --fakeroot myenv_centos_default.sif myenv_centos_default.def\r\nDEBUG   [U=1000,P=430915]  persistentPreRun()            Singularity version: 3.8.1\r\nDEBUG   [U=1000,P=430915]  persistentPreRun()            Parsing configuration file /tmp/envs/spack1/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/singularity-3.8.1-yvuhkankhgat6qx6sza3zdkj6lwi2u2i/etc/singularity/singularity.conf\r\nDEBUG   [U=1000,P=430915]  handleConfDir()               /home/ubuntu/.singularity already exists. Not creating.\r\nDEBUG   [U=1000,P=430915]  init()                        Use starter binary /tmp/envs/spack1/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/singularity-3.8.1-yvuhkankhgat6qx6sza3zdkj6lwi2u2i/libexec/singularity/bin/starter-suid\r\nVERBOSE [U=1000,P=430915]  print()                       Set messagelevel to: 5\r\nVERBOSE [U=1000,P=430915]  init()                        Starter initialization\r\nVERBOSE [U=1000,P=430915]  is_suid()                     Check if we are running as setuid\r\nDEBUG   [U=1000,P=430915]  read_engine_config()          Read engine configuration\r\nDEBUG   [U=1000,P=430915]  init()                        Wait completion of stage1\r\nDEBUG   [U=1000,P=430927]  set_parent_death_signal()     Set parent death signal to 9\r\nVERBOSE [U=1000,P=430927]  init()                        Spawn stage 1\r\nDEBUG   [U=1000,P=430927]  startup()                     fakeroot runtime engine selected\r\nVERBOSE [U=1000,P=430927]  startup()                     Execute stage 1\r\nDEBUG   [U=1000,P=430927]  StageOne()                    Entering stage 1\r\nVERBOSE [U=1000,P=430927]  PrepareConfig()               Fakeroot requested with unprivileged workflow, fallback to newuidmap/newgidmap\r\nDEBUG   [U=1000,P=430927]  PrepareConfig()               Search for newuidmap binary\r\nFATAL   [U=1000,P=430927]  StageOne()                    newuidmap was not found in PATH (/usr/bin:/usr/sbin:/bin:/sbin:/usr/local/bin:/usr/local/sbin), required with fakeroot and unprivileged installation\r\nVERBOSE [U=1000,P=430915]  wait_child()                  stage 1 exited with status 255\r\n```\r\nThe cause seems to be the unability of singularity to detect the `newuidmap` command. However, it is reachable and found from the shell:\r\n```bash\r\n$ which newuidmap\r\n/tmp/envs/spack1/opt/spack/linux-ubuntu20.04-skylake/gcc-9.3.0/shadow-4.8.1-ik7hpk7czh6m6c7mriode56n4q4uw2pd/bin/newuidmap\r\n```\r\n\r\n### Information on your system\r\n\r\n```bash\r\n$ spack debug report\r\n* **Spack:** 0.16.2-4165-c424b86a64\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-skylake\r\n* **Concretizer:** original\r\n```\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output\r\n\r\nEDIT: I have also obtained the same results with `singularity@master`.",
    "user": "jacorvar",
    "url": "https://api.github.com/repos/spack/spack/issues/25815",
    "updated_at": "2021-09-10 09:59:45",
    "created_at": "2021-09-07 09:13:05",
    "closed_at": "2021-09-10 09:59:44",
    "state": "closed",
    "title": "singularity 3.8.1 lacks `--fakeroot` support ",
    "number": 25815,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 989769299,
    "html_url": "https://github.com/spack/spack/issues/25815",
    "assignees": [],
    "comments": 2
}