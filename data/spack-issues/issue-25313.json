{
    "body": "### Steps to reproduce\r\n\r\nurllib is the default url retriever for http and https protocol, however, it is not possible to retrieve any packages using `spack -k` (disabling SSL verification) with urllib (bug introduced by deleting `context` ). There is a bug in lib/spack/spack/util/web.py because it cannot behave properly with the `-k` flag for Spack.\r\n\r\nPlease examine lib/spack/spack/util/web.py:\r\n\r\n- Note that `context` is removed from kwargs for all calls to `_urlopen` in order to be backwards compatible with urllib on line 514 (urrlib functionality varies from version of Python to version of Python, with a comment on line 511)\r\n- `context` is needed in kwargs if VerifyMode.CERT_NONE is set (which will be the case if `spack -k` is used) otherwise `opener(req,...)` will have a failed to verify SSL error (reference line 108).\r\n\r\nThis combination of setting a context and then intentionally removing it means that `spack -k` will fail to work as intended for http and https protocol.\r\n\r\nReproduction:\r\n- Be on a machine where SSL verification will fail (behind a proxy is a good place to start), use the `-k` flag with Spack to see that all packages using the `git` protocol fetch and succeed. Try to install `cmake` as an example with `spack -k install cmake` and the fetcher will fail. \r\n\r\nThis relates to issue #25254 and is due to switching from curl as default to urllib\r\n\r\n\r\n### Error message\r\n\r\n```==> [2021-08-09-07:04:22.649134] FailedDownloadError: Failed to fetch file from URL: https://mirror.spack.io/_source-cache/archive/fa/fac3915171d4dff25913975d712f76e69aef44bf738ba7b976793a458b4cfed4.tar.gz\r\n    Urllib fetch failed to verify url https://mirror.spack.io/_source-cache/archive/fa/fac3915171d4dff25913975d712f76e69aef44bf738ba7b976793a458b4cfed4.tar.gz\r\n==> [2021-08-09-07:04:22.652664] Checking existence of https://mirror.spack.io/cmake/cmake-3.21.1.tar.gz\r\nurllib\r\nhttps://mirror.spack.io/cmake/cmake-3.21.1.tar.gz\r\nhere2\r\n==> [2021-08-09-07:05:02.750286] FailedDownloadError: Failed to fetch file from URL: https://mirror.spack.io/cmake/cmake-3.21.1.tar.gz\r\n    Urllib fetch failed to verify url https://mirror.spack.io/cmake/cmake-3.21.1.tar.gz\r\n==> [2021-08-09-07:05:02.753044] Checking existence of https://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1.tar.gz\r\nurllib\r\nhttps://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1.tar.gz\r\nhere2\r\n==> [2021-08-09-07:05:12.813018] FailedDownloadError: Failed to fetch file from URL: https://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1.tar.gz\r\n    Urllib fetch failed to verify url https://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1.tar.gz\r\n==> [2021-08-09-07:05:12.816336] Fetching from https://mirror.spack.io/_source-cache/archive/fa/fac3915171d4dff25913975d712f76e69aef44bf738ba7b976793a458b4cfed4.tar.gz failed.\r\n==> [2021-08-09-07:05:12.817188] Fetching from https://mirror.spack.io/cmake/cmake-3.21.1.tar.gz failed.\r\n==> [2021-08-09-07:05:12.817991] Fetching from https://github.com/Kitware/CMake/releases/download/v3.21.1/cmake-3.21.1.tar.gz failed.\r\n==> [2021-08-09-07:05:12.832977] Error: FetchError: All fetchers failed\r\n\r\n/Users/pakuber/test_spack_xyce/spack/lib/spack/spack/package.py:1379, in do_fetch:\r\n       1376\r\n       1377        self.stage.create()\r\n       1378        err_msg = None if not self.manual_download else self.download_instr\r\n  >>   1379        start_time = time.time()\r\n       1380        self.stage.fetch(mirror_only, err_msg=err_msg)\r\n       1381        self._fetch_time = time.time() - start_time\r\n       1382\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.2-3864-a3f76740e7\r\n* **Python:** 3.7.8\r\n* **Platform:** darwin-catalina-skylake\r\n* **Concretizer:** original\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "kuberry",
    "url": "https://api.github.com/repos/spack/spack/issues/25313",
    "updated_at": "2021-08-26 20:51:09",
    "created_at": "2021-08-09 13:08:22",
    "closed_at": "2021-08-26 20:51:09",
    "state": "closed",
    "title": "_urlopen purges 'context' from request, causing SSL no-verify to be ignored (spack -k)",
    "number": 25313,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 963978376,
    "html_url": "https://github.com/spack/spack/issues/25313",
    "assignees": [],
    "comments": 0
}