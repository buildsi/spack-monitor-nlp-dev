{
    "body": "### Steps to reproduce\n\nThere are quite a few open clingo related issues so this may have already been reported.\r\n\r\nI can not build llvm-12 so I set llvm in `$spack/etc/packages.yaml`\r\n```\r\npackages:\r\n...\r\n  llvm:\r\n    version: [11.1.0]\r\n...\r\n```\r\nThat is not honored when concretizing.\r\n```console\r\n$ spack spec mesa | grep llvm\r\nmesa@21.2.3%gcc@9.4.0+glx+llvm+opengl~opengles+osmesa~strip buildtype=debugoptimized default_library=shared swr=auto arch=linux-centos7-x86_64\r\n    ^llvm@12.0.1%gcc@9.4.0~all_targets+clang~code_signing+compiler-rt~cuda~flang+gold+internal_unwind~ipo+libcxx+lld+lldb~llvm_dylib~mlir+omp_as_runtime~omp_debug~omp_tsan+polly~python~shared_libs~split_dwarf build_type=Release cuda_arch=none arch=linux-centos7-x86_64\r\n```\r\nThere is no indication as to why it is overriding my constraint. What it really should print is why it can not satisfy the constraint. If I switch the concretizer to \"original\" I can see what is wrong.\r\n```console\r\n$ spack spec mesa | grep llvm\r\n==> Warning: the original concretizer is currently being used.\r\n        Upgrade to \"clingo\" at your earliest convenience. The original concretizer will be removed from Spack starting at v0.18.0\r\n==> Error: Conflicts in concretized spec \"mesa@21.2.3%gcc@9.4.0+glx+llvm+opengl~opengles+osmesa~strip buildtype=debugoptimized default_library=shared swr=auto arch=linux-centos7-x86_64/wdggfum\"\r\n\r\nList of matching conflicts for spec:\r\n\r\n    llvm@11.1.0%gcc@9.4.0~all_targets+clang~code_signing+compiler-rt~cuda~flang+gold+internal_unwind~ipo+libcxx+lld+lldb~llvm_dylib~mlir+omp_as_runtime~omp_debug~omp_tsan+polly~python~shared_libs~split_dwarf build_type=Release cuda_arch=none patches=6811ad441aa0221fb6f519550e7fc75a69a84998d44c1bea6d507605213c769c arch=linux-centos7-x86_64\r\n        ^binutils@2.37%gcc@9.4.0~gas+gold~headers~interwork+ld~libiberty~lto+nls+plugins libs=shared,static arch=linux-centos7-x86_64\r\n            ^diffutils@3.8%gcc@9.4.0 arch=linux-centos7-x86_64\r\n            ^gettext@0.21%gcc@9.4.0+bzip2+curses+git~libunistring+libxml2+tar+xz arch=linux-centos7-x86_64\r\n                ^bzip2@1.0.8%gcc@9.4.0~debug~pic+shared arch=linux-centos7-x86_64\r\n                ^libiconv@1.16%gcc@9.4.0 libs=shared,static arch=linux-centos7-x86_64\r\n                ^libxml2@2.9.12%gcc@9.4.0~python arch=linux-centos7-x86_64\r\n                    ^pkgconf@1.8.0%gcc@9.4.0 arch=linux-centos7-x86_64\r\n                    ^xz@5.2.5%gcc@9.4.0~pic libs=shared,static arch=linux-centos7-x86_64\r\n                    ^zlib@1.2.11%gcc@9.4.0+optimize+pic+shared arch=linux-centos7-x86_64\r\n                ^ncurses@6.2.20210619%gcc@9.4.0+symlinks+termlib abi=6 arch=linux-centos7-x86_64\r\n                ^tar@1.34%gcc@9.4.0 arch=linux-centos7-x86_64\r\n        ^cmake@3.21.3%gcc@9.4.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-centos7-x86_64\r\n        ^hwloc@2.5.0%gcc@9.4.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml~opencl+pci~rocm+shared arch=linux-centos7-x86_64\r\n            ^libpciaccess@0.16%gcc@9.4.0 arch=linux-centos7-x86_64\r\n                ^libtool@2.4.6%gcc@9.4.0 arch=linux-centos7-x86_64\r\n                ^util-macros@1.19.3%gcc@9.4.0 arch=linux-centos7-x86_64\r\n        ^libedit@3.1-20210216%gcc@9.4.0 arch=linux-centos7-x86_64\r\n        ^perl-data-dumper@2.173%gcc@9.4.0 arch=linux-centos7-x86_64\r\n            ^perl@5.34.0%gcc@9.4.0+cpanm+shared~threads arch=linux-centos7-x86_64\r\n        ^python@3.9.7%gcc@9.4.0+bz2+ctypes+dbm~debug+libxml2+lzma~nis~optimizations+pic+pyexpat+pythoncmd+readline+shared+sqlite3+ssl~tix~tkinter~ucs4+uuid+zlib patches=0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87,4c2457325f2b608b1b6a2c63087df8c26e07db3e3d493caf36a56f0ecf6fb768,f2fd060afc4b4618fe8104c4c5d771f36dc55b1db5a4623785a4ea707ec72fb4 arch=linux-centos7-x86_64\r\n        ^swig@4.0.2%gcc@9.4.0 arch=linux-centos7-x86_64\r\n            ^pcre@8.44%gcc@9.4.0~jit+multibyte+utf arch=linux-centos7-x86_64\r\n        ^z3@4.8.9%gcc@9.4.0~gmp~ipo~python build_type=RelWithDebInfo arch=linux-centos7-x86_64\r\n\r\n1. \"+omp_as_runtime\" conflicts with \"llvm@:11.1\" [omp_as_runtime works since LLVM 12.]\r\n```\r\nIf I then set `~omp_as_runtime` as an llvm variant then the clingo spec is correct.\r\n```console\r\n$ spack spec mesa | grep llvm\r\nmesa@21.2.3%gcc@9.4.0+glx+llvm+opengl~opengles+osmesa~strip buildtype=debugoptimized default_library=shared swr=auto arch=linux-centos7-x86_64\r\n    ^llvm@11.1.0%gcc@9.4.0~all_targets+clang~code_signing+compiler-rt~cuda~flang+gold+internal_unwind~ipo+libcxx+lld+lldb~llvm_dylib~mlir~omp_as_runtime~omp_debug~omp_tsan+polly~python~shared_libs~split_dwarf build_type=Release cuda_arch=none patches=6811ad441aa0221fb6f519550e7fc75a69a84998d44c1bea6d507605213c769c arch=linux-centos7-x86_64\r\n```\r\nSo, the constraint is not honored. The constraint should be honored and a message given as to why the spec fails.\n\n### Error message\n\nThis looks like the relevant information with the `--debug` option.\r\n```console\r\n$ spack --debug spec mesa\r\n==> [2021-10-30-04:15:26.960360] opt_criterion(16, deprecated versions used)\r\n==> [2021-10-30-04:15:26.960475] opt_criterion(15, version weight)\r\n==> [2021-10-30-04:15:26.960503] opt_criterion(14, number of non-default variants (roots))\r\n==> [2021-10-30-04:15:26.960526] opt_criterion(13, preferred providers for roots)\r\n==> [2021-10-30-04:15:26.960547] opt_criterion(12, number of values in multi valued variants (root))\r\n==> [2021-10-30-04:15:26.960568] opt_criterion(11, number of non-default variants (non-roots))\r\n==> [2021-10-30-04:15:26.960589] opt_criterion(9, preferred providers (non-roots))\r\n==> [2021-10-30-04:15:26.960610] opt_criterion(8, compiler mismatches)\r\n==> [2021-10-30-04:15:26.960630] opt_criterion(7, version badness)\r\n==> [2021-10-30-04:15:26.960650] opt_criterion(6, number of values in multi valued variants (non-root))\r\n==> [2021-10-30-04:15:26.960671] opt_criterion(5, non-preferred compilers)\r\n==> [2021-10-30-04:15:26.960691] opt_criterion(4, target mismatches)\r\n==> [2021-10-30-04:15:26.960711] opt_criterion(3, non-preferred targets)\r\n==> [2021-10-30-04:15:26.970739] Ordered hashes [flex]: flex/151/09c22e5c6fef327d3e48eb23f0d610dcd3a35ab9207f12e0f875701c677978d3\r\n==> [2021-10-30-04:15:26.971333] Ordered hashes [python]: python/27/0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87, python/28/f2fd060afc4b4618fe8104c4c5d771f36dc55b1db5a4623785a4ea707ec72fb4, python/30/4c2457325f2b608b1b6a2c63087df8c26e07db3e3d493caf36a56f0ecf6fb768\r\n==> [2021-10-30-04:15:26.971451] Ordered hashes [meson]: meson/21/aa6c50d5a2aeb1a487d16f6712be4357fefb923aae37ab830699b07338388287\r\n```\n\n### Information on your system\n\n* **Spack:** 0.16.3-5118-c38d3044fa\r\n* **Python:** 3.9.7\r\n* **Platform:** linux-centos7-cascadelake\r\n* **Concretizer:** clingo\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "glennpj",
    "url": "https://api.github.com/repos/spack/spack/issues/27085",
    "updated_at": "2021-11-02 17:12:28",
    "created_at": "2021-10-30 04:19:10",
    "closed_at": "None",
    "state": "open",
    "title": "clingo concretizer not honoring version specs",
    "number": 27085,
    "milestone": null,
    "labels": [
        "bug",
        "concretization",
        "triage"
    ],
    "id": 1040045370,
    "html_url": "https://github.com/spack/spack/issues/27085",
    "assignees": [
        "alalazo"
    ],
    "comments": 5
}