{
    "body": "Hello,\r\n\r\nWhen I set the modules projections, \"{architecture}\" seems hard coded at the beginning of the path and \"-{hash}\" at the end.\r\nI would like a path like this:\r\n\r\n```\r\n${HOME}/products/zlib-1.2.11/linux-centos7-haswell/j7b7tbjytsg6yfwe2vicshv4zygmidid\r\n${HOME}/modules/zlib-1.2.11/linux-centos7-haswell/j7b7tbjytsg6yfwe2vicshv4zygmidid\r\n```\r\n\r\n### Steps to reproduce the issue\r\n\r\nFirst, this is my file to reproduce:\r\n```console\r\n$ cat << EOF > spack.yaml\r\nspack:\r\n\r\n  config:\r\n    install_tree:\r\n      root: \"${HOME}/products\"\r\n      projections:\r\n        all: \"${PACKAGE}-${VERSION}/${ARCHITECTURE}/${COMPILERNAME}-${COMPILERVER}/${HASH}\"\r\n    module_roots:\r\n      tcl: \"${HOME}/modules\"\r\n    shared_linking: 'rpath'\r\n\r\n  modules:\r\n    tcl:\r\n      hash_length: 32\r\n      projections:\r\n        all: '{name}-{version}/{architecture}/{compiler.name}-{compiler.version}/'\r\n\r\n  view: false\r\n\r\n  specs:\r\n  - zlib\r\nEOF\r\n```\r\n\r\nThen, let's install this env:\r\n\r\n```console\r\n$ spack env create reproducer ./spack.yaml\r\n$ spack -e reproducer install\r\n```\r\nFinally, check products and modules paths:\r\n\r\n```console\r\n$ [ -e ${HOME}/products/zlib-1.2.11/linux-centos7-haswell/gcc-4.8.5/pkmj6e72vggig3epxjcwxgzmxncaqnmp ] ; echo $?\r\n0\r\n$ [ -e ${HOME}/modules/zlib-1.2.11/linux-centos7-haswell/gcc-4.8.5/pkmj6e72vggig3epxjcwxgzmxncaqnmp ] ; echo $?\r\n1\r\n```\r\nAs describe in spack.yaml, modules and products must have the same path (except at root) but instead there is the module path:\r\n\r\n```console\r\n$ [ -e ${HOME}/modules/linux-centos7-haswell/zlib-1.2.11/linux-centos7-haswell/gcc-4.8.5/-pkmj6e72vggig3epxjcwxgzmxncaqnmp ] ; echo $?\r\n0\r\n```\r\nThere are `linux-centos7-haswell/` as prefix and `-pkmj6e72vggig3epxjcwxgzmxncaqnmp` as suffix (I don't if it's clear but there is a \"-\" that I don't want).\r\n\r\n### Information on your system\r\n\r\n<!-- Please include the output of `spack debug report` -->\r\nspack debug report\r\n```\r\n* **Spack:** 0.16.0-406-8f9297071\r\n* **Python:** 2.7.5\r\n* **Platform:** linux-centos7-haswell\r\n* **Concretizer:** original\r\n```\r\n\r\nspack.yaml\r\n```\r\nspack:\r\n\r\n  config:\r\n    install_tree:\r\n      root: \"${HOME}/products\"\r\n      projections:\r\n        all: \"${PACKAGE}-${VERSION}/${ARCHITECTURE}/${COMPILERNAME}-${COMPILERVER}/${HASH}\"\r\n    module_roots:\r\n      tcl: \"${HOME}/modules\"\r\n    shared_linking: 'rpath'\r\n\r\n  modules:\r\n    tcl:\r\n      hash_length: 32\r\n      projections:\r\n        all: '{name}-{version}/{architecture}/{compiler.name}-{compiler.version}/'\r\n\r\n  view: false\r\n\r\n  specs:\r\n  - zlib\r\n```\r\n\r\n### Additional information\r\n\r\nMaybe this is not a bug but a feature, I don't know.\r\nBut this (very ugly) patch did the job to fix my problem:\r\n```\r\ndiff --git a/lib/spack/spack/modules/common.py b/lib/spack/spack/modules/common.py\r\nindex fb688e4f1..4e254b409 100644\r\n--- a/lib/spack/spack/modules/common.py\r\n+++ b/lib/spack/spack/modules/common.py\r\n@@ -573,7 +573,7 @@ def use_name(self):\r\n         name = os.path.join(*parts)\r\n         # Add optional suffixes based on constraints\r\n         path_elements = [name] + self.conf.suffixes\r\n-        return '-'.join(path_elements)\r\n+        return ''.join(path_elements)\r\n \r\n     @property\r\n     def filename(self):\r\n@@ -583,7 +583,7 @@ def filename(self):\r\n         if self.extension:\r\n             filename = '{0}.{1}'.format(self.use_name, self.extension)\r\n         # Architecture sub-folder\r\n-        arch_folder = str(self.spec.architecture)\r\n+        arch_folder = \"\"\r\n         # Return the absolute path\r\n         return os.path.join(self.dirname(), arch_folder, filename)\r\n\r\n```\r\n\r\nMany thanks,\r\nAdrien",
    "user": "adrien-cotte",
    "url": "https://api.github.com/repos/spack/spack/issues/20605",
    "updated_at": "2020-12-29 16:14:59",
    "created_at": "2020-12-29 16:12:20",
    "closed_at": "None",
    "state": "open",
    "title": "Modules optional arch folder and hash suffix",
    "number": 20605,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 775971156,
    "html_url": "https://github.com/spack/spack/issues/20605",
    "assignees": [],
    "comments": 0
}