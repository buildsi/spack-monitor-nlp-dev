{
    "body": "### Steps to reproduce\r\n\r\nThis happened in a commit sometime in January 14 or early 15.\r\n\r\n```console\r\n$ git clone https://github.com/mochi-hpc/mochi-spack-packages.git\r\n$ spack env create myenv\r\n$ spack env activate myenv\r\n$ spack repo add mochi-spack-packages\r\n$ spack add mochi-mona\r\n$ spack install\r\n```\r\n\r\n### Error message\r\n\r\n```\r\n==> Error: 'NoneType' object has no attribute 'copy'\r\n```\r\n\r\nWith --debug:\r\n\r\n```\r\n...\r\n==> [2022-01-15-08:05:57.566504] Reading config file /home/mdorier/mochi-ci/spack/etc/spack/defaults/config.yaml\r\n==> [2022-01-15-08:05:57.614363] Reading config file /home/mdorier/mochi-ci/spack/var/spack/environments/myenv/spack.yaml\r\n==> [2022-01-15-08:05:57.620534] Using environment 'myenv'\r\n==> [2022-01-15-08:05:57.621268] Reading config file /home/mdorier/mochi-ci/spack/etc/spack/defaults/repos.yaml\r\nTraceback (most recent call last):\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/package.py\", line 311, in _flush_callbacks\r\n    phase = attr_dict[phase_attr]\r\nKeyError: '_InstallPhase_build'\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/home/mdorier/mochi-ci/spack/bin/spack\", line 98, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/main.py\", line 900, in main\r\n    return _main(argv)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/main.py\", line 883, in _main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/main.py\", line 553, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/cmd/install.py\", line 342, in install\r\n    concretized_specs = env.concretize(tests=tests, reuse=args.reuse)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/environment/environment.py\", line 1118, in concretize\r\n    return self._concretize_separately(tests=tests, reuse=reuse)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/environment/environment.py\", line 1200, in _concretize_separately\r\n    _ = spack.repo.path.provider_index\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/llnl/util/lang.py\", line 786, in __getattr__\r\n    return getattr(self.instance, name)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 529, in provider_index\r\n    self._provider_index.merge(repo.provider_index)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 953, in provider_index\r\n    return self.index['providers']\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 359, in __getitem__\r\n    self._build_all_indexes()\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 374, in _build_all_indexes\r\n    self.indexes[name] = self._build_index(name, indexer)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 404, in _build_index\r\n    indexer.update(namespaced_name)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 286, in update\r\n    if spack.repo.path.is_virtual(name, use_index=False):\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 684, in is_virtual\r\n    self.get_pkg_class(pkg_name).virtual)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 647, in get_pkg_class\r\n    return self.repo_for_pkg(pkg_name).get_pkg_class(pkg_name)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 1107, in get_pkg_class\r\n    module = self._get_pkg_module(pkg_name)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/repo.py\", line 1080, in _get_pkg_module\r\n    prepend=_package_prepend)\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/util/imp/importlib_importer.py\", line 48, in load_source\r\n    return loader.load_module()\r\n  File \"<frozen importlib._bootstrap_external>\", line 399, in _check_name_wrapper\r\n  File \"<frozen importlib._bootstrap_external>\", line 823, in load_module\r\n  File \"<frozen importlib._bootstrap_external>\", line 682, in load_module\r\n  File \"<frozen importlib._bootstrap>\", line 265, in _load_module_shim\r\n  File \"<frozen importlib._bootstrap>\", line 684, in _load\r\n  File \"<frozen importlib._bootstrap>\", line 665, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 678, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 219, in _call_with_frames_removed\r\n  File \"/home/mdorier/mochi-ci/mochi-spack-packages/packages/flamestore/package.py\", line 11, in <module>\r\n    \"\"\"Transient distributed object store for deep learning\"\"\"\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/package.py\", line 326, in __new__\r\n    _flush_callbacks('run_before')\r\n  File \"/home/mdorier/mochi-ci/spack/lib/spack/spack/package.py\", line 321, in _flush_callbacks\r\n    phase = attr_dict[phase_attr] = phase.copy()\r\nAttributeError: 'NoneType' object has no attribute 'copy'\r\n```\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.1-840-3f903c49e4\r\n* **Python:** 3.6.9\r\n* **Platform:** linux-ubuntu18.04-sandybridge\r\n* **Concretizer:** clingo\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "mdorier",
    "url": "https://api.github.com/repos/spack/spack/issues/28429",
    "updated_at": "2022-01-15 19:09:50",
    "created_at": "2022-01-15 14:06:28",
    "closed_at": "2022-01-15 19:09:50",
    "state": "closed",
    "title": "Cannot add external repo to an environment anymore (spack install fails)",
    "number": 28429,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1104728975,
    "html_url": "https://github.com/spack/spack/issues/28429",
    "assignees": [
        "adamjstewart"
    ],
    "comments": 0
}