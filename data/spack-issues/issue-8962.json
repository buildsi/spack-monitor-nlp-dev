{
    "body": "\r\n## Summary\r\nI've installed community edition of PGI 18.4 on my system, and spack successfully picks up PGI compilers as an option. I've attempted to install HDF5 with the following command\r\n```console\r\n$ spack install hdf5%pgi@18.4 +fortran -mpi\r\n```\r\n\r\n### Expected Result\r\n\r\nSerial HDF5 should have been installed with ability to work with PGI compiled Fortran applications\r\n\r\n### Actual Result\r\nDuring the make stage, the build fails with\r\n```\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j8'\r\n\r\n8 errors found in build log:\r\n     618    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #1 (H5system.c: 1072)\r\n     619    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5system.c: 1078)\r\n     620    PGC-W-0095-Type cast required for this conversion (H5system.c: 1089\r\n            )\r\n     621    PGC-W-0155-Pointer value created from a nonlong integral type  (H5s\r\n            ystem.c: 1089)\r\n     622    PGC/x86-64 Linux 18.4-0: compilation completed with severe errors\r\n     623    Makefile:1434: recipe for target 'H5timer.lo' failed\r\n  >> 624    make[2]: *** [H5timer.lo] Error 1\r\n     625    make[2]: *** Waiting for unfinished jobs....\r\n     626    Makefile:1434: recipe for target 'H5system.lo' failed\r\n  >> 627    make[2]: *** [H5system.lo] Error 1\r\n     628    PGC-I-0222-Redundant definition for symbol __extension__ (/usr/incl\r\n            ude/x86_64-linux-gnu/sys/cdefs.h: 358)\r\n     629    PGC-S-0039-Use of undeclared variable CHAR_BIT (./H5VMprivate.h: 46\r\n            4)\r\n     630    PGC-S-0039-Use of undeclared variable CHAR_BIT (./H5VMprivate.h: 46\r\n            4)\r\n     631    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5.c: 158)\r\n     632    PGC-W-0095-Type cast required for this conversion (H5.c: 231)\r\n     633    PGC-W-0155-Pointer value created from a nonlong integral type  (H5.\r\n            c: 231)\r\n\r\n     ...\r\n\r\n     639    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5.c: 799)\r\n     640    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5Abtree2.c: 482)\r\n     641    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5Abtree2.c: 512)\r\n     642    PGC/x86-64 Linux 18.4-0: compilation completed with severe errors\r\n     643    PGC/x86-64 Linux 18.4-0: compilation completed with severe errors\r\n     644    Makefile:1434: recipe for target 'H5Abtree2.lo' failed\r\n  >> 645    make[2]: *** [H5Abtree2.lo] Error 1\r\n     646    Makefile:1434: recipe for target 'H5.lo' failed\r\n  >> 647    make[2]: *** [H5.lo] Error 1\r\n     648    PGC-S-0039-Use of undeclared variable CHAR_BIT (./H5VMprivate.h: 46\r\n            4)\r\n     649    PGC-S-0039-Use of undeclared variable CHAR_BIT (./H5VMprivate.h: 46\r\n            4)\r\n     650    PGC-S-0039-Use of undeclared variable DBL_EPSILON (H5trace.c: 156)\r\n     651    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5trace.c: 161)\r\n     652    PGC-W-0155-Pointer value created from a nonlong integral type  (H5t\r\n            race.c: 215)\r\n     653    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5trace.c: 234)\r\n     654    PGC-I-0155-Long value is passed to a nonprototyped function - argum\r\n            ent #3 (H5A.c: 915)\r\n     655    PGC/x86-64 Linux 18.4-0: compilation completed with severe errors\r\n     656    Makefile:1434: recipe for target 'H5trace.lo' failed\r\n  >> 657    make[2]: *** [H5trace.lo] Error 1\r\n     658    PGC/x86-64 Linux 18.4-0: compilation completed with severe errors\r\n     659    Makefile:1434: recipe for target 'H5A.lo' failed\r\n  >> 660    make[2]: *** [H5A.lo] Error 1\r\n     661    make[2]: Leaving directory '/tmp/joe/spack-stage/spack-stage-yQ1uSP\r\n            /hdf5-1.10.2/src'\r\n     662    Makefile:1001: recipe for target 'all' failed\r\n  >> 663    make[1]: *** [all] Error 2\r\n     664    make[1]: Leaving directory '/tmp/joe/spack-stage/spack-stage-yQ1uSP\r\n            /hdf5-1.10.2/src'\r\n     665    Makefile:652: recipe for target 'all-recursive' failed\r\n  >> 666    make: *** [all-recursive] Error 1\r\n```\r\n Notice that the severe errors (indicated by `PGC-S` statements) occur during `make` indicate an inability to find `CHAR_BIT` and `DBL_EPSILON` macros, which exist in `limits.h` and `float.h`. I've verified these header files are in my search path at compile time. PGI's preprocessor though, for some reason, does not roll these macros in automatically.\r\n\r\nBuilding HDF5 outside of spack has been more fruitful, by swapping out the preprocessor with GCC's preprocessor. The encantation on my system to build HDF5 with PGI compilers is\r\n```console\r\n$ CPP=cpp CFLAGS=\"-fPIC -m64 -tp=px\" CXXFLAGS=\"-fPIC -m64 -tp=px\" FCFLAGS=\"-fPIC -m64 -tp=px\" CXX=pgc++ CC=pgcc FC=pgf90 ./configure --prefix=/apps/hdf5-1.8.18/pgi-18.4/ --with-zlib=/apps/spack/opt/spack/linux-ubuntu16.04-x86_64/pgi-18.4/zlib-1.2.11-yy6235b5kltm4qta7wnzvtvm4mol4nfc/ --enable-threadsafe --enable-cxx --enable-fortran --enable-fortran2003 --enable-unsupported\r\n\r\n$ make\r\n$ make install\r\n```\r\n\r\n\r\n### Steps to reproduce the issue\r\nInstall [pgi community edition ](https://www.pgroup.com/products/community.htm), and add PGI compilers to your path.\r\n```console\r\n$ spack compilers\r\n```\r\nshould add PGI compilers to spacks set of compilers.\r\n\r\n```console\r\n$ spack install hdf5%pgi@18.4 +fortran -mpi\r\n```\r\n\r\n### Information on your system\r\nThe system I've reproduced this on is an x86_64 platform with Ubuntu 16.04 OS. I am using default `packages.yaml` and `modules.yaml`\r\n\r\n### Suggested Solution\r\nI suggest that we apply a patch for the HDF5 package with PGI to use a GCC preprocessor, but would prefer input from more experienced spack users",
    "user": "fluidnumerics-joe",
    "url": "https://api.github.com/repos/spack/spack/issues/8962",
    "updated_at": "2019-02-12 16:52:46",
    "created_at": "2018-08-12 18:33:35",
    "closed_at": "None",
    "state": "open",
    "title": "Spack build of HDF5 fails with PGI compilers",
    "number": 8962,
    "milestone": null,
    "labels": [
        "build-error",
        "pgi"
    ],
    "id": 349833906,
    "html_url": "https://github.com/spack/spack/issues/8962",
    "assignees": [
        "scheibelp"
    ],
    "comments": 3
}