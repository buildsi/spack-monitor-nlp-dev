{
    "body": "### Steps to reproduce\n\n(@becker33 -- this is the issue we chatted about)\r\n\r\nWhen running spack with multiple repos, and a patch gets added to one of those repos, you can get errors when trying to stage from the other repo.  To reproduce:\r\n\r\n```\r\n#1. Get a fresh clone of spack:\r\n%  git clone git@github.com:spack/spack.git\r\n...\r\n% source spack/share/spack/setup-env.sh\r\n% spack debug report\r\n* **Spack:** 0.17.0-473-e199d7ef6b\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rhel8-zen2\r\n* **Concretizer:** clingo\r\n\r\n\r\n#2. Concretize and stage llvm. This works.\r\n% spack stage llvm@11.0.0\r\n... \r\n\r\n#3. Make a repo with a llvm package and add it\r\n% mkdir myrepo/packages/llvm\r\n% echo \"repo:\\n  namespace: 'myrepo'\\n\" > myrepo/repo.yaml \r\n% echo \"from spack import *\\nfrom spack.pk.builtin.llvm import Llvm as BuiltinLlvm\\nclass Llvm(BuiltinLlvm):\\n  pass\\n\" > myrepo/packages/llvm/package.py\r\n% spack repo add myrepo\r\n\r\n#4. Concretize and stage myrepo.llvm. This works.\r\n% spack stage myrepo.llvm@11.0.0\r\n\r\n#5. Add a patch to builtin.llvm\r\necho a > spack/var/spack/repos.builtin/packages/llvm/mypatch.patch\r\nAdd the line 'patch(\"mypatch.patch\")' to spack/var/spack/repos.builtin/packages/llvm/package.py\r\n\r\n#6. Concretize and stage myrepo.llvm. This fails.\r\n% spack stage myrepo.llvm@11.0.0\r\n==> Error: Couldn't find patch for package myrepo.llvm with sha256: 87428fc522803d31065e7bce3cf03fe475096631e5e07bbd7a0fde60c4cf25c7\r\n```\n\n### Error message\n\nThe full spack --debug output for the failing command is:\r\n\r\n```\r\n% spack --debug stage myrepo.llvm@11.0.0\r\n==> [2021-12-09-17:45:08.653378] Imported stage from built-in commands\r\n==> [2021-12-09-17:45:08.654000] Imported stage from built-in commands\r\n==> [2021-12-09-17:45:08.655819] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/config.yaml\r\n==> [2021-12-09-17:45:08.676321] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2021-12-09-17:45:08.686499] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/config.yaml\r\n==> [2021-12-09-17:45:08.704312] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-12-09-17:45:08.704353] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-12-09-17:45:08.704647] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2021-12-09-17:45:08.711925] DATABASE LOCK TIMEOUT: 3s\r\n==> [2021-12-09-17:45:08.711964] PACKAGE LOCK TIMEOUT: No timeout\r\n==> [2021-12-09-17:45:08.712015] [BOOTSTRAP CONFIG SCOPE] name=_builtin\r\n==> [2021-12-09-17:45:08.712286] [BOOTSTRAP CONFIG SCOPE] name=defaults, path=/usr/WS1/legendre/repopatch/spack/etc/spack/defaults\r\n==> [2021-12-09-17:45:08.712320] [BOOTSTRAP CONFIG SCOPE] name=defaults/linux, path=/usr/WS1/legendre/repopatch/spack/etc/spack/defaults/linux\r\n==> [2021-12-09-17:45:08.712347] [BOOTSTRAP CONFIG SCOPE] name=bootstrap, path=/g/g0/legendre/.spack/bootstrap/config\r\n==> [2021-12-09-17:45:08.712369] [BOOTSTRAP CONFIG SCOPE] name=bootstrap/linux, path=/g/g0/legendre/.spack/bootstrap/config/linux\r\n==> [2021-12-09-17:45:08.712611] Reading config file /g/g0/legendre/.spack/bootstrap/config/linux/compilers.yaml\r\n==> [2021-12-09-17:45:08.739965] [BOOTSTRAP ROOT SPEC] clingo-bootstrap@spack+python %gcc target=x86_64\r\n==> [2021-12-09-17:45:08.740008] [BOOTSTRAP MODULE clingo] Try importing from Python\r\n==> [2021-12-09-17:45:08.740196] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/bootstrap.yaml\r\n==> [2021-12-09-17:45:08.872038] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/config.yaml\r\n==> [2021-12-09-17:45:08.933096] [BOOTSTRAP MODULE clingo] The installed spec \"clingo-bootstrap@spack+python %gcc target=x86_64 ^python@3.6 /vcipwnf57slgoo7busvvkzjkk7vydeb5\" provides the \"clingo\" Python module\r\n==> [2021-12-09-17:45:08.933361] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/repos.yaml\r\n==> [2021-12-09-17:45:08.935191] Reading config file /g/g0/legendre/.spack/repos.yaml\r\n==> [2021-12-09-17:45:09.022109] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/config.yaml\r\n==> [2021-12-09-17:45:10.352489] Reading config file /g/g0/legendre/.spack/linux/compilers.yaml\r\n==> [2021-12-09-17:45:10.362283] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/packages.yaml\r\n==> [2021-12-09-17:45:16.765757] build(llvm)\r\n==> [2021-12-09-17:45:16.765884] build(cmake)\r\n==> [2021-12-09-17:45:16.765912] build(hwloc)\r\n==> [2021-12-09-17:45:16.765935] build(ncurses)\r\n==> [2021-12-09-17:45:16.765958] build(ninja)\r\n==> [2021-12-09-17:45:16.765979] build(perl-data-dumper)\r\n==> [2021-12-09-17:45:16.766001] build(pkgconf)\r\n==> [2021-12-09-17:45:16.766022] build(libffi)\r\n==> [2021-12-09-17:45:16.766043] build(binutils)\r\n==> [2021-12-09-17:45:16.766063] build(swig)\r\n==> [2021-12-09-17:45:16.766084] build(libedit)\r\n==> [2021-12-09-17:45:16.766104] build(python)\r\n==> [2021-12-09-17:45:16.766125] build(perl)\r\n==> [2021-12-09-17:45:16.766145] build(libtool)\r\n==> [2021-12-09-17:45:16.766165] build(m4)\r\n==> [2021-12-09-17:45:16.766185] build(pcre)\r\n==> [2021-12-09-17:45:16.766206] build(diffutils)\r\n==> [2021-12-09-17:45:16.766226] build(libxml2)\r\n==> [2021-12-09-17:45:16.766246] build(libpciaccess)\r\n==> [2021-12-09-17:45:16.766266] build(zlib)\r\n==> [2021-12-09-17:45:16.766286] build(xz)\r\n==> [2021-12-09-17:45:16.766306] build(expat)\r\n==> [2021-12-09-17:45:16.766326] build(bzip2)\r\n==> [2021-12-09-17:45:16.766346] build(openssl)\r\n==> [2021-12-09-17:45:16.766365] build(gdbm)\r\n==> [2021-12-09-17:45:16.766386] build(readline)\r\n==> [2021-12-09-17:45:16.766406] build(sqlite)\r\n==> [2021-12-09-17:45:16.766426] build(gettext)\r\n==> [2021-12-09-17:45:16.766446] build(util-linux-uuid)\r\n==> [2021-12-09-17:45:16.766468] build(berkeley-db)\r\n==> [2021-12-09-17:45:16.766488] build(util-macros)\r\n==> [2021-12-09-17:45:16.766508] build(libsigsegv)\r\n==> [2021-12-09-17:45:16.766528] build(libiconv)\r\n==> [2021-12-09-17:45:16.766549] build(libbsd)\r\n==> [2021-12-09-17:45:16.766568] build(tar)\r\n==> [2021-12-09-17:45:16.766588] build(libmd)\r\n==> [2021-12-09-17:45:16.778132] Ordered hashes [llvm]: llvm/36/87428fc522803d31065e7bce3cf03fe475096631e5e07bbd7a0fde60c4cf25c7, llvm/43/af41889be3db22ba7270c4418ab31089f449d85214de2b836fc9d0e36dbfa8a7, llvm/48/47284669559b98dd068b193b72a48add09112fcb90a9bfe5c609b79628a20d2b, llvm/49/7b286b164174a2eeb72931c7d9d246\\\r\nbaef170f476d1abcedcec48a9c0692366c, llvm/51/6811ad441aa0221fb6f519550e7fc75a69a84998d44c1bea6d507605213c769c\r\n==> [2021-12-09-17:45:16.778507] Ordered hashes [berkeley-db]: berkeley-db/123/b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522\r\n==> [2021-12-09-17:45:16.778611] Ordered hashes [m4]: m4/105/bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89, m4/106/9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573\r\n==> [2021-12-09-17:45:16.779507] Ordered hashes [python]: python/64/0d98e93189bc278fbc37a50ed7f183bd8aaf249a8e1670a465f0db6bb4f8cf87, python/65/f2fd060afc4b4618fe8104c4c5d771f36dc55b1db5a4623785a4ea707ec72fb4, python/67/4c2457325f2b608b1b6a2c63087df8c26e07db3e3d493caf36a56f0ecf6fb768\r\n==> [2021-12-09-17:45:16.779930] Ordered hashes [libffi]: libffi/142/26f26c6f29a7ce9bf370ad3ab2610f99365b4bdd7b82e7c31df41a3370d685c0\r\n==> [2021-12-09-17:45:17.018900] Creating stage lock spack-stage-llvm-11.0.0-g6d6q42un3maqj7hkqcyjtutxmry4yf4\r\n==> [2021-12-09-17:45:17.019186] Reading config file /usr/WS1/legendre/repopatch/spack/etc/spack/defaults/mirrors.yaml\r\n==> [2021-12-09-17:45:17.121432] Using cached archive: /usr/WS1/legendre/repopatch/spack/var/spack/cache/_source-cache/archive/8a/8ad4ddbafac4f2c8f2ea523c2c4196f940e8e16f9e635210537582a48622a5d5.tar.gz\r\n==> [2021-12-09-17:45:17.218663] NoSuchPatchError: Couldn't find patch for package myrepo.llvm with sha256: 87428fc522803d31065e7bce3cf03fe475096631e5e07bbd7a0fde60c4cf25c7\r\n==> [2021-12-09-17:45:17.218722] Error: Couldn't find patch for package myrepo.llvm with sha256: 87428fc522803d31065e7bce3cf03fe475096631e5e07bbd7a0fde60c4cf25c7\r\nTraceback (most recent call last):\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/main.py\", line 882, in main\r\n    return _main(argv)\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/main.py\", line 865, in _main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/main.py\", line 535, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/cmd/stage.py\", line 66, in stage\r\n    package.do_stage()\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/package.py\", line 1408, in do_stage\r\n    self.do_fetch(mirror_only)\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/package.py\", line 1395, in do_fetch\r\n    for patch in self.spec.patches:\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/llnl/util/lang.py\", line 190, in _memoized_function\r\n    func.cache[args] = func(*args)\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/spec.py\", line 3427, in patches\r\n    patch = index.patch_for_package(sha256, self.package)\r\n  File \"/usr/WS1/legendre/repopatch/spack/lib/spack/spack/patch.py\", line 383, in patch_for_package\r\n    % (pkg.fullname, sha256))\r\nspack.patch.NoSuchPatchError: Couldn't find patch for package myrepo.llvm with sha256: 87428fc522803d31065e7bce3cf03fe475096631e5e07bbd7a0fde60c4cf25c7\r\n```\n\n### Information on your system\n\nI reproduced this on a LLNL RHEL8 system.\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "mplegendre",
    "url": "https://api.github.com/repos/spack/spack/issues/27902",
    "updated_at": "2021-12-17 01:15:51",
    "created_at": "2021-12-10 01:48:24",
    "closed_at": "None",
    "state": "open",
    "title": "Patch file cache can get out of date when using two repos",
    "number": 27902,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1076322591,
    "html_url": "https://github.com/spack/spack/issues/27902",
    "assignees": [
        "RikkiButler20"
    ],
    "comments": 0
}