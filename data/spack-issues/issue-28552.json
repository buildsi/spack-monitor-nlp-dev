{
    "body": "### Steps to reproduce\r\n\r\nWith current develop, and spack > https://github.com/spack/spack/commit/a2181e9d253d7e7efae411b52ee995023090edd0 by ~~@alalazo~~ @adamjstewart \r\n```console\r\nspack install python+ensurepip\r\n```\r\n\r\n### Error message\r\n\r\nFull log: [spack-build-out.txt](https://github.com/spack/spack/files/7918957/spack-build-out.txt)\r\n\r\n```console\r\n11:46:15 wdconinc@menelaos ~ $ spack install python+ensurepip \r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/libiconv-1.16-kpfapbvtfaz22jywdasty3tpwqzxpqru\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/libmd-1.0.3-zu7mcmi75uq4wgeuffg43kvpcgkpkr34\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/pkgconf-1.8.0-fkwoajbd3f3s575mk3rgsczkllnxqywj\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/xz-5.2.5-lpdrhvdwae23m52ovapt6dq7ruqjf6vz\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/zlib-1.2.11-4gznovrgfc7lht33lqctihlhc7qwi25s\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/libffi-3.3-36g2em6gyl3wkfqqt5ccx7fclheurqps\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/berkeley-db-18.1.40-j3b2docyclx7tdpnhetyacu6fe2bfgdr\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/tar-1.34-plve6dwhgyk25fkb5t2shurpoyx3cklz\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/diffutils-3.8-y4o5hwxld7ligawv6zuwlnxkgu5qqu5s\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/libbsd-0.11.3-k6bqxnjkl33mqidtlwm75w2dkw6gidco\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/ncurses-6.2-zutufy4bqs4nwwkwzhh3hycuhdklilku\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/util-linux-uuid-2.36.2-q7lq3hjunyjhymxpfzyw5qcfisogwj5n\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/libxml2-2.9.12-i4vhktmtyzxpr7me3mvskybnylfatwmx\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/bzip2-1.0.8-wqvlh3tyjpd2dekgoxahsaz2fnc3mio5\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/expat-2.4.3-cbpalrovu2346mrgrwpayeyco2uue4hg\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/readline-8.1-4d3y5gvise76nitctkulcvph6sn4ootb\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/gettext-0.21-zslfuolpfwoxvt4hfxulaz233yhwvpul\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/sqlite-3.37.1-cvhqf7iqwv5dbozowabj3amxva7ylmsz\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/gdbm-1.19-5p64xn325sx2eozu5ymsel2eleal745m\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/perl-5.34.0-ooiqj7n7xe5qhew7r37t4nl3yusqnuqu\r\n[+] /opt/software/linux-ubuntu21.10-skylake/gcc-11.2.0/openssl-1.1.1m-vfpiufs3nwu6rjqi3vewwghdoe6urrhm\r\n==> Installing python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf\r\n==> No binary for python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf found: installing from source\r\n==> Using cached archive: /home/wdconinc/.spack/cache/_source-cache/archive/2c/2cc7b67c1f3f66c571acc42479cdf691d8ed6b47bee12c9b68430413a17a44ea.tgz\r\n==> Applied patch /home/wdconinc/git/spack/var/spack/repos/builtin/packages/python/python-3.7.4+-distutils-C++.patch\r\n==> Applied patch /home/wdconinc/git/spack/var/spack/repos/builtin/packages/python/python-3.7.4+-distutils-C++-testsuite.patch\r\n==> Applied patch /home/wdconinc/git/spack/var/spack/repos/builtin/packages/python/tkinter-3.8.patch\r\n==> Ran patch() for python\r\n==> python: Executing phase: 'autoreconf'\r\n==> python: Executing phase: 'configure'\r\n==> python: Executing phase: 'build'\r\n==> python: Executing phase: 'install'\r\n==> Error: ProcessError: Command exited with status 2:\r\n    'make' '-j8' 'install'\r\n\r\n2 errors found in build log:\r\n     9716    Requirement already satisfied: pip in /usr/lib/python3/dist-packages (20.3.4)\r\n     9717    Processing /tmp/tmpw31qfvag/pip-21.2.4-py3-none-any.whl\r\n     9718    Installing collected packages: setuptools, pip\r\n     9719      Attempting uninstall: setuptools\r\n     9720        Found existing installation: setuptools 52.0.0\r\n     9721        Uninstalling setuptools-52.0.0:\r\n  >> 9722    ERROR: Could not install packages due to an OSError: [Errno 13] Permission denied: '__init__.py'\r\n     9723    Consider using the `--user` option or check the permissions.\r\n     9724    \r\n     9725    Traceback (most recent call last):\r\n     9726      File \"/home/wdconinc/.spack/stage/spack-stage-python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf/spack-src/Lib/runpy.py\", line 197, in _run_module_as_main\r\n     9727        return _run_code(code, main_globals, None,\r\n     9728      File \"/home/wdconinc/.spack/stage/spack-stage-python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf/spack-src/Lib/runpy.py\", line 87, in _run_code\r\n\r\n     ...\r\n\r\n     9735        return _run_pip(args + [p[0] for p in _PROJECTS], additional_paths)\r\n     9736      File \"/home/wdconinc/.spack/stage/spack-stage-python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf/spack-src/Lib/ensurepip/__init__.py\", line 34, in _run_pip\r\n     9737        return subprocess.run([sys.executable, \"-c\", code], check=True).returncode\r\n     9738      File \"/home/wdconinc/.spack/stage/spack-stage-python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf/spack-src/Lib/subprocess.py\", line 528, in run\r\n     9739        raise CalledProcessError(retcode, process.args,\r\n     9740    subprocess.CalledProcessError: Command '['/home/wdconinc/.spack/stage/spack-stage-python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf/spack-src/spack-build/python', '-c', '\\nimport runpy\\nimport sys\\nsys.path = [\\'/tmp/tmpw31qfv\r\n             ag/setuptools-58.1.0-py3-none-any.whl\\', \\'/tmp/tmpw31qfvag/pip-21.2.4-py3-none-any.whl\\'] + sys.path\\nsys.argv[1:] = [\\'install\\', \\'--no-cache-dir\\', \\'--no-index\\', \\'--find-links\\', \\'/tmp/tmpw31qfvag\\', \\'--root\\', \\'\r\n             /\\', \\'--upgrade\\', \\'setuptools\\', \\'pip\\']\\nrunpy.run_module(\"pip\", run_name=\"__main__\", alter_sys=True)\\n']' returned non-zero exit status 1.\r\n  >> 9741    make: *** [Makefile:1264: install] Error 1\r\n\r\nSee build log for details:\r\n  /home/wdconinc/.spack/stage/spack-stage-python-3.9.9-4wwfvrsagjcov5amcbqr5dwjofoxr2sf/spack-build-out.txt\r\n```\r\n\r\nThe new `ensurepip` flag causes the python to find the system-installed `setuptools` in `/usr/lib/python3/dist-packages` (`Requirement already satisfied: pip in /usr/lib/python3/dist-packages (20.3.4)`).\r\n\r\nThe underlying issue is that `ensurepip` enables the configure flag `--with-ensurepip` which by default is taking the value `upgrade`. Setting this flag to `install` resolves the issue:\r\n```diff\r\ndiff --git a/var/spack/repos/builtin/packages/python/package.py b/var/spack/repos/builtin/packages/python/package.py\r\nindex f8625b3505..5c95bf9045 100644\r\n--- a/var/spack/repos/builtin/packages/python/package.py\r\n+++ b/var/spack/repos/builtin/packages/python/package.py\r\n@@ -492,7 +492,7 @@ def configure_args(self):\r\n \r\n         if spec.satisfies('@2.7.9:2,3.4:'):\r\n             if '+ensurepip' in spec:\r\n-                config_args.append('--with-ensurepip')\r\n+                config_args.append('--with-ensurepip=install')\r\n             else:\r\n                 config_args.append('--without-ensurepip')\r\n \r\n```\r\n\r\nHowever, this still will result in ensurepip finding `setuptools` and `pip` in `/usr/lib/python3/dist-packages`, so maybe this isn't quite a fix.\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.1-952-d7179e7e8f\r\n* **Python:** 3.9.7\r\n* **Platform:** linux-ubuntu21.10-skylake\r\n* **Concretizer:** clingo\r\n\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "wdconinc",
    "url": "https://api.github.com/repos/spack/spack/issues/28552",
    "updated_at": "2022-01-23 03:55:57",
    "created_at": "2022-01-22 17:54:52",
    "closed_at": "2022-01-23 03:55:57",
    "state": "closed",
    "title": "Python+ensurepip fails because `--with-ensurepip=upgrade` tries to remove system setuptools, pip",
    "number": 28552,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 1111640268,
    "html_url": "https://github.com/spack/spack/issues/28552",
    "assignees": [
        "adamjstewart"
    ],
    "comments": 6
}