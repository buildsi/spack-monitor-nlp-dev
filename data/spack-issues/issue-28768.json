{
    "body": "### Steps to reproduce the issue\n\n```console\r\n$ spack install intel@2021.3.0\r\n==> intel@2021.3.0 : has external module in ['comp/gcc/10.1.0', 'comp/intel/2021.3.0']\r\n==> Warning: cannot perform the requested write operation on module files [Trying to source non-existing file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh]\r\n==> Warning: cannot perform the requested write operation on module files [Trying to source non-existing file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh]\r\n[+] /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux (external intel-2021.3.0-hdgcisraeacu42xktiqns4w5raaqizir)\r\n```\n\n### Information on your system\n\n* **Spack:** 0.17.1-1070-5208fcf1ea\r\n* **Python:** 3.9.9\r\n* **Platform:** linux-sles12-skylake_avx512\r\n* **Concretizer:** clingo\r\n\n\n### Additional information\n\nThis is an odd one. I'm trying to use Intel 2021.3 on a cluster where Intel 2021.3 has *already been installed* by the sysadmin. Normally, I'd do:\r\n```\r\nml comp/gcc/10.1.0 comp/intel/2021.3.0\r\n```\r\nand I'd get it.\r\n\r\nSo with spack, in my `compilers.yaml` I have (truncated for this issue, and gcc 4.8 is the \"base\" gcc on this system):\r\n```yaml\r\ncompilers:\r\n- compiler:\r\n    spec: gcc@4.8\r\n    paths:\r\n      cc: /usr/bin/gcc\r\n      cxx: /usr/bin/g++\r\n      f77: /usr/bin/gfortran\r\n      fc: /usr/bin/gfortran\r\n    flags: {}\r\n    operating_system: sles12\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n- compiler:\r\n    spec: intel@2021.3.0\r\n    paths:\r\n      cc: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/icc\r\n      cxx: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/icpc\r\n      f77: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/ifort\r\n      fc: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/ifort\r\n    flags: {}\r\n    operating_system: sles12\r\n    target: x86_64\r\n    modules:\r\n    - comp/gcc/10.1.0\r\n    - comp/intel/2021.3.0\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\nI have a `packages.yaml`:\r\n```yaml\r\npackages:\r\n...\r\n  intel:\r\n    buildable: false\r\n    externals:\r\n    - spec: intel@2021.3.0%gcc@4.8\r\n      modules:\r\n        - comp/gcc/10.1.0\r\n        - comp/intel/2021.3.0\r\n...\r\n```\r\n\r\nAnd when I try to install, `spack` installs, but then fails at the Lua module creation phase. As seen above, it's looking for a `compilervars.sh` file that doesn't exist.\r\n\r\nNow, as a test, I essentially duplicated all the above with `intel-oneapi-compilers` as I didn't quite know what 2021.3 actually is in spack speak. When i do that I get:\r\n\r\n```console\r\n$ spack install intel-oneapi-compilers@2021.3.0\r\n==> intel-oneapi-compilers@2021.3.0 : has external module in ['comp/gcc/10.1.0', 'comp/intel/2021.3.0']\r\n==> Warning: cannot perform the requested write operation on module files [Trying to source non-existing file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compiler/2021.3.0/env/vars.sh]\r\n==> Warning: cannot perform the requested write operation on module files [Trying to source non-existing file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compiler/2021.3.0/env/vars.sh]\r\n[+] /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux (external intel-oneapi-compilers-2021.3.0-kucwu2giszpwh4daajsxfq5zabcz7f2p)\r\n```\r\n\r\nNow this is slightly better as there is a `vars.sh` file in the install on my system, but it's at:\r\n```\r\n/usr/local/intel/oneapi/2021/compiler/2021.3.0/env/vars.sh\r\n```\r\nnot:\r\n```\r\n/usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compiler/2021.3.0/env/vars.sh\r\n```\r\n\r\nIs there something I need to add to `modules.yaml` to tell it where `vars.sh` lives?\r\n\r\n---\r\n\r\nMaintainers: @rscohn2\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\n- [X] I have uploaded the build log and environment files\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "mathomp4",
    "url": "https://api.github.com/repos/spack/spack/issues/28768",
    "updated_at": "2022-02-12 16:04:42",
    "created_at": "2022-02-03 21:30:43",
    "closed_at": "None",
    "state": "open",
    "title": "Installation issue: intel: Can't build Intel lmod file from module-based Intel install",
    "number": 28768,
    "milestone": null,
    "labels": [
        "build-error"
    ],
    "id": 1123575180,
    "html_url": "https://github.com/spack/spack/issues/28768",
    "assignees": [],
    "comments": 16
}