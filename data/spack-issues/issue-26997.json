{
    "body": "### Summary\r\n\r\n@haampie @becker33 \r\n\r\nThe cray-libsci directory now provides a `NVIDIA` subdirectory which i presume is the canonical name to refer nvhpc builds to use cray-libsci.\r\n\r\nSee content of root directory for libsci 21.08.1.2\r\n```\r\nsiddiq90@login37> ls -l /opt/cray/pe/libsci/21.08.1.2/\r\ntotal 27\r\nlrwxrwxrwx. 1 root root     4 Oct 23  2019 aocc -> AOCC\r\ndrwxr-xr-x. 3 root root    36 Aug 24 11:10 AOCC\r\n-rw-r--r--. 1 root root 14127 Jul 30 06:36 ATTRIBUTIONS_libsci21.08.1.2.txt\r\nlrwxrwxrwx. 1 root root     4 Oct 11  2017 cray -> CRAY\r\ndrwxr-xr-x. 3 root root    36 Aug 24 13:12 CRAY\r\nlrwxrwxrwx. 1 root root     3 Oct 11  2017 gnu -> GNU\r\ndrwxr-xr-x. 3 root root    36 Aug 24 13:12 GNU\r\n-rw-r--r--. 1 root root    67 Oct 16  2019 lib_contents\r\ndrwxr-xr-x. 1 root root    68 Aug 24 13:12 man\r\nlrwxrwxrwx. 1 root root     6 Nov 30  2020 nvidia -> NVIDIA\r\ndrwxr-xr-x. 3 root root    38 Aug 24 11:10 NVIDIA\r\n-rw-r--r--. 1 root root  3539 Jul 30 06:38 release_info\r\n-rwxr-xr--. 1 root root  1123 Aug 24 13:12 set_default_libsci_21.08.1.2\r\n-rw-r--r--. 1 root root   137 Aug 24 13:12 set_pkgconfig_default_libsci\r\n```\r\n\r\nAccording to this code we dont have a mapping  for nvhpc https://github.com/spack/spack/blob/890095e876a85d91ae7359f9120082c4e2f6a249/var/spack/repos/builtin/packages/cray-libsci/package.py#L34-L40\r\n\r\nI would think this causes issue when it tries to detect blas library because it depends on `self.canonical_names` which maps to compiler that is coming from `self.spec.compiler.name`\r\n\r\n\r\nhttps://github.com/spack/spack/blob/890095e876a85d91ae7359f9120082c4e2f6a249/var/spack/repos/builtin/packages/cray-libsci/package.py#L55-L78\r\n\r\nI am not sure if its just a matter of adding a `nvhpc` key to fix the issue. Most of the content looks the same \r\n\r\n\r\n```\r\n    canonical_names = {\r\n        'gcc': 'GNU',\r\n        'cce': 'CRAY',\r\n        'intel': 'INTEL',\r\n        'clang': 'ALLINEA',\r\n        'aocc': 'AOCC',\r\n        'nvhpc': 'NVIDIA'\r\n    }\r\n```\r\n\r\n\r\n\r\n### Rationale\r\n\r\n_No response_\r\n\r\n### Description\r\n\r\nThis is causing some builds to fail that depend on blas libraries. Currently we have `cray-libsci` on Perlmutter along with nvhpc compiler providing its blas libraries. That's all we have so i am trying to figure out why this is not working.\r\n```\r\n==> Installing amrex-21.08-xtm5oazrom3qmttrafsd6wezjkvkezxz\r\n==> No binary for amrex-21.08-xtm5oazrom3qmttrafsd6wezjkvkezxz found: installing from source\r\n==> Error: IndexError: list index out of range\r\n\r\n/global/common/software/spackecp/perlmutter/e4s-21.08/spack/var/spack/repos/builtin/packages/cray-mpich/package.py:90, in headers:\r\n         88    def headers(self):\r\n         89        hdrs = find_headers('mpi', self.prefix.include, recursive=True)\r\n  >>     90        hdrs.directories = os.path.dirname(hdrs[0])\r\n         91        return hdrs\r\n\r\n\r\n[+] /tmp/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_/cray-sles15-zen3/gcc-11.2.0/vtk-m-1.6.0-q2fiea2wlax5xqxtomhbp66d7zfuyfcb\r\n[+] /tmp/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_/cray-sles15-zen3/gcc-11.2.0/perl-5.34.0-tn4lp27vgqeuuvjy3dg5f6cgpbre2i3n\r\n==> Installing vtk-h-0.7.1-nlfzs7hejzitrfeaglozpv23en7sfvbo\r\n==> No binary for vtk-h-0.7.1-nlfzs7hejzitrfeaglozpv23en7sfvbo found: installing from source\r\n==> Error: IndexError: list index out of range\r\n\r\n/global/common/software/spackecp/perlmutter/e4s-21.08/spack/var/spack/repos/builtin/packages/cray-mpich/package.py:90, in headers:\r\n         88    def headers(self):\r\n         89        hdrs = find_headers('mpi', self.prefix.include, recursive=True)\r\n  >>     90        hdrs.directories = os.path.dirname(hdrs[0])\r\n         91        return hdrs\r\n\r\n\r\n==> Warning: Skipping build of ascent-0.7.1-e2u4yppxmxh7ohy2l2l55vlkoozcyd5k since vtk-h-0.7.1-nlfzs7hejzitrfeaglozpv23en7sfvbo failed\r\n[+] /tmp/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_/cray-sles15-zen3/gcc-11.2.0/autoconf-2.69-jiczdztnkqv4vruoxh6x4kwpwkv3w4ou\r\n[+] /tmp/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_/cray-sles15-zen3/gcc-11.2.0/automake-1.16.3-vdfwvgnd4zmahmpvxawdvfrjlp5zmhqk\r\n[+] /tmp/spack/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_path_placeholder__/__spack_/cray-sles15-zen3/gcc-11.2.0/numactl-2.0.14-npmzh2ajujcvhypnpnn3hsa5wpuxpwzz\r\n==> Installing hdf5-1.8.22-t4k73drdvcuguetnzcb47okdotxbf4wx\r\n==> No binary for hdf5-1.8.22-t4k73drdvcuguetnzcb47okdotxbf4wx found: installing from source\r\n==> Error: IndexError: list index out of range\r\n\r\n/global/common/software/spackecp/perlmutter/e4s-21.08/spack/var/spack/repos/builtin/packages/cray-mpich/package.py:90, in headers:\r\n         88    def headers(self):\r\n         89        hdrs = find_headers('mpi', self.prefix.include, recursive=True)\r\n  >>     90        hdrs.directories = os.path.dirname(hdrs[0])\r\n         91        return hdrs\r\n\r\n\r\n==> Warning: Skipping build of conduit-0.7.2-6zhhfay4k53mpg7h2ocjj2hl3nv26yse since hdf5-1.8.22-t4k73drdvcuguetnzcb47okdotxbf4wx failed\r\n\r\n```\r\n\r\n### Additional information\r\n\r\n_No response_\r\n\r\n### General information\r\n\r\n- [X] I have run `spack --version` and reported the version of Spack\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "shahzebsiddiqui",
    "url": "https://api.github.com/repos/spack/spack/issues/26997",
    "updated_at": "2022-02-12 09:45:46",
    "created_at": "2021-10-27 22:55:29",
    "closed_at": "2022-02-12 09:45:46",
    "state": "closed",
    "title": "cray-libsci support for NVHPC",
    "number": 26997,
    "milestone": null,
    "labels": [
        "feature",
        "e4s",
        "nersc"
    ],
    "id": 1037926547,
    "html_url": "https://github.com/spack/spack/issues/26997",
    "assignees": [],
    "comments": 1
}