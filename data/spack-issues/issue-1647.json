{
    "body": "i recently came across `-Werror=line-truncation` issues when compiling two packages in Spack with `clang+gfortran` (see below). One of them is `ape`, both [Homebrew](https://github.com/Homebrew/homebrew-science/blob/master/atomic-pseudopotential-engine.rb) and [Macports](https://trac.macports.org/browser/trunk/dports/science/ape/Portfile) don't set any special flags during configure. As a matter of fact, i contributed `ape` to Homebrew and did not have any problems building it at that time. This makes me believe that the issue could be related to compiler wrappers in Spack.\n\nIn APE's mailing list it was suggested that\n\n> the problem is not with the not the\n> Fortran compiler, but rather the C preprocessor. It seems the CFLAGS\n> macro was not replaced by it's appropriate value, probably because \"//\"\n> indicates a C++ comment (in Fortran \"//\" is a string concatenation\n> operator).\n\nLogs for both packages show the same flags `-E -x c -ansi`. Here's an excerpt from the configure\n\n```\nchecking whether /Users/davydden/spack/lib/spack/env/clang/clang -E is usable for Fortran preprocessing... preprocessor cannot be run\nchecking whether /Users/davydden/spack/lib/spack/env/clang/clang -E -x c is usable for Fortran preprocessing... preprocessor mangles C++ style comment\nchecking whether /Users/davydden/spack/lib/spack/env/clang/clang -E -x c -ansi is usable for Fortran preprocessing... yes\n```\n\nOn [this page](http://www.tddft.org/programs/octopus/wiki/index.php/Preprocessors) there is an m4 macro used to get flags.\n\nI am somewhat suspicious by the fact that `-x c` is there as at least for [LLVM](http://clang.llvm.org/docs/CommandGuide/clang.html)\n\n> -x <language>\n> Treat subsequent input files as having type language.\n\nWould appreciate of someone who knows well compiler wrappers' code could comment on this issue.\n\n---\n\np.s. I must tell that both issues disappear when `-ffree-line-length-none` flag is set\n\n> -ffree-line-length-n\n> Set column after which characters are ignored in typical free-form lines in the source file. The default value is 132. n may be \u2018none\u2019, meaning that the entire line is meaningful. -ffree-line-length-0 means the same thing as -ffree-line-length-none.\n\nbut I am not sure anymore that this is the right solution.\n\n---\n\n1) ape\n\n```\n/Users/davydden/spack/lib/spack/env/clang/clang -E -x c -ansi  -I../liboct_parser -I../libstring_f -I../src -I../src -I. ape.F90 > ape_ape.f90\n/Users/davydden/spack/lib/spack/env/clang/gfortran -g -O2 -I /Users/davydden/spack/opt/spack/darwin-elcapitan-x86_64/clang-7.3.0-apple/libxc-2.2.2-ovavb5bmxo3o63ccr4gp6fayscvdpcyw/include    -I ../src -c  -o ape.o ape_ape.f90\nape.F90:68:132:\n\n  message(6) = \"  C compiler flags: \"// CFLAGS\n                                                                                                                                   1\nError: Line truncated at (1) [-Werror=line-truncation]\nape.F90:68:41:\n\n  message(6) = \"  C compiler flags: \"// CFLAGS\n                                        1\nError: Unterminated character constant beginning at (1)\nf951: some warnings being treated as errors\nmake[2]: *** [ape.o] Error 1\nmake[1]: *** [all-recursive] Error 1\nmake: *** [all] Error 2\n```\n\n2) octopus\n\n```\n/Users/davydden/spack/opt/spack/darwin-elcapitan-x86_64/clang-7.3.0-apple/openmpi-2.0.0-6uy66j3mu3rsjoiauplx556zsr7yzaon/bin/mpicc -E -x c -ansi  -I../../src/include -I../../src/include -I../../external_libs/spglib-1.5.2/src -I../../liboct_parser -I/Users/davydden/spack/opt/spack/darwin-elcapitan-x86_64/clang-7.3.0-apple/gsl-2.1-ff4bai6puh25vcodlowkim6tl5w75fbd/include  -DSHARE_OCTOPUS='\"/Users/davydden/spack/opt/spack/darwin-elcapitan-x86_64/clang-7.3.0-apple/octopus-5.0.1-jo7vq4dzll22s7sh5nillplc3fvc7wn6/share/octopus\"' -I../../external_libs/metis-5.1/include/ -I. global.F90 > global_oct.f90\n../../build/preprocess.pl global_oct.f90 \\\n      \"\" \"yes\" \"yes\"\n/Users/davydden/spack/opt/spack/darwin-elcapitan-x86_64/clang-7.3.0-apple/openmpi-2.0.0-6uy66j3mu3rsjoiauplx556zsr7yzaon/bin/mpif90 -O2 -I /Users/davydden/spack/opt/spack/darwin-elcapitan-x86_64/clang-7.3.0-apple/libxc-2.2.2-lprcrjphgengbwdlxtbcud3newxaxg6d/include         -I ../../src/basic -I ../../src/math -I ../../src/species -I ../../src/ions -I ../../src/grid -I ../../src/poisson -I ../../src/states -I ../../src/frozen -I ../../src/xc -I ../../src/system -I ../../src/hamiltonian -I ../../src/scf -I ../../src/td -I ../../src/opt_control -I ../../src/sternheimer -I ../../external_libs/qshep -I ../../external_libs/bpdn -I ../../external_libs/spglib-1.5.2/src  -I ../../external_libs/newuoa -c  -o global.o global_oct.f90\nglobal.F90:157:132:\n\n\n      conf%share = SHARE_OCTOPUS\n                                                                                                                                   1\nError: Line truncated at (1) [-Werror=line-truncation]\nglobal.F90:157:20:\n\n      conf%share = SHARE_OCTOPUS\n                   1\nError: Unterminated character constant beginning at (1)\nglobal.F90:162:132:\n\n    conf%cc         = CC\n                                                                                                                                   1\nError: Line truncated at (1) [-Werror=line-truncation]\nglobal.F90:162:15:\n\n    conf%cc         = CC\n              1\nError: Unterminated character constant beginning at (1)\nglobal.F90:166:132:\n\n    conf%fc         = FC\n                                                                                                                                   1\nError: Line truncated at (1) [-Werror=line-truncation]\nglobal.F90:166:15:\n\n    conf%fc         = FC\n              1\nError: Unterminated character constant beginning at (1)\nf951: some warnings being treated as errors\n```\n",
    "user": "davydden",
    "url": "https://api.github.com/repos/spack/spack/issues/1647",
    "updated_at": "2016-08-29 07:04:15",
    "created_at": "2016-08-28 19:42:57",
    "closed_at": "2016-08-29 07:04:15",
    "state": "closed",
    "title": "clang as CPP for Fortran and compiler wrappers",
    "number": 1647,
    "milestone": null,
    "labels": [],
    "id": 173663581,
    "html_url": "https://github.com/spack/spack/issues/1647",
    "assignees": [],
    "comments": 7
}