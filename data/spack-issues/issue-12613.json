{
    "body": "Something major must have broken very recently, because this bug didn't exist 3 weeks ago when I was working on #12170.\r\n\r\nI'm trying to install numpy, but when I run the unit tests, it turns out `pytest` isn't added as a dependency. The package contains:\r\n```python\r\n    depends_on('py-nose@1.0.0:', when='@:1.14', type='test')                    \r\n    depends_on('py-pytest', when='@1.15:', type='test')    \r\n```\r\nIf I run:\r\n```console\r\n$ spack install --test=root py-numpy\r\n==> intel-mkl@2019.4 : externally installed in /opt/intel\r\n==> intel-mkl@2019.4 : already registered in DB\r\n==> diffutils is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/diffutils-3.7-jvgimm7dfdzbuwjxhmrmrzfangw3r3ry\r\n==> bzip2 is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/bzip2-1.0.8-llnc6sqphf7yp4drig6njzzkxctjwfse\r\n==> expat is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/expat-2.2.5-ivx3l77irr7xnft6v2xduzqier7zlct3\r\n==> pkgconf is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/pkgconf-1.6.1-gws4nai5kqznvyfk2uaz5o26td45oq6x\r\n==> ncurses is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/ncurses-6.1-nhodl3ckldkmn6nfzgtymzlsn7mm3htq\r\n==> readline is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/readline-7.0-kn3u3qhqwktlvjpr47ism2uqqgstvvf2\r\n==> gdbm is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/gdbm-1.18.1-pvjwideh43qybd2ifi65gjxq2dd6p4nj\r\n==> libiconv is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/libiconv-1.15-6y7tjlqeuu7qmpv3zokgbdowqs7emk7y\r\n==> xz is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/xz-5.2.4-snwzcouby3x3ztkutupqzmqwbbxh2tur\r\n==> zlib is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/zlib-1.2.11-nqnlnxddpa4qfz5cnf4grnct57ds25ks\r\n==> libxml2 is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/libxml2-2.9.9-owmrtw347mtch4jm4cium25nvsjamqkf\r\n==> tar is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/tar-1.31-vyjf7fdqrr6ybqblhuujonbcguepjbne\r\n==> gettext is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/gettext-0.19.8.1-n3673flplqiagvozwgyeezzs4u22gvrr\r\n==> libffi is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/libffi-3.2.1-rmioaofogfk7efvt3cpb3d433sevjnaf\r\n==> perl is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/perl-5.26.2-agbs3wmvu2qp3hjc3amdhpo4znwkcwxs\r\n==> openssl is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/openssl-1.1.1c-lqiupxyyvankdx6zybheqiocy33cfnhl\r\n==> sqlite is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/sqlite-3.28.0-mijtevf42dqzctgyaizz44skbyqwxgol\r\n==> python is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/python-3.7.4-4o2smrf7lfyyg5pa6gu4q4rmjwdtxrel\r\n==> py-setuptools is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-setuptools-41.0.1-amzguxfvxjiqaivtv7sxakdrapupbtv7\r\n==> Installing py-numpy\r\n...\r\n==> [2019-08-27-20:43:00.538422] '/Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/python-3.7.4-4o2smrf7lfyyg5pa6gu4q4rmjwdtxrel/bin/python3.7' '-c' 'import numpy; numpy.test(\"full\", verbose=2)'\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"/Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-numpy-1.17.1-zu2emnwpzq4mefyg4vpyeiphn64ctquz/lib/python3.7/site-packages/numpy/_pytesttester.py\", line 122, in __call__\r\n    import pytest\r\nModuleNotFoundError: No module named 'pytest'\r\n```\r\nit doesn't add the `py-pytest` dependency. But if I do:\r\n```console\r\n$ spack install --test=root py-numpy@1.17.0\r\n==> intel-mkl@2019.4 : externally installed in /opt/intel\r\n==> intel-mkl@2019.4 : already registered in DB\r\n==> diffutils is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/diffutils-3.7-jvgimm7dfdzbuwjxhmrmrzfangw3r3ry\r\n==> bzip2 is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/bzip2-1.0.8-llnc6sqphf7yp4drig6njzzkxctjwfse\r\n==> expat is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/expat-2.2.5-ivx3l77irr7xnft6v2xduzqier7zlct3\r\n==> pkgconf is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/pkgconf-1.6.1-gws4nai5kqznvyfk2uaz5o26td45oq6x\r\n==> ncurses is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/ncurses-6.1-nhodl3ckldkmn6nfzgtymzlsn7mm3htq\r\n==> readline is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/readline-7.0-kn3u3qhqwktlvjpr47ism2uqqgstvvf2\r\n==> gdbm is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/gdbm-1.18.1-pvjwideh43qybd2ifi65gjxq2dd6p4nj\r\n==> libiconv is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/libiconv-1.15-6y7tjlqeuu7qmpv3zokgbdowqs7emk7y\r\n==> xz is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/xz-5.2.4-snwzcouby3x3ztkutupqzmqwbbxh2tur\r\n==> zlib is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/zlib-1.2.11-nqnlnxddpa4qfz5cnf4grnct57ds25ks\r\n==> libxml2 is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/libxml2-2.9.9-owmrtw347mtch4jm4cium25nvsjamqkf\r\n==> tar is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/tar-1.31-vyjf7fdqrr6ybqblhuujonbcguepjbne\r\n==> gettext is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/gettext-0.19.8.1-n3673flplqiagvozwgyeezzs4u22gvrr\r\n==> libffi is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/libffi-3.2.1-rmioaofogfk7efvt3cpb3d433sevjnaf\r\n==> perl is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/perl-5.26.2-agbs3wmvu2qp3hjc3amdhpo4znwkcwxs\r\n==> openssl is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/openssl-1.1.1c-lqiupxyyvankdx6zybheqiocy33cfnhl\r\n==> sqlite is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/sqlite-3.28.0-mijtevf42dqzctgyaizz44skbyqwxgol\r\n==> python is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/python-3.7.4-4o2smrf7lfyyg5pa6gu4q4rmjwdtxrel\r\n==> py-setuptools is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-setuptools-41.0.1-amzguxfvxjiqaivtv7sxakdrapupbtv7\r\n==> py-atomicwrites is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-atomicwrites-1.1.5-tnmuobbfpx4cup67dfvphizas2o5pzxt\r\n==> py-attrs is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-attrs-18.1.0-36epqfqjluqj66sqsopzlckjxryl4qzf\r\n==> py-six is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-six-1.12.0-rnxesoishseodeag23dovmejiyzlwmzy\r\n==> py-more-itertools is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-more-itertools-4.3.0-psaitjhb646j54e37wvtcvj5bugarad2\r\n==> py-setuptools-scm is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-setuptools-scm-3.1.0-b6lcwj2vhjv5fjroeux757pdmx3hdaj6\r\n==> py-pluggy is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-pluggy-0.7.1-uzcmx3ckh6y472hmrexwu55rl5muz4pb\r\n==> py-py is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-py-1.5.4-wir74mgvvhwvqvc4zvg3x45hogzjngwp\r\n==> py-pytest is already installed in /Users/Adam/spack/opt/spack/darwin-mojave-x86_64/clang-10.0.1-apple/py-pytest-4.3.0-xemkacmzrs7brdc4j6v7i35kiolbaaw7\r\n==> Installing py-numpy\r\n```\r\nit does add the `py-pytest` dependency.",
    "user": "adamjstewart",
    "url": "https://api.github.com/repos/spack/spack/issues/12613",
    "updated_at": "2019-08-28 21:12:44",
    "created_at": "2019-08-28 02:15:33",
    "closed_at": "2019-08-28 21:11:53",
    "state": "closed",
    "title": "Conditional test dependencies not added to spec",
    "number": 12613,
    "milestone": null,
    "labels": [
        "bug",
        "unreproducible",
        "workaround",
        "impact-low"
    ],
    "id": 486123119,
    "html_url": "https://github.com/spack/spack/issues/12613",
    "assignees": [],
    "comments": 11
}