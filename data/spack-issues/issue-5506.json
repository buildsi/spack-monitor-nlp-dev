{
    "body": "Dear all,\r\n\r\n@alalazo asked me to have a look at the [plumed package](https://github.com/LLNL/spack/blob/develop/var/spack/repos/builtin/packages/plumed/package.py) in spack. First of all, thanks to you guys for maintaining it and helping people installing PLUMED on their systems.\r\n\r\nI am not sure how much I can help, though I write some comments below. I hope this is the right place to do it.\r\n\r\n#### List of patches\r\nIn [this part](https://github.com/LLNL/spack/blob/733965b3c6fdc9bb16b5c9985fe5ff35d31a5a22/var/spack/repos/builtin/packages/plumed/package.py#L78) you are hardcoding a map of indexes of plumed patches. I think this is correct since you point to a specific plumed version (X.Y.Z). However, I guess your life could be a bit easier using the following commands:\r\n\r\n````\r\n  plumed patch -q -l | grep -v Available\r\n````\r\n\r\nshould print a list of the available patches, and\r\n\r\n````\r\n  plumed patch -e gromacs-5.1.4 -p\r\n````\r\n\r\nwould directly apply the patch for gromacs-5.1.4, without knowing which is its index in the list. You may construct the list within the `apply_patch` method, so as to avoid the need to update your map at every new PLUMED release.\r\n\r\n#### Patch command\r\n\r\nIn [this part](https://github.com/LLNL/spack/blob/733965b3c6fdc9bb16b5c9985fe5ff35d31a5a22/var/spack/repos/builtin/packages/plumed/package.py#L120) you call `plumed` executable directly. Notice that:\r\n\r\n- If the node on which you run the install job has no MPI available and your `plumed` executable is linked to MPI, you might have troubles. `plumed --no-mpi` should work in this case.\r\n- If you are cross-compiling, also `plumed --no-mpi` will not work. `plumed-patch` directly calls a bash scripts and is the most general choice.\r\n\r\nSo, I would recommend using `plumed-patch`, which always works. It should be installed side-by-side with the regular `plumed` executable.\r\n\r\n#### Linking plumed and MD codes\r\n\r\nI see you patch MD codes with `plumed patch -p`, which by defaults links plumed as a shared library. You might want to try `plumed patch --runtime -p`, which does the following:\r\n- Link a single object file, plus `-ldl` flag. This object is a dummy wrapper that never changes.\r\n- When MD code is launched, it looks for plumed based on the `PLUMED_KERNEL` environment variable. Basically, shared object `libplumedKernel.so` is opened with `dlopen`. \r\n\r\nI am using this procedure to keep up to date a local cluster using tcl env modules. I basically have a number of gromacs and plumed modules (corresponding to different versions) that can be combined in an arbitrary manner.\r\n\r\n**warning**: the following comments would not work with some of the PLUMED versions that you support, so they might be useless.\r\n\r\n#### GSL and BLAS\r\n\r\n[Here](https://github.com/LLNL/spack/blob/733965b3c6fdc9bb16b5c9985fe5ff35d31a5a22/var/spack/repos/builtin/packages/plumed/package.py#L138) you remove `-lgslcblas` from the libraries that are linked. Notice that as of PLUMED 2.2.4 (and 2.3.0 as well) the problem you mention is solved. Namely, our `./configure` script first tries to link `-lgsl` alone, and `-lgslblas` is only linked if required. Thus, when using system BLAS and gsl, `-lgslblas` will not be linked.\r\n\r\n#### About linked libraries\r\n\r\nWhile implementing a `Portfile` for [MacPorts](https://github.com/macports/macports-ports/blob/b11eeec11714b8c4c376d11dc78e7c6ec828ada3/science/plumed/Portfile), I had troubles making sure that not-requested libs were not linked just because they were present in the system. In principle, one might explicitly disable features (e.g. using `--disable-matheval`). However, I found it easier to add an option to our `./configure` (`--disable-libsearch`, available as of PLUMED 2.3.2) which tells not to try any default name for libraries. Only libraries specified in `LIBS=...` are linked. So you can do for instance\r\n````\r\n./configure --disable-libsearch LIBS=-lmatheval\r\n````\r\nto enable matheval library.\r\n\r\nI hope this helps... Thanks again and feel free to cross link our official repository whenever you find issues or want to propose solutions.\r\n\r\nRegards\r\n\r\nGiovanni",
    "user": "GiovanniBussi",
    "url": "https://api.github.com/repos/spack/spack/issues/5506",
    "updated_at": "2017-10-10 19:35:54",
    "created_at": "2017-09-27 09:55:06",
    "closed_at": "2017-10-10 19:35:54",
    "state": "closed",
    "title": "Comments on package/plumed",
    "number": 5506,
    "milestone": null,
    "labels": [],
    "id": 260914617,
    "html_url": "https://github.com/spack/spack/issues/5506",
    "assignees": [
        "alalazo"
    ],
    "comments": 2
}