{
    "body": "Compiler property flags, like `cxx11_flag` and `cxx14_flag`, are not being interpreted properly when the compilers are loaded via modulefile. This affects a wide variety of packages; `harfbuzz` and `clingo` are both packages that I have been having trouble with.\r\n\r\n### Steps to reproduce the issue\r\n\r\nFrom the examples mentioned above,\r\n\r\n```console\r\n$ spack install harfbuzz%gcc@9.3.0\r\n$ spack install clingo%gcc@9.3.0\r\n...\r\n```\r\n\r\n### Error Message\r\n\r\n```console\r\n$ spack --debug --stacktrace install harfbuzz%gcc@9.3.0\r\n...\r\nlib/spack/spack/installer.py:1669 ==> [2020-12-09-14:01:40.897223] harfbuzz: Executing phase: 'configure'\r\nlib/spack/spack/error.py:55 ==> [2020-12-09-14:01:41.030647] Error: JSONDecodeError: Expecting value: line 1 column 1 (char 0)\r\n\r\n/deac/opt/DEAC-Spack/spack/var/spack/repos/builtin/packages/harfbuzz/package.py:48, in configure_args:\r\n         45        # disable building of gtk-doc files following #9771\r\n         46        args.append('--disable-gtk-doc-html')\r\n         47        true = which('true')\r\n  >>     48        args.append('CXXFLAGS={0}'.format(self.compiler.cxx11_flag))\r\n         49        args.append('GTKDOC_CHECK={0}'.format(true))\r\n         50        args.append('GTKDOC_CHECK_PATH={0}'.format(true))\r\n         51        args.append('GTKDOC_MKPDF={0}'.format(true))\r\n\r\nSee build log for details:\r\n  /scratch/anderss/spack-stage/spack-stage-harfbuzz-2.6.8-ho2dtuamqtnqgrq6bf7y5bd5gvsj7rzg/spack-build-out.txt\r\n\r\nTraceback (most recent call last):\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/build_environment.py\", line 847, in _setup_pkg_and_run\r\n    return_value = function(pkg, kwargs)\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/installer.py\", line 1674, in build_process\r\n    phase(pkg.spec, pkg.prefix)\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/package.py\", line 109, in phase_wrapper\r\n    phase(spec, prefix)\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/build_systems/autotools.py\", line 334, in configure\r\n    options += self.configure_args()\r\n  File \"/deac/opt/DEAC-Spack/spack/var/spack/repos/builtin/packages/harfbuzz/package.py\", line 49, in configure_args\r\n    args.append('GTKDOC_CHECK={0}'.format(true))\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/compilers/gcc.py\", line 66, in cxx11_flag\r\n    if self.real_version < ver('4.3'):\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/compiler.py\", line 348, in real_version\r\n    self.get_real_version())\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/compiler.py\", line 524, in get_real_version\r\n    with self._compiler_environment():\r\n  File \"/usr/lib64/python3.6/contextlib.py\", line 81, in __enter__\r\n    return next(self.gen)\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/compiler.py\", line 609, in _compiler_environment\r\n    spack.util.module_cmd.load_module(module)\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/util/module_cmd.py\", line 109, in load_module\r\n    module('load', mod)\r\n  File \"/deac/opt/DEAC-Spack/spack/lib/spack/spack/util/module_cmd.py\", line 72, in module\r\n    env_dict = json.loads(env_json)\r\n  File \"/usr/lib64/python3.6/json/__init__.py\", line 354, in loads\r\n    return _default_decoder.decode(s)\r\n  File \"/usr/lib64/python3.6/json/decoder.py\", line 339, in decode\r\n    obj, end = self.raw_decode(s, idx=_w(s, 0).end())\r\n  File \"/usr/lib64/python3.6/json/decoder.py\", line 357, in raw_decode\r\n    raise JSONDecodeError(\"Expecting value\", s, err.value) from None\r\njson.decoder.JSONDecodeError: Expecting value: line 1 column 1 (char 0)\r\nlib/spack/spack/installer.py:1263 ==> [2020-12-09-14:01:41.030951] Flagging harfbuzz-2.6.8-ho2dtuamqtnqgrq6bf7y5bd5gvsj7rzg as failed: JSONDecodeError: Expecting value: line 1 column 1 (char 0)\r\nlib/spack/spack/main.py:765 ==> [2020-12-09-14:01:41.050504] ChildError: JSONDecodeError: Expecting value: line 1 column 1 (char 0)\r\n\r\n```\r\n\r\nAttached is the full debug output for the `harfbuzz` installation. When simply commenting out the modulefile within the compiler definition, the installation works perfectly; I have also attached the full debug output for this scenario.\r\n\r\nThis behavior is very strange because modulefile is loaded correctly to obtain the linker paths, but for some reason it cannot load (within `_compiler_environment()`) ir order to output the appropriate version (with `cc -dumpversion`). This makes it fail the version checks and thus not assign the correct property flags.\r\n\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.16.0\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-rhel7-cascadelake\r\n\r\nThe `gcc@9.3.0` compiler is defined in `compilers.yaml` as follows:\r\n\r\n```yaml\r\n- compiler:\r\n    spec: gcc@9.3.0\r\n    paths:\r\n      cc: /deac/opt/rhel7/gcc/9.3.0/bin/gcc\r\n      cxx: /deac/opt/rhel7/gcc/9.3.0/bin/g++\r\n      f77: /deac/opt/rhel7/gcc/9.3.0/bin/gfortran\r\n      fc: /deac/opt/rhel7/gcc/9.3.0/bin/gfortran\r\n    flags: {}\r\n    operating_system: rhel7\r\n    target: x86_64\r\n    modules: [compilers/gcc/9.3.0]\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\n\r\nI have attached the `compilers/gcc/9.3.0` modulefile, but it is pretty standard fare. Again, commenting out the `modules: [compilers/gcc/9.3.0]` line fixes the issue.\r\n\r\n### Additional information\r\n\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n\r\n[gcc9.3.0_modulefile.txt](https://github.com/spack/spack/files/5668556/gcc9.3.0_modulefile.txt)\r\n[with_modulefile.log](https://github.com/spack/spack/files/5668552/with_modulefile.log)\r\n[without_modulefile.log](https://github.com/spack/spack/files/5668553/without_modulefile.log)\r\n",
    "user": "roguephysicist",
    "url": "https://api.github.com/repos/spack/spack/issues/20312",
    "updated_at": "2021-01-08 17:26:01",
    "created_at": "2020-12-09 20:44:46",
    "closed_at": "2021-01-08 17:26:01",
    "state": "closed",
    "title": "Compiler property flags are not being interpreted from modulefiles",
    "number": 20312,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 760657807,
    "html_url": "https://github.com/spack/spack/issues/20312",
    "assignees": [],
    "comments": 0
}