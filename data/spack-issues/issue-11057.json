{
    "body": "Resolves #8835\r\n\r\nThis PR requires an update after #10017 is merged. I've marked WIP for now.\r\n\r\nAllow users to specify combinatorial sets of packages for Environments.\r\n\r\nThis feature is aimed at facilities deployment people, to enable Spack usage at the facility level.\r\n\r\nFrom the documentation (with only slight formatting changes):\r\n\r\n\"\r\nEntries in the ``specs`` list can be individual abstract specs or a\r\nspec matrix.\r\n\r\nA spec matrix is a yaml object containing multiple lists of specs, and\r\nevaluates to the cross-product of those specs. Spec matrices also\r\ncontain an ``excludes`` directive, which eliminates certain\r\ncombinations from the evaluated result.\r\n\r\nThe following two Environment manifests are identical:\r\n\r\n```yaml\r\nspack:\r\n  specs:\r\n    - zlib %gcc@7.1.0\r\n    - zlib %gcc@4.9.3\r\n    - libelf %gcc@7.1.0\r\n    - libelf %gcc@4.9.3\r\n    - libdwarf %gcc@7.1.0\r\n    - cmake\r\n```\r\n```yaml\r\nspack:\r\n  specs:\r\n    - matrix:\r\n        - [zlib, libelf, libdwarf]\r\n        - ['%gcc@7.1.0', '%gcc@4.9.3']\r\n      exclude:\r\n        - libdwarf%gcc@4.9.3\r\n    - cmake\r\n```\r\n\r\nSpec matrices can be used to install swaths of software across various\r\ntoolchains.\r\n\r\nThe concretization logic for spec matrices differs slightly from the\r\nrest of Spack. If a variant or dependency constraint from a matrix is\r\ninvalid, Spack will reject the constraint and try again without\r\nit. For example, the following two Environment manifests will produce\r\nthe same specs:\r\n\r\n```yaml\r\nspack:\r\n  specs:\r\n    - matrix:\r\n        - [zlib, libelf, hdf5+mpi]\r\n        - [^mvapich2@2.2, ^openmpi@3.1.0]\r\n```\r\n```yaml\r\nspack:\r\n  specs:\r\n    - zlib\r\n    - libelf\r\n    - hdf5+mpi ^mvapich2@2.2\r\n    - hdf5+mpi ^openmpi@3.1.0\r\n```\r\n\r\nThis allows one to create toolchains out of combinations of\r\nconstraints and apply them somewhat indiscriminantly to packages,\r\nwithout regard for the applicability of the constraint.\r\n\r\nThe last type of possible entry in the specs list is a reference.\r\n\r\nThe Spack Environment manifest yaml schema contains an additional\r\nheading ``definitions``. Under definitions is an array of yaml\r\nobjects. Each object has one or two fields. The one required field is\r\na name, and the optional field is a ``when`` clause.\r\n\r\nThe named field is a spec list. The spec list uses the same syntax as\r\nthe ``specs`` entry. Each entry in the spec list can be a spec, a spec\r\nmatrix, or a reference to an earlier named list. References are\r\nspecified using the ``$`` sigil, and are \"splatted\" into place\r\n(i.e. the elements of the referent are at the same level as the\r\nelements listed separately). As an example, the following two manifest\r\nfiles are identical.\r\n\r\n```yaml\r\nspack:\r\n  definitions:\r\n    - first: [libelf, libdwarf]\r\n    - compilers: ['%gcc', '%intel']\r\n    - second:\r\n        - $first\r\n        - matrix:\r\n            - [zlib]\r\n            - [$compilers]\r\n  specs:\r\n    - $second\r\n    - cmake\r\n```\r\n```yaml\r\nspack:\r\n  specs:\r\n    - libelf\r\n    - libdwarf\r\n    - zlib%gcc\r\n    - zlib%intel\r\n    - cmake\r\n```\r\n\r\nN.B. Named a spec list in the definitions section may only refer\r\n   to a named list defined above itself. Order matters.\r\n\r\nIn short files like the example, it may be easier to simply list the\r\nincluded specs. However for more complicated examples involving many\r\npackages across many toolchains, separately factored lists make\r\nEnvironments substantially more manageable.\r\n\r\nAdditionally, the ``-l`` option to the ``spack add`` command allows\r\none to add to named lists in the definitions section of the manifest\r\nfile directly from the command line.\r\n\r\nThe ``when`` directive can be used to conditionally add specs to a\r\nnamed list. The ``when`` directive takes a string of python code\r\nreferring to a restricted set of variables, and evaluates to a\r\nboolean. The specs listed are appended to the named list if the\r\n``when`` string evaluates to ``True``. In the following snippet, the\r\nnamed list ``compilers`` is ``['%gcc', '%clang', '%intel']`` on\r\n``x86_64`` systems and ``['%gcc', '%clang']`` on all other systems.\r\n\r\n```yaml\r\nspack:\r\n  definitions:\r\n    - compilers: ['%gcc', '%clang']\r\n    - when: spack_target == 'x64_64'\r\n      compilers: ['%intel']\r\n```\r\n  N.B. Any definitions with the same named list with true ``when``\r\n   clauses (or absent ``when`` clauses) will be appended together\r\n\r\nThe valid variables for a ``when`` clause are:\r\n\r\n1. ``platform``. The platform string of the default Spack architecture on the system. \r\n\r\n2. ``os``. The os string of the default Spack architecture on the system.\r\n\r\n3.  ``target``. The target string of the default Spack architecture on the system.\r\n\r\n4.  ``architecture`` or ``arch``. The full string of the default Spack architecture on the system.\r\n\r\n5. ``re``. The standard regex module in python.\r\n\r\n6. ``env``. The user environment (usually ``os.environ`` in python).\r\n \r\n7.  ``hostname``. The hostname of the system (if ``hostname`` is an executable in the user's PATH).\r\n\"",
    "user": "becker33",
    "url": "https://api.github.com/repos/spack/spack/issues/11057",
    "updated_at": "2019-08-08 18:09:44",
    "created_at": "2019-03-29 15:08:15",
    "closed_at": "2019-07-19 02:28:51",
    "state": "closed",
    "title": "Spack stacks: Allow combinatorial Environment specifications.",
    "number": 11057,
    "milestone": null,
    "labels": [
        "impact-high",
        "environments",
        "stacks"
    ],
    "id": 427033727,
    "html_url": "https://github.com/spack/spack/pull/11057",
    "assignees": [
        "tgamblin"
    ],
    "comments": 20
}