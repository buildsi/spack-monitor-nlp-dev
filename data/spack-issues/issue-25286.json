{
    "body": "### Steps to reproduce\r\n\r\nI'm working on LLNL's rzansel machine (Power9).  Installing trilinos with XL drops custom flags defined in `compilers.yaml` that I require.  The install command is:\r\n\r\n```console\r\nspack install trilinos@12.18.1 %  % xl@2021.03.11-cuda-11.0.2\r\n```\r\n\r\nThis build completes without error but the installed libraries are not useful to me.  \r\n\r\nIn my case, we need the XL options `--gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1 -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlC/16.1.1/lib` so that the correct RPATH to `libstdc++.so.6` is embedded in the trilinos shared libraries.  My  `compiler.yaml` contains the following to ensure that these compiler flags are used.\r\n\r\n```yaml\r\n- compiler:\r\n    environment: {}\r\n    extra_rpaths: []\r\n    flags:\r\n      cxxflags: >-\r\n        --gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1\r\n        -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlC/16.1.1/lib\r\n      cflags: >-\r\n        --gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1\r\n        -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlC/16.1.1/lib\r\n      fflags: >-\r\n        --gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1\r\n        -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlf/16.1.1/lib\r\n    modules:\r\n      - xl/2021.03.11-cuda-11.0.2\r\n    operating_system: rhel7\r\n    paths:\r\n      cc: /usr/tce/packages/xl/xl-2021.03.11-cuda-11.0.2/bin/xlc_r\r\n      cxx: /usr/tce/packages/xl/xl-2021.03.11-cuda-11.0.2/bin/xlC_r\r\n      f77: /usr/tce/packages/xl/xl-2021.03.11-cuda-11.0.2/bin/xlf_r\r\n      fc: /usr/tce/packages/xl/xl-2021.03.11-cuda-11.0.2/bin/xlf2003_r\r\n    spec: xl@2021.03.11-cuda-11.0.2\r\n    target: ppc64le\r\n```\r\n\r\n\r\n### Error message\r\n\r\nWhen these extra compiler flags are dropped by spack's trilinos recipe, any dependent software cannot depend on C++14 features.  A link error is generated when my code attempts to link to trilinos libraries:\r\n\r\n```console\r\n.../libteuchosparameterlist.so.12.18.1: undefined reference to `std::__throw_out_of_range_fmt(char const*, ...)@GLIBCXX_3.4.20'\r\n```\r\n\r\nThe problematic code is found in `trilinos/package.py` and was added by #23518.\r\n\r\n```diff\r\n+    def flag_handler(self, name, flags):\r\n+        if self.spec.satisfies('%cce'):\r\n+            if name == 'ldflags':\r\n+                flags.append('-fuse-ld=gold')\r\n+        return (None, None, flags)\r\n```\r\n\r\nThe `return (None, None, flags)` seems to strip off any custom compiler flags.  If I comment out this block of code, my build completes and my custom compiler flags are used.  If I compare the _good_ and _bad_ trilinos builds I see this diff in `spack-build-01-cmake-out.txt`:\r\n\r\n```diff\r\ncmake  \\\r\n<options found for both builds>\r\n+ '-DCMAKE_C_FLAGS=--gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1 -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlC/16.1.1/lib' \\\r\n+ '-DCMAKE_CXX_FLAGS=--gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1 -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlC/16.1.1/lib' \\\r\n+ '-DCMAKE_Fortran_FLAGS=--gcc-toolchain=/usr/tce/packages/gcc/gcc-8.3.1 -Wl,-rpath,/usr/tce/packages/xl/xl-2021.03.11/xlf/16.1.1/lib'  \r\n```\r\n\r\nThe `*_FLAGS` defines are only present when the custom `flag_handler` is commented out in `trilinos/package.py`.\r\n\r\nCan someone help me correct the broken code `return (None, None, flags)`?  I'm not sure what the correct syntax should be.\r\n\r\n### Information on your system\r\n\r\n```console\r\n% spack debug report\r\n* **Spack:** 0.16.1-2680-b462ccb565\r\n* **Python:** 3.7.2\r\n* **Platform:** linux-rhel7-power9le\r\n* **Concretizer:** original\r\n```\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output\r\n\r\n### Resolution\r\n\r\n* Fixed by #25290",
    "user": "KineticTheory",
    "url": "https://api.github.com/repos/spack/spack/issues/25286",
    "updated_at": "2021-08-08 18:37:35",
    "created_at": "2021-08-05 22:56:31",
    "closed_at": "2021-08-08 18:37:35",
    "state": "closed",
    "title": "[trilinos] build broken by PR23518 when custom compiler flags are required",
    "number": 25286,
    "milestone": null,
    "labels": [
        "bug",
        "help wanted",
        "triage"
    ],
    "id": 962254240,
    "html_url": "https://github.com/spack/spack/issues/25286",
    "assignees": [],
    "comments": 3
}