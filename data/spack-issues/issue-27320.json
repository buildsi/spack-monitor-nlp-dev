{
    "body": "### Steps to reproduce\r\n\r\nUsing `spack@develop` checked out at commit 285548588f533338cc5493a7ba492f107e714794 (`Fri Nov 5 17:11:18 2021 -0700`)\r\n\r\nConcretizing this environment:\r\n```\r\nspack:\r\n  view: false\r\n  packages:\r\n    cuda:\r\n      version: [11.4.2]\r\n  specs:\r\n  - kokkos+cuda+wrapper cuda_arch=80\r\n```\r\n\r\nProduces this DAG:\r\n```\r\n==> Concretized kokkos+cuda+wrapper cuda_arch=80\r\n -   gljj3kr  kokkos@3.4.01%gcc@11.1.0~aggressive_vectorization~compiler_warnings+cuda~cuda_constexpr~cuda_lambda~cuda_ldg_intrinsic~cuda_relocatable_device_code~cuda_uvm~debug~debug_bounds_check~debug_dualview_modify_check~deprecated_code~examples~explicit_instantiation~hpx~hpx_async_dispatch~hwloc~ipo~memkind~numactl~openmp~pic+profiling~profiling_load_print~pthread~qthread~rocm+serial+shared~sycl~tests~tuning+wrapper amdgpu_target=none build_type=RelWithDebInfo cuda_arch=80 std=14 arch=linux-ubuntu20.04-cascadelake\r\n -   yyah5pu      ^cmake@3.21.4%gcc@11.1.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-cascadelake\r\n -   grthxwx          ^ncurses@6.2%gcc@11.1.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-cascadelake\r\n -   mgg7ghl              ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   oa4qlki          ^openssl@1.1.1l%gcc@11.1.0~docs certs=system arch=linux-ubuntu20.04-cascadelake\r\n -   fnqizbm              ^perl@5.34.0%gcc@11.1.0+cpanm+shared+threads arch=linux-ubuntu20.04-cascadelake\r\n -   wofhqzd                  ^berkeley-db@18.1.40%gcc@11.1.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu20.04-cascadelake\r\n -   7wchphv                  ^bzip2@1.0.8%gcc@11.1.0~debug~pic+shared arch=linux-ubuntu20.04-cascadelake\r\n -   ml5drad                      ^diffutils@3.8%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   vzx7hne                          ^libiconv@1.16%gcc@11.1.0 libs=shared,static arch=linux-ubuntu20.04-cascadelake\r\n -   kzk6uri                  ^gdbm@1.19%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   bjf5i6y                      ^readline@8.1%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   bqdql2a                  ^zlib@1.2.11%gcc@11.1.0+optimize+pic+shared arch=linux-ubuntu20.04-cascadelake\r\n -   6pai7qh      ^cuda@11.4.2%gcc@11.1.0~dev arch=linux-ubuntu20.04-cascadelake\r\n -   z46oebe          ^libxml2@2.9.12%gcc@11.1.0~python arch=linux-ubuntu20.04-cascadelake\r\n -   6wb75ft              ^xz@5.2.5%gcc@11.1.0~pic libs=shared,static arch=linux-ubuntu20.04-cascadelake\r\n -   gyzzuei      ^kokkos-nvcc-wrapper@3.2.00%gcc@11.1.0+mpi arch=linux-ubuntu20.04-cascadelake\r\n -   prvpwxp          ^openmpi@4.1.1%gcc@11.1.0~atomics~cuda~cxx~cxx_exceptions+gpfs~internal-hwloc~java~legacylaunchers~lustre~memchecker~pmi~pmix~singularity~sqlite3+static~thread_multiple+vt+wrapper-rpath fabrics=none schedulers=none arch=linux-ubuntu20.04-cascadelake\r\n -   g7x5bgx              ^hwloc@2.6.0%gcc@11.1.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml~opencl+pci~rocm+shared arch=linux-ubuntu20.04-cascadelake\r\n -   4ibmegc                  ^libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   d4jo7hf                      ^libtool@2.4.6%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   apqh2gh                          ^m4@1.4.19%gcc@11.1.0+sigsegv patches=9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573,bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89 arch=linux-ubuntu20.04-cascadelake\r\n -   blaocp7                              ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   uhdtmfl                      ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   kupusgo              ^libevent@2.1.12%gcc@11.1.0+openssl arch=linux-ubuntu20.04-cascadelake\r\n -   mpygmgn              ^numactl@2.0.14%gcc@11.1.0 patches=4e1d78cbbb85de625bad28705e748856033eaafab92a66dffd383a3d7e00cc94,62fc8a8bf7665a60e8f4c93ebbd535647cebf74198f7afafec4c085a8825c006,ff37630df599cfabf0740518b91ec8daaf18e8f288b19adaae5364dc1f6b2296 arch=linux-ubuntu20.04-cascadelake\r\n -   uijpki2                  ^autoconf@2.69%gcc@11.1.0 patches=35c449281546376449766f92d49fc121ca50e330e60fefcfc9be2af3253082c2,7793209b33013dc0f81208718c68440c5aae80e7a1c4b8d336e382525af791a7,a49dd5bac3b62daa0ff688ab4d508d71dbd2f4f8d7e2a02321926346161bf3ee arch=linux-ubuntu20.04-cascadelake\r\n -   b2folmi                  ^automake@1.16.3%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   zzak4hl              ^openssh@8.7p1%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   7izo6ey                  ^libedit@3.1-20210216%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n```\r\n\r\nThe same environment built with the same version of cuda, but where cuda is defined externally, concretizes this way:\r\n```\r\n==> Concretized kokkos+cuda+wrapper cuda_arch=80\r\n -   7bayia7  kokkos@3.4.01%gcc@11.1.0~aggressive_vectorization~compiler_warnings+cuda~cuda_constexpr~cuda_lambda~cuda_ldg_intrinsic~cuda_relocatable_device_code~cuda_uvm~debug~debug_bounds_check~debug_dualview_modify_check~deprecated_code~examples~explicit_instantiation~hpx~hpx_async_dispatch~hwloc~ipo~memkind~numactl~openmp~pic+profiling~profiling_load_print~pthread~qthread~rocm+serial+shared~sycl~tests~tuning+wrapper amdgpu_target=none build_type=RelWithDebInfo cuda_arch=80 std=14 arch=linux-ubuntu20.04-cascadelake\r\n -   yyah5pu      ^cmake@3.21.4%gcc@11.1.0~doc+ncurses+openssl+ownlibs~qt build_type=Release arch=linux-ubuntu20.04-cascadelake\r\n -   grthxwx          ^ncurses@6.2%gcc@11.1.0~symlinks+termlib abi=none arch=linux-ubuntu20.04-cascadelake\r\n -   mgg7ghl              ^pkgconf@1.8.0%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   oa4qlki          ^openssl@1.1.1l%gcc@11.1.0~docs certs=system arch=linux-ubuntu20.04-cascadelake\r\n -   fnqizbm              ^perl@5.34.0%gcc@11.1.0+cpanm+shared+threads arch=linux-ubuntu20.04-cascadelake\r\n -   wofhqzd                  ^berkeley-db@18.1.40%gcc@11.1.0+cxx~docs+stl patches=b231fcc4d5cff05e5c3a4814f6a5af0e9a966428dc2176540d2c05aff41de522 arch=linux-ubuntu20.04-cascadelake\r\n -   7wchphv                  ^bzip2@1.0.8%gcc@11.1.0~debug~pic+shared arch=linux-ubuntu20.04-cascadelake\r\n -   ml5drad                      ^diffutils@3.8%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   vzx7hne                          ^libiconv@1.16%gcc@11.1.0 libs=shared,static arch=linux-ubuntu20.04-cascadelake\r\n -   kzk6uri                  ^gdbm@1.19%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   bjf5i6y                      ^readline@8.1%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   bqdql2a                  ^zlib@1.2.11%gcc@11.1.0+optimize+pic+shared arch=linux-ubuntu20.04-cascadelake\r\n -   je3ey34      ^cuda@11.4.2%gcc@11.1.0~dev arch=linux-ubuntu20.04-cascadelake\r\n -   d7mkofv      ^kokkos-nvcc-wrapper@3.2.00%gcc@11.1.0+mpi arch=linux-ubuntu20.04-cascadelake\r\n -   prvpwxp          ^openmpi@4.1.1%gcc@11.1.0~atomics~cuda~cxx~cxx_exceptions+gpfs~internal-hwloc~java~legacylaunchers~lustre~memchecker~pmi~pmix~singularity~sqlite3+static~thread_multiple+vt+wrapper-rpath fabrics=none schedulers=none arch=linux-ubuntu20.04-cascadelake\r\n -   g7x5bgx              ^hwloc@2.6.0%gcc@11.1.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml~opencl+pci~rocm+shared arch=linux-ubuntu20.04-cascadelake\r\n -   4ibmegc                  ^libpciaccess@0.16%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   d4jo7hf                      ^libtool@2.4.6%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   apqh2gh                          ^m4@1.4.19%gcc@11.1.0+sigsegv patches=9dc5fbd0d5cb1037ab1e6d0ecc74a30df218d0a94bdd5a02759a97f62daca573,bfdffa7c2eb01021d5849b36972c069693654ad826c1a20b53534009a4ec7a89 arch=linux-ubuntu20.04-cascadelake\r\n -   blaocp7                              ^libsigsegv@2.13%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   uhdtmfl                      ^util-macros@1.19.3%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   z46oebe                  ^libxml2@2.9.12%gcc@11.1.0~python arch=linux-ubuntu20.04-cascadelake\r\n -   6wb75ft                      ^xz@5.2.5%gcc@11.1.0~pic libs=shared,static arch=linux-ubuntu20.04-cascadelake\r\n -   kupusgo              ^libevent@2.1.12%gcc@11.1.0+openssl arch=linux-ubuntu20.04-cascadelake\r\n -   mpygmgn              ^numactl@2.0.14%gcc@11.1.0 patches=4e1d78cbbb85de625bad28705e748856033eaafab92a66dffd383a3d7e00cc94,62fc8a8bf7665a60e8f4c93ebbd535647cebf74198f7afafec4c085a8825c006,ff37630df599cfabf0740518b91ec8daaf18e8f288b19adaae5364dc1f6b2296 arch=linux-ubuntu20.04-cascadelake\r\n -   uijpki2                  ^autoconf@2.69%gcc@11.1.0 patches=35c449281546376449766f92d49fc121ca50e330e60fefcfc9be2af3253082c2,7793209b33013dc0f81208718c68440c5aae80e7a1c4b8d336e382525af791a7,a49dd5bac3b62daa0ff688ab4d508d71dbd2f4f8d7e2a02321926346161bf3ee arch=linux-ubuntu20.04-cascadelake\r\n -   b2folmi                  ^automake@1.16.3%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   zzak4hl              ^openssh@8.7p1%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n -   7izo6ey                  ^libedit@3.1-20210216%gcc@11.1.0 arch=linux-ubuntu20.04-cascadelake\r\n```\r\n\r\nNotice that despite both cuda specs being:\r\n* `cuda@11.4.2%gcc@11.1.0~dev arch=linux-ubuntu20.04-cascadelake`\r\n\r\n... they have different hashes.\r\n\r\nNon-external `cuda@11.4.2`\r\n```\r\n -   6pai7qh      ^cuda@11.4.2%gcc@11.1.0~dev arch=linux-ubuntu20.04-cascadelake\r\n```\r\n\r\nExternal `cuda@11.4.2`\r\n```\r\n -   je3ey34      ^cuda@11.4.2%gcc@11.1.0~dev arch=linux-ubuntu20.04-cascadelake\r\n```\r\n\r\nIs this expected behavior? If it is, I'll close this issue. It seems like, if an external is providing the same spec in the dag, it shouldn't have a different hash solely because it is external.\r\n\r\n### Error message\r\n\r\n_No response_\r\n\r\n### Information on your system\r\n\r\n* **Spack:** 0.17.0\r\n* **Python:** 3.8.10\r\n* **Platform:** linux-ubuntu20.04-cascadelake\r\n* **Concretizer:** clingo\r\n\r\n### General information\r\n\r\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [X] I have searched the issues of this repo and believe this is not a duplicate\r\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "eugeneswalker",
    "url": "https://api.github.com/repos/spack/spack/issues/27320",
    "updated_at": "2021-11-15 12:15:24",
    "created_at": "2021-11-10 00:21:17",
    "closed_at": "None",
    "state": "open",
    "title": "concretizer: `kokkos +cuda ^cuda@11.4.2` has different hash depending on whether cuda is external or not",
    "number": 27320,
    "milestone": null,
    "labels": [
        "bug",
        "concretization",
        "triage"
    ],
    "id": 1049260779,
    "html_url": "https://github.com/spack/spack/issues/27320",
    "assignees": [
        "alalazo"
    ],
    "comments": 1
}