{
    "body": "### Steps to reproduce the issue\n\n```console\r\ncat << EOF > spack.yaml\r\nspack:\r\n  specs:\r\n  - qt +opengl ^mesa -llvm\r\n  - pkg-config\r\n  - assimp\r\n  concretization: together\r\n  view: /opt/qt\r\nEOF\r\nspack env activate .\r\nspack install\r\n```\r\nIn this environment, `qt` fails to compile because it tries to link against the system `assimp`, which is not a formal dependency of `qt` but is found because `qt` queries `pkg-config` for assimp when compiling QtQuick3D when `+opengl`. The irony is that it works fine without `assimp` installed trough spack since then a 3rdparty version bundled with Qt is used (but in this case our environments need assimp for other reasons, i.e. `dd4hep`).\r\n\r\n(Note: the `mesa -llvm` is optional here but makes this a more minimal example, timewise. OpenGL is required, though.)\r\n\r\nCompilation error (full logs with `-j1`: [spack-build-01-configure-out.txt](https://github.com/spack/spack/files/7790000/spack-build-01-configure-out.txt), [spack-build-02-build-out.txt](https://github.com/spack/spack/files/7789997/spack-build-02-build-out.txt), [spack-build-env.txt](https://github.com/spack/spack/files/7790009/spack-build-env.txt)):\r\n```\r\n     7161    Project ERROR: Library 'assimp' is not defined.\r\n  >> 7162    make[4]: *** [Makefile:73: sub-assimp-make_first] Error 3\r\n     7163    make[4]: Leaving directory '/home/wdconinc/.spack/stage/spack-stage-qt-5.15.2-3sec4peaqtr34nbn4nk3lvyd5qrq2smv/spack-src/qtquick3d/src/plugins/assetimporters'\r\n  >> 7164    make[3]: *** [Makefile:47: sub-assetimporters-make_first] Error 2\r\n     7165    make[3]: Leaving directory '/home/wdconinc/.spack/stage/spack-stage-qt-5.15.2-3sec4peaqtr34nbn4nk3lvyd5qrq2smv/spack-src/qtquick3d/src/plugins'\r\n  >> 7166    make[2]: *** [Makefile:182: sub-plugins-make_first-ordered] Error 2\r\n     7167    make[2]: Leaving directory '/home/wdconinc/.spack/stage/spack-stage-qt-5.15.2-3sec4peaqtr34nbn4nk3lvyd5qrq2smv/spack-src/qtquick3d/src'\r\n  >> 7168    make[1]: *** [Makefile:50: sub-src-make_first] Error 2\r\n     7169    make[1]: Leaving directory '/home/wdconinc/.spack/stage/spack-stage-qt-5.15.2-3sec4peaqtr34nbn4nk3lvyd5qrq2smv/spack-src/qtquick3d'\r\n  >> 7170    make: *** [Makefile:364: module-qtquick3d-make_first] Error 2\r\n```\n\n### Information on your system\n\n* **Spack:** 0.17.1-675-84e26017b3\r\n* **Python:** 3.9.7\r\n* **Platform:** linux-ubuntu21.10-skylake\r\n* **Concretizer:** clingo\r\n\n\n### Additional information\n\nMaintainer tag: @sethrj \r\n\r\nNot sure what the right approach is here. I guess one approach would be `depends_on('assimp', when='+opengl')` and fix the issue so it actually always compiles with the system (spack) assimp. Another would be `conflicts('assimp', when='+opengl')` and always use the 3rdparty version shipped with Qt.\r\n\r\nI can emphatize with the trouble it must be to support Qt as a spack package: the build system tries hard to be smart and picks up all kind of things from the host system instead... and recompiling takes a long time.\r\n\r\nWhat if no `pkg-config` as provider for `pkgconf`?\r\n```yaml\r\nspack:\r\n  specs:\r\n  - qt +opengl ^mesa -llvm\r\n  - assimp\r\n  concretization: together\r\n  view: false\r\n```\r\nThis picks up the host system `pkg-config` which doesn't know about `assimp` and therefore works fine (something else in our environments has a hard requirement on `pkg-config`).\r\n\r\nWhich other packages does `pkg-config` pick up and use, even if not explicited depended upon?\r\n* `zstd`\r\n* `dbus`\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\n- [X] I have uploaded the build log and environment files\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "wdconinc",
    "url": "https://api.github.com/repos/spack/spack/issues/28181",
    "updated_at": "2022-01-10 13:19:18",
    "created_at": "2021-12-29 18:34:56",
    "closed_at": "2022-01-10 13:19:17",
    "state": "closed",
    "title": "Installation issue: qt ^pkg-config when assimp is in environment with view",
    "number": 28181,
    "milestone": null,
    "labels": [
        "build-error",
        "vendored-dependencies",
        "qt"
    ],
    "id": 1090687200,
    "html_url": "https://github.com/spack/spack/issues/28181",
    "assignees": [],
    "comments": 8
}