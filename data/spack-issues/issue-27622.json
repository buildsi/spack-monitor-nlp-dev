{
    "body": "### Steps to reproduce\n\nOn a system where the compiler needs a module loaded to work correctly the clingo bootstrap build will fail because it won't use the module configuration provided by the user's environment. \r\n\r\n```\r\nmodule load gcc\r\nclone spack\r\nsource setup.sh\r\nspack compiler find\r\nspack spec zlib\r\n```\r\n\r\nWill result in the failure shown under 'error message'.\r\n\r\nExample compilers.yaml entry. Note that the module entry must be manually edited or the compiler will fail:\r\n```\r\n- compiler:\r\n    spec: gcc@8.1.0\r\n    paths:\r\n      cc: /packages/gcc/8.1/bin/gcc\r\n      cxx: /packages/gcc/8.1/bin/g++\r\n      f77: /packages/gcc/8.1/bin/gfortran\r\n      fc: /packages/gcc/8.1/bin/gfortran\r\n    flags: {}\r\n    operating_system: centos7\r\n    target: x86_64\r\n    modules: [ gcc/8.1 ]\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\n\r\nThe compiler entry that shows up in: ~/.spack/bootstrap/config/linux/compilers.yaml. Note that the modules list is empty:\r\n```\r\n - compiler:\r\n    spec: gcc@8.1.0\r\n    paths:\r\n      cc: /packages/gcc/8.1/bin/gcc\r\n      cxx: /packages/gcc/8.1/bin/g++\r\n      f77: /packages/gcc/8.1/bin/gfortran\r\n      fc: /packages/gcc/8.1/bin/gfortran\r\n    flags: {}\r\n    operating_system: centos7\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\n\r\n\r\nExample compiler module setup:\r\n```\r\nmodule show gcc\r\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\n   /packages/modulefiles/gcc/8.1:\r\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\r\nwhatis(\"The GNU Compiler Collection version 8.1.0 \")\r\nsetenv(\"GCC\",\"/packages/gcc/8.1\")\r\nsetenv(\"MPC\",\"/packages/mpc/1.1\")\r\nsetenv(\"MPFR\",\"/packages/mpfr/4.0\")\r\nsetenv(\"GMP\",\"/packages/gmp/6.1\")\r\nsetenv(\"ISL\",\"/packages/isl/0.18\")\r\nprepend_path(\"PATH\",\"/packages/gcc/8.1/bin\")\r\nprepend_path(\"LD_LIBRARY_PATH\",\"/packages/gcc/8.1/lib\")\r\nprepend_path(\"LD_LIBRARY_PATH\",\"/packages/gcc/8.1/lib64\")\r\nprepend_path(\"LD_LIBRARY_PATH\",\"/packages/mpc/1.1/lib\")\r\nprepend_path(\"LD_LIBRARY_PATH\",\"/packages/mpfr/4.0/lib\")\r\nprepend_path(\"LD_LIBRARY_PATH\",\"/packages/gmp/6.1/lib\")\r\nprepend_path(\"LD_LIBRARY_PATH\",\"/packages/isl/0.18/lib\")\r\nprepend_path(\"INFOPATH\",\"/packages/gcc/8.1/info\")\r\nprepend_path(\"INFOPATH\",\"/packages/mpc/1.1/share/info\")\r\nprepend_path(\"INFOPATH\",\"/packages/mpfr/4.0/share/info\")\r\nprepend_path(\"INFOPATH\",\"/packages/gmp/6.1/share/info\")\r\nprepend_path(\"MANPATH\",\"/packages/gcc/8.1/share/man\")\r\nprepend_path(\"C_INCLUDE_PATH\",\"/packages/gcc/8.1/include\")\r\nprepend_path(\"CPLUS_INCLUDE_PATH\",\"/packages/gcc/8.1/include\")\r\nexecute{cmd=\"/packages/Modules/track.sh gcc/8.1\", modeA={\"all\"}}\r\nhelp([[The gcc/8.1 modulefile defines the default system paths\r\nand environment variables needed to use GCC.\r\n]])\r\n\r\n```\n\n### Error message\n\nThe reported failure is: \r\n```\r\nInput spec\r\n--------------------------------\r\nzlib\r\n\r\nConcretized\r\n--------------------------------\r\n==> Bootstrapping clingo from pre-built binaries\r\n==> Bootstrapping clingo from sources\r\n[+] /usr (external bison-3.0.4-o67njlyidben622n7pkd3e6vyzn57drm)\r\n==> Installing pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug\r\n==> No binary for pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug found: installing from source\r\n==> Using cached archive: /wopr/users/wspear/bin/SPACK/cerberus/spack/var/spack/cache/_source-cache/archive/ef/ef9c7e61822b7cb8356e6e9e1dca58d9556f3200d78acab35e4347e9d4c2bbaf.tar.xz\r\n==> No patches needed for pkgconf\r\n==> pkgconf: Executing phase: 'autoreconf'\r\n==> pkgconf: Executing phase: 'configure'\r\n==> Error: ProcessError: Command exited with status 77:\r\n    '/tmp/wspear/spack-stage/spack-stage-pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug/spack-src/configure' '--prefix=/tmp/tmp.7WTa4nW7WP/bootstrap/store/linux-centos7-x86_64/gcc-8.1.0/pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug'\r\n\r\n2 errors found in build log:\r\n  >> 6    configure: error: in `/tmp/wspear/spack-stage/spack-stage-pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug/spack-src':\r\n  >> 7    configure: error: C compiler cannot create executables\r\n     8    See `config.log' for more details\r\n\r\nSee build log for details:\r\n  /tmp/wspear/spack-stage/spack-stage-pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug/spack-build-out.txt\r\n\r\n==> Warning: Skipping build of ncurses-6.2-26ahemmirjg7kug3fiijgxd7bsqprs4r since pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug failed\r\n==> Warning: Skipping build of readline-8.1-33u4lot47ud2objs7p3kcelgl2j3sdqn since ncurses-6.2-26ahemmirjg7kug3fiijgxd7bsqprs4r failed\r\n==> Warning: Skipping build of gdbm-1.19-c5pfgg7ynhkzx3dawkxtmyqnxjgeodvm since readline-8.1-33u4lot47ud2objs7p3kcelgl2j3sdqn failed\r\n==> Warning: Skipping build of perl-5.34.0-tpww2f32g3htfo5xo2vlmdyxw7v7d3qe since gdbm-1.19-c5pfgg7ynhkzx3dawkxtmyqnxjgeodvm failed\r\n==> Warning: Skipping build of openssl-1.1.1l-kk3psff42bu2pmftgljqixpkm4p5tavj since perl-5.34.0-tpww2f32g3htfo5xo2vlmdyxw7v7d3qe failed\r\n==> Warning: Skipping build of cmake-3.21.4-6yr4iaawvjtwswyhgy4m3jbbuyzondjx since openssl-1.1.1l-kk3psff42bu2pmftgljqixpkm4p5tavj failed\r\n==> Warning: Skipping build of clingo-bootstrap-spack-michlrqgln2izgkaaedimth74qlhszxi since cmake-3.21.4-6yr4iaawvjtwswyhgy4m3jbbuyzondjx failed\r\n==> Error: cannot bootstrap the \"clingo\" Python module from spec \"clingo-bootstrap@spack+python %gcc target=x86_64\" due to the following failures:\r\n    'spack-install' raised InstallError: Terminating after first install failure: ProcessError: Command exited with status 77:\r\n    '/tmp/wspear/spack-stage/spack-stage-pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug/spack-src/configure' '--prefix=/tmp/tmp.7WTa4nW7WP/bootstrap/store/linux-centos7-x86_64/gcc-8.1.0/pkgconf-1.8.0-euouhqi2bpfbpeznhhr5wouqm6e33gug'\r\n    Please run `spack -d spec zlib` for more verbose error messages\r\n```\r\n\r\nThe internal error reported in configure.log is:\r\n`/wopr/packages/rhel7/gcc/8.1/bin/../libexec/gcc/x86_64-pc-linux-gnu/8.1.0/cc1: error while loading shared libraries: libisl.so.15: cannot open shared object file: No such file or directory`\r\n\r\nWhich is the same error seen if you use the compiler on the command line after loading the module but unsetting LD_LIBRARY_PATH.\r\n\r\n(No additional useful info from spack debug output)\n\n### Information on your system\n\n* **Spack:** 0.17.0-266-2d20e55\r\n* **Python:** 3.6.8\r\n* **Platform:** linux-centos7-ivybridge\r\n* **Concretizer:** clingo\r\n\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "wspear",
    "url": "https://api.github.com/repos/spack/spack/issues/27622",
    "updated_at": "2021-11-29 15:47:27",
    "created_at": "2021-11-23 21:58:07",
    "closed_at": "None",
    "state": "open",
    "title": "Clingo bootstrap fails: bootstrap environment doesn't import compiler configuration",
    "number": 27622,
    "milestone": null,
    "labels": [
        "bug",
        "triage",
        "bootstrap"
    ],
    "id": 1061746557,
    "html_url": "https://github.com/spack/spack/issues/27622",
    "assignees": [
        "alalazo"
    ],
    "comments": 0
}