{
    "body": "I first built an openmpi variant and then tried to build parmetis with the hash of the previously built openmpi as a dependency but spack nevertheless tries to rebuild a different openmpi. I try to re-use some installed packages from the base system. I've attached packages.yaml for that, in case it matters.\r\n[packages.yaml.gz](https://github.com/spack/spack/files/4085711/packages.yaml.gz)\r\n\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack spec -l /o7noi7ole6q5wsge7guf6j5wsubmjwji\r\nInput spec\r\n--------------------------------\r\nopenmpi@3.0.2%gcc@8.2.0 cflags=\"-O3 -DNDEBUG -finline-functions -fno-strict-aliasing -pthread -g -march=native\" cxxflags=\"-O3 -DNDEBUG -finline-functions -pthread -g -march=native\" fflags=\"-O2 -g -march=native\" ldflags=\"-g\" ~cuda~cxx_exceptions+devel_headers fabrics=libfabric,verbs ~java+legacylaunchers~memchecker patches=32effdf1deab19ca87850161d3ad8ff34540c9e26f6bf40cd64839ea47a3a0e0 +pmi schedulers=slurm ~sqlite3~thread_multiple+vt arch=linux-debian9-sandybridge\r\n    ^hwloc@1.11.5%gcc@6.3.0~cairo~cuda~gl+libxml2~nvml+pci+shared arch=linux-debian9-sandybridge\r\n    ^libfabric@1.4.0%gcc@6.3.0 fabrics=sockets ~kdreg arch=linux-debian9-sandybridge\r\n    ^numactl@2.0.11%gcc@6.3.0 patches=592f30f7f5f757dfc239ad0ffd39a9a048487ad803c26b419e0f96b8cda08c1a arch=linux-debian9-sandybridge\r\n    ^slurm@16.05.9%gcc@6.3.0~gtk~hdf5~hwloc~mariadb~pmix+readline arch=linux-debian9-sandybridge\r\n    ^zlib@1.2.8%gcc@6.3.0+optimize+pic+shared arch=linux-debian9-sandybridge\r\n\r\nConcretized\r\n--------------------------------\r\no7noi7o  openmpi@3.0.2%gcc@8.2.0 cflags=\"-O3 -DNDEBUG -finline-functions -fno-strict-aliasing -pthread -g -march=native\" cxxflags=\"-O3 -DNDEBUG -finline-functions -pthread -g -march=native\" fflags=\"-O2 -g -march=native\" ldflags=\"-g\" ~cuda~cxx_exceptions+devel_headers fabrics=libfabric,verbs ~java+legacylaunchers~memchecker patches=32effdf1deab19ca87850161d3ad8ff34540c9e26f6bf40cd64839ea47a3a0e0 +pmi schedulers=slurm ~sqlite3~thread_multiple+vt arch=linux-debian9-sandybridge\r\n2wtdtoq      ^hwloc@1.11.5%gcc@6.3.0~cairo~cuda~gl+libxml2~nvml+pci+shared arch=linux-debian9-sandybridge\r\nnbe2fkc      ^libfabric@1.4.0%gcc@6.3.0 fabrics=sockets ~kdreg arch=linux-debian9-sandybridge\r\nxie6fvg      ^numactl@2.0.11%gcc@6.3.0 patches=592f30f7f5f757dfc239ad0ffd39a9a048487ad803c26b419e0f96b8cda08c1a arch=linux-debian9-sandybridge\r\n5yjjkpd      ^slurm@16.05.9%gcc@6.3.0~gtk~hdf5~hwloc~mariadb~pmix+readline arch=linux-debian9-sandybridge\r\ntcqyprp      ^zlib@1.2.8%gcc@6.3.0+optimize+pic+shared arch=linux-debian9-sandybridge\r\n\r\n$  spack spec -l parmetis%gcc@8.2.0 ^/o7noi7ole6q5wsge7guf6j5wsubmjwji ^cmake@3.7.2%gcc@6.3.0\r\nInput spec\r\n--------------------------------\r\nparmetis%gcc@8.2.0\r\n    ^cmake@3.7.2%gcc@6.3.0\r\n    ^openmpi@3.0.2%gcc@8.2.0 cflags=\"-O3 -DNDEBUG -finline-functions -fno-strict-aliasing -pthread -g -march=native\" cxxflags=\"-O3 -DNDEBUG -finline-functions -pthread -g -march=native\" fflags=\"-O2 -g -march=native\" ldflags=\"-g\" ~cuda~cxx_exceptions+devel_headers fabrics=libfabric,verbs ~java+legacylaunchers~memchecker patches=32effdf1deab19ca87850161d3ad8ff34540c9e26f6bf40cd64839ea47a3a0e0 +pmi schedulers=slurm ~sqlite3~thread_multiple+vt arch=linux-debian9-sandybridge\r\n        ^hwloc@1.11.5%gcc@6.3.0~cairo~cuda~gl+libxml2~nvml+pci+shared arch=linux-debian9-sandybridge\r\n        ^libfabric@1.4.0%gcc@6.3.0 fabrics=sockets ~kdreg arch=linux-debian9-sandybridge\r\n        ^numactl@2.0.11%gcc@6.3.0 patches=592f30f7f5f757dfc239ad0ffd39a9a048487ad803c26b419e0f96b8cda08c1a arch=linux-debian9-sandybridge\r\n        ^slurm@16.05.9%gcc@6.3.0~gtk~hdf5~hwloc~mariadb~pmix+readline arch=linux-debian9-sandybridge\r\n        ^zlib@1.2.8%gcc@6.3.0+optimize+pic+shared arch=linux-debian9-sandybridge\r\n\r\nConcretized\r\n--------------------------------\r\ngcfedut  parmetis@4.0.3%gcc@8.2.0 build_type=RelWithDebInfo ~gdb patches=4f892531eb0a807eb1b82e683a416d3e35154a455274cf9b162fb02054d11a5b,50ed2081bc939269689789942067c58b3e522c269269a430d5d34c00edbc5870,704b84f7c7444d4372cb59cca6e1209df4ef3b033bc4ee3cf50f369bce972a9d +shared arch=linux-debian9-sandybridge\r\nmg2a2ax      ^cmake@3.7.2%gcc@6.3.0~doc+ncurses+openssl+ownlibs patches=dd3a40d4d92f6b2158b87d6fb354c277947c776424aa03f6dc8096cf3135f5d0 ~qt arch=linux-debian9-sandybridge\r\nyr4xkq5      ^metis@5.1.0%gcc@8.2.0 build_type=Release ~gdb~int64 patches=4991da938c1d3a1d3dea78e49bbebecba00273f98df2a656e38b83d55b281da1,b1225da886605ea558db7ac08dd8054742ea5afe5ed61ad4d0fe7a495b1270d2 ~real64+shared arch=linux-debian9-sandybridge\r\ngy6snkp      ^openmpi@3.0.2%gcc@8.2.0 cflags=\"-O3 -DNDEBUG -finline-functions -fno-strict-aliasing -pthread -g -march=native\" cxxflags=\"-O3 -DNDEBUG -finline-functions -pthread -g -march=native\" fflags=\"-O2 -g -march=native\" ldflags=\"-g\" ~cuda~cxx_exceptions+devel_headers fabrics=libfabric,verbs ~java+legacylaunchers~memchecker patches=32effdf1deab19ca87850161d3ad8ff34540c9e26f6bf40cd64839ea47a3a0e0 +pmi schedulers=slurm ~sqlite3~thread_multiple+vt arch=linux-debian9-sandybridge\r\nbhkzxki          ^hwloc@1.11.5%gcc@6.3.0~cairo~cuda~gl+libxml2~nvml+pci+shared arch=linux-debian9-sandybridge\r\njr2yxsj          ^libfabric@1.4.0%gcc@6.3.0 fabrics=sockets ~kdreg arch=linux-debian9-sandybridge\r\nfp2knlg          ^numactl@2.0.11%gcc@6.3.0 patches=592f30f7f5f757dfc239ad0ffd39a9a048487ad803c26b419e0f96b8cda08c1a arch=linux-debian9-sandybridge\r\nukdj2h3          ^slurm@16.05.9%gcc@6.3.0~gtk~hdf5~hwloc~mariadb~pmix+readline arch=linux-debian9-sandybridge\r\n4umtteo          ^zlib@1.2.8%gcc@6.3.0+optimize+pic+shared arch=linux-debian9-sandybridge\r\n```\r\n\r\nAs can be seen, /o7noi7o is an already installed openmpi (with local modifications to package.py so I can also install MCA development headers and specific flags) and trying to build parmetis to depend on it generates a new hash gy6snkp were it's unclear to me how the two differ, i.e. what prompts spack to regenerate.\r\n\r\n### Error Message\r\n\r\nUnfortunately there's no error, just unexpected behaviour. Can I ask spack in more detail what it thinks needs to be different? And why does it even try to rebuild an explicit dependency?\r\n\r\n### Information on your system\r\n\r\nThe system in question is a debian 9 on Intel sandybridge in x86_64 mode.\r\n\r\n\r\n\r\n",
    "user": "tjahns",
    "url": "https://api.github.com/repos/spack/spack/issues/14566",
    "updated_at": "2020-01-23 13:45:25",
    "created_at": "2020-01-20 10:34:30",
    "closed_at": "None",
    "state": "open",
    "title": "spack install decides to rebuild dependency given by hash",
    "number": 14566,
    "milestone": null,
    "labels": [
        "bug"
    ],
    "id": 552212182,
    "html_url": "https://github.com/spack/spack/issues/14566",
    "assignees": [],
    "comments": 6
}