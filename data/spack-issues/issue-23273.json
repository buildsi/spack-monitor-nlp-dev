{
    "body": "When setting `ldlibs` for a package or compiler, the link flags are injected by the wrapper script after the flags from the input command. This is different than all other injectable flags (e.g. `cflags`, `cxxflags`, `ldflags`, etc.) and can cause the wrong library to be used when the injected one is intended to override another library.\r\n\r\nFor example, below I want to install `libxml2` while overriding functions from the standard `libm` with AMD's optimized versions, in `libalm`. However, `-lalm` is ordered after `-lm`; this causes functions in `libm` to be preferred, which is _not_ what is intended.\r\n\r\n### Steps to reproduce the issue\r\n\r\n```console\r\n$ spack install libxml2 %aocc ldlibs='-lalm'\r\n...\r\n$ ldd \"$(spack location -i libxml2 %aocc ldlibs='-lalm')/lib/libxml2.so\"\r\n\tlinux-vdso.so.1 (0x0000155555551000)\r\n\tlibdl.so.2 => /lib64/libdl.so.2 (0x0000155554c97000)\r\n\tlibz.so.1 => /home/omor1/spack/opt/spack/linux-centos8-zen2/aocc-3.0.0/zlib-1.2.11-omq2fsz3fi4zex2xa2yj2lvluixsyk6x/lib/libz.so.1 (0x000015555538d000)\r\n\tliblzma.so.5 => /home/omor1/spack/opt/spack/linux-centos8-zen2/aocc-3.0.0/xz-5.2.5-enj5mygu7xn3l4wdsuzmpqmwezveumh6/lib/liblzma.so.5 (0x0000155555364000)\r\n\tlibiconv.so.2 => /home/omor1/spack/opt/spack/linux-centos8-zen2/aocc-3.0.0/libiconv-1.16-x7c5xwvmdon6mhug7dwmu5eqlpzyicqe/lib/libiconv.so.2 (0x0000155554b9b000)\r\n\tlibm.so.6 => /lib64/libm.so.6 (0x0000155554e9b000)\r\n\tlibalm.so => /home/omor1/spack/opt/spack/linux-centos8-zen/gcc-8.3.1/aocc-3.0.0-4tflgtbenvsdjuq4nzlb5n2zmvlmxf6y/lib/libalm.so (0x000015555521d000)\r\n\tlibc.so.6 => /lib64/libc.so.6 (0x00001555547d8000)\r\n\t/lib64/ld-linux-x86-64.so.2 (0x000015555532b000)\r\n\tlibpthread.so.0 => /lib64/libpthread.so.0 (0x00001555545b8000)\r\n```\r\n\r\n### Information on your system\r\n\r\n```console\r\n$ spack debug report\r\n* **Spack:** 0.16.1-2358-91845956ba\r\n* **Python:** 3.9.4\r\n* **Platform:** linux-centos8-zen2\r\n* **Concretizer:** original\r\n```\r\n\r\n```yaml\r\ncompilers.yaml\r\n\r\ncompilers:\r\n- compiler:\r\n    spec: gcc@8.3.1\r\n    paths:\r\n      cc: /usr/bin/gcc\r\n      cxx: /usr/bin/g++\r\n      f77: /usr/bin/gfortran\r\n      fc: /usr/bin/gfortran\r\n    flags:\r\n      cflags: -O2\r\n      cxxflags: -O2\r\n      fflags: -O2\r\n    operating_system: centos8\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n- compiler:\r\n    spec: aocc@3.0.0\r\n    paths:\r\n      cc: /home/omor1/spack/opt/spack/linux-centos8-zen/gcc-8.3.1/aocc-3.0.0-4tflgtbenvsdjuq4nzlb5n2zmvlmxf6y/bin/clang\r\n      cxx: /home/omor1/spack/opt/spack/linux-centos8-zen/gcc-8.3.1/aocc-3.0.0-4tflgtbenvsdjuq4nzlb5n2zmvlmxf6y/bin/clang++\r\n      f77: /home/omor1/spack/opt/spack/linux-centos8-zen/gcc-8.3.1/aocc-3.0.0-4tflgtbenvsdjuq4nzlb5n2zmvlmxf6y/bin/flang\r\n      fc: /home/omor1/spack/opt/spack/linux-centos8-zen/gcc-8.3.1/aocc-3.0.0-4tflgtbenvsdjuq4nzlb5n2zmvlmxf6y/bin/flang\r\n    flags:\r\n      cflags: -O2 -fveclib=AMDLIBM -Wno-unused-command-line-argument -mllvm -eliminate-similar-expr=false\r\n      cxxflags: -O2 -fveclib=AMDLIBM -Wno-unused-command-line-argument -mllvm -eliminate-similar-expr=false\r\n      fflags: -O2 -fveclib=AMDLIBM -Wno-unused-command-line-argument -mllvm -eliminate-similar-expr=false\r\n      ldlibs: -lalm -lm\r\n    operating_system: centos8\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\n\r\n### Additional information\r\n\r\n<!-- These boxes can be checked by replacing [ ] with [x] or by clicking them after submitting the issue. -->\r\n- [x] I have run `spack debug report` and reported the version of Spack/Python/Platform\r\n- [x] I have searched the issues of this repo and believe this is not a duplicate\r\n- [x] I have run the failing commands in debug mode and reported the output\r\n\r\n### Solutions\r\n\r\nIf this ordering is needed, passing the flags in `ldflags` instead of `ldlibs` might be sufficient. The proper solution is to inject `SPACK_LDLIBS` before the input flags in the `cc` script:\r\n```diff\r\ndiff --git a/lib/spack/env/cc b/lib/spack/env/cc\r\nindex 4d8c4644cb..7ffac0c90c 100755\r\n--- a/lib/spack/env/cc\r\n+++ b/lib/spack/env/cc\r\n@@ -545,14 +555,14 @@ case \"$mode\" in\r\n         ;;\r\n esac\r\n \r\n-# Other arguments from the input command\r\n-args+=(\"${other_args[@]}\")\r\n-\r\n # Inject SPACK_LDLIBS, if supplied\r\n for lib in \"${libs[@]}\"; do\r\n     args+=(\"-l$lib\");\r\n done\r\n \r\n+# Other arguments from the input command\r\n+args+=(\"${other_args[@]}\")\r\n+\r\n full_command=(\"$command\" \"${args[@]}\")\r\n```\r\n\r\nHowever, I'm concerned this might cause other, hidden issues that might be hard to debug later\u2014in some use cases, at least. Maybe providing an alternative `override_ldlibs` parameter might be useful for making this use case clear?",
    "user": "omor1",
    "url": "https://api.github.com/repos/spack/spack/issues/23273",
    "updated_at": "2021-04-30 22:53:56",
    "created_at": "2021-04-26 22:46:10",
    "closed_at": "None",
    "state": "open",
    "title": "ldlibs compiler flags injection order",
    "number": 23273,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 868258371,
    "html_url": "https://github.com/spack/spack/issues/23273",
    "assignees": [],
    "comments": 1
}