{
    "body": "### Steps to reproduce the issue\n\nI cannot install `fftw +mpi` on macOS any more. The FFTW libraries are built without linking against the MPI libraries, leading to an error due to undefined symbols.\r\n\r\n```console\r\n$ spack --env-dir utils/spack/redshift spec -I fftw\r\nInput spec\r\n--------------------------------\r\n -   fftw\r\n\r\nConcretized\r\n--------------------------------\r\n -   fftw@3.3.10%apple-clang@13.0.0+mpi~openmp~pfft_patches precision=double,float arch=darwin-monterey-skylake\r\n -       ^openmpi@4.1.2%apple-clang@13.0.0~atomics~cuda~cxx~cxx_exceptions+gpfs~internal-hwloc~java~legacylaunchers~lustre~memchecker~pmi~pmix+romio~singularity~sqlite3+static~thread_multiple+vt+wrapper-rpath fabrics=none schedulers=none arch=darwin-monterey-skylake\r\n[+]          ^hwloc@2.7.0%apple-clang@13.0.0~cairo~cuda~gl~libudev+libxml2~netloc~nvml~opencl~pci~rocm+shared arch=darwin-monterey-skylake\r\n[+]              ^libxml2@2.9.12%apple-clang@13.0.0~python arch=darwin-monterey-skylake\r\n[+]                  ^libiconv@1.16%apple-clang@13.0.0 libs=shared,static arch=darwin-monterey-skylake\r\n[+]                  ^pkgconf@1.8.0%apple-clang@13.0.0 arch=darwin-monterey-skylake\r\n[+]                  ^xz@5.2.5%apple-clang@13.0.0~pic libs=shared,static arch=darwin-monterey-skylake\r\n[+]                  ^zlib@1.2.11%apple-clang@13.0.0+optimize+pic+shared arch=darwin-monterey-skylake\r\n[+]              ^ncurses@6.2%apple-clang@13.0.0~symlinks+termlib abi=none patches=3970661 arch=darwin-monterey-skylake\r\n[+]          ^libevent@2.1.12%apple-clang@13.0.0+openssl arch=darwin-monterey-skylake\r\n[+]              ^openssl@1.1.1m%apple-clang@13.0.0~docs certs=system arch=darwin-monterey-skylake\r\n[+]                  ^perl@5.34.0%apple-clang@13.0.0+cpanm+shared+threads arch=darwin-monterey-skylake\r\n[+]                      ^berkeley-db@18.1.40%apple-clang@13.0.0+cxx~docs+stl patches=9f5b54a,b231fcc arch=darwin-monterey-skylake\r\n[+]                      ^bzip2@1.0.8%apple-clang@13.0.0~debug~pic+shared arch=darwin-monterey-skylake\r\n[+]                          ^diffutils@3.8%apple-clang@13.0.0 arch=darwin-monterey-skylake\r\n[+]                      ^gdbm@1.19%apple-clang@13.0.0 arch=darwin-monterey-skylake\r\n[+]                          ^readline@8.1%apple-clang@13.0.0 arch=darwin-monterey-skylake\r\n[+]          ^openssh@8.8p1%apple-clang@13.0.0 arch=darwin-monterey-skylake\r\n[+]              ^libedit@3.1-20210216%apple-clang@13.0.0 arch=darwin-monterey-skylake\r\n```\r\n\n\n### Error message\n\n<details><summary>Error message</summary><pre>\r\n6 errors found in build log:\r\n     6474    mv -f .deps/rdft2-rank-geq2-transposed.Tpo .deps/rdft2-rank-geq2-transposed.Plo\r\n     6475    mv -f .deps/rdft2-solve.Tpo .deps/rdft2-solve.Plo\r\n     6476    mv -f .deps/rdft2-problem.Tpo .deps/rdft2-problem.Plo\r\n     6477    mv -f .deps/api.Tpo .deps/api.Plo\r\n     6478    /bin/sh ../libtool  --tag=CC   --mode=link /Users/eschnett/src/spack/opt/spack/darwin-monterey-skylake/gcc-11.2.0/open\r\n             mpi-4.1.2-7poxc72sktaq4bllursf2spuanjv7sw2/bin/mpicc  -O3 -fomit-frame-pointer -mtune=native -malign-double -fstrict-a\r\n             liasing -fno-schedule-insns -Wa,-q -Wl,-no_compact_unwind -version-info 9:10:6  -o libfftw3_mpi.la -rpath /Users/eschn\r\n             ett/src/spack/opt/spack/darwin-monterey-skylake/gcc-11.2.0/fftw-3.3.10-beequmaebpecoqrwnyoyvr32v66ymrv2/lib any-true.l\r\n             o api.lo block.lo choose-radix.lo conf.lo dtensor.lo rearrange.lo wisdom-api.lo f03-wrap.lo transpose-alltoall.lo tran\r\n             spose-pairwise.lo transpose-recurse.lo transpose-problem.lo transpose-solve.lo dft-serial.lo dft-rank-geq2.lo dft-rank\r\n             -geq2-transposed.lo dft-rank1.lo dft-rank1-bigvec.lo dft-problem.lo dft-solve.lo rdft-serial.lo rdft-rank-geq2.lo rdft\r\n             -rank-geq2-transposed.lo rdft-rank1-bigvec.lo rdft-problem.lo rdft-solve.lo rdft2-serial.lo rdft2-rank-geq2.lo rdft2-r\r\n             ank-geq2-transposed.lo rdft2-problem.lo rdft2-solve.lo ../libfftw3.la   -lm\r\n     6479    libtool: link: /Users/eschnett/src/spack/lib/spack/env/gcc/gcc -dynamiclib  -o .libs/libfftw3_mpi.3.dylib  .libs/any-t\r\n             rue.o .libs/api.o .libs/block.o .libs/choose-radix.o .libs/conf.o .libs/dtensor.o .libs/rearrange.o .libs/wisdom-api.o\r\n              .libs/f03-wrap.o .libs/transpose-alltoall.o .libs/transpose-pairwise.o .libs/transpose-recurse.o .libs/transpose-prob\r\n             lem.o .libs/transpose-solve.o .libs/dft-serial.o .libs/dft-rank-geq2.o .libs/dft-rank-geq2-transposed.o .libs/dft-rank\r\n             1.o .libs/dft-rank1-bigvec.o .libs/dft-problem.o .libs/dft-solve.o .libs/rdft-serial.o .libs/rdft-rank-geq2.o .libs/rd\r\n             ft-rank-geq2-transposed.o .libs/rdft-rank1-bigvec.o .libs/rdft-problem.o .libs/rdft-solve.o .libs/rdft2-serial.o .libs\r\n             /rdft2-rank-geq2.o .libs/rdft2-rank-geq2-transposed.o .libs/rdft2-problem.o .libs/rdft2-solve.o   ../.libs/libfftw3.dy\r\n             lib -lm  -O3 -mtune=native -malign-double -Wl,-no_compact_unwind   -install_name  /Users/eschnett/src/spack/opt/spack/\r\n             darwin-monterey-skylake/gcc-11.2.0/fftw-3.3.10-beequmaebpecoqrwnyoyvr32v66ymrv2/lib/libfftw3_mpi.3.dylib -compatibilit\r\n             y_version 10 -current_version 10.10 -Wl,-single_module\r\n  >> 6480    Undefined symbols for architecture x86_64:\r\n     6481      \"_MPI_Abort\", referenced from:\r\n     6482          _fftw_mpi_gather_wisdom in wisdom-api.o\r\n     6483          _fftw_mpi_broadcast_wisdom in wisdom-api.o\r\n     6484      \"_MPI_Allreduce\", referenced from:\r\n     6485          _fftw_mpi_any_true in any-true.o\r\n     6486          _wisdom_ok_hook in api.o\r\n\r\n     ...\r\n\r\n     6572      \"_ompi_mpi_unsigned\", referenced from:\r\n     6573          _wisdom_ok_hook in api.o\r\n     6574      \"_ompi_mpi_unsigned_long\", referenced from:\r\n     6575          _fftw_mpi_gather_wisdom in wisdom-api.o\r\n     6576          _fftw_mpi_broadcast_wisdom in wisdom-api.o\r\n     6577    ld: symbol(s) not found for architecture x86_64\r\n  >> 6578    collect2: error: ld returned 1 exit status\r\n  >> 6579    make[3]: *** [libfftw3_mpi.la] Error 1\r\n  >> 6580    make[2]: *** [all] Error 2\r\n  >> 6581    make[1]: *** [all-recursive] Error 1\r\n  >> 6582    make: *** [all] Error 2\r\n\r\n</pre></details>\r\n\r\nI believe the problem is related to `libtool`. `libtool` is configured without MPI, and saves as `CC` the path to the actual compiler. Later, when building MPI code, fftw redefines `CC` to `$MPICC`. `libtool` seems to ignore this setting, and then tires to create a dynamic library while calling `$CC`, which fails since the `-lmpi` option is missing.\r\n\r\nThe same seems to happen on both Linux and macOS. However, the build finishes fine on Linux. Maybe the dynamic linker behaves different on Linux, and is not flagging missing external symbols when creating a dynamic library?\r\n\r\nThis problem was introduced fairly recently; I used to be able to build `fftw` without problems.\n\n### Information on your system\n\n$ spack debug report\r\n* **Spack:** 0.17.1-1357-d62b8f0bf3\r\n* **Python:** 3.8.9\r\n* **Platform:** darwin-monterey-skylake\r\n* **Concretizer:** clingo\r\n\n\n### Additional information\n\n[spack-build-out.txt](https://github.com/spack/spack/files/8143245/spack-build-out.txt)\r\n[spack-build-env.txt](https://github.com/spack/spack/files/8143247/spack-build-env.txt)\r\n\r\n\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have run `spack maintainers <name-of-the-package>` and **@mentioned** any maintainers\n- [X] I have uploaded the build log and environment files\n- [X] I have searched the issues of this repo and believe this is not a duplicate",
    "user": "eschnett",
    "url": "https://api.github.com/repos/spack/spack/issues/29224",
    "updated_at": "2022-03-05 22:09:59",
    "created_at": "2022-02-25 18:03:58",
    "closed_at": "None",
    "state": "open",
    "title": "Installation issue: fftw",
    "number": 29224,
    "milestone": null,
    "labels": [
        "macOS",
        "build-error",
        "mpi"
    ],
    "id": 1150716493,
    "html_url": "https://github.com/spack/spack/issues/29224",
    "assignees": [],
    "comments": 1
}