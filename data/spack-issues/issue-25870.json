{
    "body": "### Steps to reproduce\n\nI am on a cluster (NCCS Discover) where Intel oneAPI 2021.3 is already installed. So if I do:\r\n```console\r\n$ ml comp/intel/2021.3.0\r\n$ spack compiler find\r\n==> Added 2 new compilers to /home/mathomp4/.spack/linux/compilers.yaml\r\n    oneapi@2021.3.0  intel@2021.3.0\r\n==> Compilers are defined in the following files:\r\n    /home/mathomp4/.spack/linux/compilers.yaml\r\n```\r\nso spack found them and in my `linux/compilers.yaml`:\r\n```yaml\r\n- compiler:\r\n    spec: intel@2021.3.0\r\n    paths:\r\n      cc: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/icc\r\n      cxx: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/icpc\r\n      f77: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/ifort\r\n      fc: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/intel64/ifort\r\n    flags: {}\r\n    operating_system: sles12\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n- compiler:\r\n    spec: oneapi@2021.3.0\r\n    paths:\r\n      cc: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/icx\r\n      cxx: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/icpx\r\n      f77: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/ifx\r\n      fc: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/bin/ifx\r\n    flags: {}\r\n    operating_system: sles12\r\n    target: x86_64\r\n    modules: []\r\n    environment: {}\r\n    extra_rpaths: []\r\n```\r\nNow, I want the `ifort`, etc, so in `packages.yaml` I have:\r\n```yaml\r\n  intel:\r\n    buildable: false\r\n    externals:\r\n    - spec: intel@2021.3.0%gcc@4.8\r\n      modules:\r\n        - comp/intel/2021.3.0\r\n```\r\nAnd now I want to \"install\" that so I can do `spack load intel@2021.3` and:\r\n```console\r\n$ spack install intel@2021.3.0\r\n==> intel@2021.3.0 : has external module in ['comp/intel/2021.3.0']\r\n[+] /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux (external intel-2021.3.0-ga2dlngst54wupld7bhytcd4qtzw3owc)\r\n$ spack load intel@2021.3.0\r\n==> Error: Trying to source non-existing file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh\r\n```\n\n### Error message\n\n```console\r\n$ spack --debug --stacktrace load intel@2021.3.0\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/cmd/__init__.py:122 ==> [2021-09-09-11:18:42.788718] Imported load from built-in commands\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/cmd/__init__.py:122 ==> [2021-09-09-11:18:42.789934] Imported load from built-in commands\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:42.853212] Reading config file /gpfsm/dnb44/mathomp4/spack/etc/spack/defaults/config.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:42.878304] Reading config file /home/mathomp4/.spack/config.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:42.881212] Reading config file /gpfsm/dnb44/mathomp4/spack/etc/spack/defaults/bootstrap.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/database.py:371 ==> [2021-09-09-11:18:42.908475] DATABASE LOCK TIMEOUT: 3s\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/database.py:375 ==> [2021-09-09-11:18:42.908866] PACKAGE LOCK TIMEOUT: No timeout\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:42.955524] Reading config file /gpfsm/dnb44/mathomp4/spack/etc/spack/defaults/repos.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:43.543436] Reading config file /gpfsm/dnb44/mathomp4/spack/etc/spack/defaults/modules.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:43.562110] Reading config file /gpfsm/dnb44/mathomp4/spack/etc/spack/defaults/linux/modules.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:43.572221] Reading config file /home/mathomp4/.spack/modules.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/config.py:991 ==> [2021-09-09-11:18:43.719659] Reading config file /home/mathomp4/.spack/linux/compilers.yaml\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py:46 ==> [2021-09-09-11:18:43.835100] normalize_path.normalize_suite_dir:\ttrying /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries_2021.3.0\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py:46 ==> [2021-09-09-11:18:43.835921] normalize_path.normalize_suite_dir:\ttrying /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries_2021.0.*\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py:46 ==> [2021-09-09-11:18:43.836932] normalize_path.normalize_suite_dir:\ttrying /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries_*.*.*\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py:46 ==> [2021-09-09-11:18:43.838024] normalize_path.normalize_suite_dir:\t/usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py:46 ==> [2021-09-09-11:18:43.838872] file_to_source.normalize_path:\t/usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py:1016 ==> [2021-09-09-11:18:43.839087] sourcing /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh\r\ngpfsm/dnb44/mathomp4/spack/lib/spack/spack/util/environment.py:643 ==> [2021-09-09-11:18:43.839309] EnvironmentModifications.from_sourcing_file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh\r\nTraceback (most recent call last):\r\n  File \"/discover/nobackup/mathomp4/spack/bin/spack\", line 100, in <module>\r\n    sys.exit(spack.main.main())\r\n  File \"/gpfsm/dnb44/mathomp4/spack/lib/spack/spack/main.py\", line 797, in main\r\n    return _invoke_command(command, parser, args, unknown)\r\n  File \"/gpfsm/dnb44/mathomp4/spack/lib/spack/spack/main.py\", line 525, in _invoke_command\r\n    return_val = command(parser, args)\r\n  File \"/gpfsm/dnb44/mathomp4/spack/lib/spack/spack/cmd/load.py\", line 79, in load\r\n    env_mod.extend(uenv.environment_modifications_for_spec(spec))\r\n  File \"/gpfsm/dnb44/mathomp4/spack/lib/spack/spack/user_environment.py\", line 95, in environment_modifications_for_spec\r\n    spec.package.setup_run_environment(env)\r\n  File \"/gpfsm/dnb44/mathomp4/spack/lib/spack/spack/build_systems/intel.py\", line 1027, in setup_run_environment\r\n    env.extend(EnvironmentModifications.from_sourcing_file(f, *args))\r\n  File \"/gpfsm/dnb44/mathomp4/spack/lib/spack/spack/util/environment.py\", line 648, in from_sourcing_file\r\n    raise RuntimeError(msg)\r\nRuntimeError: Trying to source non-existing file: /usr/local/intel/oneapi/2021/compiler/2021.3.0/linux/compilers_and_libraries/linux/bin/compilervars.sh\r\n```\n\n### Information on your system\n\n$ spack debug report\r\n* **Spack:** 0.16.2-4196-e47f0d486c\r\n* **Python:** 3.8.5\r\n* **Platform:** linux-sles12-haswell\r\n* **Concretizer:** original\n\n### General information\n\n- [X] I have run `spack debug report` and reported the version of Spack/Python/Platform\n- [X] I have searched the issues of this repo and believe this is not a duplicate\n- [X] I have run the failing commands in debug mode and reported the output",
    "user": "mathomp4",
    "url": "https://api.github.com/repos/spack/spack/issues/25870",
    "updated_at": "2021-09-09 15:22:52",
    "created_at": "2021-09-09 15:22:52",
    "closed_at": "None",
    "state": "open",
    "title": "Odd issue with already-installed oneAPI and Module Generate?",
    "number": 25870,
    "milestone": null,
    "labels": [
        "bug",
        "triage"
    ],
    "id": 992354026,
    "html_url": "https://github.com/spack/spack/issues/25870",
    "assignees": [],
    "comments": 0
}